# AWS re:Invent 2025 - DSQL 开发者实战会议总结

## 会议概述

本次会议是一场关于 Amazon DSQL 的开发者实战演示（Code Talk），由两位 DSQL 工程师 Mark 和 Ruka 主讲。会议通过构建一个简单的银行转账应用来展示 DSQL 的核心功能和开发实践。

DSQL 是 AWS 在去年 re:Invent 大会上预览发布、今年早些时候正式 GA 的分布式 PostgreSQL 实现。它结合了关系型数据库的强大功能（如 JOIN、复杂查询、模式管理）与 DynamoDB 的水平扩展能力和 Lambda 的无服务器特性。DSQL 的四大核心支柱包括：几乎无限的扩展能力、高可用性、零基础设施管理和易用性。会议展示了 DSQL 集群可以在 10 秒内快速创建，无需配置实例类型、副本数量、子网等传统数据库所需的复杂参数。

演示过程中，讲师们详细介绍了如何使用 AWS CDK 管理基础设施、如何通过 IAM 认证连接 DSQL、如何在 Lambda 函数中实现数据库操作，以及如何处理 DSQL 的乐观并发控制（OCC）机制。会议特别强调了 DSQL 采用强快照隔离（Strong Snapshot Isolation）的事务模型，这是一种无锁设计，能够提供强一致性和高吞吐量，但需要应用层实现重试逻辑来处理序列化冲突（错误代码 40001）。

## 详细时间线与关键要点

### 00:00 - 会议开场与 DSQL 简介
- Mark 和 Ruka 介绍自己是 DSQL 团队的工程师
- 说明本次会议是开发者视角的代码演示，将构建一个简单的银行转账应用
- 会议将展示如何连接 DSQL、使用 CDK 管理基础设施、处理并发冲突

### 02:30 - DSQL 产品定位与特性
- DSQL 于去年 re:Invent 预览发布，今年早些时候正式 GA，目前已运行约 6 个月
- DSQL 是分布式 PostgreSQL 实现，满足客户对关系型数据库、水平扩展和无服务器的三重需求
- 四大核心支柱：几乎无限扩展、高可用性、零基础设施管理、易用性

### 04:00 - 快速创建 DSQL 集群演示
- 在控制台中演示创建集群，挑战观众数到 10 秒完成创建
- 展示创建界面的简洁性：无需选择实例类型、副本数量、子网等参数
- 只需配置集群名称、标签、加密密钥、删除保护等基本选项
- 强调这种简化设计消除了传统数据库创建时的决策负担

### 06:30 - 连接 DSQL 的两种方式
- 方式一：Web 查询编辑器（两周前发布），浏览器通过 WebSocket 直接连接 DSQL
- 方式二：Cloud Shell 集成，可在 AWS 控制台底部直接连接

### 08:00 - 项目结构介绍
- 展示 GitHub 上的 starter kit，包含两个主要文件夹：CDK 和 Lambda
- Lambda 文件夹包含请求处理函数，使用标准的 Node.js PostgreSQL 驱动
- CDK 文件夹定义基础设施，包括 Lambda 函数打包和 DSQL 集群配置

### 10:00 - IAM 认证机制详解
- DSQL 使用类似 S3 预签名 URL 的认证方式
- 通过 AWS CLI 生成临时认证令牌作为数据库密码
- 令牌包含签名、过期时间等信息，提供防篡改和时间限制特性
- 演示如何设置环境变量（PG_USER、PG_DATABASE、PG_HOST、PGPASSWORD）并连接

### 13:00 - Lambda 函数中的数据库连接
- 展示如何在 Lambda 函数中配置 PostgreSQL 连接池
- 连接池配置为最多 20 个连接（虽然 Lambda 一次只处理一个请求）
- 每次打开连接时调用 SDK 生成认证令牌，操作仅需约 20 纳秒
- 通过 CDK 将集群端点注入 Lambda 环境变量

### 16:00 - IAM 角色与数据库用户映射
- 在 DSQL 中创建数据库角色：CREATE ROLE myapp WITH LOGIN
- 使用 GRANT 语句将 IAM 角色 ARN 映射到数据库角色
- 查询系统表 aws_dsql.iam_role_mapping 验证映射关系
- 这种设计充分利用 PostgreSQL 的权限系统，支持细粒度访问控制

### 19:00 - 事务基础与 ACID 特性
- Ruka 介绍事务的重要性：确保多个操作原子性执行（全部成功或全部失败）
- 演示错误做法：不使用事务进行转账，可能导致数据不一致
- 强调 ACID 特性：
  - Atomicity（原子性）：操作要么全部成功要么全部失败
  - Consistency（一致性）：数据库从一个有效状态转换到另一个有效状态
  - Isolation（隔离性）：并发事务相互隔离
  - Durability（持久性）：提交后的数据永久保存

### 22:00 - DSQL 的隔离级别与强一致性
- DSQL 支持强快照隔离（Strong Snapshot Isolation），比 PostgreSQL 的可重复读更强
- 强一致性意味着写入后立即在所有读取位置可见，无需路由到特定端点
- 与最终一致性相对，消除了数据延迟问题

### 24:00 - 构建银行转账应用
- 创建 accounts 表，包含 id（主键）和 balance（余额）字段
- 实现转账逻辑：在事务中扣除付款方余额、增加收款方余额
- 使用 BEGIN/COMMIT 包裹事务，try/catch 处理错误
- 使用参数化查询防止 SQL 注入攻击

### 28:00 - 乐观并发控制（OCC）机制
- 观众提问：两个事务同时从同一账户取款如何处理？
- Ruka 解释 DSQL 采用乐观并发控制（OCC）而非悲观锁
- 当两个事务更新同一行时，第一个提交的事务成功，第二个收到序列化错误（40001）
- 无锁设计避免了传统数据库的行锁等待问题，支持更高吞吐量
- 应用需要实现重试逻辑，理想情况下操作应该是幂等的

### 32:00 - 实现重试逻辑
- 在事务代码外层添加 while(true) 循环
- 捕获 PostgreSQL 错误代码 40001（序列化冲突）时执行 continue 重试
- 重要：每次重试时必须从连接池获取新连接
- 添加遥测数据：记录重试次数和执行时长

### 35:00 - 并发测试与冲突处理
- 运行 1000 个并发请求，每个请求随机选择付款方和收款方进行转账
- 由于只有 1000 个账户，高并发下冲突率很高
- 展示如何统计和监控序列化错误数量
- 强调通过遥测可以量化热点和死锁情况，必要时可添加指数退避策略

### 38:00 - 观众讨论：OCC vs 悲观锁
- 观众提出：OCC 并非绝对优于传统 PostgreSQL 的悲观锁
- 在 PostgreSQL 的 Read Committed 模式下，开发者无需处理重试逻辑
- OCC 要求幂等性和重试逻辑，增加了开发者负担
- 讲师回应：这是一种权衡（trade-off），为了获得更高吞吐量而做的设计选择

### 40:00 - 连接池管理与故障恢复
- 观众提问：为什么必须在重试循环内获取新连接？
- Mark 解释：DSQL 是分布式系统，每个连接运行在不同机器上
- 当某个节点故障时，只有部分连接受影响
- 在重试时获取新连接可以自动从故障中恢复，无需手动切换端点

### 42:00 - 定价模型
- 观众提问：连接是否收费？
- 回答：连接本身免费（带星号说明，但未详细展开）

### 43:00 - 其他技术问题
- VPC 端点支持：DSQL 支持公共端点和 VPC 端点
- 资源策略：最近添加了资源基础策略支持，可限制 IP 地址、VPC 等
- MySQL 支持：目前仅支持 PostgreSQL，但 SQL 方言相对通用
- 端点策略：支持 VPC 端点策略配置

### 45:00 - 会议彩蛋
- Ruka 宣布：在 AWS 展位提到"序列化错误 40001"可获得 AWS 卫衣和 DSQL 贴纸

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


注意：本总结基于会议字幕生成，涵盖了 DSQL 的核心概念、开发实践和技术权衡。会议强调了 DSQL 作为无服务器分布式数据库的优势，同时也坦诚讨论了乐观并发控制带来的开发复杂性。