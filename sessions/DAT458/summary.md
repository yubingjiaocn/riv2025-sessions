# AWS re:Invent 2025 Valkey 技术分享会总结

## 会议概述

本次技术分享会由 AWS 产品管理总监 Joseph 和首席工程师 Madeline Olsen 主讲，重点介绍了 Amazon ElastiCache 中 Valkey 的最新技术进展。两位演讲者都在 AWS 工作超过九年，专注于数据库服务开发。

会议核心围绕 Valkey 项目的三大主题展开：性能提升、成本优化和可靠性增强。Valkey 是一个开源的 BSD 许可数据存储系统，专为高性能键值工作负载设计，如缓存、会话存储、排行榜和语义缓存等场景。该项目由 Linux 基金会支持，在 2024 年 3 月 Redis 改变许可协议后，社区从最后一个开源版本 Redis 7.2 分叉创建。短短一年半时间内，Valkey 已发布两个主要版本（8.0 和 9.0），拥有 50 多个贡献组织、150 多名代码贡献者和 10 多个托管服务提供商。

演讲重点介绍了多线程架构改进带来的 230% 性能提升，以及一系列可靠性功能，包括双通道复制、前向兼容性、集群弹性改进和内存开销优化。这些改进不仅提升了系统性能，还实现了节点版本降价 20%、无服务器版本降价 33% 的成本优化目标。

## 详细时间线与关键要点

### 00:00 - 开场介绍
- Joseph 自我介绍，担任 AWS 产品管理总监，专注 Amazon ElastiCache
- 介绍合作伙伴 Madeline Olsen，两人均来自明尼苏达州，在 AWS 共事超过九年
- 强调产品管理的核心理念：持续改进，让产品更好、更快、更便宜

### 02:30 - Valkey 项目起源
- 2009 年 Redis 以 BSD 许可发布并保持开源
- 2024 年 3 月 Redis 改变为双重许可模式
- 社区响应：从 Redis 7.2 最后开源版本分叉创建 Valkey 7.2
- 2024 年 9 月发布 Valkey 8.0
- 2025 年 3 月发布 Valkey 8.1
- 2025 年 10 月 21 日发布 Valkey 9.0

### 05:00 - Valkey 项目特点
- 多供应商治理模型，非单一厂商控制
- Linux 基金会永久托管，BSD 许可永久开源
- 50+ 组织贡献，150+ 代码贡献者
- 10+ 托管服务提供商
- 1000+ 代码提交
- 技术指导委员会由六名成员组成，包括 Madeline

### 07:00 - ElastiCache 中的 Valkey 支持
- 提供无服务器版本
- 从 Redis 7.1 升级到 Valkey 7.2（无缝零停机升级）
- 支持 Valkey 8.0、8.1、8.2，即将支持 9.0
- 持续缩短开源发布到 ElastiCache 可用的时间差

### 09:00 - 缓存工作负载挑战
- 稳态工作负载相对简单
- 峰值工作负载最具挑战性：演唱会结束后的打车服务、票务销售、游戏流行、餐饮配送高峰期
- 传统方案：预留额外容量应对峰值
- 面临选择：纵向扩展还是横向扩展

### 11:30 - 单线程架构分析
- Valkey 7.2 采用单线程架构
- 约 30% 的与会者了解这一特性
- 设计原因：在单线程上执行命令以序列化操作，避免复杂的线程间通信和竞态条件
- 事件循环分析：读取客户端命令、解析命令、执行命令、发送响应
- 火焰图显示大部分 CPU 时间用于写响应和读取客户端数据

### 14:00 - 多线程架构演进
- CPU 时钟速率提升放缓，核心密度增加
- 解决方案：将 CPU 密集型任务分离到多个 IO 线程
- 保持命令执行在主线程，IO 操作分散到多个线程
- 根据 CPU 使用率动态创建 IO 线程
- 实现更高并行度和吞吐量

### 17:00 - 性能提升成果
- **多线程架构带来 230% 性能提升**
- 示例：原需 2xlarge 实例的工作负载可降级到 xlarge
- 成本降低 50%，同时获得更大的扩展空间
- Next Door 客户案例：赞赏 Valkey 团队专注核心工程工作

### 20:00 - 无服务器架构
- 实现 100% 资源利用率
- 按请求和内存付费
- 多线程架构是无服务器实现的关键
- 架构：客户端 → NLB → 代理集群 → 缓存节点
- 数据分布在多个槽位，动态管理峰值负载
- 5 秒内从 30K 扩展到 240K 请求
- 每 2-3 分钟可将任意槽位吞吐量翻倍

### 24:00 - 定价优化
- Valkey 7.2 相比 Redis 7.1：节点版本降价 20%，无服务器降价 33%
- 从 7.2 升级到 8.0：吞吐量密集型工作负载性能提升 230%
- 无需修改应用程序即可获得性能和价格改进

### 26:00 - Madeline 接管：可靠性改进介绍
- Madeline 在 ElastiCache 工作超过十年
- 2018 年开始为 Redis 开源贡献
- 2020 年加入 Redis 核心团队
- 现为 Valkey 技术指导委员会成员

### 27:30 - 缓存可用性重要性
- 缓存故障导致更多请求发送到后端
- 后端通常延迟更高、成本更高、扩展性不足
- 语义缓存场景同样需要高可用性
- 目标：缓存可用性显著高于后端服务

### 29:00 - 可靠性关注领域
- 托管升级：版本补丁以获得性能、安全改进
- 非托管变更：节点故障时快速检测和故障转移

### 30:00 - 主从复制架构
- 单分片包含一个主节点和多个副本
- 可横向扩展至 1000 个分片
- 客户端感知拓扑，将请求路由到特定分片
- 逻辑复制：将命令发送到副本（非物理复制）

### 32:00 - N+K 升级策略
- 为每个现有节点添加两个额外节点
- 示例：从 Valkey 7.2 升级到 8.0
- 添加一个指定为未来主节点的副本
- 添加另一个副本接管其他副本职责

### 34:00 - 数据同步过程
- 第一步：对主节点进行完整快照（所有键值数据）
- 发送快照到两个新副本
- 限制主节点额外负载和持续时间
- 第二步：流式传输增量写入
- 副本同步后可开始提供数据服务

### 36:30 - 故障转移过程
- 安全转移分片所有权从旧主节点到新主节点
- 开始阻塞写入（用户感知为轻微延迟增加）
- 读取可用性不受影响
- 确保主节点和新主节点同步
- 完成后 8.0 主节点接管，处理暂停的写入

### 39:00 - 前向兼容性问题
- 完整快照不支持前向兼容
- 支持后向兼容：8.0 可接收 7.2 快照
- 不支持前向：7.2 无法接收 8.0 快照
- 问题：副本无法及时连接到新主节点时无法同步

### 41:00 - 前向兼容性解决方案
- **Valkey 9.1 将支持前向兼容性**
- 新版本可向旧版本发送降级快照
- 支持蓝绿部署和安全降级
- 7.2 版本将能与 9.1 集群保持稳定状态

### 43:00 - 双通道复制
- **Valky 8.0 引入双通道复制**
- 同时发送快照和增量写入
- 将内存压力从主节点转移到副本
- 利用现代网络卡更快的传输速度
- 旧硬件通常受网络吞吐量限制，新硬件已解决此问题

### 45:30 - 非计划故障检测
- 集群总线：所有节点定期发送 ping/pong 消息
- 消息包含：拥有的数据/分片、节点纪元（唯一标识符）
- 通过 gossip 协议快速传播信息
- 无响应表示节点故障，触发故障转移

### 47:00 - 故障转移机制
- 示例：三个分片，每个有一个主节点和一个副本
- 每个分片有唯一纪元（epoch）
- 主节点故障时，副本通过集群总线检测
- 副本向其他主节点请求接管分片

### 49:00 - 仲裁机制
- 分布式系统中的仲裁：提交决策所需的最小节点数
- 副本请求包含纪元信息
- 每个主节点每个纪元只能投票一次
- 获得仲裁后副本接管

### 51:00 - 并发故障问题
- 多个并发故障场景（如网络分区）
- 示例：四个分片，分片 2 和分片 4 同时故障
- 两个副本可能同时开始选举
- 可能各自获得部分投票，导致选举失败
- 传统解决方案：重试加抖动/退避

### 53:00 - 并发故障优化
- **Valky 8.1 改进：字典序排序机制**
- 副本按节点 ID 字典序等待
- 字典序最高的节点首先尝试选举
- 成功后下一个副本开始选举
- 大型集群（200-300 节点）故障转移时间从数分钟降至 10-15 秒

### 55:30 - 复制改进总结
- Valky 8.0：双通道复制
- Valky 8.1：更快的故障转移
- 即将推出（Valky 9.1）：前向复制兼容性

### 56:30 - 内存效率优化
- 大多数缓存工作负载受内存限制
- 内存成本高昂，需要优化

### 57:30 - 内存开销分析（Valky 7.2）
- 简单键值对开销：52 字节
- ElastiCache 元数据分析：P50 键大小 16 字节，值大小 80 字节
- 总计约 100 字节，开销占比约 33%
- 添加 TTL：额外 32 字节开销
- 集群模式：额外 16 字节开销

### 59:00 - 内存优化工作开始
- 在 Redis 7.2 分叉前就已开始
- 目标：重构数据结构以减少开销

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


注： 字幕在此处中断，未包含完整的内存优化细节和会议结尾部分。