# AWS re:Invent 2025 - DAT442: 使用 Aurora 构建弹性应用

## 会议概述

本次技术分享会由 AWS 的 Tim 和 Mark 两位专家主讲,深入探讨了如何使用 Amazon Aurora 数据库服务构建具有高可用性和灾难恢复能力的应用系统。会议分为两个主要部分:第一部分由 Tim 介绍 Aurora PostgreSQL (APG) 和 Aurora MySQL (AMS) 的弹性架构和最佳实践;第二部分由 Mark 讲解最新发布的 Aurora DSQL 引擎如何实现分布式数据库的弹性能力。

会议首先明确了弹性(Resilience)的定义,包括可用性(Availability)和灾难恢复(Disaster Recovery)两大支柱。可用性通过历史时间衡量工作负载可用的比例,而灾难恢复则关注恢复时间目标(RTO)和恢复点目标(RPO)。Aurora 通过其独特的存储架构 Grover,在三个可用区自动创建六个数据副本,实现了零 RPO 的数据持久性保证。通过添加只读副本和使用全球数据库功能,Aurora 可以在单区域和多区域场景下提供秒级故障转移能力。会议还介绍了 Aurora 的自动化维护、蓝绿部署、以及最新的组织级升级策略等企业级功能。

在会议的第二部分,Mark 详细介绍了 Aurora DSQL 这一全新的分布式 SQL 数据库引擎。DSQL 结合了关系数据库的查询能力、分布式数据库的无单点故障架构以及 Serverless 服务的按需付费模式。通过查询处理器(Query Processor)、裁决器(Adjudicator)和日志服务(Journal)的分离架构,DSQL 实现了真正的水平扩展能力和跨区域的强一致性。这种架构使得 DSQL 能够在多个可用区甚至多个区域之间提供活跃-活跃(Active-Active)的部署模式,大幅提升了应用的弹性和可用性。

## 详细时间线

### 开场与弹性定义 (00:00 - 05:30)
- **00:00** - Tim 开场致歉可能出现的音视频问题,欢迎参会者来到 DAT442 会议
- **00:30** - 互动环节:询问现场有多少人在生产环境运行数据库,以及有多少人对此感到不安
- **01:15** - 定义弹性(Resilience):工作负载从中断中恢复的能力,包括动态获取资源和缓解配置错误
- **02:00** - 介绍弹性的两大支柱:可用性(Availability)和灾难恢复(DR)
- **02:30** - 解释 RTO(恢复时间目标)和 RPO(恢复点目标)的概念
- **03:45** - 会议议程说明:第一部分讲解 Aurora PostgreSQL 和 MySQL,第二部分讲解 Aurora DSQL
- **04:30** - 介绍 Aurora 的基本特性:结合高端商业数据库的性能与开源数据库的成本效益

### 问题一:数据库节点故障 (05:30 - 15:00)
- **05:30** - 提出第一个问题:如果数据库节点失败会怎样?
- **06:00** - 对比自管理数据库的单节点架构:存储和引擎在同一节点,故障影响大
- **07:00** - 介绍 Aurora 存储架构 Grover:多租户存储集群,跨三个可用区创建六个副本
- **08:15** - 强调 Aurora 的关键优势:可以承受一个完整可用区加一个存储节点的故障,RPO 为零
- **09:30** - 深入解析 Aurora 的数据存储机制:只写入日志记录,不写入页面,存储层负责应用日志
- **11:00** - 介绍备份和恢复功能:存储引擎持续自动备份到 S3,不影响主节点性能
- **12:00** - 演示时间点恢复(PITR):可以恢复到 35 天内的任意时间点,最新可恢复时间约为 5 分钟前
- **13:30** - 讲解数据库实例可用性:通过添加备用副本实现快速故障转移,RTO 约 30 秒
- **14:30** - 总结多可用区(Multi-AZ)可用性模式的优势

### 问题二:性能弹性 (15:00 - 22:00)
- **15:00** - 提出第二个问题:如何应对性能波动?
- **15:30** - 对比开源数据库的扩展方式:纵向扩展(购买硬件)和横向扩展(应用层分片)
- **16:30** - 介绍 Aurora 的读副本功能:可添加最多 15 个副本,每个最大可达 48xlarge(1.5TB 内存)
- **17:45** - 强调副本的隔离性:不同工作负载可使用不同副本,避免"吵闹邻居"问题
- **18:30** - 说明存储自动扩展:容量和性能都自动扩展,无需手动配置
- **19:15** - 介绍实例扩展选项:可添加不同大小的实例,包括 Serverless 实例
- **20:00** - 解释故障转移层级(Failover Tiers):通过层级编号控制故障转移顺序
- **21:00** - 介绍 Serverless 实例:可从零扩展到 256 个 Aurora 容量单位,实现成本优化

### 问题三:连接管理 (22:00 - 28:00)
- **22:00** - 提出连接管理挑战:如何知道连接到哪个实例,如何避免过多空闲连接
- **22:45** - 介绍连接池和限制技术:按实例大小限制连接数,避免重连
- **23:30** - 讲解 Aurora 端点(Endpoints):写入端点始终指向当前写入节点,读取端点使用 DNS 轮询指向副本池
- **25:00** - 介绍自定义端点:可将特定副本分组为分析端点等
- **25:45** - 重点介绍 AWS 高级包装驱动程序(Advanced Wrapper Drivers):深入了解集群状态,快速处理故障转移
- **26:30** - 说明驱动程序插件:增强故障转移、读写分离、蓝绿部署等功能
- **27:15** - 强调使用高级驱动程序的优势:将故障转移时间降至约 6 秒
- **27:45** - 展示 GitHub 项目 QR 码:所有驱动程序都是开源的

### 问题四:多区域灾难恢复 (28:00 - 35:00)
- **28:00** - 提出第四个问题:如果整个区域失败怎么办?
- **28:30** - 介绍 Aurora 全球数据库(Global Database):可添加最多 10 个次要区域
- **29:15** - 解释全球数据库架构:复制代理处理区域间的异步物理复制,不影响主节点性能
- **30:30** - 说明 RPO 约为 1 秒(取决于区域对选择),受光速限制
- **31:15** - 讲解次要区域的只读副本:可在本地进行低延迟读取
- **32:00** - 介绍全球端点:自动指向当前主区域
- **32:45** - 演示强制故障转移:需要设置"允许数据丢失"标志,因为是异步复制
- **33:30** - 详细解释计划切换(Switchover):在两个区域都健康时进行,通过日志记录标记实现零 RPO
- **34:30** - 总结全球数据库优势:RTO 约 30 秒,RPO 为零(计划切换时)

### 问题五:维护和升级 (35:00 - 42:00)
- **35:00** - 提出第五个问题:如何处理维护和版本升级?
- **35:30** - 对比自管理数据库的挑战:需要停机窗口、快照、兼容性测试、性能测试
- **36:45** - 介绍 Aurora 的全托管升级体验:自动化的次要版本和补丁升级
- **37:30** - 展示控制台中的维护操作:可定义维护窗口,选择自动维护
- **38:15** - 重点介绍 AWS Organizations 升级推出策略:基于标签管理整个数据库集群的升级
- **39:00** - 演示策略配置:开发环境先升级,生产环境最后升级
- **40:00** - 解释升级波次:在不同波次之间等待,发现问题可及时停止
- **40:45** - 介绍就地主要版本升级:使用快速克隆进行测试,然后升级生产环境
- **41:30** - 详细讲解蓝绿部署:使用逻辑复制保持同步,切换时间约 1 分钟

### Aurora DSQL 介绍 (42:00 - 52:00)
- **42:00** - Mark 接手演讲,开始介绍 Aurora DSQL
- **42:30** - 说明 DSQL 的设计目标:结合关系数据库、分布式架构和 Serverless 的优势
- **43:15** - 对比自管理 PostgreSQL 架构:后端进程、查询执行、本地存储
- **44:30** - 介绍 DSQL 架构的三个核心组件:查询处理器(Query Processor)、裁决器(Adjudicator)、日志服务(Journal)
- **45:45** - 解释查询处理器:每个连接一个 QP,处理读写操作
- **46:30** - 说明写入流程:在内存中缓冲更改,提交时发送到裁决器
- **47:45** - 讲解裁决器的作用:并发控制和冲突检测
- **48:30** - 介绍日志服务:作为 AWS 关键服务的骨干,持久化已提交事务
- **49:15** - 说明存储引擎:从日志服务读取并应用更改
- **50:00** - 强调 DSQL 的分布式特性:所有组件都是分布式的,无单点故障
- **51:00** - 对比传统数据库:DSQL 的每个组件都可以独立扩展

### DSQL 弹性特性详解 (52:00 - 结束)
- **52:00** - 回顾第一个问题在 DSQL 中的答案:节点故障时的处理
- **52:30** - 说明 DSQL 的多可用区部署:查询处理器、裁决器、日志服务都跨多个可用区
- **53:15** - 解释自动故障转移:客户端自动重连到健康的查询处理器
- **54:00** - 介绍 DSQL 的性能扩展:通过添加更多查询处理器实现水平扩展
- **54:45** - 说明 Serverless 特性:按实际使用的计算和存储付费
- **55:30** - 讲解多区域部署:DSQL 支持跨区域的活跃-活跃配置
- **56:15** - 强调强一致性:即使在多区域部署中也保证 ACID 事务
- **57:00** - 总结 DSQL 的维护优势:作为完全托管服务,自动处理所有维护任务
- **57:45** - 会议总结:回顾 Aurora 家族(APG、AMS、DSQL)的弹性能力
- **58:30** - 提醒参会者参加周四的 Chalk Talk 424 进行更深入讨论
- **59:00** - 会议结束,感谢参会者