# AWS re:Invent 2025 - Amazon GuardDuty 运行时监控威胁检测会议总结

## 会议概述

本次技术分享由 Amazon GuardDuty 首席安全工程师 Mouhammad 主讲，重点介绍了 GuardDuty 运行时监控的威胁检测能力。GuardDuty 是 AWS 的威胁检测服务，通过监控 CloudTrail 日志、VPC 流日志等多种日志源，并应用机器学习和检测规则来实时发现威胁。GuardDuty 运行时监控是一个可选的解决方案，通过在 EC2 实例等计算工作负载上部署 eBPF 代理，收集操作系统级别的事件并发送到 GuardDuty 后端进行监控和威胁检测。

演讲者强调了使用真实攻击场景测试运行时监控的重要性。许多客户使用过于简单的测试方法（如创建 cron 任务）来测试持久化检测，但这些测试既不真实，也无法评估运行时监控解决方案的噪音管理能力。为了帮助客户进行更有效的测试，AWS 在 Amazon GuardDuty Tester GitHub 仓库中添加了多个基于真实攻击场景的测试用例。

会议详细介绍了 GuardDuty 如何从实际客户事件、AWS 客户事件响应团队（AWSert）以及威胁情报源收集真实攻击信息。数据显示，针对 AWS 客户的两大初始访问技术是凭证泄露和面向公众的应用程序入侵。演讲者通过一个 PHP Web 应用程序入侵的实际演示，展示了如何使用 GuardDuty Tester 在 EKS 集群上部署漏洞应用并执行攻击，最终 GuardDuty 成功检测到多个高严重性发现，包括可疑命令执行、网络侦察工具使用、加密货币挖矿以及攻击序列综合发现。

## 详细时间线

00:00 - 开场介绍
- 演讲者 Mouhammad 自我介绍，担任 Amazon GuardDuty 首席安全工程师
- 过去三年专注于 GuardDuty 运行时监控的研究和开发

01:30 - GuardDuty 服务介绍
- GuardDuty 是威胁检测服务，监控 CloudTrail 日志、VPC 流日志等多种日志源
- 应用机器学习和检测规则实时发现威胁

02:15 - GuardDuty 运行时监控说明
- 可选的运行时监控解决方案
- 在 EC2 实例等 AWS 计算工作负载上部署 eBPF 代理
- 收集操作系统级别事件并发送到 GuardDuty 后端

03:00 - 为什么需要测试运行时监控
- 评估服务是否满足需求
- 测试事件响应能力
- 建立健壮的事件响应流程

04:00 - 简单测试的问题
- 许多客户使用过于简单的测试（如创建 cron 任务测试持久化）
- 两个主要问题：不真实、无法评估噪音管理能力
- 这些操作在正常活动中也很常见

06:00 - GuardDuty 如何收集真实攻击信息
- 第一来源：实际客户事件
- AWS 客户事件响应团队（AWSert）帮助客户应对安全事件
- 从客户互动中收集攻击战术和技术信息

07:30 - 最常见的初始访问技术
- 凭证泄露：攻击者获取 AWS 或 IAM 凭证访问账户
- 面向公众的应用程序入侵：利用漏洞获取底层计算资源访问权限
- 这两种技术占 AWS 客户遭受攻击的绝大多数

09:00 - 威胁情报来源
- 使用内部和第三方威胁情报源
- 学习入侵指标（IP 地址、域名、文件哈希）
- 了解攻击中使用的战术、技术和活动模式
- 获取攻击的上下文信息

10:30 - Web 应用程序入侵场景示例
- 攻击者利用 Web 应用漏洞部署 Web Shell
- 通过 Web Shell 执行操作系统命令
- 下载并执行脚本恶意软件
- 下载第二阶段恶意软件（加密货币挖矿或 DDoS）
- 使用 chmod 命令使恶意软件可执行
- 执行恶意软件并通过 cron 任务实现持久化

13:00 - 攻击模式分析
- 所有活动映射到特定的 MITRE 战术和技术
- 学习特定模式：使用 curl 从基于 IP 的 URL 下载脚本并通过管道传递给 shell
- cron 任务创建模式：将指令写入临时文件并使用 crontab 命令加载
- 了解攻击上下文：所有操作源自面向网络的应用程序并遵循特定序列

15:00 - Amazon GuardDuty Tester 介绍
- 公开的 GitHub 仓库
- 允许测试各种 GuardDuty 发现
- 提供易于使用的说明设置安全测试环境

16:00 - 设置测试环境
- 在 AWS 账户中创建锁定的 VPC
- 部署 EC2 实例、ECS 集群和 EKS 集群等资源

17:00 - 启用 GuardDuty 运行时监控
- 打开 GuardDuty 控制台
- 点击运行时监控链接
- 确保启用运行时监控
- 启用 AWS Fargate 和 Amazon EC2 的代理管理

19:00 - 执行测试场景
- 两步过程：部署漏洞 PHP 应用程序，然后执行攻击
- 使用 SSM Session Manager 连接到驱动实例
- 设置 AWS CLI 和区域配置

21:00 - 部署 PHP Web 应用程序
- 进入 runtime_scenarios/php_webshell 目录
- 执行 deploy_php 脚本
- 创建 ECR 仓库并加载 PHP Apache 容器镜像
- 在 EKS 集群上创建 Pod
- 设置命令和控制服务器模拟 C2 通信

24:00 - 执行攻击脚本
- 运行 attack 脚本
- 获取 PHP Web 应用程序的 IP 地址
- 访问 index.php 并利用漏洞部署 Web Shell
- 通过 Web Shell 执行各种命令
- 执行发现命令
- 下载并执行恶意软件

26:00 - 查看 GuardDuty 发现
- 打开 GuardDuty 控制台查看发现
- 生成多个发现结果

26:30 - 可疑命令发现
- 高严重性可疑命令发现
- 进程谱系显示父进程为 Apache2，确认源自 PHP Web 应用程序

27:30 - 可疑工具发现
- 检测到 nmap 网络侦察工具的执行
- 进程名称为 nmap

28:00 - 加密货币挖矿发现
- 检测到加密货币挖矿程序执行
- 进程谱系显示祖父进程为 Apache2，确认源自 PHP Web 应用程序

29:00 - 攻击序列发现
- 聚合或复合发现
- 提供攻击场景中检测到的所有战术、技术和信号的综合视图

30:00 - 关键要点总结
- 了解 GuardDuty 如何收集真实攻击信息
- 如何优先考虑和实施威胁检测
- 如何使用真实攻击场景测试 GuardDuty 运行时监控
- Amazon GuardDuty Tester GitHub 仓库中添加了多个真实场景
- 将继续添加更多场景

31:00 - 会议结束
- 感谢参会者