# AWS re:Invent 2025 技术会议总结

## 会议概述

本次会议由 DraftKings 的资深软件架构师 Joel Miller 主讲,重点介绍了 DraftKings 如何基于 Amazon Aurora MySQL 构建其金融账本系统,以支持每分钟百万级的金融操作。DraftKings 是一家体育娱乐和游戏公司,主要运营在线体育博彩业务,同时涉及 iGaming、梦幻体育和彩票等多个垂直领域,在北美多个美国州和加拿大省份提供服务,每月拥有数百万付费客户。

为了在体育赛事的速度下运营,DraftKings 必须应对极端的流量峰值。在 NFL 比赛日等重大体育赛事期间,系统面临四大规模挑战:赛前存款流量激增、下注交易量暴增、比赛中因关键比赛时刻导致的读取流量锯齿状波动,以及赛后结算时高达 30 倍的交易量峰值。这些挑战要求账本系统必须在一分钟内处理海量的并发操作,同时保证数据的准确性和低延迟响应。

通过采用 Amazon Aurora MySQL 的分片架构、读写分离策略和自动故障转移机制,DraftKings 成功构建了一个高性能、高可用的金融账本系统。该系统不仅实现了线性扩展能力,还带来了成本降低和数据仓库性能提升等附加收益。演讲者强调了性能分析、存储过程优化和命令查询分离(CQRS)等关键技术实践的重要性。

## 详细时间线

00:00 - 00:30 - 开场介绍  
演讲者 Joel Miller 自我介绍,提出核心问题:如何在一分钟内运行百万次金融操作?介绍将分享 DraftKings 如何基于 Amazon Aurora MySQL 构建金融账本系统。

00:30 - 01:30 - DraftKings 公司背景  
介绍 DraftKings 是体育娱乐和游戏公司,主要业务包括在线体育博彩、iGaming、梦幻体育和彩票。产品覆盖北美多个地区,每月拥有数百万付费客户。强调必须"以体育的速度运营"。

01:30 - 02:30 - 体育速度的定义  
解释虽然比赛可能持续数小时,但关键比赛时刻(如拦截、双杀、绝杀球)发生在瞬间,这些时刻对体育有巨大影响并驱动客户参与度,当球迷参与时客户就会涌入 DraftKings 平台。

02:30 - 04:00 - NFL 比赛日的规模挑战(第一部分:存款)  
展示 NFL 比赛日早场比赛前的存款量图表。随着比赛开始时间临近,交易量急剧上升。客户将资金存入账户,系统需要与支付提供商合作,所有操作最终都要写入账本,更新余额和记录交易。

04:00 - 05:30 - 规模挑战(第二部分:借记交易)  
展示比赛开始前的借记流量图表,与存款流量高度相关。客户存款后立即想要使用资金进行投注或参加梦幻比赛。从账本角度看,当存款繁忙时借记也繁忙,问题被复合放大。

05:30 - 07:30 - 规模挑战(第三部分:比赛中读取流量)  
展示比赛中的锯齿状读取流量模式。关键比赛时刻驱动客户访问平台,每次客户打开应用都需要加载余额信息。当热门四分卫向热门接球手传出达阵球时,全国各地的用户同时打开梦幻应用查看比分和投注状态。

07:30 - 09:00 - 规模挑战(第四部分:赛后结算峰值)  
展示赛后最大的峰值问题。比赛结束、统计数据确定后,所有体育相关系统同时想要支付奖金。业务指标要求在结果确定后尽快将资金返还到客户钱包。体育博彩和梦幻体育的支付时间略有不同,但任一垂直领域开始支付时,后台交易量会增加约 30 倍。

09:00 - 11:00 - 系统架构概览  
展示架构图:左侧是运行在 Kubernetes(主要是 EKS)上的业务服务,向中心的账本服务发送同步借记流量。账本服务也运行在 EKS 上,从顶部接收来自支付服务的异步支付指令(通过消息代理)。底部是客户的余额查询流量。

11:00 - 13:00 - Aurora MySQL 的核心作用  
强调架构图右侧的关键部分:账本数据存储在 Amazon Aurora MySQL 上。每个集群都有读取副本,为了处理大规模读取流量,必须释放写入节点专注于写入操作,将读取流量导向读取副本。Aurora MySQL 可以轻松扩展到约 15 个读取副本。

13:00 - 15:30 - 分片策略  
解释为何架构图显示多个账本实例。单个 Aurora 集群效果很好,但随着业务增长,决定对账本进行分片。通过对用户标识符进行一致性哈希,将用户分配到不同集群以分布式方式支持流量。有时选择垂直扩展集群规模,但到达边缘时垂直扩展不再带来线性吞吐量增长,更多写入节点才能带来线性吞吐量增长。

15:30 - 17:00 - 分片的附加收益  
分片带来两个意外收益:1) 成本降低 - 运行多个 4XL 实例比单个 24XL 实例更便宜,考虑到读取副本时成本节省更明显;2) 数据仓库性能提升 - DraftKings 所有数据都需要入仓用于分析和验证,数据仓库通过 CDC 从 Aurora MySQL 复制数据,分片后有五个 binlog 而非一个,可以并行化数据摄取,仓库速度显著提升。

17:00 - 19:30 - Aurora MySQL 的优势  
总结 Aurora MySQL 的关键优势:1) 快速扩展能力 - 可以快速扩展读取副本,新副本启动快速且因底层存储机制已同步数据;2) 极低延迟 - 读取副本延迟通常低于 15 毫秒,比测试过的其他技术好一个数量级,客户存款后立即查看余额时数据已经可用;3) 托管服务优势 - 无需处理操作系统补丁,存储自动扩展,包括自动故障转移。

19:30 - 21:00 - 自动故障转移的价值  
强调硬件故障不可避免,只能做出反应。之前使用其他产品时,故障恢复需要数分钟,提升读取副本会导致明显的服务中断。Aurora MySQL 的自动故障转移使这一过程无缝化,虽然不能说完全察觉不到,但比手动操作快得多。

21:00 - 23:00 - 优化经验(第一部分:性能分析)  
分享优化经验:达到每分钟百万次操作涉及数据和测试。首先要知道什么慢,慢的部分可能影响吞吐量。性能分析是关键,不仅要知道存储过程慢,还要知道为什么慢才能修复。Performance Insights(现在是 CloudWatch Database Insights)对于查看存储过程内部、识别耗时操作(锁定、未使用索引、表扫描、数据设置不当)非常宝贵。

23:00 - 25:00 - 优化经验(第二部分:存储过程返回数据)  
分享一个意外的优化发现:从存储过程获取数据有多种方式,某些方式优于其他方式。通常在存储过程末尾执行 SELECT 以表格格式返回数据,这实际上显著降低了吞吐量。相比之下,使用输出参数返回标量数据性能更好。这可能与临时表使用有关。关键建议:如果存储过程返回标量数据,使用输出参数,吞吐量会大幅提升。

25:00 - 27:00 - 优化经验(第三部分:命令查询分离)  
强调最重要的一点:命令查询分离(CQRS)。需要将读取与写入分离,特别是在 Aurora MySQL 上可以轻松启动读取副本的情况下。系统需要知道何时进行只读查询、何时修改数据。将只读查询导向读取副本后,就不会因 CPU 容量或奇怪的锁而拖累写入节点。如果问题发生在读取副本而非写入节点上,影响极小。如果只记住一点,那就是:分离读写以处理规模。

27:00 - 27:30 - 结束语  
演讲者表示愿意会后回答问题,感谢听众的时间。