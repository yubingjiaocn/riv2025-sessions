# Apache Iceberg V3 及未来发展技术分享总结

## 会议概述

本次技术分享由AWS产品经理Ron Ortloff和首席软件工程师Yuri Zerubin主讲,重点介绍Apache Iceberg V3规范的新特性及V4的发展方向。这是一场聚焦开源技术的专题会议,主要讨论Iceberg规范本身的演进,而非AWS服务的具体实现。

Apache Iceberg项目起源于2017年Netflix,由Dan Weekes、Ryan Blue和Jason Reid等人发起。2018年进入Apache软件基金会孵化器,2020年成为顶级项目,2021年发布V2规范(引入行级删除的merge-on-read能力),2025年5月正式批准V3规范。需要注意的是,规范的批准与实际功能的实现存在时间差,V3的各项特性正在从1.7到1.10版本中逐步落地,目前尚未100%完整实现。

会议重点介绍了V3规范中最受客户关注的三大核心特性:Variant数据类型(用于半结构化数据处理)、删除向量(Deletion Vectors,优化写入和存储)以及行血缘(Row Lineage,变更跟踪)。这些特性显著提升了Iceberg在处理复杂数据场景时的性能和灵活性,为实时分析、数据管道和合规性需求提供了强大支持。

## 详细时间线与关键要点

### 项目历史与背景 (00:00 - 03:30)
- **00:00** - 会议开场,介绍主讲人Ron Ortloff(AWS产品经理)和Yuri Zerubin(AWS首席软件工程师)
- **00:30** - 说明这是开源技术专场,聚焦Apache Iceberg规范本身,而非AWS服务实现
- **01:00** - 会议议程:V3三大核心特性、其他附加功能、V4前瞻、行动建议
- **01:30** - Apache Iceberg项目历史回顾:
  - 2017年:Netflix启动项目
  - 2018年:进入Apache孵化器
  - 2020年:成为Apache顶级项目
  - 2021年:V2规范发布(引入merge-on-read)
  - 2025年5月:V3规范正式批准

### 规范与发布机制说明 (03:30 - 05:00)
- **03:30** - 解释Apache项目中"规范"(Specification)与"发布"(Release)的区别
- **04:00** - 规范是合约文档,需PMC投票批准;发布是具体实现,经过正式软件发布流程
- **04:30** - 重要提示:V3规范虽已批准,但从1.7到1.10版本仍在逐步实现各项特性,尚未100%完成
- **04:50** - 现场调查:使用Iceberg的举手(多数),已创建V3表的举手(仅一人)

### 核心特性一:Variant数据类型 (05:00 - 15:30)
- **05:00** - 数据类型分类:原始类型(int、string等)、结构化类型(list、map等,固定schema)、半结构化类型(Variant,灵活schema)
- **05:45** - Variant规范三大组件:
  - 元数据(支持文件剪枝)
  - 编码(为值分配数据类型)
  - 分解(Shredding,将元素提取为隐藏列)

- **06:30** - V2时代处理半结构化数据的痛点:
  - 强制转换为结构化类型(需转换成本,性能较差)
  - 物化额外列(转换成本高,但性能好)
  - 存储为字符串(灵活但性能极差)

- **07:30** - Variant典型应用场景:
  - **IoT工作负载**:事件数据schema多变,适合读时应用schema
  - **数据管道**:供应商数据格式不统一,用"impossible fields"列存储非标准数据
  - **实时分析**:金融科技报价分析,无时间做预处理

- **09:00** - Variant核心优势:
  - 性能与成本:列式存储、统计信息、谓词下推
  - 灵活schema:自动schema演进
  - 高效存储:自动压缩
  - 便捷查询:点号导航语法

- **10:00** - Shredding机制详解(演讲者最喜欢的幻灯片):
  - 示例:表有event_date、source_id、event_details(variant)三列
  - 数据加载时,variant字段通过"shredder"处理
  - 自动生成隐藏子列:sku(integer)、account_id(integer)、price(decimal)
  - 查询时可直接使用点号访问:event_details.account_id

- **12:30** - 性能对比:
  - Variant作为基准(1x)
  - 结构化类型:慢4倍
  - 字符串解析:慢10倍以上(全表扫描场景可能更差)

### 核心特性二:删除向量 (15:30 - 23:00)
- **15:30** - 写入模式对比:
  - **Copy-on-Write**(默认):删除时重写整个数据文件,写放大严重
  - **Merge-on-Read**(V2引入):只写删除文件,写入快但读取需合并

- **16:30** - V2删除类型:
  - **等值删除**(Equality Deletes):写入删除条件(如user_id='ABC'),适合流式工作负载(Flink)
  - **位置删除**(Positional Deletes):写入删除位置,V3中已被删除向量取代

- **17:30** - 删除向量应用场景:
  - **GDPR合规**:随机删除个人数据,写放大严重
  - **数据清理**:Medallion架构中Bronze层的噪声数据清理
  - **增量数据管道**:Merge语句中的随机写入操作

- **19:00** - 删除向量工作机制:
  - 删除查询时更新位图(bitmap)
  - 位图持久化为Puffin文件
  - 读取时用位图过滤结果集
  - 单个S3事务中提交数据文件和位图

- **21:00** - V2位置删除 vs V3删除向量:
  - V2问题:删除文件泛滥(无规范指导)、需要位图与Parquet互转
  - V3改进:每个快照只允许一个删除文件、位图直接存储在Puffin文件、写入器维护位图

### 核心特性三:行血缘 (23:00 - 30:00)
- **23:00** - 行血缘三大组件:
  - **写入器规范**:必须生成记录级变更信息
  - **读取器支持**:新增隐藏列(row_id和sequence_number)
  - **操作特性**:默认启用,无法关闭

- **24:00** - 附加优势:状态信息存储在记录上,时间旅行查询时自动获得对应时刻的行血缘信息

- **24:30** - 应用场景:
  - **增量处理**:用sequence_number追踪变更,作为数据管道输入
  - **事件生命周期跟踪**:订单状态变更(提交→处理→发货→送达)
  - **缓慢变化维度**(SCD Type 2)
  - **调试**:追溯计算来源
  - **合规性**:审计数据修改历史(如工资变更)

- **26:00** - 工作示例:
  - 初始加载:两行数据,row_id和sequence_number均为1
  - 更新操作:Diego改为Pablo,sequence_number增至2
  - Merge操作:新增记录+更新记录,两者sequence_number均为3(新记录从当前序列号开始)

- **28:00** - 增量查询示例:
 sql
  SELECT * FROM table 
  WHERE sequence_number > last_processed_sequence
  
  - 追踪最大sequence_number,每次只获取增量变更

- **29:00** - 行血缘 vs V2变更日志(Changelog):
  - V2变更日志:快照差异对比,需计算成本,需维护视图,多快照关联复杂
  - V3行血缘:信息直接存储在记录上,零配置,自动维护,轻松追踪完整生命周期

### 其他V3特性 (30:00 - 34:00)
- **30:00** - 核心基础设施特性:

 30:30 - 默认值(Default Values):
  - 未指定值时自动插入默认值
  - 默认值存储在元数据中(非文件中)
  - 读取时用元数据替换缺失值
  - 确保数据一致性,避免开发者自定义默认值混乱

 31:30 - 表加密密钥(Table Encryption Keys):
  - 表级和元数据级加密密钥
  - 细粒度控制
  - 支持KMS集成
  - 支持密钥轮换
  - 满足高级安全合规要求

 32:30 - 多参数转换(Multi-argument Transformations):
  - 分区或排序时可指定多个字段
  - 避免数据倾斜
  - 更好地匹配查询模式
  - 性能优化特性

### V3附加数据类型 (34:00 - 结束)
- **34:00** - 除Variant外,V3还引入其他新数据类型(演讲在此处字幕截断,未详细展开)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


注:本总结基于提供的字幕文本,涵盖了会议的主要内容。字幕在讨论"附加数据类型"部分时截断,Yuri关于V4前瞻的内容未包含在提供的文本中。