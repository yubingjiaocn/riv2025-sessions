# AWS re:Invent 2025 Step Functions 可观测性会议总结

## 会议概述

本次技术会议由 AWS 无服务器首席专家 Pavan 和 AWS Step Functions 团队首席工程师 Diego 主讲,重点介绍了如何使用 AWS Step Functions 构建大规模数据处理工作流,以及如何通过可观测性工具监控和调试分布式工作流。

会议通过四个实际演示案例,展示了 Step Functions 的分布式映射(Distributed Map)功能如何处理大规模数据集。演示使用了一个包含全球风速数据的开源数据集,该数据集包含约 60 万个对象,总大小约 70GB。通过分布式映射功能,整个数据处理流程在约 2 分 15 秒内完成,展示了 Step Functions 在处理大规模并发任务时的强大能力。

会议还深入讨论了 Step Functions 的关键可观测性指标,特别是新推出的 Map Run 指标和状态转换(State Transition)限制监控。这些工具帮助开发者识别性能瓶颈、监控并发限制,以及诊断跨账户调用中的异步问题。演讲者强调了设置 CloudWatch 告警和仪表板的最佳实践,以便及时发现和解决生产环境中的问题。

## 详细时间线与关键要点

### 00:00 - 会议开场与介绍
- Pavan(AWS 无服务器首席专家)和 Diego(AWS Step Functions 首席工程师)介绍会议主题
- 现场调查:大部分观众已在生产环境中使用 Step Functions
- 会议议程:从基础构建开始,逐步深入可观测性和调试技巧

### 02:30 - 演示案例 1:风速数据分析
- 使用开源全球风速数据集(按年份和站点 ID 分区)
- 数据集规模:约 60 万个对象,70GB 数据
- 目标:构建可视化仪表板显示全球各站点的平均风速

### 05:00 - 创建 Step Functions 工作流
- 在控制台创建名为"wind speed analysis"的标准工作流
- 使用拖放界面配置分布式映射(Distributed Map)状态
- 分布式映射适用于处理 S3 中数百万级对象的场景

### 07:15 - 配置分布式映射参数
- 数据源:S3 对象列表
- 批处理:每批 500 个对象(提高处理效率)
- 并发限制:1000(默认值,最高可达 10,000)
- 容错阈值:5%(超过此失败率则整个工作流失败)
- 输出位置:指定 S3 存储桶

### 10:00 - 配置业务逻辑
- 添加 Lambda 函数进行数据分析(Map 阶段)
- 添加 Reducer Lambda 函数整合结果
- 添加单位转换 Lambda(将风速从节转换为英里/小时)
- 注意:可使用 JSONata 表达式替代 Lambda 进行简单计算

### 12:30 - 执行工作流
- 控制台自动生成所需 IAM 权限和策略
- 启动执行后,可实时查看 Map Run 状态
- Pending 状态:分布式映射正在读取和准备 S3 对象列表
- 监控执行时长和处理进度

### 14:00 - Diego 解释分布式映射机制
- 每次迭代成为独立的工作流执行
- 避免单一执行的历史记录限制
- 异步调度执行,实现高度并行化
- 跟踪失败数量,根据容错阈值决定是否中止

### 16:15 - 执行完成
- 总执行时间:约 2 分 15 秒(处理 60 万个对象)
- 每批处理 500 个项目
- 结果输出到 S3,可用于 QuickSight 可视化
- 失败项目会生成单独文件,支持重新处理

### 18:00 - 新推出的 Map Run 可观测性指标
- Open Map Run Limit:账户级别的并发 Map Run 限制
- Approximate Open Map Run Count:当前运行的 Map Run 数量
- Map Run Backlog Size:等待执行的积压数量
- 这些指标帮助识别何时达到并发限制

### 20:30 - 演示 Map Run 限制监控
- 使用负载测试 Lambda 模拟高并发场景
- CloudWatch 仪表板显示实时指标
- 当超过限制时,Backlog Size 开始增长
- Step Functions 不会失败,而是调度到未来执行

### 23:00 - 最佳实践建议
- 为 Backlog Size 设置 CloudWatch 告警
- 通过 Service Quotas 请求提高限制
- Backlog 指标仅在存在积压时发布
- 可识别同账户中其他团队消耗限制的情况

### 25:30 - 状态转换(State Transition)概念
- 状态转换包括:执行开始、完成、节点间转换、Map 迭代启动
- 默认限制:大区域 5000/秒,小区域 800/秒(软限制)
- 这是账户级别的共享限制
- 使用令牌桶算法:每秒补充,每次转换消耗一个令牌

### 28:00 - 状态转换限流机制
- 超过限制时不会失败,而是延迟执行
- 使用指数退避:1 秒、2 秒、4 秒、8 秒...
- 可能导致执行看起来"卡住"30 秒或更长时间
- 需要通过指标识别是否受限流影响

### 30:15 - 演示状态转换监控
- 创建包含嵌套循环的状态机模拟高转换率
- CloudWatch 仪表板监控关键指标:
  - Bucket Size(最大统计)
  - Refill Rate(最大统计)
  - Consumed Capacity(求和聚合,按分钟)
  - Throttle Events

### 32:00 - 指标解读注意事项
- CloudWatch 指标按分钟发布,但限制是按秒计算
- 显示的是一分钟内所有秒的平均值
- 可能出现某秒被限流但分钟平均值未超限的情况

### 34:00 - 识别问题状态机
- 添加"Execution Throttled"指标
- 按状态机名称分组查看
- 快速识别哪个状态机导致限流
- 演示中"state transition"状态机是主要贡献者

### 36:30 - 跨账户调用场景介绍
- 中心账户:包含产品评论分析工作流(调用 Bedrock API 检测虚假评论)
- 其他团队账户:通过跨账户调用复用中心工作流
- 使用 .sync 方法进行同步调用

### 38:00 - 跨账户 IAM 配置
- 父账户角色需要 sts:AssumeRole 权限
- 子账户角色需要信任父账户的 Principal
- 使用条件属性防止混淆代理(Confused Deputy)问题
- 指定特定账户和状态机 ARN

### 40:30 - 跨账户调用机制(Diego 详解)
- 使用角色链(Role Chaining)实现
- 父账户执行角色假定子账户目标角色
- 使用假定的凭证进行 API 调用
- 适用于所有 AWS 服务集成,不仅限于 Step Functions

### 42:00 - 跨账户调用的可观测性挑战
- 同账户:Step Functions 使用 EventBridge 托管规则自动监听子执行完成
- 跨账户:无法直接读取其他账户的事件
- 解决方案:父执行通过轮询(Polling)检查子执行状态
- 异步过程可能导致父执行看似"等待"状态

### 44:00 - 问答环节
- Lambda 并发限制:可通过 Service Quotas 提高软限制
- 状态转换限制:大区域 5000/秒,可根据用例申请提高
- 限制是账户级别,所有状态机共享
- 建议使用仪表板按状态机过滤,识别消耗最多的工作流

### 46:00 - 会议总结与资源分享
- 所有演示代码将在会后分享
- 强调设置监控和告警的重要性
- 鼓励根据实际需求申请限制提升
- Step Functions 的容错设计:限流时延迟而非失败