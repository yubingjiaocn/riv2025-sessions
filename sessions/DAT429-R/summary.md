# AWS re:Invent 2025 会议总结：为 Amazon Aurora 编写 MCP 服务器

## 会议概述

本次会议是一场代码实操演示（Code Talk），由 Jim 和 Vlad 两位讲师主讲，主题是如何为 Amazon Aurora PostgreSQL 构建模型上下文协议（MCP）服务器。这是一场互动性很强的编程演示会议，讲师现场编写代码，鼓励观众参与并提出问题。

会议的核心内容是演示如何使用 MCP（Model Context Protocol）这一开放协议将后端数据库安全地暴露给大语言模型（LLM）。讲师选择了一个实际应用场景：构建一个娱乐信息中心应用，使用 IMDb 数据集，通过 Streamlit 前端、Amazon Bedrock 作为 LLM 服务、以及 Aurora PostgreSQL 作为数据库。整个演示过程展示了从编写 SQL 查询、创建 MCP 工具、到实现行级安全（Row-Level Security）的完整开发流程。

会议特别强调了"预定义查询模式"（Canned Query Pattern）的重要性。与让 LLM 动态生成 SQL 查询不同，这种方法将经过优化的查询封装成工具，既提高了性能、降低了延迟和成本，又增强了安全性。讲师还深入讨论了如何使用 PostgreSQL 的行级安全特性来确保不同用户只能访问其被授权的数据，这对于将数据库暴露给 AI 应用至关重要。

## 详细时间线与关键要点

### 开场介绍（开始）
- **讲师介绍**：Jim 和 Vlad 介绍自己，说明这是一场代码实操会议
- **会议形式**：鼓励观众互动，发现错误可以随时指出，类似结对编程
- **工具说明**：将使用 Cursor（Kiro）来辅助编码，减少打字错误

### MCP 协议介绍
- **MCP 定义**：模型上下文协议是一个通用框架，用于将后端数据暴露给 LLM 和生成式 AI
- **协议状态**：MCP 规范发布仅一年，上周刚发布最新版本，包含重要的安全功能
- **工作原理**：MCP 由多个工具组成，通过自由文本描述让 LLM 理解工具功能

### 技术栈介绍
- **数据库**：使用 Amazon Aurora PostgreSQL（代码也适用于开源 PostgreSQL）
- **LLM 服务**：使用 Amazon Bedrock 托管模型
- **应用框架**：使用 Streamlit 构建前端应用
- **MCP 客户端**：从 Streamlit 调用 MCP 服务器

### 数据模型说明
- **数据来源**：使用 IMDb 数据集
- **数据库设计**：采用传统的规范化关系型数据模型，包含外键和多表关联
- **数据特点**：包含真实世界的复杂性，如空值处理、数据演变等
- **数据量**：titles 表包含 1100 万条记录

### 数据库注释的重要性
- **使用 COMMENT 命令**：在 PostgreSQL 中为表和列添加描述
- **用途**：MCP 服务器可以读取这些注释，帮助 LLM 理解数据结构
- **示例**：为 end_year 列添加注释说明"仅电视剧有结束年份，其他类型为 null"
- **最佳实践**：不仅对 LLM 有用，也是团队知识共享的好方法

### 演示应用展示
- **登录页面**：简单的 Streamlit 登录界面
- **电影列表**：显示数据库中的电影数据
- **MCP 服务器测试**：演示时间 MCP 服务器（说明 LLM 需要外部工具获取当前时间）
- **天气服务**：展示可以同时使用多个 MCP 服务器

### 使用 Cursor 进行开发
- **MCP 集成**：Cursor 已配置连接到 Aurora PostgreSQL MCP 服务器
- **查询数据库**：通过 Cursor 查询可用的表
- **上下文构建**：让 Cursor 了解数据库结构，为后续开发做准备

### 编写第一个查询
- **需求**：编写查询返回指定电影的所有角色和扮演者
- **开发流程**：
  - 让 Cursor 生成初始查询
  - 查询使用全文搜索和四表关联
  - 测试查询确保正确性
  - 优化查询（如使用 CTE 避免重复全文搜索）
- **迭代改进**：根据需求调整查询，如只返回最受欢迎的电影标题

### 保存工作成果
- **文件保存**：将查询保存到 query1.sql 文件
- **原因**：防止会话丢失导致上下文丢失，便于后续使用
- **最佳实践**：完成一个小模块后立即保存

### 编写第二个查询
- **需求**：返回指定演员的所有角色和电影标题
- **开发速度**：由于已有上下文，Cursor 生成查询更快
- **测试验证**：运行查询确保返回正确结果

### 创建 MCP 服务器
- **提示词策略**：
  - 指定要创建两个工具：get_movie_characters 和 get_actor_roles
  - 提供天气 MCP 服务器作为模板参考
  - 指定使用 psycopg3 连接数据库
  - 使用之前生成的查询作为模板
  - 从 .env 文件加载连接信息
- **代码生成**：Cursor 快速生成完整的 Python MCP 服务器代码

### MCP 服务器代码审查
- **数据库连接**：创建数据库连接函数
- **查询集成**：将之前保存的 SQL 查询导入
- **工具定义**：定义两个 MCP 工具及其参数
- **连接配置优化**：修改为使用独立的用户名和密码参数，而非完整 URL

### 测试 MCP 服务器
- **配置文件**：复制 .env 配置文件
- **首次测试**：查询《星球大战》角色
- **LLM 行为**：LLM 直接从训练数据回答，未调用 MCP 工具（因为星球大战是公开知识）
- **配置应用**：需要在用户应用中配置新的 MCP 服务器

### 更新应用配置
- **修改 Streamlit 应用**：添加新的电影 MCP 服务器配置
- **重启应用**：使配置生效
- **验证工具**：确认 get_movie_characters 工具可用并正常工作

### 创建自定义数据测试
- **管理界面**：使用简单的管理应用添加数据
- **创建电影**：添加名为"429 Coding an MCP Server"的电视电影
- **添加人物**：添加 Jim 和 Vlad 作为演员
- **分配角色**：为演员分配角色名称（Jimbo 和 Mr. Vlad）
- **测试目的**：验证 MCP 能查询数据库中的私有数据，而非仅依赖 LLM 训练数据

### 验证私有数据访问
- **查询测试**：询问"429"电影中有谁
- **工具调用**：这次 LLM 调用了 MCP 工具（因为这是私有数据）
- **结果确认**：成功返回 Jim 和 Vlad 的角色信息
- **重要意义**：证明可以使用 MCP 访问未包含在模型训练数据中的内部数据

### LLM 决策机制讨论
- **非确定性**：Vlad 解释 LLM 决策是非确定性的
- **工具选择**：LLM 自主决定是使用训练数据还是调用工具
- **无法强制**：没有规则强制 LLM 总是先查询工具
- **引导方法**：可以通过提示词引导，但无法完全保证

### 预定义查询模式（Canned Query Pattern）
- **概念解释**：将优化的查询封装成确定性工具
- **对比方案**：让 LLM 动态发现模式、生成查询
- **优势**：
  - 降低延迟（避免多轮 agent 循环）
  - 减少 token 消耗和成本
  - 提高可预测性
  - 适合面向用户的生产应用
- **适用场景**：当查询模式可预测时使用

### 数据安全考虑
- **安全挑战**：将数据库暴露给 LLM 存在安全风险
- **数据隔离需求**：不同用户应只能访问其授权的数据
- **示例场景**：
  - titles 表有 1100 万条记录
  - 需要根据 title_type 限制访问
  - Jim 只能看 type=1（电影）
  - Vlad 可以看所有类型
  - test2 可以看 type=1 和 type=5

### PostgreSQL 行级安全（RLS）实现
- **设置环境变量**：使用 set_config() 函数设置 rls.types 变量
- **测试 WHERE 子句**：验证基于环境变量的过滤逻辑
- **数据验证**：
  - type=1 返回 719,000 条记录
  - type=1 和 5 返回 872,000 条记录
- **创建策略**：CREATE POLICY 定义访问规则

### 启用行级安全
- **创建策略**：基于 current_setting('rls.types') 创建策略
- **启用 RLS**：ALTER TABLE titles ENABLE ROW LEVEL SECURITY
- **权限说明**：表所有者不受 RLS 限制
- **切换用户**：以 MCP 用户身份连接测试 RLS

### RLS 测试验证
- **默认行为**：未设置环境变量时返回 0 条记录（安全默认值）
- **设置后查询**：设置 rls.types 后自动应用过滤
- **自动追加**：WHERE 子句自动添加，无需在查询中显式指定
- **安全优势**：即使 LLM 生成的查询不包含过滤条件，数据库层面也会强制执行

### 集成 RLS 到 MCP 服务器
- **添加命令行参数**：MCP 服务器接收 title_types 参数
- **导入库**：添加参数解析库
- **连接后设置**：建立数据库连接后立即调用 set_config()
- **使用模板**：提供具体的代码模板加快开发

### 修改应用传递参数
- **用户表查询**：从 users 表加载 title_types
- **登录时传递**：用户登录时将 title_types 传递给 MCP 服务器
- **数据类型处理**：将 PostgreSQL 数组转换为文本字符串便于传递
- **变量作用域**：确保 title_types 在正确的上下文中可访问

### 会议要点总结
- **MCP 协议**：标准化 LLM 访问后端数据的方式
- **预定义查询模式**：平衡灵活性与性能的最佳实践
- **安全第一**：使用数据库原生安全特性保护数据
- **迭代开发**：使用 AI 辅助工具加速开发，但需要人工审查和调整
- **实用建议**：
  - 添加数据库注释帮助 LLM 理解结构
  - 保存中间成果避免丢失上下文
  - 使用模板加快代码生成
  - 测试验证每个步骤
  - 实现确定性安全控制

### 代码仓库
- **GitHub 链接**：会议结束时提供 QR 码
- **发布时间**：re:Invent 后的周一上传完整代码
- **内容**：包含所有演示代码和配置文件