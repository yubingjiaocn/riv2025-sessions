# AWS re:Invent 2025 - Amazon S3 发布流水线最佳实践

## 会议概述

本次会议由 George Lewis 和 Wana 主讲，深入探讨了 Amazon S3 的发布流水线和部署安全最佳实践。作为 AWS 最大规模的服务之一，S3 在全球拥有数百万台服务器，分布在 39 个区域（每个区域包含 3 个可用区），并持续扩展至中国分区和 Amazon 专用云环境。

会议重点介绍了 S3 团队如何在如此大规模的基础设施上实现安全部署。核心内容包括三大测试基础设施：Noodles（行为驱动的功能测试平台）、Hi-Fi（基于模型的自动化推理测试系统）和性能测试框架。这些系统使 S3 的全球分布式团队能够高效协作，在部署前进行全面验证。

会议还详细讲解了多分区部署策略，包括如何在商业云、中国区、美国政府云、欧洲主权云和 Amazon 专用云之间进行部署。此外，演讲者分享了应用功能控制技术，如特性标志（feature flags）、允许列表/拒绝列表、以及影子模式部署等 A/B 测试方法。最后，会议触及了有状态系统的部署挑战，为理解 S3 如何维护数据持久性和状态一致性奠定基础。

## 详细时间线

### 开场与背景介绍
[00:00:00 - 00:02:30] - George Lewis 和 Wana 介绍会议主题：Amazon S3 的发布流水线
- 会议目标：分享 S3 的部署安全最佳实践
- 核心议题预告：测试基础设施、多分区部署、应用功能控制、有状态部署

[00:02:30 - 00:04:00] - 会议前提假设说明
- 面向有经验的开发者和运维人员
- 假设听众已具备单元测试、组件测试、CI/CD 流水线和基础设施即代码的基础知识
- 虽然针对大型组织和复杂系统，但小型团队也能从中获益

[00:04:00 - 00:05:30] - S3 规模背景介绍
- 全球数百万台服务器
- 39 个区域，每个区域 3 个可用区，持续增长
- 包括 Amazon 专用云和中国分区
- 三大核心组件：S3 Web 服务器（无状态 API 前端）、索引集群、存储集群（有状态系统）

### 测试基础设施：Noodles
[00:05:30 - 00:07:00] - 部署安全从测试开始
- 重点介绍三大测试系统：Noodles、Hi-Fi 和性能测试
- 这些系统支持横向扩展

[00:07:00 - 00:09:30] - Noodles 测试平台详解
- 针对 S3 公共 API 的行为驱动测试平台
- 专为 S3 分布式团队设计
- 采用 Given-When-Then 结构的场景化测试

[00:09:30 - 00:12:00] - Noodles 代码示例
- 展示特性定义和场景描述（如：桶所有者上传 PNG 返回 200）
- 步骤定义由基础设施团队预先构建
- 服务团队只需编写测试场景并链接到预定义方法
- 大幅降低分布式团队的测试编写复杂度

[00:12:00 - 00:14:30] - Noodles 的规模化优势
- 抽象化的账户和资源池（桶、CloudWatch 指标、DynamoDB 表等）
- 中央基础设施统一管理日志和指标
- 服务团队无需关心基础设施配置

[00:14:30 - 00:16:00] - "一次编写，到处运行"理念
- 同一测试可在多个环境运行：开发者 IDE、集成环境、Web 服务器集成环境、非生产区域验证器
- 自动转换为生产环境的持续金丝雀测试
- 在每个生产区域持续运行

### 测试基础设施：Hi-Fi
[00:16:00 - 00:18:00] - 从功能测试到基于模型的测试
- 功能测试的局限：只测试已知问题
- 无法覆盖客户使用 API 的所有可能方式
- 引入自动化推理和高保真模型测试

[00:18:00 - 00:20:30] - 基于模型测试的基本原理
- 从应用规范或模型开始（而非实现）
- 验证系统是否实现规范，而非测试实现本身
- 对于复杂 API 和多实现场景尤为关键

[00:20:30 - 00:23:00] - S3 PUT 请求的复杂性示例
- 数十个可能的请求头：内容类型、缓存控制、内容编码、服务器端加密选项、ACL 设置、元数据等
- 模型测试不仅测试单个头部，还测试所有组合可能性
- 测试冲突场景、错误优先级、多个格式错误头部的处理

[00:23:00 - 00:25:00] - 多实现一致性验证
- 比较 S3 通用桶、S3 Express One Zone 目录桶、S3 on Outposts
- 确保相同 API 在不同实现中行为一致

[00:25:00 - 00:28:00] - Hi-Fi 系统的三大组件：模型/规范
- 可执行的模型或规范（非仅文档）
- 精确性是关键，需要大量时间构建
- 不仅参考公开文档和内部规范，还需验证客户实际使用方式
- 通过日志分析了解客户真实交互模式

[00:28:00 - 00:30:00] - 模型实现示例
- 本质上是内存中的键值存储
- 可接收请求并根据模型返回响应
- 代码示例展示基本的键值对结构

[00:30:00 - 00:33:00] - Hi-Fi 组件：测试生成器
- 规范、自动化推理和客户行为的结合
- 持续查询 API 规范并生成请求
- 生成所有可能的组合（如 S3 PUT 对象 API 的所有排列）
- 利用真实客户行为塑造测试工作流
- 确保客户实际使用的工作流得到重点测试

[00:33:00 - 00:35:30] - 跨 API 工作流测试
- 不仅测试单个 API，还测试多 API 工作流
- 例如：PUT → GET → HEAD → 修改 ACL 等标准工作流
- 采样生产环境中的任意请求并重新运行
- 持续学习新的客户行为模式

[00:35:30 - 00:38:00] - Hi-Fi 组件：验证器服务
- 从生成器接收测试
- 针对被测服务端点或实现执行测试
- 同时针对可执行规范运行相同测试
- 报告与模型或规范的偏差
- 提供详细的差异报告

[00:38:00 - 00:40:00] - Hi-Fi 与流水线集成
- 不仅生成报告，还集成到 CloudWatch 告警
- 作为流水线的阻塞器
- 如果不符合规范，立即停止部署

[00:40:00 - 00:42:30] - Hi-Fi 的"一次编写，到处运行"
- 当前在集成环境、区域非生产验证器和部分生产区域运行
- 计划扩展到全球每个区域
- 重要性：检测与外部系统集成时的偏差（如新分区中的外部系统返回不同错误代码）

### 性能测试
[00:42:30 - 00:45:00] - 性能测试与部署安全的关系
- 性能测试不仅关乎速度，更关乎容量规划
- 峰值流量处理能力决定最小和安全容量计划
- 结合客户流量预测进行容量规划
- S3 作为区域服务需要考虑可用区冗余

[00:45:00 - 00:47:00] - 性能测试的三个阶段
- 软件功能性能：微观级别，隔离环境
- 实例性能：软件与代表性硬件结合，仍在隔离环境
- 区域评级：生产环境中的实际性能评估

[00:47:00 - 00:50:00] - 软件功能性能测试
- 微观性能，由各服务团队负责
- 避免中央性能团队难以理解具体实现细节的问题
- 示例：压缩 API 的性能取决于数据的可压缩性和熵值
- 服务团队最了解实现细节

[00:50:00 - 00:53:00] - 硬件配置交叉对比
- 在不同硬件配置上运行至少两次迭代
- 隔离软件性能与硬件差异
- 消除硬件偏差：如果软件 B 在任何硬件上都表现更好，则是真正的软件改进或退化

[00:53:00 - 00:56:00] - 多维度独立对比
- 分别比较每个维度和 API 组合
- 避免大规模测试中掩盖单个 API 性能问题
- 示例：80% 请求是 GET，PUT 性能退化可能被平均掉
- 测试不同加密类型、对象大小等维度
- 进行 A/B 直接对比

[00:56:00 - 00:58:00] - 生产环境资格认证的必要性
- 高度差异化的区域流量特征
- 基于区域年龄和成熟工作流的差异

[00:58:00 - 01:01:00] - 区域流量差异示例
- US-East-1（最老区域）：平均请求大小超过 1MB
- 新区域：平均请求大小约 250KB
- 请求越小 → 单主机 TPS 越高 → CPU 压力更大
- 请求越大 → 更多流式传输 → 网络带宽压力更大，TPS 更低
- 相同软件和硬件在不同区域表现完全不同

[01:01:00 - 01:03:30] - S3 Rise 系统介绍
- 持续安全地认证生产集群的系统
- Step Functions 编排器，集成 S3 容量控制系统
- 与 DNS 设置直接集成

[01:03:30 - 01:06:00] - S3 Rise 工作原理
- 改变被测系统的 DNS 权重
- 客户端回收 DNS 时逐渐增加流量
- 持续提升直到主机出现资源耗尽迹象
- 不突破 KPI（延迟、可用性等）
- 当 CPU 达到 92%、RAM 和带宽达到目标水平时停止

[01:06:00 - 01:08:30] - 评级存储和应用
- 将评级保存到 S3 评级存储
- 在每个区域持续运行
- 评级数据输入容量预测
- 预测团队据此选择实例类型
- 持续更新以应对客户行为变化

[01:08:30 - 01:10:00] - "一次编写，到处运行"再次体现
- 在每个区域、每种主要实例类型上运行
- S3 集群异构性高，但重点测试最差、最好和主要组件
- 小规模实例类型可不必持续测试

### 爆炸半径控制与部署流水线
[01:10:00 - 01:12:00] - 爆炸半径控制概述
- 无状态架构的爆炸半径控制相对简单
- 有状态系统的爆炸半径控制将由 Wana 详细讲解
- 目标：将变更限制在最小故障单元

[01:12:00 - 01:15:00] - S3 Web 服务器流水线概览
- 生产前测试：涵盖前述所有测试内容
- 验证器阶段：每个生产区域的生产主机，但不接收生产流量，仅接收金丝雀流量
- 重要性：在 Amazon 专用云等不同分区中，提前验证软件能否加载并连接所有依赖项

[01:15:00 - 01:17:30] - 区域部署策略
- 第一个区域（非"牺牲区域"）：单个实例，长时间烘焙
- US-East-1：最大区域，流量模式最多样化，作为质量门控
- 暴露软件于多样化流量模式，避免后续 39 个区域出现问题

[01:17:30 - 01:19:30] - 指数扇出部署
- 几年前有 6-7 个阶段，现已简化为 2 波
- US-East-1 后部署 4 个区域（包括 GovCloud、中国区和 2 个商业区域）
- 然后并行部署到全球其余区域
- 每个区域同一时间只部署一个可用区

### 部署监控
[01:19:30 - 01:21:00] - 核心指标和告警
- 假设听众已有 CloudWatch 设置基础
- 提供核心指标和必要告警清单
- 参考 AWS Well-Architected Framework

[01:21:00 - 01:23:00] - AI 辅助监控配置
- 使用 Amazon Q 快速迭代 CloudWatch 指标配置
- 审计告警配置
- 确保告警与部署区域关联
- CodeDeploy 可自动关联部署指标和部署区域，识别何时自动回滚

[01:23:00 - 01:25:30] - 应用监控的局限性
- 应用服务告警难以检测负载均衡器之前或应用之前的问题
- 当应用完全宕机时无法报告
- 客户流量骤降告警有时无法检测到问题（隐藏在正常波动中）
- 静默故障是最糟糕的运维事件

[01:25:30 - 01:28:00] - 金丝雀测试的重要性
- 运行自己的客户端，向公共 API 推送合成流量
- 从客户预期位置发起请求（如客户主要来自 AWS 外部，则金丝雀也应在 AWS 外部）
- 防止静默故障：在客户投诉前检测到 500 错误

[01:28:00 - 01:30:00] - Noodles 自动生成金丝雀
- 基于单元测试自动构建金丝雀
- 从集成到生产的所有测试自动转为金丝雀
- 强烈推荐服务团队采用

[01:30:00 - 01:33:00] - CloudWatch Synthetics
- S3 不使用（因依赖管理和区域启动顺序：CloudWatch 依赖 S3）
- 全球覆盖
- 直接集成 CloudWatch 告警和指标
- 自动关联金丝雀和客户流量告警
- 支持 UI 测试（示例：测试 Amazon.com 网页）

### 应用功能控制
[01:33:00 - 01:35:00] - 特性标志（Feature Flags）
- re:Invent 第一天是 AWS 特性标志翻转日
- 工程师编码功能、部署时隐藏功能，然后通过翻转标志逐步启用
- S3 使用 AWS AppConfig 管理所有特性标志和动态配置

[01:35:00 - 01:37:00] - AppConfig 使用示例
- 定义特性标志和验证规则
- 编写客户端代码动态拉取配置
- 支持事件驱动和定期轮询（推荐两者结合）

[01:37:00 - 01:39:00] - 允许列表和拒绝列表
- 通常与特性标志结合使用
- 用于子集用户启动：Beta 测试、Alpha 启动、内部启动
- S3 的狗粮测试机制：首先允许列表自己的账户 → AWS 内部账户 → 大 Amazon → 客户
- 然后在 re:Invent 等活动中通过特性标志向客户推出

[01:39:00 - 01:42:00] - 影子模式部署
- 复制真实生产流量并发送到新版本服务
- 影子服务与现有生产服务并行处理请求
- 影子服务的响应不返回给客户，仅记录或度量
- 比较主系统和影子系统的结果

[01:42:00 - 01:44:30] - 影子模式实现
- 负载均衡器示例：50/50 流量分配
- API Gateway 也支持开箱即用
- 适用场景：内部基础设施改进和软件升级（如更换 Web 服务器引擎、更新 JDK）
- 不太适合新功能（更推荐允许列表和特性标志）
- 确保客户流量在升级前后保持一致

[01:44:30 - 01:46:00] - 从无状态到有状态系统的过渡
- Web 服务器缺乏共享状态，故障影响范围小
- 单个 Web 服务器宕机不影响其他请求
- 但对于有共享状态的持久存储服务（如 S3），情况完全不同
- 交接给 Wana 讲解有状态系统部署

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


注：本摘要基于会议字幕生成，涵盖了 George Lewis 主讲的无状态系统部分。Wana 关于有状态系统的部分未包含在提供的字幕中。