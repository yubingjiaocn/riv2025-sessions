# AWS re:Invent 2025 - ECS 托管实例与蓝绿部署深度解析

## 会议概述

本次 AWS re:Invent 2025 的 400 级深度技术会议由 AWS 开发者关系团队的开发者倡导者 Maish Saidel-Keesing 和无服务器与容器团队的高级首席工程师 Malcolm Fitby 共同主讲，重点介绍了 Amazon ECS 托管实例（ECS Managed Instances）和蓝绿部署功能。

作为 AWS 的一级服务，Amazon ECS 已经运行 11 年，每周在全球范围内启动超过 30 亿个任务。超过 65% 的新 AWS 客户选择从 ECS 开始使用容器服务。在 Prime Day 期间，仅 AWS Fargate 上就启动了超过 1840 万个任务来支撑流量高峰。ECS 不仅服务于外部客户，Amazon 内部的多个服务如 SageMaker、Lex、Polly、AWS Batch 以及 Amazon.com 的推荐系统都构建在 ECS 之上。

本次会议深入探讨了 2024 年 9 月发布的 ECS 托管实例功能，这是一个介于传统 ECS on EC2 和完全无服务器的 Fargate 之间的解决方案。它旨在提供 EC2 的灵活性和 Fargate 的简便管理体验，让开发团队能够专注于为客户创造价值，而将基础设施的无差异化工作交给 AWS 处理。

## 详细时间线与关键要点

### 开场与服务介绍 (0:00 - 5:30)

0:00 - 1:30 - 会议开场
- 演讲者介绍：Maish Saidel-Keesing（开发者倡导者）和 Malcolm Fitby（高级首席工程师）
- 确认这是一个 400 级深度技术会议，假设听众已了解容器和 ECS 基础知识

1:30 - 3:00 - 会议议程
- 第一部分：Amazon ECS 简要概述
- 第二部分：ECS 托管实例深度技术解析（Malcolm 主讲）
- 第三部分：软件部署和蓝绿部署最佳实践（Maish 主讲）

3:00 - 5:30 - Amazon ECS 服务规模与重要性
- ECS 是 AWS 一级服务，任何新区域必须首先部署 ECS
- 每周启动超过 30 亿个任务
- 超过 65% 的新客户选择 ECS 作为容器服务起点
- Prime Day 期间在 Fargate 上启动了 1840 万个任务
- 广泛的客户群体跨越各个行业和规模
- Amazon 内部服务（SageMaker、Lex、Polly、AWS Batch、Amazon.com 推荐系统）都基于 ECS 构建

### ECS 托管实例核心概念 (5:30 - 15:00)

5:30 - 8:00 - 无差异化工作理念
- AWS 的核心目标：让客户团队专注于为业务创造独特价值
- AWS 承担重要但非核心的基础设施管理工作
- 包括底层计算管理、实例健康维护、部署复杂性处理等

8:00 - 11:00 - ECS 计算引擎演进
- **2014 年**：ECS on EC2 推出（客户自带和管理 EC2 实例）
- **2017 年**：ECS Fargate 推出（完全无服务器体验）
- **2024 年 9 月**：ECS 托管实例推出（结合两者优势）

11:00 - 15:00 - 共享责任模型连续体
- **ECS on EC2**：高度控制和灵活性，但客户承担更多管理责任（自动扩展、分布、放置、启动模板、实例类型、补丁等）
- **ECS Fargate**：AWS 承担所有基础设施责任，客户专注于应用程序，但灵活性受限
- **ECS 托管实例**：提供 EC2 的灵活性选择，同时提供 Fargate 的管理体验

### 客户反馈与 ECS 托管实例设计 (15:00 - 22:00)

15:00 - 17:00 - 客户需求分析
- 客户喜欢 ECS on EC2 的灵活性，但不想承担额外管理责任
- 客户喜欢 Fargate 的管理简便性，但希望获得更多选择和丰富性
- ECS 托管实例应运而生，填补这一空白

17:00 - 22:00 - ECS 托管实例的共享责任模型
- AWS 负责：
  - 底层计算和基础设施
  - 可用区管理
  - 存储和网络
  - ECS 控制平面
  - **计算自动扩展**
  - **分布和放置策略**
  - **启动模板创建**
  - **EC2 实例补丁管理**
- 客户保留：实例类型选择的灵活性
- 客户专注：应用程序开发

### 容量提供程序机制 (22:00 - 28:00)

22:00 - 25:00 - 容量提供程序概念
- 容量提供程序是配置对象，描述所需的底层计算类型
- 可以关联到集群、ECS 服务或通过 RunTask API 使用
- 三种类型：
  1. **ASG 托管容量提供程序**：管理客户自带的自动扩展组
  2. **Fargate 容量提供程序**：每个集群的默认选项
  3. **ECS 托管实例容量提供程序**（新）：介于两者之间

25:00 - 28:00 - 多样性选择的重要性
- AWS 强调没有一刀切的解决方案
- 提供多种选择以满足不同客户需求
- 所有容量提供程序可以协同工作

### ECS 托管实例配置 (28:00 - 35:00)

28:00 - 31:00 - 基本配置要求
- 最少需要两个 IAM 角色：
  1. **实例角色**：允许 EC2 实例与 ECS 控制平面通信，ECS 代理注册和获取配置
  2. **基础设施管理角色**：授权 AWS 在客户账户中管理 EC2 资源
- 基于 EC2 托管实例功能构建（2023 年推出）

31:00 - 35:00 - 透明度和可见性
- 托管的 EC2 实例在客户账户中可见
- 通过 DescribeInstances API 可以查看
- 在 EC2 控制台中显示
- 实例标记为"托管"并由 ECS 管理
- 客户可以排除这些实例，无需担心管理

### 放置策略与子网配置 (35:00 - 40:00)

35:00 - 38:00 - 默认分散放置策略
- ECS 托管实例默认使用分散放置（与 Fargate 相同）
- 目标：最大化可用性
- 通过指定子网来定义可用区
- 每个子网对应一个可用区

38:00 - 40:00 - 使用体验
- 配置容量提供程序后，使用方式与 Fargate 相同
- 创建 ECS 服务和任务定义
- ECS 自动调用 EC2 托管队列获取所需容量
- 将实例配置到集群并开始部署任务

### 实例类型选择策略 (40:00 - 48:00)

40:00 - 43:00 - 默认实例选择
- AWS 分析了大多数客户使用 EC2 托管实例的模式
- 考虑了 Fargate 底层使用的实例类型
- 默认选择通用计算系列（C、M、R 系列）
- 如无特殊需求，可以让 AWS 自动选择

43:00 - 48:00 - 基于属性的选择（Attribute-Based Selection）
- 如需更多控制，可使用属性基选择
- 可以指定特定实例类型（如 C6i.48xlarge）
- 也可以更广泛地描述计算需求（如网络优化型）
- **最佳实践**：尽可能保持通用性
  - 提供更广泛的实例选择范围
  - 提高可用性
  - 让 ECS 优化成本和可用性
- 特殊工作负载（如需要 GPU）可以精确指定

### 任务定义驱动的实例选择 (48:00 - 55:00)

48:00 - 52:00 - 任务定义配置层级
- **容器级别**：
  - 内存预留（Memory Reservation）：容器所需的最小内存
  - 内存限制（Memory）：容器的内存上限
  - CPU：按比例分配给容器（非硬限制，可突发）
- **任务级别**：
  - 内存和 CPU：硬限制（Fargate 使用此方式）

52:00 - 55:00 - ECS 托管实例的决策逻辑
- 最低要求：必须指定内存预留
- ECS 根据任务定义配置选择合适的 EC2 实例
- 配置越不具体，弹性越高
- 与 Fargate 的区别：托管实例支持多租户，多个任务共享同一 EC2 实例

### 弹性和突发能力 (55:00 - 58:00)

55:00 - 58:00 - Java 工作负载案例
- Java 应用在 JIT 编译时 CPU 使用率会突发
- Fargate 需要按峰值 CPU 配置（P100）
- ECS 托管实例允许指定较低的聚合内存需求
- 利用底层计算的弹性处理突发负载
- 多个任务可以共享和突发使用可用资源

### 实例启动决策流程 (58:00 - 65:00)

58:00 - 61:00 - 调度器优先级
- 目标：尽快配置工作负载以满足客户需求
- 大型集群持续活跃，多个服务不断扩缩容
- 调度器定期检查待处理任务

61:00 - 65:00 - 三阶段放置策略
1. 第一阶段：优先使用现有计算资源
   - 如果现有实例可以容纳任务且满足放置约束，直接使用
   - 最快的启动方式
2. 第二阶段：分散放置
   - 对于无法放置的任务，考虑放置约束和可用区分散需求
   - 从 EC2 获取满足容量提供程序规格的实例
3. 第三阶段：装箱优化（Bin Packing）
   - 使用首次适应递减算法（First Fit Decreasing）
   - 选择能容纳任务的最大实例
   - 优化成本，以最佳价格获取最大实例

### 大实例的优势 (65:00 - 68:00)

65:00 - 68:00 - 重用计算资源的好处
- **弹性**：大实例提供更多突发空间
- **镜像缓存**：
  - 第一个工作负载拉取镜像
  - 后续工作负载重用缓存的镜像
  - 相同任务在同一实例上启动时无需重新拉取
  - 显著提高吞吐量
- 成本和吞吐量的双重优化

### 主机替换生命周期 (68:00 - 75:00)

68:00 - 71:00 - 主机替换触发条件
- **补丁管理**：确保主机合规性
- **操作员操作**：手动排空、注销或强制注销实例
- **维护事件**：ECS 持续监控 EC2 维护事件
- **操作系统补丁**：需要更新操作系统
- **自动扩展**：服务持续扩缩容
- **成本优化**：避免空闲实例

71:00 - 75:00 - 排空生命周期流程
- 收到实例需要替换的通知后进入排空周期
- 调度器首先替换该实例上的所有托管任务
- **黄金法则**：始终先启动新任务，再停止旧任务
- 确保服务弹性和可用性
- （会话在此处字幕截断）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


## 关键技术要点总结

1. ECS 托管实例定位：在 EC2 灵活性和 Fargate 简便性之间找到最佳平衡点
2. 共享责任优化：AWS 承担更多基础设施管理，客户保留必要的选择权
3. 智能调度：三阶段放置策略（现有资源 → 分散放置 → 装箱优化）
4. 成本与性能兼顾：大实例策略、镜像缓存、弹性突发能力
5. 透明可见：托管资源在客户账户中完全可见
6. 最佳实践：尽可能保持配置通用性以获得最佳可用性和成本效益