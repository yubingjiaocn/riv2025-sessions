# AWS 成本优化会议总结

## 会议概述

本次 AWS 技术会议由 Steph Gu（AWS 高级倡导者）和 Kenneth（Betsson 企业架构师及 AWS Hero）共同主讲，重点探讨了如何避免意外的云成本超支问题。会议通过真实案例分享了从简单到复杂的成本优化策略，并展示了如何利用 AI 工具（Amazon Q 和 Kira）加速优化流程。

演讲者以一个常见场景开场：周五早晨收到预算超支警报，所有相关人员都在询问发生了什么。这种情况往往不是因为系统故障，而是因为持续构建导致支出逐渐累积超出预期。会议的目标是帮助与会者掌握成本优化机会、利用 AI 工具提升效率，并建立预防未来浪费的机制。

Kenneth 来自 Betsson，这是一家领先的博彩公司，在 24 个市场运营，提供多种服务包括游戏、体育博彩、扑克和赛马等。由于业务遍布多个地区，成本优化对他们来说至关重要。会议分享的所有优化策略都是 Kenneth 团队在实际业务中实施并验证过的。

## 详细时间线与关键要点

### **00:00 - 02:30 | 开场与问题场景**
- 描述了周五早晨收到 AWS 预算超支邮件的场景
- 邮件发送给本人、经理和财务团队，引发恐慌
- 问题往往不是系统故障，而是持续构建导致的自然增长
- 介绍演讲者：Steph Gu（AWS 高级倡导者）和 Kenneth（Betsson 企业架构师、AWS Hero）

### **02:30 - 04:00 | 会议议程介绍**
- 三大主题：成本优化机会、AI 工具应用、预防未来浪费
- Kenneth 介绍 Betsson 公司背景：在 24 个市场运营的博彩公司
- 提供游戏、体育博彩、扑克、赛马等多种服务
- 强调多区域运营带来的成本挑战

### **04:00 - 06:30 | 简单优化 - CloudTrail**
- 展示成本节省目标：从 100K 开始逐步优化
- **CloudTrail 优化**：API 调用日志服务，基础免费但多条轨迹收费
- 解决方案：删除多余的 CloudTrail，采用组织级别的单一轨迹
- 遵循最佳实践，实现成本节省

### **06:30 - 08:00 | 简单优化 - EBS 卷和网络资源**
- **EBS 卷清理**：删除未附加的卷，必要时先做备份
- **网络优化**：
  - 删除未使用的弹性负载均衡器（ALB）
  - 移除多余的公网 IP（双重收费：公网 IP + ALB）
  - 清理未使用的 NAT 网关和 Transit Gateway

### **08:00 - 10:30 | 简单优化 - 实例调整与存储**
- **实例右调整（Right Sizing）**：通过工具分析并调整实例大小，影响显著
- **存储优化**：
  - S3：删除不需要的数据，将需要的数据迁移到 Glacier
  - 实施 S3 智能分层（Intelligent Tiering）
  - EBS 卷优化

### **10:30 - 12:00 | Graviton 和数据库优化**
- **Graviton 迁移**：基于 ARM 的 CPU，性价比优异
- 不仅适用于 EC2，还支持多种服务
- **RDS 数据库优化**：
  - 将 PostgreSQL、MySQL、MariaDB 从 Intel 迁移到 Graviton
  - 降低成本的同时提升性能

### **12:00 - 15:00 | Cost Optimization Hub 演示**
- Steph 演示 AWS Cost Optimization Hub 工具
- 免费服务，提供单一视图查看所有优化机会
- 避免重复计算（如删除资源和右调整不能同时进行）
- 演示如何从控制台访问和使用该工具
- 展示如何按账户、区域、资源类型筛选建议
- 介绍 Compute Optimizer 提供的详细数据和指标

### **15:00 - 18:00 | AI 工具 - Amazon Q 和 Kira CLI**
- 介绍 Amazon Q Developer 和 Kira CLI
- **MCP（Model Context Protocol）**：预配置的连接工具
- Kira CLI 演示：
  - 连接到 Cost Optimization Hub
  - 查询计算优化建议
  - 自动修改代码实现建议
  - 生成并执行 CLI 命令部署更改
- 强调 AI 工具可以大幅加速优化流程

### **18:00 - 20:00 | 高级优化 - CloudWatch**
- 进入高级优化阶段（已完成 50K，目标的一半）
- **CloudWatch 日志优化**：
  - 删除不需要的日志
  - 设置适当的保留期限（避免"永不过期"）
  - 减少应用程序生成的日志量
  - 使用"不频繁访问"（Infrequent Access）层级降低成本

### **20:00 - 22:00 | 高级优化 - AWS Config**
- AWS Config 持续记录账户中的资源变更事件
- **EKS 场景问题**：
  - Kubernetes 自动扩展会产生大量配置变更
  - 持续记录模式在高峰期产生巨大成本
- **解决方案**：将记录模式从"持续"改为"每日"，大幅降低日志量

### **22:00 - 24:30 | 高级优化 - 数据传输**
- AWS 数据传输基本规则：产生流量就会收费
- **跨可用区流量问题**：
  - 某些 VPC 只有一个 NAT 网关
  - 跨 AZ 访问 NAT 网关产生额外费用
- **S3 流量优化**：
  - S3 默认解析到公网 IP 空间
  - 私有子网访问需经过 NAT 网关，产生额外费用
  - **解决方案**：实施 S3 Gateway Endpoints（免费功能）
  - 同样适用于 DynamoDB
- Kubernetes 优化：尽量保持流量在同一可用区内

### **24:30 - 26:00 | 高级优化 - Lambda**
- 将 Lambda 函数迁移到 Graviton 架构
- 降低计算资源需求
- 通过代码优化减少执行时间和复杂度
- 综合实现成本节省

### **26:00 - 30:00 | 深度优化 - NAT Gateway 架构**
- 典型设置：VPC + Internet Gateway + 每个 AZ 一个 NAT Gateway
- 成本构成：按小时收费 + 数据处理费用
- **集中式出口 VPC 方案**：
  - 创建专用的出口 VPC
  - 在出口 VPC 中部署 NAT Gateway
  - 通过 Transit Gateway 连接其他 VPC
  - 实施 S3 Gateway Endpoints
  - 使用网络 ACL 在源头阻止不必要的流量
- **成本分析**：
  - 3 个 NAT Gateway 传统方案：$190（假设 2TB 流量）
  - 集中式方案固定成本：$218
  - 但流量减少 35-45%，变动成本：$104
  - **盈亏平衡点**：10 个 VPC
  - 超过 10 个 VPC 可节省高达 8%

### **30:00 - 33:00 | 深度优化 - 区域选择（DMS 案例）**
- 展示 AWS 全球网络地图
- **场景**：从欧洲向圣保罗传输数据
- 网络路径：欧洲 → 美国 → 圣保罗
- **DMS 实例成本对比**（db.r6i.4xlarge）：
  - 法兰克福：$2,573/月
  - 爱尔兰：$2,300/月
  - 美国东部 1：$1,619/月
  - 圣保罗：成本显著更高
- **结论**：在美国东部 1 部署可节省 $2,438/月
- 该逻辑适用于其他服务和工具

### **33:00 - 37:00 | 深度优化 - WAF（Web Application Firewall）**
- WAF 用于保护 HTTP/HTTPS 端点
- **标准功能**（包含在基础价格中）：
  - 地理位置阻止规则
  - AWS 托管规则
  - 核心规则集
  - 速率限制
  - IP 信誉列表
- **高级功能**（成本更高）：
  - Bot 控制
  - 账户创建欺诈防护
  - 账户接管防护
- **优化策略**：
  - 最大化使用标准功能过滤流量
  - 使用自定义规则和标签
  - 缩小高级功能的应用范围

### **37:00 - 39:00 | WAF 优化 - Challenge vs CAPTCHA**
- **CAPTCHA**：用户需要解决拼图验证
  - 成本：$4/10K 请求
- **Challenge**：后台静默检查
  - 成本：$0.40/百万响应
- **建议**：除非必要，否则使用 Challenge 而非 CAPTCHA

### **39:00 - 41:00 | WAF 优化 - Web ACL 容量单元**
- 默认标准价格支持 1,500 容量单元
- 最大限制：5,000 单元
- 每增加 500 单元：额外收费 $0.20/百万请求
- **优化方案**：
  - 在 CloudFront 上关联 WAF（获得 1,500 单元）
  - 在源（ALB 或 API Gateway）上再关联 WAF（再获得 1,500 单元）
  - 双层部署实现成本节省

### **41:00 - 45:00 | AI 工具演示 - 架构优化**
- Steph 演示使用 Amazon Q Developer 优化 CloudFormation 模板
- 选择整个文件 → 右键 → Amazon Q → Optimize
- AI 自动分析并提供优化建议：
  - 网络优化
  - 存储优化
  - 计算优化
- 生成优化后的新版本文件
- 除了成本，还提供架构和安全方面的建议
- 强调这是快速评估整体架构的好方法

### **45:00 - 48:00 | 预防未来浪费 - 服务控制策略（SCP）**
- **SCP 介绍**：
  - 在组织级别（OU 或账户级别）设置的策略
  - 作为账户的护栏
  - 不授予权限，但设置权限上限
  - 覆盖角色和用户的策略
- **现场调查**：约半数听众听说过 SCP，但使用者较少
- 目标：会后更多人开始使用 SCP

### **48:00 - 50:00 | SCP 示例 - 实例类型限制**
- 示例：阻止启动或运行特定 EC2 实例类型
- 限制 24xlarge 或 metal 实例
- 适用于开发和沙箱账户
- 可设置绕过角色以应对特殊需求
- 防止意外部署昂贵资源

### **50:00 - 52:00 | SCP 使用场景**
- **强制使用 GP3**：比 GP2 便宜 20%，1TB 以下性能相同
- **拒绝 NAT Gateway**：在集中式架构中防止随意创建
- **强制标签**：用于调度、自动化、安全、合规
- **标准化实例类型**：强制使用 Graviton 等托管服务
- **区域限制**：防止在错误区域部署资源

### **52:00 - 56:00 | AI 工具演示 - 创建 SCP**
- 使用 Kira CLI 创建服务控制策略
- 将需求文本粘贴给 AI，自动生成 SCP
- **新功能演示**：保存和加载对话
  - 使用 /sls <filename> 保存对话
  - 使用 /load <filename> 恢复对话
  - 允许中断工作后继续之前的上下文
- 演示如何检查代码是否违反 SCP 规则
- 在部署前发现潜在问题，避免部署时遇到障碍

### **56:00 - 结束 | 总结**
- 完成从简单到复杂的全面成本优化策略讲解
- 展示了多种 AI 工具加速优化流程的方法
- 强调预防性措施（SCP）的重要性
- 鼓励与会者将这些策略应用到实际工作中