# AWS re:Invent 2025 - MAM 339 会议总结

## 会议概述

本次会议主题为"Topali 在 AWS 上的 Windows 容器化转型之旅"(MAM 339)。会议由 AWS 技术客户经理 Maya Morv Freeman 和 Topali 首席 DevOps 架构师 Denny Teller 共同主讲,分享了 Topali 公司将其传统 .NET Framework 单体应用迁移到 AWS EKS Windows 容器的完整历程。

Topali 是一个由 AI 驱动的财务自动化平台,提供全球支付、应付账款、采购、税务合规、资金管理等 CFO 运营服务。随着业务快速增长,交易量从数十万激增至数百万,原有的 EC2 单体架构面临严重的扩展性瓶颈、频繁崩溃、支付延迟和性能下降等问题。为解决这些挑战,Topali 选择了容器化道路,最终成功实现了 50% 的性能提升和无缝的自动扩展能力。

整个迁移过程充满挑战,包括日志记录问题、容器优雅关闭信号传递缺陷、以及 Windows 容器特有的技术难题。通过与 AWS 团队的紧密合作和创新性的解决方案,Topali 不仅克服了这些障碍,还为其他企业的 Windows 容器化转型提供了宝贵的实践经验。

## 详细时间线与关键要点

### **开场与背景介绍 (0:00-5:30)**
- **0:00** - 会议开始,介绍主题:Topali 在 AWS 上的 Windows 容器转型
- **0:45** - 现场调查:询问参会者是否运行 Windows 工作负载及是否考虑容器化
- **1:30** - 会议议程:容器基础知识、Topali 的迁移旅程、经验教训和未来规划
- **2:15** - Denny 预告:将分享从传统架构到现代化的技术决策、挑战、性能优化和业务影响

### **Windows 容器基础知识 (5:30-15:00)**
- **5:30** - 计算演进历史:从单应用单服务器 → 虚拟化 → 容器化(虚拟化操作系统)
- **7:00** - 容器优势:共享内核、成本优化、快速部署、敏捷性
- **8:15** - Windows 容器发展史:2015 年 Docker 规范诞生,2017 年 Microsoft 支持 Linux 容器,2019 年 containerd 支持,2023 年 Karpenter 支持
- **9:30** - 容器化收益:客户平均节省 60% EC2 成本、68% 存储成本,减少管理开销
- **10:45** - Windows 容器考虑因素:镜像较大(起始 3GB),需要更大主机,仅特定应用适用
- **12:00** - 适合容器化的应用类型:ASP.NET、WCF、Windows 服务、控制台应用(不适合完整 GUI 应用)
- **13:15** - 容器化五大要素:Dockerfile、基础镜像、镜像仓库(ECR)、工作节点主机(EKS)、编排器

### **镜像缓存策略与 Karpenter (15:00-20:00)**
- **15:00** - EC2 Image Builder 缓存策略:通过预构建自定义 AMI 加速部署 65%
- **16:30** - 性能对比:使用缓存策略 54 秒启动 vs 不使用缓存 7 倍时间(约 6 分钟)
- **18:00** - Karpenter 介绍:2023 年 AWS 开始支持,自动扩展节点,成本优化,与 Kubernetes 调度器协同工作
- **19:00** - AWS App2Container 工具:代码现代化工具,转换速度提升 4 倍

### **Topali 公司背景与技术架构 (20:00-28:00)**
- **20:00** - Topali 业务介绍:AI 驱动的财务自动化平台,整合全球支付、应付账款、采购、税务、资金管理
- **21:30** - 初始架构:NET Framework 4.7 单体应用,运行在 EC2 实例上,多进程架构
- **23:00** - 早期优势:快速开发、可靠、适合初创阶段
- **24:15** - 增长带来的挑战:单进程演变为多子进程,调度复杂,调试困难
- **25:30** - 转折点:交易量从数十万激增至数百万,系统频繁崩溃、支付延迟、性能下降、工程师不满
- **27:00** - 单体架构痛点:固定容量无弹性、部署耗时数小时、故障排查困难、发布周期缓慢、无法采用现代 DevOps 实践

### **技术选型决策 (28:00-35:00)**
- **28:00** - 决策:选择容器化而非重写代码
- **29:00** - ECS vs EKS 对比:ECS 简化运维,EKS 提供完整 Kubernetes 能力
- **30:30** - 选择 EKS 的原因:团队已在 Linux 工作负载上使用 Kubernetes,需要深度调试能力,Windows + Kubernetes 是未开拓领域
- **32:00** - 最小风险策略:保持接近现有环境,专注应用而非平台
- **33:15** - 迁移路径选择:Rehost(迁移到 EC2)、Replatform(容器化)、Refactor(重构为云原生)
- **34:30** - Topali 选择 Replatform:避免多年重写,直接迁移到 Windows 容器

### **EKS 配置与初始设置 (35:00-42:00)**
- **35:00** - 研究阶段:阅读所有 AWS 关于 Windows 和 Kubernetes 的文档
- **36:00** - VPC CNI 配置:负责为 Pod 分配 IP 地址并连接到 VPC,需要正确的标志配置
- **37:15** - Windows 节点特殊性:不运行 AWS node pod,IP 分配在内部处理
- **38:30** - IAM 权限调整:Windows 节点需要额外权限,从 aws-auth ConfigMap 迁移到 Access Entries
- **39:45** - Windows 版本选择:Windows Server Core 2019 容器运行在 Windows Server 2019 节点上,保持一致性
- **41:00** - LTSC 版本策略:使用长期服务渠道版本,避免 OS 构建版本匹配的复杂性

### **Windows 容器镜像类型 (42:00-47:00)**
- **42:00** - Nano Server:最小化镜像,支持跨平台 .NET 和现代开源框架,适合 sidecar 容器
- **43:15** - Server Core:最受欢迎,平衡效率与功能,支持 .NET Framework 和 IIS,覆盖大多数企业应用需求
- **44:30** - Server:比完整 Windows 镜像小,但包含完整 Windows API,支持 DirectX 图形功能
- **45:45** - 完整 Windows 镜像:最大镜像,包含所有 Windows API,适合图形密集型应用和机器学习框架
- **46:30** - 选择建议:考虑 ODBC 驱动、应用调用的 API,镜像过小应用无法运行,过大会拖慢部署

### **第一个重大挑战:日志记录 (47:00-54:00)**
- **47:00** - 日志问题:EC2 上使用 XML 格式 + Fluent Bit,Kubernetes 需要 JSON 格式
- **48:15** - Linux vs Windows 日志差异:Linux 容器默认输出到 stdout,Windows Pod 不会
- **49:30** - Log Monitor 解决方案:作为"通用翻译器",将 ETW、Windows 事件日志、应用日志格式化并输出到 stdout
- **51:00** - Log Monitor 配置:集成到 Windows AMI,配置日志规范,部署 Fluent Bit 转发到 CloudWatch
- **52:15** - 最佳实践:使用结构化格式(JSON/CSV),减少日志冗余,避免凌晨 2 点调试噩梦
- **53:00** - Log Monitor 问题:引入额外开销,导致应用崩溃,进程钩子带来神秘问题
- **53:45** - 最终解决方案:修改应用日志配置直接输出到 stdout,移除 Log Monitor

### **第二个重大挑战:优雅关闭问题 (54:00-63:00)**
- **54:00** - 问题发现:部署新版本时 Pod 卡在 Terminating 状态长达 5 分钟
- **55:15** - 根本原因调查:怀疑 kubelet 和 containerd 之间的通信问题
- **56:30** - 信号传递机制:Linux 使用 SIGTERM,Windows 使用 Control Shutdown 事件
- **57:45** - 问题诊断:Kubernetes 发送信号但应用未响应,最终强制终止 Pod(非优雅关闭)
- **59:00** - 发现 Bug:containerd 1.6.6 版本不支持 Windows 信号传递,AWS Linux 和 Windows 运行不同版本
- **60:15** - 与 AWS 协作:通过 GitHub 开 issue,AWS 确认后续版本将修复
- **61:00** - 临时解决方案:使用 Kubernetes 生命周期钩子(lifecycle hooks)和调整优雅终止期限
- **62:00** - 验证测试:EC2 环境与 Kubernetes 环境并行运行,连接同一 RabbitMQ 队列,观察到新容器成功消费消息

### **自动扩展与性能优化 (63:00-70:00)**
- **63:00** - 扩展性测试:使用 KEDA(Kubernetes Event-Driven Autoscaling)基于 RabbitMQ 消息队列长度扩展
- **64:15** - 基于工作负载扩展:根据待处理工作量而非 CPU/内存扩展,更符合业务需求
- **65:30** - Karpenter 扩展:通过 CRD 扩展支持 Windows 节点自动扩展
- **66:45** - 扩展结果:Pod 和 Windows 节点无缝高效地自动扩展
- **68:00** - 性能提升:与 EC2 环境对比,获得 50% 性能提升(完全意外的收获)
- **69:00** - 运维改进:从调试数百个进程变为单个 Pod 单个进程,日志、追踪、指标清晰简单

### **成本分析与优化策略 (70:00-76:00)**
- **70:00** - Karpenter 优势:理解 Spot 定价和 EC2 承诺,自动扩展和缩减,整合工作负载
- **71:00** - 成本现实:基础设施成本略有上升,但运维收益远超支出
- **72:15** - 成本合理性:50% 性能提升 + 可扩展性 + 部署便捷性,减轻开发人员和客户痛苦
- **73:30** - Spot 实例尝试:应用无法处理 2 分钟关闭通知,放弃 Spot 策略
- **74:15** - 成本优化策略:使用 Savings Plans 和预留实例,EC2 Compute Optimizer 进行实例大小调整
- **75:00** - 资源监控:使用 AWS Container Insights 追踪资源使用,优化 Pod 资源配置
- **75:45** - 持续优化:成本效率和性能优化是永无止境的过程

### **成本管理工具与最佳实践 (76:00-结束)**
- **76:00** - Cost Explorer 建议:启用成本分配标签,按 Kubernetes 命名空间、服务、团队拆分成本
- **77:00** - 标签策略:为 EKS 集群、节点组、Pod 添加标签,实现精细化成本追踪
- **78:00** - 会议总结:从单体架构到容器化的完整旅程,技术挑战与解决方案,性能与成本平衡

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


关键收获:
- Windows 容器化是可行的生产级解决方案,但需要理解其与 Linux 容器的差异
- 选择 ECS 或 EKS 取决于团队能力和标准化需求
- 日志记录和优雅关闭是 Windows 容器的两大关键挑战
- 与 AWS 团队协作可以快速解决平台级问题
- 容器化带来的运维简化和性能提升可以抵消基础设施成本增加
- Karpenter 和 KEDA 是实现自动扩展的强大组合