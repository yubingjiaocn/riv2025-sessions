# AWS re:Invent 2025 Aurora 安全架构深度解析

## 会议概述

本次技术分享由 Amazon 安全团队副总裁兼杰出工程师 Eric Branwine 和 AWS 数据库团队首席安全工程师 Andy 共同呈现,深入剖析了 Aurora 云原生数据库的安全架构设计理念。

演讲的核心围绕一个真实的安全事件展开:2025年在 Defcon 安全会议上,来自 Veronus 的安全研究人员 Tal 和 Kobe 发现了 PostgreSQL 数据库的零日漏洞(通过 PL/Perl 扩展实现权限提升),并对所有提供 PostgreSQL 服务的云厂商进行了攻击测试。虽然该漏洞在 Aurora 的数据库引擎层面成功触发,但由于 Aurora 采用了多层纵深防御架构,攻击最终被成功阻止,无法突破单租户头节点进入多租户存储系统或控制平面。

这次事件充分验证了 AWS 的核心安全设计原则:不将数据库引擎本身视为安全边界,而是通过 SE Linux 强制访问控制、Chronicle 遥测监控、VPC 流日志、网络隔离、令牌代理等多层独立防护机制,构建了即使面对未知攻击也能有效防御的安全体系。演讲强调,这种安全能力并非一蹴而就,而是多年持续投入、不断测试改进、积累海量分析数据的结果,体现了云原生架构在安全性方面的独特优势。

## 详细时间线与关键要点

### **Aurora 架构基础 (00:00 - 08:30)**

00:00 - 01:30 | 演讲者介绍与合作模式
- Eric Branwine(Amazon 安全团队副总裁)与 Andy(AWS 数据库安全工程师)共同演讲
- 强调 AWS 的安全协作文化:安全团队与业务团队紧密合作确保客户安全

01:30 - 04:00 | 数据库服务的演进谱系
- **RDS**:将传统数据库(MySQL、PostgreSQL、Oracle 等)直接部署在 EC2 上作为托管服务,本质仍是单主机架构
- **DynamoDB**:完全云原生的 NoSQL 数据库,具备无服务器、弹性扩展、多可用区等优势,但需要专门的开发接口
- **Aurora**:位于两者之间的云原生关系型数据库,兼具云原生优势与 MySQL/PostgreSQL 兼容性

04:00 - 08:30 | Aurora 的创新架构设计
- **核心设计理念**:将数据库"锯成两半"
  - **头节点(Head Node)**:运行真实的 MySQL/PostgreSQL 代码,处理查询解析、查询规划、连接等需要单一内存空间的操作
  - **存储层**:完全重新设计的多租户、多可用区分布式存储系统
- **关键特性**:
  - 头节点是无状态的,事务提交后数据已持久化到存储层
  - 可以有多个头节点分布在不同可用区
  - 头节点通过标准 ENI 连接到客户 VPC,客户拥有完全的网络控制权
  - 第二个 ENI 连接到 Aurora 专用网络,用于与多租户存储系统和控制平面通信
- **软件组件**:
  - 数据库引擎:处理客户查询
  - Host Manager:管理主机,与控制平面通信

### **威胁模型与安全设计原则 (08:30 - 15:00)**

08:30 - 11:00 | Aurora 的威胁模型
- **多租户架构**:
  - 头节点:单租户,专属于单个客户的单个数据库
  - 存储系统和控制平面:多租户,服务于该区域所有 Aurora 客户
- **核心假设**:不将数据库引擎视为安全容器
  - 数据库引擎由第三方开发,设计初衷是单方系统(所有者即用户)
  - 现在变成三方系统:引擎开发商、云服务提供商、最终客户
  - 数据库引擎本身不是为多租户安全场景设计的

11:00 - 15:00 | 为什么不能依赖数据库引擎作为安全边界
- **客户需求的复杂性**:
  - 需要丰富的功能接口(如 PL/Perl、PL/Rust 等扩展)
  - 希望快速获得新版本特性
  - 不希望被强制升级(业务窗口、变更控制等原因)
- **维护负担**:
  - 不希望维护大量专有补丁
  - 需要快速跟进上游引擎发布
- **安全策略**:
  - 持续对数据库层进行安全加固和补丁管理
  - 但从根本上不依赖这一层作为安全边界
  - **头节点被视为"可牺牲的"(sacrificial)**:假设攻击者可以获得访问权限,但必须阻止其突破到共享存储或控制平面

### **真实安全事件:PostgreSQL 零日漏洞 (15:00 - 22:00)**

15:00 - 17:30 | 漏洞发现与攻击
- **2025年 Defcon 会议**:Veronus 的研究人员 Tal 和 Kobe 展示了 PostgreSQL 的新型权限提升漏洞
- **攻击向量**:通过 PL/Perl 扩展实现代码执行
  - PL/Perl 是允许用 Perl 语言扩展数据库功能的完整代码执行引擎
  - 这类复杂接口是安全漏洞的高风险区域
- **测试范围**:针对所有提供 PostgreSQL 服务的云厂商进行测试
- **Aurora 的表现**:
  - 漏洞在数据库引擎层面成功触发(因为运行的就是 PostgreSQL)
  - 但无法进一步渗透或利用
  - 研究人员在演讲中特别称赞 AWS Aurora 的防护有效性

17:30 - 22:00 | 事件时间线
1. 研究人员安装 PL/Rust 并重启实例
2. 约1小时后:漏洞利用成功,SE Linux 开始产生告警
   - 初期告警路由到服务团队(而非安全团队)
   - 因为这是新功能,告警规则尚未完全调优
   - 团队无法确定是合法的 PL/SQL 行为还是恶意活动
3. 研究人员继续探索:触发 Chronicle 系统的成熟告警
   - 立即通知安全团队
4. 安全团队评估:
   - 这是成熟的付费客户账户,有长期历史记录
   - 实例不是新创建的,没有"研究"标签
   - 不是预先协调的安全研究
   - 监控显示没有成功突破头节点
5. 响应决策:
   - 与法务团队协商
   - 通过客户的 TAM(技术客户经理)联系客户
   - 最终切断网络访问,使数据库进入存储故障模式
6. 重要说明:
   - 这些机制是为了保护 Aurora 服务本身,而非客户数据
   - AWS 承诺不查看客户数据(除非客户选择启用 GuardDuty 高级威胁防护)
   - 如果检测到成功突破头节点的迹象,会立即采取行动

### **安全控制机制详解 (22:00 - 40:00)**

22:00 - 27:00 | SE Linux(安全增强型 Linux)
- **背景**:美国国家安全局(NSA)于2000年发布的内核安全模块
- **功能**:提供强制访问控制(MAC)等细粒度权限管理
- **挑战**:配置复杂,在通用计算平台上容易引发问题
- **Aurora 的优势**:
  - 环境受限且明确:清楚知道哪些进程需要访问哪些资源
  - 可以配置非常严格的策略
- **实际案例**:
  - 检测到 Rust 包管理器 cargo 试图执行代码被拒绝
  - 来源进程是 PostgreSQL 引擎
- **在架构中的位置**:在头节点内部,监控和强制执行资源权限、进程执行等

27:00 - 32:00 | Chronicle 遥测服务
- **部署范围**:所有 AWS 主机上运行代理
- **监控内容**:
  - 进程执行(特别是 execve 系统调用)
  - 内核模块加载/卸载
  - 其他系统活动
- **数据处理**:
  - 事件传输到中央服务
  - 安全工程师和服务团队可查询分析
  - 创建告警规则
- **Aurora 的优势**:
  - 数据库服务器不像 EC2 那样运行多样化服务
  - 可以设置非常精确的预期行为基线
  - 数据库引擎升级改变行为时,告警可能会触发(需要调优)
- **隐私保护**:
  - 不查看客户数据
  - 数据库引擎日志在事件调查中会被编辑
  - 只能看到错误发生和时间戳,看不到错误内容(可能包含客户数据)
  - 但 Chronicle 可以看到数据库外部的进程执行情况
- **本次事件**:检测到 curl 执行(非预期行为),立即触发告警

32:00 - 37:00 | VPC 流日志
- **功能**:捕获网络接口的 IP 流量
- **Aurora 应用**:
  - 监控异常流量
  - 检测跨 VPC 通信尝试
  - 客户 VPC 无法直接与存储 VPC 通信
- **网络隔离机制**:
  - 安全组
  - 私有子网
  - VPC 隔离
  - IP tables 防火墙
- **流日志格式解析**:
  - 账户 ID、网络接口 ID
  - 源 IP/端口、目标 IP/端口
  - 流量是否被接受/拒绝
- **大规模分析**:海量流日志数据支持复杂的查询和分析

37:00 - 40:00 | 其他安全控制
- **令牌代理(Token Broker)**:
  - 不使用标准 EC2 实例角色(会导致所有头节点拥有相同权限,存在跨实例权限提升风险)
  - 实例角色仅有权访问令牌代理
  - 令牌代理为每个实例颁发精确范围的 AWS API 密钥
  - 每个头节点只能执行其特定需要的操作
- **互联网可访问的 API**:
  - Host Manager API 仅由内部头节点调用
  - 但设计为互联网可访问的 API
  - 提供额外的纵深防御层
  - 即使头节点被攻破,仍不会失去信任边界(因为头节点本身不是信任边界)
- **持续评估**:
  - 不断评估 SE Linux 拒绝和 Chronicle 检测
  - 寻找"狗没叫"的情况(应该触发但没触发的告警)
  - 使用金丝雀测试验证控制措施
- **成本效益**:
  - 单位安全工程投入保护数百万实例
  - 在巨大规模上分摊成本

### **主动安全计划 (40:00 - 48:00)**

40:00 - 42:00 | 应用安全计划
- **全生命周期安全**:
  - 威胁建模
  - 风险识别
  - 安全评估
  - 从设计到部署监控的每个阶段都有安全工程师参与
- **渗透测试**:
  - 有意设定范围
  - 验证系统行为预期
  - 验证现有控制措施

42:00 - 44:30 | 漏洞赏金计划
- **与顶级安全研究人员合作**
- **实地活动**:
  - 在伦敦举办面对面活动
  - 邀请已证明能力的专家研究人员
  - 提供非生产环境的 root 访问权限
  - 挑战研究人员突破到多租户存储
  - **结果**:研究人员未能突破

44:30 - 48:00 | 红队(Red Team)
- **定位**:模拟复杂威胁行为者和外部对手
- **优势**:
  - 无限制的范围
  - "开卷考试":深入了解系统内部、防御机制
  - 定期发现数据库引擎本身的新漏洞
- **近年发现的 CVE 示例**:
  - CVE-2023-5868
  - CVE-2023-5869
  - CVE-2023-5870
  - CVE-2024-7348
- **协作模式**:
  - 不仅报告问题
  - 与构建团队紧密合作
  - 展示攻击思路和方法
  - 讨论哪些控制措施能够阻止攻击
  - 与构建团队一起验证
  - 形成良性循环,持续演进和加强
- **取证分析支持**:
  - 案例:检测到客户实例上的可疑活动
  - 联系客户后发现是其安全团队雇佣的渗透测试人员
  - 客户运维团队不知情,也未检测到
  - 但 AWS 检测到了,客户对此表示感谢

### **事件回顾与技术细节 (48:00 - 58:00)**

48:00 - 52:00 | 完整事件流程回顾
1. 研究人员安装 PL/Rust 并重启
   - 网络隔离从一开始就阻止访问存储服务和控制平面 VPC
   - 只能访问单租户头节点
2. SE Linux 拒绝:
   - cargo 试图执行命令被阻止
   - 作为新控制措施,告警路由到工程团队
   - 工程值班人员开始诊断:是升级行为还是其他问题?
3. 研究人员创新攻击:
   - 通过嵌套 PL/Perl 和 PL/Rust 函数
   - 利用 Rust GDB 环境变量
   - 成功执行 shell 命令
4. Chronicle 告警触发:
   - 检测到 curl 执行
   - 这是高度调优的告警,置信度极高
   - 立即通知安全值班人员
5. 安全响应:
   - 首次值班的安全工程师呼叫红队、升级、法务等
   - 能够快速但不慌乱地行动(因为对控制措施有信心)
   - 这不是预期活动
   - 客户账户不在漏洞赏金计划中
   - 是成熟的付费客户,有生产工作负载
   - 不能随意终止实例
6. 社区联系:
   - 红队负责人通过社区渠道
   - 根据数据库名称中的元数据识别出是 Kobe
7. 客户沟通:
   - 通过 TAM 联系
   - 客户在另一个国家和时区
   - 半夜叫醒相关人员
   - 负责任地处理,不中断运营
   - 这种细致判断难以编码到 AI 响应代理中
   - **人在回路中很重要**
8. 最终决策:
   - 快照实例并转入存储故障模式
   - 而不是禁用整个账户
   - 与 Kobe 和 Tal 确认情况
   - 他们相当惊讶
   - 安全终止实例

52:00 - 58:00 | 技术深度分析
- **攻击者的劣势**:
  - 通常攻击者会在本地测试完整攻击链
  - 可以在笔记本上安装 PostgreSQL,开发脚本化攻击
  - 正常情况下执行只需几秒到一分钟
- **SE Linux 的关键作用**:
  - 虽然没有完全阻止攻击
  - 但成功阻断了原始攻击链(cargo 执行被拒绝)
  - **迫使攻击者现场创新**
  - 从准备好的计划转向即兴发挥
  - 这是巨大的优势转换
- **攻击链的复杂性**:
  - PL/Perl 转向 PL/Rust
  - 滥用调试器环境变量
  - 这些都是聪明的研究人员在攻击中间进行的创新
- **为什么 SE Linux 不阻止 curl**:
  - 数据库引擎本身会调用 curl(远程数据连接器等功能)
  - curl 二进制文件必须存在
  - 但 AWS 知道合法调用的模式:父进程、环境等
  - 当以异常方式调用时触发 Chronicle 告警
- **时间线的重要性**:
  - 前几个步骤的时间线由 AWS 控制
  - 不是闪电式攻击
  - 研究人员不断尝试更多命令
  - 只有在能够执行 curl 后才获得突破
  - 这给了 AWS 响应时间
- **防御的演进**:
  - SE Linux 控制随时间越来越严格
  - 直到新数据库引擎发布引入新行为
  - **这是一项永无止境的工作**

58:00 - 结束 | 数据收集与分析架构
- **设计原则**:保持收集器简单
  - Chronicle 代理部署在数亿台主机上
  - 如果消耗过多内存,会浪费 EB 级别的内存
  - 复杂功能增加导致舰队范围问题的风险
  - 违反跨可用区、跨区域不相关故障的承诺
- **云的优势**:
  - 拥有云基础设施来存储和分析数据
  - "我们是囤积者":收集并仓储 Chronicle 日志
  - 为每个 ENI 保存 VPC 流日志
  - 使用 Sinaris 和主动防御(去年 re:Invent 演讲主题)
- **智能分析架构**:
  - 简单的收集器
  - 中央系统中的智能分析
  - 数据仓库(S3)
- **时间机器能力**:
  - 当开发新检测规则时,无需舰队范围部署
  - 数据已经在分析系统和 S3 中
  - 只需部署新检测到分析舰队(比整个云小得多)
  - 可以回溯查询过去 30、60、90、4000 天的数据
  - 能够明确回答"过去是否见过这种行为"
- **成本考虑**:
  - S3 存储有成本
  - 需要调整:保留什么、如何处理、保留多久
  - 原始数据和处理后数据的保留策略
- **与端点安全的对比**:
  - 传统 EDR 代理在客户端可能面临糟糕的 Wi-Fi、蜂窝网络、间歇性连接
  - 必须让代理本身足够智能
  - 云环境中可以采用不同的设计点:简单收集器 + 强大后端

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


总结要点:
- Aurora 的安全不依赖单一防线,而是多层独立控制的组合
- 即使面对零日漏洞,纵深防御也能有效保护多租户基础设施
- 持续投入、测试、数据积累是安全能力的基础
- 云原生架构在安全方面具有独特优势:集中分析、历史数据、规模效应