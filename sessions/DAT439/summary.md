# AWS re:Invent 2025 - Amazon Aurora DSQL 架构深度解析 (DAT439)

## 会议概述

本次会议是关于 Amazon Aurora DSQL 的深度技术讲解，由 DSQL 团队工程师 Mark 主讲。这是继去年同名演讲之后的系列深度解析之一，重点探讨了 DSQL 的连接管理、查询处理器架构以及会话路由层的设计。

Aurora DSQL 是 AWS 推出的分布式关系数据库服务，它将传统关系数据库的强大功能与分布式系统的可扩展性相结合。DSQL 基于 PostgreSQL 构建，提供完全无服务器的体验——无需配置服务器、无需管理维护窗口、按使用量付费，并且可以在 5 秒内创建集群。该服务采用强一致性设计，支持 active-active 架构，可以在多个可用区甚至多个 AWS 区域中同时处理读写请求。

DSQL 的核心架构包含三个关键组件：查询处理器(QP)负责接收和执行 SQL 语句；日志服务(Journal)作为分布式事务日志提供持久性保证；存储服务(Storage)从日志中学习已提交的事务并保持数据最新。通过基于时间的同步协议（利用 EC2 Time Sync 和 AWS Clockbound 服务），DSQL 实现了强一致性保证。该服务还支持自动扩展，包括读扩展、写扩展以及跨分片提交能力。

## 详细时间线

### 开场与服务概述 (0:00 - 5:30)

0:00 - 0:45 - 会议开场
- 演讲者 Mark 介绍自己是 DSQL 团队的工程师
- 本次会议编号为 DAT439，主题是 Amazon Aurora DSQL 架构深度解析
- 说明这是继去年 Mark Brooker 同名演讲后的系列深度讲解

0:45 - 2:15 - DSQL 服务定位
- DSQL 是分布式关系数据库的实现
- 结合了关系数据库的优势（复杂查询、模式演化、索引）和分布式系统的特性（无单点故障、水平扩展）
- 基于 PostgreSQL 构建，专为事务性工作负载设计
- 响应客户对完全无服务器数据库的需求

2:15 - 3:30 - 创建集群演示
- 展示了极简的集群创建界面，无需配置复杂参数
- 5 秒即可创建完成集群
- 所有配置项（标签、删除保护、加密密钥等）都可以后续修改
- 无需预先决定 VPC 设置或维护窗口

3:30 - 4:30 - 查询编辑器功能
- 介绍了新发布的 Web 查询编辑器
- 这是一个在浏览器中运行的 PostgreSQL 应用
- 通过 WebSocket 直接与 DSQL 通信
- 兼容绝大多数基于 PostgreSQL 的库（libpq、JDBC 等）

### 核心架构组件 (4:30 - 10:00)

4:30 - 6:00 - 三大核心组件介绍
- **查询处理器 (QP)**：接收 PostgreSQL 协议，解释和执行 SQL 查询
- **日志服务 (Journal)**：分布式事务日志，为 S3 等服务提供支持，单区域配置写入至少两个可用区，多区域配置复制到至少一个其他 AWS 区域
- **存储服务 (Storage)**：团队从零构建的服务，连接到日志学习已提交事务并更新本地视图

6:00 - 7:30 - 数据流程说明
- SELECT 语句：QP 解析、规划、执行查询，转换为对存储的低级读操作
- INSERT 语句：新行驻留在 QP 内存中，未写入磁盘
- UPDATE 语句：QP 先读取现有行值，然后在内存中生成新版本
- COMMIT 时：QP 将事务通过网络发送到日志，写入至少两个可用区后完成提交

7:30 - 9:00 - 强一致性实现
- 使用基于时间的同步协议
- 利用 EC2 Time Sync 服务（基于 GPS 卫星时钟）获取微秒级精确时间
- 使用 AWS Clockbound 服务纠正潜在误差
- 生成线性化时间戳，保证在任何提交时间戳之后
- 存储实现多版本并发控制 (MVCC)，返回精确时间戳的结果

9:00 - 10:00 - Active-Active 架构
- 多个连接可以在不同 QP、不同物理主机、不同可用区甚至不同区域运行
- 所有 QP 都可以更新数据
- 通过 Adjudicator 服务协调，该服务位于日志前面
- 实现乐观并发控制 (OCC)，检查事务冲突

### 自动扩展机制 (10:00 - 12:30)

10:00 - 11:00 - 读扩展
- DSQL 持续备份数据
- 使用最近快照创建存储克隆
- 克隆连接到日志学习最新事务
- QP 智能地在副本间负载均衡

11:00 - 11:45 - 大小拆分
- 随着数据增长，副本会变大
- DSQL 保持副本在可管理的大小
- 小数据集提高性能
- 副本故障时可快速恢复

11:45 - 12:30 - 写扩展
- 日志层可以横向扩展
- 通过自动透明分片实现
- 将更新发送到不同的 Adjudicator 和日志
- 支持跨分片提交

### PostgreSQL 连接模型对比 (12:30 - 18:00)

12:30 - 14:00 - 传统 PostgreSQL 连接
- 应用连接后进行凭证交换（如用户名密码）
- 服务器验证后使用 Unix fork 系统调用创建专用进程
- 每个连接获得独立进程
- 即使空闲也消耗资源
- 可能需要更大主机仅为支持更多连接

14:00 - 18:00 - 扩展挑战场景演示
- **安全性问题**：PostgreSQL 是百万行 C 代码，暴露在互联网上有安全风险，密码可能泄露，通常需要 VPC 保护但增加开发复杂度
- **连接池需求**：建立连接耗时可达 1 秒（TCP、TLS、凭证交换、fork、准备语句），需要客户端连接池预先打开连接
- **峰值平均比问题**：稳态 10 TPS 可能需要 100 个连接来处理峰值，按 RDS 公式（每 GB 内存 10 个连接），需要相应实例大小
- **高可用性要求**：三副本场景下需要 300 个连接（每个副本 100），但最大连接数限制为 5000
- **连接代理**：需要部署 PgBouncer 或 RDS Proxy 来管理连接池
- **故障转移复杂性**：单写入节点故障需要隔离、选择备用节点、DNS 更新等，通常导致 30 秒到数小时停机
- **读扩展复杂性**：需要配置读副本端点、应用层流量分割、处理最终一致性问题

### DSQL 连接架构设计 (18:00 - 28:00)

18:00 - 19:30 - 设计愿景
- 客户痛点源于单一写入节点这个单点
- DSQL 采用 active-active 架构，任何 QP 都可接受读写
- 所有读取都是强一致性
- 目标：通过负载均衡器封装所有复杂性，提供简单体验

19:30 - 21:00 - 共享端点决策
- 考虑是否每个集群独立端点和 QP
- 独立端点需要客户提供连接数提示，最小单位受限（如 50 个连接）
- 无法提供细粒度扩展（只能 50、100、150）
- 补丁和部署管理复杂
- 决定：构建单一共享端点，所有集群共用，根据需求动态分配 QP

21:00 - 23:00 - SNI (Server Name Indication) 技术
- 需要在 PostgreSQL 协议范围内工作
- 使用 TLS 的 SNI 功能
- 创建集群时生成随机标识符
- 使用 Route 53 别名记录，看似独立 A 记录实际指向共享端点
- TLS 握手时客户端发送 Client Hello 消息，包含服务器名称
- 服务端解析 SNI 值识别目标集群
- SNI 是 TLS 功能（非 PostgreSQL），PostgreSQL 14+ 已集成

23:00 - 25:00 - Firecracker 微虚拟机隔离
- 共享 QP 存在安全风险：恶意客户可能利用 PostgreSQL 漏洞突破进程隔离
- AWS 要求硬件级虚拟化而非进程或容器隔离
- 采用 Lambda 团队开发的 Firecracker 技术
- 提供微虚拟机 (microVM)，类似 EC2 实例但资源占用更少
- 毫秒级启动，最小开销
- 单台主机可运行数百个微虚拟机

25:00 - 28:00 - 预热池 (Warm Pool) 优化
- Agent 提前创建 VM 到预热池
- 连接到达时直接从池中取出 QP
- 内存操作，类似链表弹出 + TCP 连接建立
- 速度快，开销小
- Agent 后台补充预热池

### 内存优化技术 (28:00 - 33:00)

28:00 - 30:00 - PostgreSQL Fork 内存共享
- 传统 PostgreSQL：服务器进程占用数百 MB 内存
- Fork 后端进程时，操作系统使用指针共享未修改的物理内存页
- 多个连接可共享相同物理页，显著降低开销
- 每个连接的独特工作（查询、排序、聚合）使用独立内存页

30:00 - 32:00 - Firecracker 内存挑战
- 每个 VM 运行完整 Linux 操作系统
- 包含 PostgreSQL 服务器和监控、管理、日志等附加服务
- 单个 VM 占用约 700 MB 内存
- 多个 VM 快速累积到数 GB

32:00 - 33:00 - Snapstart 技术
- Lambda 团队开发的技术
- 创建"种子" VM：启动 Linux、启动 PostgreSQL、准备就绪
- 暂停 VM 并将所有内存页写入磁盘文件 (mem file)
- 从快照克隆新 VM，内存布局完全相同
- 使用内存映射，新 VM 只是指向原始快照的指针
- 多个 VM 共享相同快照数据，只为独特工作付费

### Relay 服务与认证 (33:00 - 42:00)

33:00 - 34:30 - Relay 服务介绍
- 运行在负载均衡器后的服务
- 使用 Rust 从零构建
- 使用 S2N 库确保安全性
- 处理 TLS 握手和解析 SNI 值
- 接收应用的认证令牌

34:30 - 37:30 - 认证令牌机制
- 类似 S3 的 Signature Version 4 算法
- SDK 签名请求防止篡改，识别调用者身份
- 类似 S3 预签名 URL 的概念
- DSQL SDK 生成认证令牌（纳秒级快速）
- 与 RDS IAM 认证使用相同机制
- 每个连接请求生成一次令牌

37:30 - 39:00 - IAM 集成
- 与 IAM 数据平面集成
- 获取账户密钥、策略和标签
- Relay 高效缓存，本地完成认证授权
- 建立 AWS 身份，执行策略（如标签限制、IP 限制、PrivateLink 要求）
- 登录尝试写入 CloudTrail

39:00 - 42:00 - Placement 服务与 TLS 会话迁移
- Placement 服务跟踪整个机群
- 为应用建议合适的 QP
- Relay 将连接发送到选定的 QP
- **TLS 会话迁移**：完成初始握手和认证后，Relay 将 TLS 会话移入沙箱
- 将临时加密密钥打包并安全发送到 QP
- Relay 清零内存，无法再解码连接内容
- 这是关键安全特性：Relay 只处理必要的复杂协议解析，之后由 PostgreSQL 处理

### Placement 服务详解 (42:00 - 结束)

42:00 - 44:00 - Placement 服务职责
- 演讲在此处字幕截断，但从上下文推断：
- Placement 服务负责智能选择 QP
- 考虑负载均衡、可用区分布、资源利用率
- 动态管理 QP 池的扩展和收缩
- 确保高可用性和性能

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


总结：本次演讲深入剖析了 Aurora DSQL 如何通过创新架构设计解决传统关系数据库的扩展性和可用性挑战，特别是在连接管理、安全隔离和性能优化方面的技术突破。