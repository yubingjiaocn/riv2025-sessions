# AWS re:Invent 2025 - Amazon Aurora DSQL 架构深度解析

## 会议概述

本次会议是 AWS re:Invent 2025 的技术深度解析会议（DAT439），由 DSQL 团队工程师 Marc 主讲。会议深入探讨了 Amazon Aurora DSQL 的连接管理、查询处理器架构以及会话路由层的设计原理。DSQL 是一个基于 Postgres 的分布式关系数据库服务，旨在解决传统关系数据库在扩展性、可用性和管理复杂性方面的挑战。

会议重点介绍了 DSQL 如何通过创新的架构设计实现无服务器、强一致性的分布式数据库服务。Marc 详细解释了 DSQL 的核心组件包括查询处理器（Query Processor）、日志服务（Journal）和存储服务（Storage），以及它们如何协同工作提供高性能的数据库服务。会议还深入分析了连接管理的技术实现，包括使用 Firecracker 微虚拟机技术实现安全隔离，以及通过智能路由和连接池技术优化性能。

## 详细时间线与关键要点

### 0:00-5:00 - 会议开场与 DSQL 概述
- Marc 介绍会议主题：Aurora DSQL 架构深度解析
- 回顾去年同名会议的广泛概述，今年聚焦具体架构领域
- DSQL 定位：结合关系数据库和分布式系统优势的服务
- 基于 Postgres 构建，支持事务性工作负载
- 客户需求：完全无服务器的数据库服务，按使用付费

### 5:00-10:00 - DSQL 创建体验与核心架构
- 展示 DSQL 集群创建界面的简洁性：5秒内完成创建
- 无需预先配置维护窗口、VPC 设置等复杂参数
- 介绍查询编辑器：基于 WebSocket 的 Postgres 应用
- 核心架构三大组件：
  - 查询处理器（Query Processor）：接收 Postgres 协议和 SQL 语句
  - 日志服务（Journal）：分布式事务日志，提供持久性保证
  - 存储服务（Storage）：专为 DSQL 性能需求构建的存储系统

### 10:00-15:00 - 数据处理流程与一致性保证
- SQL Select 语句处理：QP 解析、规划、执行查询并转换为存储读操作
- DML 操作处理：插入数据驻留在 QP 内存中，更新操作先读取现有值
- 事务提交流程：数据发送到日志服务，写入至少两个可用区
- 强一致性实现：
  - 使用 EC2 Time Sync Service 获取微秒级精确时间
  - AWS ClockBound Service 校正时间测量误差
  - 线性化时间戳保证存储始终看到最新数据

### 15:00-20:00 - 多连接支持与扩展机制
- 多连接强一致性：不同 QP 可运行在不同主机、可用区甚至区域
- Active-Active 架构：任何 QP 都可更新数据
- 仲裁器（Adjudicator）协调并发控制
- 乐观并发控制（OCC）技术实现
- 自动扩展机制：
  - 使用最新快照创建存储克隆
  - 智能负载均衡跨副本分配
  - 透明分片实现日志层扩展

### 20:00-25:00 - 传统 Postgres 连接挑战
- 标准 Postgres 连接模型：fork 进程为每个连接创建专用进程
- 扩展过程中面临的问题：
  - 安全性挑战：暴露在互联网上的风险
  - 连接池需求：避免连接建立延迟
  - 峰值平均比问题：需要更大连接池应对突发流量
  - 实例大小限制：连接数与内存的权衡

### 25:00-30:00 - 高可用性与读扩展挑战
- 单点故障问题：单一写入节点的可用性风险
- 故障转移复杂性：需要30秒以上的停机时间
- 读副本扩展：
  - 需要配置读端点和流量分割
  - 最终一致性带来的应用复杂性
  - 负载均衡需要排除落后的副本
- DSQL 解决方案：Active-Active 架构消除单点故障

### 30:00-35:00 - 共享端点架构设计
- 设计决策：使用共享端点而非每集群专用端点
- SNI（Server Name Indication）技术应用：
  - 利用 TLS 特性识别目标集群
  - Route 53 别名记录实现集群端点
  - Client Hello 消息中提取服务器名称
- Postgres 14+ 版本集成 SNI 支持
- 硬件级虚拟化隔离：使用 Firecracker 微虚拟机

### 35:00-40:00 - Firecracker 与内存优化
- 安全隔离需求：硬件级虚拟化而非进程级隔离
- Firecracker 微虚拟机特性：毫秒级启动，最小开销
- 预热池（Warm Pool）机制：提前创建数百个虚拟机
- SnapStart 技术：
  - 种子虚拟机创建和快照保存
  - 内存页面共享减少内存开销
  - 克隆虚拟机快速启动

### 40:00-45:00 - 连接路由与定价模型
- Relay 服务：Rust 构建的 TLS 处理服务
- 认证令牌机制：基于 SigV4 的 IAM 集成
- 放置服务（Placement Service）：智能 QP 分配
- TLS 会话迁移：加密密钥安全传输到 QP
- 连接池机制：按集群分组的 QP 池
- 定价模型：
  - 分布式处理单元（DPU）：计算、读取、写入分别计费
  - 存储按 GB-小时计费
  - 活动基础定价：无活动时仅支付存储费用

### 45:00-45:48 - 总结与优势
- 连接安全性：微虚拟机隔离和端到端加密
- 连接可扩展性：按需扩展，按使用付费
- 连接简单性：无需维护、补丁或代理服务
- 连接性能：可用区本地路由和预热连接池
- 系统无单点故障，支持大规模重连