# AWS re:Invent 2025 - FSX for NetApp ONTAP 迁移实践总结

## 会议概述

本次分享由纽约时报的 Aric Kinatki 主讲，详细介绍了他们团队成功将大量 SMB 共享和 NFS 共享迁移到 Amazon FSX for NetApp ONTAP 的实践经验。演讲涵盖了从规划设计到实施部署的完整迁移流程，重点强调了数据评估、容量规划和性能层设计的重要性。

纽约时报原本在多个平台上运行文件共享服务，包括 Isilon 存储和 Windows 文件服务器。通过迁移到 FSX for NetApp ONTAP，他们成功整合了复杂的存储环境，实现了约 70% 的成本节省。这一显著的成本优化主要得益于数据去重、压缩技术以及自动分层功能，将冷数据自动迁移到成本更低的 S3 容量层。演讲者特别强调了 SSD 性能层的正确设计是迁移成功的关键因素，如果设计不当可能导致写入失败。

整个分享以一个包含 9 个共享的虚拟项目为例，详细说明了如何根据数据特征、高可用性需求、RPO/RTO 要求等因素将共享整合为 5 个卷，并提供了具体的容量计算方法和迁移步骤。

## 详细时间线与关键要点

00:00:00 - 开场介绍
- AWS 的 Jim White 介绍演讲嘉宾
- Aric Kinatki 来自纽约时报，分享 FSX for NetApp ONTAP 的部署经验

00:01:30 - 迁移背景与会议议程
- 迁移目标：将 SMB 和 NFS 共享从 Isilon、Windows 文件服务器迁移到 FSX
- 会议内容：设计部署、迁移收益、挑战和未来规划

00:02:45 - 数据评估的重要性
- 强调必须了解数据的关键属性
- 需要收集每个共享的利用率信息
- 区分热数据（30 天内活跃）和冷数据
- 热数据将存储在 SSD 性能层，冷数据存储在容量层

00:04:00 - 数据类型与数据保护
- 了解数据类型以预测去重和压缩效果
- 确定高可用性需求（是否需要多可用区部署）
- 定义 RPO（恢复点目标）以设置快照和备份策略
- 识别需要跨区域灾难恢复的卷

00:05:30 - 示例项目数据收集
- 虚拟项目包含 9 个共享（S1-S9）
- 收集热数据和冷数据的容量信息
- 使用第三方工具、PowerShell 或 Robocopy 识别活跃数据
- 实际热数据通常只占总数据的 10-20%

00:07:00 - 共享分组与需求分析
- 9 个共享属于 3 个不同部门
- 每个共享有不同的 HA 和 DR 需求
- RPO 要求从 1 小时到 24 小时不等
- 例如：S1（ISO 镜像）不需要复制

00:08:30 - 卷容量设计方法
- 按属性对共享进行分组
- 快照和备份策略基于卷而非共享
- 卷大小 = 数据大小 + 快照预留（20%）+ 年增长预期（20%）
- 设置自动增长上限（例如 150%）

00:10:00 - 卷整合结果
- 将 9 个共享整合为 5 个卷
- 卷大小范围从 140 GB 到 5 TB
- 基于当前利用率、快照需求和增长预期计算

00:11:30 - 数据流与 SSD 层的关键性
- 迁移期间数据首先写入 SSD 层
- 在 SSD 层进行去重和压缩
- 然后数据移动到容量层（S3）
- SSD 性能层是 FSX 的关键组件

00:13:00 - SSD 层设计算法
- 如果 SSD 层设计不当，可能无法写入数据
- 演讲者提出的算法：SSD 大小 = 所有热数据总和 + 50%
- 需要 50% 的可用空间以触发自动分层
- 自动分层在 SSD 使用率超过 51% 时触发

00:15:00 - 存储效率与备份考虑
- 必须为存储效率操作预留 SSD 空间
- 备份恢复时数据流更快，可能使 SSD 过载
- 正确设计后，SSD 利用率峰值不会超过 70-80%

00:16:30 - FSX 架构配置
- 在两个区域部署 FSX
- 生产区域使用多可用区（Multi-AZ）配置
- 灾难恢复区域使用单可用区以节省成本
- 创建 5 个卷并启用存储效率

00:18:00 - 迁移步骤：初始设置
- 构建 FSX 环境并定义 SSD 层
- 创建卷并启用存储效率
- 初始迁移时设置自动分层策略为"全部"（All）
- 所有数据直接进入 S3，SSD 仅用于数据效率处理

00:19:30 - 迁移步骤：初始同步
- 此阶段不创建快照
- 使用 rsync、Robocopy 或第三方工具进行初始数据复制
- 完成初始复制后再进行后续配置

00:21:00 - 迁移步骤：启用自动分层
- 初始复制完成后启用自动分层
- 所有数据已在 S3，现在将热数据移到 SSD
- 热数据将保留在 SSD 层
- 30 天后未访问的数据自动移回容量层

00:22:30 - 快照与备份配置
- 启用快照功能
- FSX 快照与 Windows 卷影复制集成
- 用户可以在 Windows 中看到以前的版本
- 备份是 FSX 级别的全局设置，不是按卷设置

00:24:00 - 备份策略注意事项
- 备份配置适用于整个 FSX，而非单个卷
- 如果不同卷有不同备份需求，应使用 AWS Backup
- 或者创建多个 FSX 实例

00:25:00 - 跨区域复制
- 设置源和目标之间的复制
- 推荐使用 BlueXP 进行配置管理
- BlueXP 使复制设置变得简单

00:26:00 - 切换过程（Cutover）
- 切换是最痛苦的任务
- 如果使用 DFS 命名空间（DFSN），可以逐个共享切换
- 如果使用 CNAME，切换会比较复杂
- 需要计算最后 24 小时增量数据的同步时间

00:27:30 - 切换最佳实践
- 估算停机时间
- 在最后同步前将源设置为只读
- 同步数据后再切换到读写模式

00:28:30 - 迁移收益总结
- 消除了当前解决方案的复杂性
- 统一管理界面（单一管理平台）
- 成本优化：总成本降低约 70%
- 得益于去重、压缩和自动分层到 S3

00:30:00 - 成本对比：Windows 文件服务器 vs FSX
- 原有 9 台服务器（包括 HA 配置）
- 迁移后从 9 个 EC2 实例减少到 4 个
- 节省 5 个 EC2 实例的成本

00:31:30 - 存储成本对比
- EBS 卷使用厚配置（thick provisioning）
- FSX 使用精简配置（thin provisioning）
- 厚配置按分配容量付费，而非实际使用量
- FSX 支持 S3 分层，显著降低存储成本

00:33:00 - 挑战：卷设计
- 卷设计很复杂，没有黄金法则
- 必须了解数据特征
- 根据 RPO、RTO、快照和备份需求对共享进行分组
- SSD 性能层容量设计至关重要

00:34:30 - 挑战：利益相关者协调
- 与利益相关者协调非常困难
- 很难在生产时间内安排停机时间
- 需要找到合适的维护窗口

00:35:30 - 监控要求
- 设置适当的监控至关重要
- 性能层利用率监控：70% 为警告，90% 为告警
- CPU 利用率监控（特别是大量数据传输时）
- 可能需要根据数据量调整 CPU 大小
- 延迟监控也很重要

00:37:00 - FSX for ONTAP 的优势
- 跨可用区高可用性（A1、A2）
- 自动分层功能
- 数据去重和压缩
- 与 Windows DFS 命名空间集成
- 灾难恢复能力
- 出色的勒索软件保护

00:38:00 - 更多优势特性
- 快照与 Windows 以前版本集成
- Windows ACL 支持
- 可扩展的性能
- 静态加密
- 多协议支持（SMB 和 NFS）

00:39:00 - 总结与建议
- 必须了解你的数据
- 考虑所有变量以满足 SLA（特别是 RPO 和 RTO）
- 使用 BlueXP 管理 FSX 环境
- 关注勒索软件保护功能
- 参加所有 FSX 相关会议以深入了解产品

00:40:00 - 结束语
- 感谢听众参与
- 推荐参加更多 FSX 相关会议
- FSX for NetApp ONTAP 是一个出色的产品