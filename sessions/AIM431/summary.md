# AWS re:Invent 2025 - Agent Core 深度解析

## 会议概述

本次技术分享由 AWS 副总裁兼杰出工程师 Mark Brooker 主讲，深入探讨了 AWS Agent Core 的架构设计与核心功能。Mark Brooker 专注于 Agentic AI 及其基础设施的开发工作，在演讲中详细介绍了 AI Agent 的内部工作原理以及如何将 Agent 成功部署到生产环境中。

演讲从一个看似荒谬但极具教学意义的例子开始——计算"Strawberry"中字母 R 的数量、获取当前时间和西雅图室外温度，然后进行复杂的数学运算。通过这个例子，Mark 展示了 AI 模型的能力边界：模型可以独立完成某些封闭性问题，但对于需要实时数据或高精度数学计算的任务，则必须依赖工具调用（tool calls）。这正是 Agent 的核心价值所在——通过循环执行推理和工具调用来实现目标。

Agent Core 是 AWS 为构建生产级 AI Agent 而打造的完整基础设施平台，包含运行时环境、网关、内存管理、身份认证等核心组件。该平台的设计理念是提供强隔离的安全环境、无服务器的可扩展性，以及精细化的授权控制。特别值得关注的是，Agent Core 采用了神经符号 AI（neurosymbolic AI）技术，将神经网络的灵活性与符号推理的精确性相结合，为 Agent 安全性提供了数学级别的保障。

## 详细时间线与关键要点

### 开场与背景介绍
[00:00 - 02:30]
- Mark Brooker 自我介绍，担任 AWS 副总裁兼杰出工程师，主要工作聚焦于 Agentic AI 和 Agent Core 基础设施
- 提及当天早上 Matt 的主题演讲中发布的多项激动人心的产品
- 演讲大纲：Agent 内部机制、生产环境所需组件、运行时、内存、网关、评估以及神经符号工作

### AI Agent 内部工作原理
[02:30 - 08:00]
- 通过"Strawberry 问题"示例说明 Agent 的工作流程：
  - 计算 Strawberry 中 R 的数量（模型可独立完成）
  - 获取当前时间（可通过系统提示词提供）
  - 获取西雅图室外温度（需要工具调用）
  - 执行复杂数学运算（需要工具调用）
- Agent 定义：接收目标，在 AI 模型推理和工具调用之间循环，最终实现目标
- 现代 Agent 越来越多地包含代码组件，用于提高可靠性、降低延迟和成本

### Strands 框架实现示例
[08:00 - 12:00]
- 介绍 Strands Agent 框架（AWS 内部开发，用于构建基础 Agent）
- 展示代码示例：使用 @tool 装饰器定义工具，包括工具描述和实现
- 强调 Agent Core 支持任何 AI 框架（LangChain、自定义 SDK 等）
- Strands 的灵活性：可构建从单一提示词到复杂硬编码工作流的各类 Agent

### Bedrock API 层面的深入分析
[12:00 - 18:00]
- 详细展示 Bedrock API 调用过程：
  - 第一次调用：发送目标、工具规范和系统提示词
  - 模型响应：请求工具调用（如 get_weather_fact）
  - 第二次调用：包含完整对话历史和工具调用结果
- 指出请求内容不断增长的问题（N 平方复杂度），但有技术可以优化
- 强调安全挑战：带内信号传输（inband signaling）可能导致控制信号与用户内容混淆
- 平均需要 3.5 轮推理循环完成任务，存在非确定性

### 生产环境核心组件
[18:00 - 22:00]
- 使用更实际的例子：根据天气、积雪和河流水位决定滑雪或划船
- Agent Core 核心组件介绍：
  - **Runtime（运行时）**：安全运行 Agent 代码的地方，每个会话使用独立的硬件支持虚拟机
  - **Gateway（网关）**：连接 Agent 与工具（天气 API、停车预订 API 等）
  - **Memory（内存）**：跨会话记忆用户偏好
  - **Identity（身份）**：连接用户身份到工具，支持 OAuth 流程
  - **Browser Use（浏览器使用）**：自动化网站交互
  - **Code Interpreter（代码解释器）**：安全运行代码的隔离环境

### Agent Core Runtime 深度解析
[22:00 - 30:00]
- Runtime 集成示例：添加 @app 入口点注解，传入网关 URL 和配置
- 支持多轮对话：相同 session ID 返回同一 VM，不同 session ID 获得新的隔离 VM
- Runtime 设计原则：
  - **无服务器（Serverless）**：无需管理基础设施
  - **可扩展（Scalable）**：自动伸缩
  - **安全（Secure）**：强隔离保护
  - **细粒度自动化（Fine-grained automation）**：精确控制
- 基于 Firecracker 微虚拟机管理程序（2018 年发布，支持 Lambda、DSQL 等服务）
- 提供毫秒级虚拟机启动速度和会话级隔离

### 定价模型与成本优化
[30:00 - 33:00]
- 基于忙碌时间（busy time）计费，而非总运行时间
- Agent 等待用户输入或工具调用时，不收取 CPU 费用
- 成本降低约 20 倍（在空闲等待期间）
- 对于需要等待人类响应或长时间工具调用的 Agent 具有巨大成本优势

### 隔离模型的优势
[33:00 - 37:00]
- 每个会话独立 VM 的安全优势：
  - 防止提示词注入攻击
  - 防止跨会话数据泄露
  - 即使存在远程代码执行漏洞也无法访问其他会话
- 简化 Agent 代码开发：
  - 无需考虑多租户问题
  - 无需多线程处理
  - 无需传播身份和清理变量
- 支持任何框架、库、语言（Python、Rust 等）
- 可以创建新进程、派生线程，完全灵活

### Memory（内存）功能
[37:00 - 42:00]
- 问题场景：用户告诉 Agent"我不喜欢披萨"，第二天 Agent 却推荐披萨店
- 用户偏好内存（User Preference Memory）：
  - 自动提取对话中的用户偏好
  - 在后续会话中提供这些偏好信息
  - 处理用户隔离、管道设置、模型提示、重试等
- 配置示例：检索时最多返回 5 个最相关的事实，设置相关性过滤阈值
- 内存提取在后台异步进行（1-2 秒），下次对话时自动应用

### Gateway（网关）与工具调用
[42:00 - 50:00]
- 工具调用是 Agent 实用性的核心：没有工具调用，Agent 无法与外部世界交互
- Gateway 功能：
  - 简化工具连接设置
  - 工具策展（tool curation）
  - 可控性和可审计性
  - 策略设置
- 连接对象：微服务、数据库、存储、SaaS 应用、其他 Agent
- 支持 MCP 客户端、OpenAPI 客户端等多种协议

### 工具策展的重要性
[50:00 - 55:00]
- 反模式：向 Agent 提供组织内所有工具（如 1000 个工具）
- 类比：如同给人类一个装有 1000 个工具的工具箱，仅凭标签选择合适工具
- 数据对比实验（乘法任务）：
  - 模型自己做数学：更少 token、更低延迟，但成功率仅 40%
  - 提供乘法工具：更多 token、更高延迟，但成功率 100%
- 结论：工具策展不是最小化工具数量，而是提供"正确的"工具集合
- Gateway 提供便捷的工具策展、测试和 A/B 测试能力

### 神经符号 AI 与 Policy（策略）
[55:00 - 65:00]
- AWS 十多年来在自动化和形式化推理方面的投资
- 神经符号 AI：结合神经网络方法与符号推理方法
- Agent Core Policy 基于神经符号 AI 技术
- 去年 re:Invent 发布的 Bedrock Automated Reasoning Guardrails 使用类似技术
- Policy 功能：
  - 在 Gateway 内部层，以数学确定性定义 Agent 允许的操作
  - 区分"Agent 允许说什么"（使用 Bedrock Guardrails）和"Agent 允许做什么"（使用 Policy）

### Cedar 策略语言
[65:00 - 72:00]
- 使用 Cedar 策略语言实现 Policy
- Cedar 特点：
  - 强大且富有表现力
  - 形式化验证的实现
  - 策略组合的明确语义
- 简单授权示例：限制工具调用仅对特定 OAuth 主体可用
- 无需修改工具或 Agent 代码即可附加到 Gateway
- 安全团队可审计所有策略及其组合效果

### 详细策略示例
[72:00 - 76:00]
- 天气 API 限制示例：
  - Agent 设计用于获取西雅图天气数据
  - 策略限制：天气服务 API 只能查询华盛顿州（或进一步限制为西雅图）
  - 无论用户如何操作（提示词注入、远程代码执行等），Agent 都无法查询其他地区天气
- 强调：这是控制 Agent 行为的强大方式，无需在每个工具中实现细粒度授权

### Agent 安全架构（"盒子"模型）
[76:00 - 82:00]
- 安全架构设计理念：将 Agent 放入"盒子"中
- 架构示例：
  - 两个 Agentic 应用，一个包含两个 Agent，另一个包含 Agent 和内存
  - 每个应用有自己的 Gateway 和 Policy 层
  - Policy 层定义应用可访问的工具和调用权限
- Gateway 使用模式：
  - 不是为每个工具前面放置 Gateway（类似 API Gateway）
  - 而是为每个应用/Agent 集合关联一个 Gateway
- 隔离机制：
  - Agent 运行在独立虚拟机中
  - 只能通过 Gateway 与外界通信
  - 会话结束后内存和存储被安全擦除
- 结果：构建了一个围绕 Agent 的"盒子"，只需关注其对外部世界的影响

### 总结与展望
[82:00 - 结束]
- Agent Core 提供了完整的生产级 Agent 基础设施
- 核心优势：强隔离、无服务器、精细控制、数学级安全保障
- 神经符号 AI 技术的应用是重大技术突破
- 明天将有 500 级别的深度技术分享，深入到内存页级别讲解 Firecracker 工作原理

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


关键技术亮点：
- Firecracker 微虚拟机提供毫秒级启动和会话级隔离
- 基于忙碌时间的定价模型可降低约 20 倍成本
- Cedar 策略语言提供形式化验证的安全保障
- 神经符号 AI 结合了灵活性和精确性
- 完整的"盒子"安全模型确保 Agent 行为可控