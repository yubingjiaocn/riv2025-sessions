# AWS re:Invent 2025 会话总结：ISV 客户数据加密与密钥管理

## 会话概述

本次技术会话由 AWS 首席解决方案架构师 Peter O'Donnell 和 Jen Reid 主讲，重点探讨了独立软件供应商（ISV）如何使用 AWS Key Management Service (KMS) 保护客户数据。会话强调了一个核心原则：**客户数据应该由客户密钥保护**。这不仅是技术要求，更是建立信任、满足合规性和数据主权需求的关键。

演讲者详细介绍了"自带密钥"（BYOK）的演变历程，从最初的导入密钥材料功能到现在的跨账户密钥共享机制。会话特别强调了 ISV 需要为客户提供透明的密钥使用审计能力（通过 CloudTrail）、即时撤销访问的"大红按钮"功能，以及独立的密钥生命周期管理能力。这些能力已经成为企业级客户的基本采购要求。

第二部分通过实际的 Java 代码示例，展示了如何使用 AWS Encryption SDK 实现多租户环境下的分层密钥管理。演示包括了租户密钥的创建、在 DynamoDB 中的存储、密钥轮换机制，以及如何同时支持多租户和单租户两种部署模式，为不同安全需求的客户提供灵活的解决方案。

## 详细时间线与关键要点

### 开场与背景介绍 (00:00 - 05:30)
- **00:00** - 会话开始，Peter O'Donnell 介绍自己在 AWS 工作 10.5 年，这是他第 12 次参加 re:Invent
- **01:15** - 强调 ISV 处理客户数据的特殊责任和信任契约
- **02:30** - 介绍核心主题：如何保护数据、密码学的作用，以及密钥管理的演变历程
- **03:45** - 说明会话结构：从密钥管理历史到实际代码实现

### BYOK 概念演变 (05:30 - 10:00)
- **05:30** - 解释"BYOK"术语被重载的历史背景
- **06:15** - 介绍最初的 BYOK 功能：导入密钥材料（Import Key Material）
- **07:00** - 强调"大红按钮"功能的重要性：客户可以立即删除密钥材料但保留 CMK 结构
- **08:20** - 明确当前 BYOK 的主要含义：客户使用自己的密钥材料保护自己的数据
- **09:30** - 强调这是高阶原则：客户数据应由客户密钥保护

### 客户需求与动机 (10:00 - 18:00)
- **10:00** - 以 Slack 为例说明早期采用 BYOK 的 ISV
- **11:30** - 解释客户对 BYOK 的四大需求：
  - 使用自己的密钥保护数据
  - 拥有"大红按钮"立即撤销访问
  - 获得使用密钥的可观察性和审计能力
  - 控制密钥生命周期
- **13:00** - 介绍 CloudTrail 的跨账户日志记录功能：ISV 和客户都能看到密钥使用记录
- **14:30** - 讨论合规性和数据主权的重要性
- **16:00** - 分享大型银行客户案例：10 年前就要求云端数据全面加密
- **17:15** - 强调这已成为"基本要求"（table stakes），不支持将影响销售

### KMS 技术优势 (18:00 - 23:00)
- **18:00** - 说明客户普遍信任 AWS KMS
- **19:00** - 介绍 KMS 的 FIPS 140-3 Level 3 认证
- **20:15** - 强调 KMS 的灵活性和与 AWS 托管服务的集成
- **21:00** - 介绍 AWS Encryption SDK：支持数据库和通用加密场景
- **22:00** - 说明 KMS 解决了"无差异化繁重工作"：扩展性、高可用性（99.999% SLA）
- **22:45** - 介绍 KMS 的自动密钥轮换功能

### KMS 架构类型 (23:00 - 28:00)
- **23:00** - 介绍 KMS 的分层架构：API 层和密钥存储层
- **24:00** - 标准 KMS：密钥在多租户 HSM 中生成和使用（推荐方案）
- **25:00** - 强调 HSM 是定制设计的，整个设备都经过 FIPS 验证
- **25:45** - 导入 CMK：客户可以导入自己的密钥材料
- **26:30** - Custom Key Store：使用单租户 CloudHSM 连接到 KMS API
- **27:15** - XKS (External Key Store)：支持"持有自己的密钥"（HYOK），密钥存储在客户自己的数据中心
- **27:50** - 警告：不建议使用 XKS，因为会带来扩展性和可用性问题

### 加密基础知识 (28:00 - 33:00)
- **28:00** - 加密入门：加密数据很简单，管理密钥才是难点
- **29:00** - 介绍信封加密（Envelope Encryption）概念
- **29:45** - 解释数据加密密钥（DEK）的包装过程
- **30:30** - 说明加密的 DEK 应与加密数据存储在一起
- **31:15** - 回答"密钥的密钥怎么办"的问题：KMS 负责处理密钥层次结构的其余部分
- **32:00** - 介绍完整的密钥层次结构，最终以物理打印的密钥作为备份
- **32:45** - 强调信封加密是 AWS 的标准模式，ISV 也应采用

### 跨账户密钥共享实现 (33:00 - 40:00)
- **33:00** - 介绍三种密钥共享方式
- **34:00** - 方式一：跨账户资源共享（推荐）：通过密钥策略授权 ISV 服务主体
- **35:15** - 明确不建议通过假设客户角色来访问密钥
- **36:00** - 警告：不要在 ISV 账户中为每个客户创建密钥，这不是真正的 BYOK
- **37:00** - 展示密钥策略示例：仅授予加密、解密、生成数据密钥和描述密钥的权限
- **38:00** - 强调**最小权限原则**：不要请求 Disable、PutKeyPolicy、ScheduleKeyDeletion 等权限
- **39:00** - 建议提供 JSON 模板、CloudFormation 或 Terraform 模板简化客户入门流程

### 数据密钥代理模式 (40:00 - 45:00)
- **40:00** - 介绍简单场景：S3 对象加密只需指定密钥 ARN
- **41:00** - 介绍复杂场景：多租户数据库需要数据密钥代理（Data Key Broker）模式
- **42:00** - 解释分层密钥结构：KMS 密钥 → 客户密钥 → 数据密钥
- **43:00** - 讨论密码学磨损（Crypto Wearout）问题：不应使用单一 DEK 加密海量数据
- **44:00** - 展示数据密钥代理的工作流程图

### AWS Encryption SDK 介绍 (45:00 - 50:00)
- **45:00** - 介绍 Encryption SDK 解决的问题：如何正确实现客户端加密
- **46:00** - SDK 特性：开源、专家编写、支持多种语言（Java、Python 等）
- **47:00** - 介绍消息格式和多区域弹性支持
- **48:00** - 说明两种 SDK：通用 ESDK 和数据库专用 ESDK（特别针对 DynamoDB）
- **49:00** - 强调 SDK 的可移植性和多密钥提供商支持
- **49:45** - 介绍自动将加密数据和包装密钥存储在一起的功能

### 代码演示开始 (50:00 - 55:00)
- **50:00** - Jen Reid 接手演示，展示 Java 应用程序"Beer Store"
- **51:00** - 介绍分层密钥环（Hierarchical Key Ring）的实现
- **52:00** - 展示租户数据密钥的创建过程
- **53:00** - 强调每个租户获得独立的 KMS ID、客户端 ID 和凭证
- **54:00** - 说明多租户环境中密钥独立管理的重要性

### 租户生命周期管理代码 (55:00 - 62:00)
- **55:00** - 展示租户入门流程：创建分支密钥（Branch Key）和凭证
- **56:30** - 演示租户离线流程：密钥在 DynamoDB 中缓存，默认 15 分钟后过期
- **57:45** - 展示密钥轮换代码：每个客户可以独立管理轮换周期
- **59:00** - 介绍多租户密钥环实现：同时处理多个租户数据
- **60:00** - 强调数据隔离：每个数据流只能被对应的加密密钥读取
- **61:00** - 展示单租户模式：支持要求独立处理的客户

### DynamoDB 集成代码 (62:00 - 68:00)
- **62:00** - 展示 DynamoDB 数据密钥代理的设置
- **63:00** - 说明如何在 DynamoDB 中协调每个租户的密钥
- **64:00** - 展示密钥轮换时中间密钥的设置
- **65:00** - 演示密钥 ID、分支 ID 和加密上下文的配置
- **66:00** - 介绍凭证提供商的调用方式
- **67:00** - 详细解释缓存时间参数：默认 15 分钟，可调整为 5 分钟或 1 分钟

### 缓存策略讨论 (68:00 - 72:00)
- **68:00** - 解释缓存时间与删除延迟的关系
- **69:00** - 说明更短的缓存时间意味着更频繁的 DynamoDB 查询
- **70:00** - 建议根据应用需求平衡缓存时间和删除响应速度
- **71:00** - 提出混合方案：大多数客户使用多租户模式（较长缓存），特殊客户使用单租户模式（较短缓存）

### KMS 客户端配置 (72:00 - 75:00)
- **72:00** - 展示 KMS 客户端代码
- **73:00** - 演示如何使用 SDK 设置独立的 KMS 密钥
- **74:00** - 说明服务客户端在应用运行时的使用方式
- **74:30** - 提及 Slack、Zoom 等客户使用类似概念

### 总结与问答 (75:00 - 结束)
- **75:00** - 强调关键点：让客户适当地提供 KMS 访问权限
- **75:30** - 说明客户不需要手动插入 ARN，应通过应用界面配置
- **76:00** - 会话结束，开放问答

## 核心技术要点

1. 信封加密模式：数据密钥加密数据，KMS 密钥加密数据密钥
2. 跨账户密钥共享：通过密钥策略授权，避免角色假设
3. 最小权限原则：仅请求加密操作权限，不要管理权限
4. 分层密钥管理：KMS → 租户密钥 → 数据密钥的三层结构
5. 多租户与单租户灵活支持：根据客户需求选择部署模式
6. 缓存策略优化：平衡性能和安全响应速度