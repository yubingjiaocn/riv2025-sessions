# AWS re:Invent 2025 技术分享会总结

## 会议概述

本次技术分享会由两位AWS ElastiCache团队的首席工程师Alad和Kevin主讲,重点介绍了如何使用Valkey（ElastiCache支持的开源键值存储）实现向量相似性搜索功能。会议通过构建一个视频采样和搜索应用程序的实际演示,展示了Valkey在处理向量嵌入、图像去重和多模态搜索方面的能力。

演讲分为两个主要部分:首先由Alad介绍Valkey向量搜索的工作原理、架构设计和扩展策略;随后由Kevin进行现场编码演示,展示如何使用AWS Bedrock的Titan嵌入模型、Lambda函数和Valkey构建完整的视频分析和搜索系统。该应用能够自动提取视频帧、生成向量嵌入、执行去重处理,并支持通过文本或图像进行相似性搜索。

整个演示强调了Valkey作为低延迟、高吞吐量向量数据库的优势,特别适合实时流分析等场景。系统架构采用了多个AWS服务的组合,包括S3存储帧数据、DynamoDB存储元数据、Lambda处理业务逻辑,以及Valkey存储和检索向量嵌入,展现了云原生应用的最佳实践。

## 详细时间线

### 开场介绍 (00:00 - 02:30)
- **00:00** - Alad和Kevin自我介绍,两人均为ElastiCache团队的首席工程师
- **00:30** - 说明会议结构:Alad讲解向量搜索原理,Kevin进行代码演示
- **01:00** - 介绍将构建的应用:视频采样和搜索系统

### Valkey向量搜索工作原理 (02:30 - 08:00)
- **02:30** - 介绍VSS(向量相似性搜索)支持的两种数据类型:哈希映射和JSON文档
- **03:00** - 解释索引定义和模式创建流程
- **03:30** - 说明数据变更的同步机制:主线程处理请求,工作线程异步索引
- **04:00** - 强调同步API的优势:用户可以立即读取自己的写入
- **05:00** - 介绍查询处理机制:查询引擎使用专用工作线程,扇出到所有分片
- **06:00** - 解释结果聚合和数据enrichment流程

### Valkey扩展架构 (08:00 - 12:00)
- **08:00** - 介绍数据摄入的扩展方式:增加分片可提高摄入速率
- **09:00** - 说明主节点和副本节点的索引同步机制
- **10:00** - 解释查询扩展的不同策略:增加分片不会提高查询吞吐量
- **10:30** - 推荐通过增加副本数量来提高查询并发能力
- **11:00** - 建议通过扩展实例类型(更多CPU核心)来提升性能

### 应用架构设计 (12:00 - 18:00)
- **12:00** - 介绍Web应用的两个主要部分:摄入和查询
- **13:00** - 说明Valkey在系统中的核心作用:连接摄入和查询流程
- **14:00** - 介绍使用Amazon Titan基础模型生成嵌入向量
- **15:00** - 解释摄入管道:视频分解为帧、去重、多模态分析
- **16:30** - 详细说明去重流程:通过向量相似性检测重复帧
- **17:30** - 介绍多模态分析:分类、标签化、摘要生成

### 查询流程说明 (18:00 - 20:00)
- **18:00** - 说明查询输入支持文本或图像
- **18:30** - 解释查询向量生成和最近邻搜索过程
- **19:00** - 介绍结果检索:从S3获取图像并显示给用户

### 现场演示准备 (20:00 - 28:00)
- **20:00** - Kevin展示已完成的应用界面
- **21:00** - 演示视频分析结果:标签、文本识别、帧提取
- **22:00** - 展示1秒采样间隔的帧序列
- **23:00** - 说明相似度分数和去重阈值(0.2)
- **24:00** - 开始清理环境:删除现有数据和代码
- **26:00** - 使用Valkey CLI清空所有分片的数据
- **27:00** - 删除现有索引,准备从头构建

### ElastiCache集群配置 (28:00 - 30:00)
- **28:00** - 展示ElastiCache配置:Valkey 8.2版本
- **28:30** - 说明集群规模:3个分片,每个分片3个副本,共9个节点
- **29:00** - 介绍实例类型:R7G XLarge节点

### 嵌入模型配置 (30:00 - 35:00)
- **30:00** - 介绍使用的两个Amazon Titan嵌入模型
- **30:30** - Titan V2用于文本嵌入
- **31:00** - Titan多模态模型用于文本和图像嵌入
- **32:00** - 说明通过Bedrock调用嵌入模型

### 编写嵌入生成Lambda (35:00 - 45:00)
- **35:00** - 开始编写生成嵌入的Lambda函数
- **36:00** - 创建Bedrock运行时客户端
- **37:00** - 根据嵌入类型选择不同的模型
- **38:00** - 构建JSON请求:处理文本或图像输入
- **40:00** - 调用Bedrock API并解析响应
- **42:00** - 部署Lambda并创建测试
- **43:00** - 测试成功:返回1024维向量

### 实现向量存储功能 (45:00 - 65:00)
- **45:00** - 开始编写向量保存Lambda函数
- **46:00** - 导入Valkey Glide客户端库
- **47:00** - 创建Glide集群客户端配置
- **48:00** - 配置连接参数:域名端点和端口6379
- **49:00** - 启用TLS加密传输
- **50:00** - 设置2秒超时配置
- **51:00** - 解释集群模式的节点发现机制
- **53:00** - 检查索引是否存在:使用FT.INFO命令
- **55:00** - 定义向量字段模式:多模态嵌入和文本嵌入
- **57:00** - 配置HNSW算法参数:1024维度,余弦相似度
- **59:00** - 修复代码错误:distance_metric拼写
- **60:00** - 设置索引前缀:只索引"frame:"开头的键
- **62:00** - 使用FT.CREATE创建索引
- **63:00** - 添加异常处理避免并发创建冲突
- **64:00** - 使用JSON.SET存储帧数据

### 部署和测试 (65:00 - 75:00)
- **65:00** - 修复多个代码错误:vector_type拼写
- **66:00** - 修复create_options的prefixes参数
- **67:00** - 部署更新后的Lambda函数
- **68:00** - 上传测试视频:AWS广告视频
- **69:00** - 配置采样设置:1秒间隔
- **70:00** - 启用多种检测:标签、文本、审核、名人识别
- **71:00** - 查看Step Functions工作流执行
- **72:00** - 第一次执行失败:vector未定义错误
- **73:00** - 修复错误后重新运行
- **74:00** - 成功完成视频处理

### 验证结果 (75:00 - 82:00)
- **75:00** - 在UI中查看处理后的视频帧
- **76:00** - 展示去重效果:第9帧被跳过
- **77:00** - 使用Valkey CLI查看存储的键
- **78:00** - 使用JSON.GET查看帧数据结构
- **79:00** - 展示存储的向量嵌入和元数据
- **80:00** - 使用FT._LIST列出所有索引
- **81:00** - 使用FT.INFO查看索引详细信息

### 实现搜索功能 (82:00 - 95:00)
- **82:00** - 开始编写搜索Lambda函数
- **83:00** - 创建Valkey客户端连接
- **84:00** - 构建FT.SEARCH查询
- **85:00** - 设置KNN向量搜索参数
- **86:00** - 指定返回字段和结果数量
- **87:00** - 解析搜索结果
- **88:00** - 从DynamoDB获取额外元数据
- **89:00** - 部署搜索Lambda
- **90:00** - 在UI中测试文本搜索:"woman"
- **91:00** - 展示搜索结果:相关帧和相似度分数
- **92:00** - 测试图像搜索:上传参考图像
- **93:00** - 展示图像搜索结果
- **94:00** - 解释搜索延迟:毫秒级响应

### 问答环节 (95:00 - 结束)
- **95:00** - 观众提问:如何确定标签和类别
- **96:00** - 回答:使用AWS Rekognition服务识别
- **97:00** - 提问:向量是如何生成的
- **98:00** - 回答:Lambda调用Bedrock服务生成
- **99:00** - 提问:是否需要API令牌
- **100:00** - 回答:Lambda通过IAM角色自动获取凭证
- **101:00** - 提问:能否使用AI生成代码
- **102:00** - 回答:可以使用Amazon Q或Claude,但需要验证准确性
- **103:00** - 演示Amazon Q的代码建议功能
- **104:00** - 总结Valkey在实时场景中的优势
- **105:00** - 强调低延迟和高吞吐量特性
- **106:00** - 会议结束