# AWS re:Invent 2025 - S3 Tables 跨区域复制功能详解

## 会议概述

本次会议由 Amazon S3 团队的产品经理 Aritra Gupta 和工程师 Nikos 主讲,同时邀请了 Zeta Global 的 Sil 分享实际应用经验。会议重点介绍了 Amazon S3 Tables 的全新跨区域复制功能,这是专为 Apache Iceberg 表格设计的完全托管式复制解决方案。

传统上,复制 Iceberg 表格是一个极其复杂的挑战,客户通常需要 6-12 个月才能构建可用的复制系统,还需要持续维护基础设施。主要难点包括:处理异步复制的顺序性、转换元数据文件中的绝对路径、协调目录和应用程序层面的提交。客户过去采用的方法包括使用 S3 复制、运行自定义 ETL 作业或实现双写架构,但这些方案都存在显著的技术挑战和运维复杂度。

新发布的 S3 Tables 复制功能从根本上简化了这一过程。该功能创建"只读副本"(read-only replica),具有四大核心特性:与源表保持相同的命名空间和表名、自动回填现有快照并持续复制增量更新、原生理解 Iceberg 元数据规范、副本始终处于可查询状态。此功能支持多区域数据湖的三大核心场景:性能优化(将数据靠近全球分布的用户)、合规要求(满足数据隔离和灾难恢复规定)、数据保护(防止意外删除和恶意攻击)。

## 详细时间线

00:00 - 开场介绍
- Aritra Gupta(S3 产品经理)和 Nikos(S3 工程师)介绍会议议程
- 现场调查显示大多数参会者已在使用或计划使用 Apache Iceberg

02:30 - 多区域数据湖的必要性
- 三大驱动因素:性能(降低跨区域延迟和数据传输成本)、合规(满足监管要求,数据需隔离至少 500 英里)、数据保护(防止表被意外删除或勒索软件攻击)

05:15 - Iceberg 架构回顾
- 底层:Parquet 数据文件
- 中层:元数据文件(manifest list、manifest、metadata JSON)
- 顶层:查询引擎和目录

06:45 - 现有复制方案的挑战
- 方案一:S3 复制 - 需处理异步复制顺序、转换文件路径、协调目录
- 方案二:自定义 ETL 作业 - 需跟踪快照状态、处理错误场景、理解 Iceberg 规范
- 方案三:双写架构 - 增加应用程序关键路径复杂度
- 真实案例:某客户构建 PB 级复制系统,涉及 S3 复制、DynamoDB 全局表、Lambda、CloudTrail 等多个组件

11:20 - S3 Tables 复制功能发布
- 昨日正式发布,提供一键式多区域数据湖复制能力
- 从底层专为 Apache Iceberg 设计,而非简单的对象复制

13:00 - 只读副本的四大特性
- 保持相同命名空间和表名,便于应用程序切换
- 自动回填历史快照并复制持续更新
- 原生理解 Iceberg 元数据和模式演变
- 副本始终可查询,无需额外配置

15:30 - 功能优势详解
- 简化运维:几次点击即可配置,支持全表或选择性复制
- 内置审计和监控:CloudTrail 日志、状态 API 实时跟踪复制进度
- 原生集成:与 Glue Data Catalog、Lake Formation、Unified Studio 无缝集成

18:00 - 规模和灵活性
- S3 每周复制超过 150 PB 数据,S3 Tables 复制基于此基础设施
- 支持 PB 级数据湖和数万张表
- 三大灵活配置:独立存储类(如 Intelligent-Tiering)、独立保留策略(7 天至 7 年)、独立加密密钥

21:45 - 专为 Iceberg 设计的特性
- 顺序复制:按快照序列号顺序提交,确保数据一致性
- 路径转换:自动重写元数据文件中的 S3 路径指向副本桶
- 增量合并:理解表更新语义,支持源表和副本表不同的保留策略
- 支持 Iceberg v2 和 v3 规范

24:30 - 使用场景
- 场景一:扇出架构 - 欧洲数据中心向伦敦、孟买、开普敦复制
- 场景二:聚合架构 - 全球制造数据汇聚到西雅图分析中心
- 场景三:数据保护 - 源表快照过期后,副本仍保留历史数据
- 场景四:多层级副本 - 操作副本(短期)、合规副本(90 天)、归档副本(7 年)

28:00 - Demo 1:配置表复制和回填
- 演示场景:电商应用的交易表从源区域复制到目标区域
- 源表包含 100 条记录,分布在 10 个快照中
- 在 AWS 控制台的表管理标签页配置复制:选择目标表桶、指定 IAM 角色
- 状态从"Pending"变为"Completed",显示复制完成时间戳
- 使用 DuckDB 验证目标表:10 个快照、100 条记录完全一致
- 快照元数据对比:序列号、快照 ID、时间戳相同,但 manifest list 路径已自动转换

35:20 - Demo 2:复制持续更新
- 在源表插入新记录(关于 S3 Tables 复制的指南)
- 源表更新为 101 条记录、11 个快照
- 使用 GetTableReplicationStatus API 查询状态,显示"Completed"
- 控制台显示新的复制完成时间戳
- 目标表自动同步到 11 个快照、101 条记录
- 强调:配置一次后,所有新快照自动复制,无需额外操作

39:45 - 复制状态 API 详解
- API 返回源表的所有目标副本状态(支持一对多复制)
- 包含配置信息、复制状态、最后更新时间戳
- 提供最新元数据 JSON 位置,便于验证

42:00 - Demo 3:跨区域数据集中分析
- 场景:电商业务扩展到欧洲、亚洲、澳洲三个大洲
- 数据存储在三个不同 AWS 区域的表桶中
- 配置表桶级别复制(而非单表):将所有表复制到美国东部分析桶
- 每个表桶包含 orders 和 order_items 父子关系表
- 使用命名空间区分不同来源的数据(避免表名冲突)

46:30 - 集中分析查询演示
- 在 Amazon Athena 中查询合并后的数据
- 查询一:按大洲和地区分析热门产品类别、收入、订单量
- 查询二:各地区销售表现、客户数、平均订单价值
- 查询三:支付方式分析(银行转账、移动支付等)
- 强调:通过命名空间标识符灵活查询不同来源数据

50:00 - 技术挑战:快照顺序
- Iceberg 快照有父子依赖关系,必须按序复制
- 类比:快照 1 创建记录、快照 2 更新、快照 3 删除,顺序错误会损坏副本
- 解决方案:基于序列号验证,序列号单调递增,确保快照按正确顺序提交

52:15 - 技术挑战:文件路径重写
- Iceberg 元数据文件包含绝对 S3 路径
- 需重写 manifest list、manifest、metadata JSON 中的所有路径
- S3 Tables 复制自动处理所有路径转换

53:30 - 技术挑战:独立保留策略
- 源表可能保留 7 天,副本保留 7 年
- 不能简单复制元数据文件,需理解更新语义
- 解决方案:将每次表更新视为逻辑操作,安全合并到副本
- 支持源表快照过期后,副本仍保留完整历史

55:00 - 技术挑战:跨账户复制
- 支持跨 AWS 账户复制,增强安全隔离
- 需配置适当的 IAM 角色和权限策略

56:30 - Zeta Global 客户案例预告
- Sil 将分享 Zeta Global 在生产环境使用 S3 Tables 的经验
- 以及如何利用新的复制功能扩展到多区域

58:00 - 总结与问答
- 强调 S3 Tables 复制功能的三大价值:简化运维、企业级规模、专为 Iceberg 设计
- 支持 Iceberg v2 和 v3,与 AWS 分析服务深度集成
- 开放现场问答环节