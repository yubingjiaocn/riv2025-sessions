# AWS re:Invent 2025 - SEC340: IAM Access Analyzer 深度解析

## 会议概述

本次会议是关于 IAM Access Analyzer 的深度技术讲座,由 AWS 高级软件开发经理 Jeremiah Dunham 和悉尼解决方案架构师 Mitch Bowmont 共同主讲。会议重点介绍了如何使用 IAM Access Analyzer 实现最小权限原则,从配置到修复的完整流程。

Jeremiah 作为 IAM Access Analyzer 工程团队的负责人,深入讲解了服务的技术原理,特别强调了自动推理(Automated Reasoning)技术的应用。这项技术不同于 AI,它使用数学证明来确定性地判断某个操作是否可能,而非基于概率预测。Mitch 则从实践角度展示了如何在真实环境中配置和使用各种分析器,分享了大量客户实施的最佳实践。

会议涵盖了 IAM Access Analyzer 的五大核心功能:外部访问分析器(External Access Analyzer)、未使用访问分析器(Unused Access Analyzer)、内部访问分析器(Internal Access Analyzer)、策略生成(Policy Generation)和自定义策略检查(Custom Policy Checks)。演讲者通过现场演示和代码示例,展示了如何利用这些工具在权限生命周期的设置、验证和优化阶段持续改进安全态势。

## 详细时间线

### 开场与介绍 (00:00 - 03:30)
- **00:00** - 会议开始,欢迎参会者
- **00:30** - 询问有多少人这是第一场会议
- **01:00** - Jeremiah Dunham 自我介绍:AWS 高级软件开发经理,IAM Access Analyzer 工程团队负责人
- **01:30** - Mitch Bowmont 自我介绍:悉尼解决方案架构师,帮助客户使用 AWS 服务
- **02:30** - 说明这是一场代码演示会议,将包含实际操作和演示

### 权限生命周期与服务概述 (03:30 - 08:00)
- **03:30** - 介绍会议议程:最小权限之旅、IAM Access Analyzer 概述、自动推理技术、代码演示
- **04:00** - 讲解最小权限是一个持续演进的目标,而非一次性任务
- **04:30** - 介绍权限生命周期的三个阶段:设置(Set)、验证(Verify)、优化(Refine)
- **05:00** - 展示 IAM Access Analyzer 的五大功能特性
- **05:30** - 说明策略生成功能:在测试环境使用 star-star 策略,分析日志后生成最小权限策略用于生产环境

### 自动推理技术 (08:00 - 09:30)
- **08:00** - 介绍自动推理(Automated Reasoning)技术
- **08:20** - 强调这不是 AI,而是 AI 的对立面:使用数学证明而非概率预测
- **08:40** - 自动推理提供确定性答案:某事是否可能发生
- **09:00** - 提供 QR 码供参会者深入了解技术细节
- **09:15** - 幽默建议:要么扫码阅读,要么去读形式逻辑博士学位

### 三种分析器类型 (09:30 - 13:00)
- **09:30** - 介绍三种分析器,用于验证和优化阶段
- **10:00** - 外部访问分析器:免费功能,检测账户或组织外部的资源访问
- **10:30** - 强调外部访问分析器是免费的,强烈建议所有人启用
- **11:00** - 未使用访问分析器:识别未使用的权限,像"整理大师"Marie Kondo 一样清理不需要的权限
- **11:30** - 未使用访问分析器会推荐优化后的策略
- **12:00** - 内部访问分析器:针对最关键资源,生成完整的内部访问报告
- **12:30** - 说明内部访问分析器计算成本高,需要付费使用

### 自定义策略检查 (13:00 - 15:00)
- **13:00** - 介绍自定义策略检查功能,用于设置阶段的预防性控制
- **13:30** - validate-policy API:免费的策略检查工具,类似策略的 linter
- **14:00** - 介绍三个 check 开头的 API:用于检查组织自定义的最佳实践
- **14:30** - 示例:使用 check-access-not-granted 检查策略是否授予了 S3 DeleteBucket 权限

### 外部访问分析器演示 (15:00 - 25:00)
- **15:00** - Mitch 开始演示部分
- **15:30** - 展示一个 S3 存储桶,配置了跨账户访问策略
- **16:00** - 存储桶策略允许外部账户进行 S3 GetObject 和 ListBucket 操作
- **16:30** - 说明在大型组织中需要规模化检测这类配置
- **17:00** - 使用 AWS CLI 创建外部访问分析器
- **17:30** - 配置选项:分析器名称、类型(账户或组织范围)、区域
- **18:00** - 账户范围:检测账户外部访问;组织范围:检测组织外部访问
- **18:30** - 执行命令,成功创建分析器
- **19:00** - Jeremiah 解释工作原理:拉取资源策略和访问控制列表
- **19:30** - 使用自动推理判断是否授予了外部访问
- **20:00** - 对于组织范围分析器,还需获取组织结构元数据
- **20:30** - 分析器开始生成发现(findings)
- **21:00** - 展示外部存储桶的发现结果
- **21:30** - 显示外部实体、共享方式(存储桶策略)和访问类型
- **22:00** - 发现还包括可被外部账户代入的 IAM 角色
- **22:30** - 刷新后显示 55 个发现

### 归档规则最佳实践 (25:00 - 30:00)
- **25:00** - 讨论如何管理大量发现,降低信噪比
- **25:30** - 介绍归档规则(Archive Rules)功能
- **26:00** - 创建归档规则,为规则命名以便后续维护
- **26:30** - 设置归档条件:公开访问为 false(永不归档公开访问资源)
- **27:00** - 添加资源名称条件,归档特定的"超级特殊角色"
- **27:30** - 归档规则匹配 61 个发现
- **28:00** - 创建归档规则后,活跃发现从 70+ 降至 31 个
- **28:30** - 展示外部访问分析器最佳实践幻灯片

### 外部访问分析器最佳实践 (30:00 - 33:00)
- **30:00** - 最佳实践 1:启用外部访问分析器(免费)
- **30:30** - 最佳实践 2:创建归档规则以减少噪音
- **31:00** - 最佳实践 3:使用良好的命名标准
- **31:30** - 展示命名不当的角色示例:"loads of random something"
- **32:00** - 建议使用描述性名称,如"高权限角色"
- **32:30** - 检查发现详情,查看角色创建时间和使用情况

### 未使用访问分析器演示 (33:00 - 42:00)
- **33:00** - 开始未使用访问分析器演示
- **33:30** - 通过控制台创建未使用访问分析器
- **34:00** - 配置:命名为"one-day-unused-access-analyzer"
- **34:30** - 设置跟踪期为 1 天(演示目的,实际建议更长)
- **35:00** - 可以排除特定账户或使用标签排除特定资源
- **35:30** - 创建分析器,等待发现生成
- **36:00** - Jeremiah 解释工作原理:处理所有 IAM 访问日志和 CloudTrail 日志
- **36:30** - 说明这需要处理大量数据
- **37:00** - IAM 的 last-used API 也使用相同的日志索引
- **37:30** - 展示预先创建的 Lambda 函数,具有过多权限
- **38:00** - Lambda 函数实际只需要 ListBuckets 权限,但被授予了所有权限
- **38:30** - 尝试在未使用访问分析器中查找 Lambda 函数发现
- **39:00** - 演示中 Lambda 函数未出现,改为展示其他角色的未使用权限
- **39:30** - 显示角色的未使用权限列表
- **40:00** - 展示策略建议功能
- **40:30** - 对比现有策略和推荐策略
- **41:00** - 推荐策略仅包含实际使用的操作
- **41:30** - 强调这是实现最小权限的迭代过程

### 未使用访问分析器最佳实践 (42:00 - 48:00)
- **42:00** - 最佳实践 1:从 365 天跟踪期开始
- **42:30** - 原因:一年未使用的资源更容易清理
- **43:00** - 逐步缩短跟踪期:365 天 → 270 天 → 90 天
- **43:30** - 警告:30 天跟踪期可能捕获正常的月度流程
- **44:00** - 示例:批处理管道可能每 30 天运行一次
- **44:30** - 最佳实践 2:在分析器名称中包含时间周期
- **45:00** - 便于按不同时间周期过滤发现
- **45:30** - 最佳实践 3:排除已知会产生发现的账户
- **46:00** - 最佳实践 4:优先处理未使用的访问密钥
- **46:30** - 展示未使用访问密钥的发现
- **47:00** - 说明工程师常创建临时访问密钥后忘记删除
- **47:30** - 按发现类型过滤:未使用的角色、权限、访问密钥

### 成本优化建议 (48:00 - 50:00)
- **48:00** - 删除未使用的角色和权限可节省分析成本
- **48:30** - 未使用访问分析器按资源/主体/月收费
- **49:00** - 建议:如果用于审计,可每 6 个月运行一次
- **49:30** - 获取结果后删除分析器以节省成本
- **50:00** - 注意:删除分析器会同时删除归档规则,需要重新创建

### 会议总结
本次会议全面展示了 IAM Access Analyzer 的配置和使用方法,通过实际演示帮助参会者理解如何在真实环境中实现最小权限原则。演讲者强调了免费启用外部访问分析器的重要性,并提供了大量实用的最佳实践建议,包括如何管理发现、优化成本以及避免常见陷阱。