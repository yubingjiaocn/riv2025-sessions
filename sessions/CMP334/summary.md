# AWS EC2 Mac 技术会议总结

## 会议概述

本次会议由 AWS EC2 Mac 产品经理 Vashal 主持,并邀请了来自 Riot Games 的 Miranda Pearson 和 Supercell 的 Tony Suvenan 分享他们使用 EC2 Mac 的实践经验。会议重点介绍了 EC2 Mac 服务的发展历程、核心功能以及两家游戏公司如何利用该服务解决 Apple 平台应用开发中的基础设施挑战。

EC2 Mac 于 2020 年在 re:Invent 大会上首次推出,解决了 Apple 开发生态中 Xcode 必须运行在 Mac 硬件上的限制。该服务通过将 Mac Mini 硬件集成到 AWS 数据中心,利用 PCIe 到 Thunderbolt 的连接实现与 AWS Nitro 系统的整合,为全球超过 3400 万 Apple 平台开发者提供云端 Mac 开发环境。从最初的 Intel Mac Mini 到最新的 M4 和 M4 Pro 芯片,EC2 Mac 持续演进,提供更强大的性能和更丰富的功能。

两家游戏公司的案例展示了从本地数据中心迁移到 EC2 Mac 后带来的显著改进:构建时间大幅缩短(2-3倍提升)、基础设施维护成本降低、构建失败率减少,以及更灵活的扩展能力。Riot Games 采用 Terraform 和事件驱动自动化实现基础设施即代码,而 Supercell 则利用虚拟化技术(Tart)在 EC2 Mac 上运行多个虚拟机,实现快速环境切换。两家公司都强调了 EC2 Mac 如何帮助他们摆脱物理硬件维护的困扰,提升开发团队的生产力。

## 详细时间线

### 开场介绍 (00:00 - 02:30)
- **00:00** - Vashal 介绍自己是 AWS EC2 Mac 产品经理
- **00:15** - 介绍演讲嘉宾:Riot Games 的 Miranda 和 Supercell 的 Tony
- **00:30** - 说明会议议程:EC2 Mac 历史、客户痛点、AWS 内部使用案例以及客户分享

### EC2 Mac 背景与市场 (02:30 - 06:00)
- **02:30** - 讲解 Apple 平台应用开发生命周期,强调从构建阶段开始必须使用 Xcode 和 Mac 硬件
- **03:15** - 介绍市场规模:超过 3400 万开发者,200 万应用,20 亿活跃设备
- **03:45** - 提到支持包括 Vision OS 在内的所有 Apple 平台
- **04:00** - EC2 Mac 于 2020 年推出,解决了云端运行 Mac OS 的技术难题

### 客户痛点分析 (06:00 - 09:30)
- **06:00** - 第一大痛点:基础设施管理开销,客户需要驱车数小时到数据中心维护物理硬件
- **06:45** - Pinterest 案例:物理数据中心访问是重大挑战
- **07:15** - 第二大痛点:无法自动化机群管理,Groupon 案例显示增加了上市时间
- **08:00** - 第三大痛点:无法灵活扩展,周末和工作日需求不同
- **08:30** - IQVIA 案例:利用自动扩展组优化资源使用

### EC2 Mac 技术架构 (09:30 - 13:00)
- **09:30** - 展示 2018 Intel Mac Mini 的初始硬件配置
- **10:00** - 解释 PCIe 到 Thunderbolt 连接如何实现与 AWS Nitro 系统集成
- **10:45** - 介绍早期版本甚至使用机械手指按压电源按钮
- **11:30** - 展示最新的 M2 Pro、M2、M4 和 M4 Pro Mac Mini 在数据中心的实际部署
- **12:15** - 强调 M4 系列配备 2TB 内部 SSD,提供更好的本地缓存性能

### EC2 Mac 核心优势 (13:00 - 16:30)
- **13:00** - 自动化改进:支持禁用/启用系统完整性保护(SIP)
- **13:45** - 解释 SIP 自动化的技术挑战:需要模拟鼠标移动和 GUI 交互
- **14:30** - 每次 Mac OS 更新(如 Sequoia 的 Liquid Glass)都需要重新适配
- **15:00** - 运营效率:集成 Image Builder、支持 Packer、Replace Root Volume 功能
- **15:45** - 安全性:通过 Amazon VPC 和 IAM 控制访问

### 2024 年新功能发布 (16:30 - 19:00)
- **16:30** - M4 和 M4 Pro 实例已正式发布约 2.5 个月
- **17:00** - 2TB 实例存储卷,无额外费用,用于缓存机制
- **17:30** - 支持专用主机自动恢复和基于重启的实例迁移
- **18:00** - 两周前发布 Amazon DCV 支持,提供 4K 分辨率 GUI 访问
- **18:30** - 支持系统完整性保护配置和 Mac OS Sequoia AMI

### 当前产品矩阵 (19:00 - 20:30)
- **19:00** - 展示当前支持的所有实例类型
- **19:30** - 继续支持 Intel Mac,提供 Sonoma 和 Sequoia 镜像
- **20:00** - 预告 Matt Garman 明天主题演讲将有更多 EC2 相关公告

### 客户成功案例概览 (20:30 - 22:00)
- **20:30** - 展示使用 EC2 Mac 的客户列表,涵盖不同行业和平台
- **21:00** - 客户反馈:构建时间减少,构建失败率降低
- **21:30** - 强调 AWS 网络和弹性措施的可靠性优势

### 未来发展方向 (22:00 - 23:00)
- **22:00** - 继续支持最新 Mac 硬件
- **22:30** - 扩大区域和全球可用性
- **22:45** - 强调以客户需求为导向的产品开发理念

### Riot Games 案例分享 (23:00 - 35:00)
- **23:00** - Miranda Pearson 介绍自己是 Riot IT 基础设施团队系统工程师
- **23:30** - Riot 使用 Apple 开发工作流的三个场景:签名、游戏构建、音频资源处理
- **24:00** - 起点:在 Las Vegas Switch 数据中心拥有约 60 台本地 Mac,每年损失 2%
- **24:45** - 展示本地机架中的"奶酪刨丝器"(Mac Pro)照片
- **25:15** - 硬件问题:驱动器实际熔化(非夸张),存储故障时 VM 仍在运行但无人知晓
- **26:00** - 每次维修占用约 8% 的机群容量
- **26:30** - 痛点:散热、冷却、IO、存储和计算限制影响开发者构建速度
- **27:15** - 最大痛点:需要乘飞机到 Vegas 进行固件更新和修复
- **28:00** - 触发因素一:Riot 决定退出数据中心业务
- **28:30** - 触发因素二:安全事件要求从头重建,无法重用原有基础设施
- **29:00** - 触发因素三:VMware ESXi 8 放弃 Mac 支持
- **29:30** - 结论:无法继续扩展本地物理维护模式
- **30:00** - 解决方案:EC2 Mac 提供所需容量,无需物理访问
- **30:45** - 采用 Terraform 实现基础设施即代码
- **31:15** - 工作流程:客户提交 PR 到 GitHub → Jenkins 触发 Terraform plan
- **32:00** - 使用产品安全团队维护的集中式 AMI,包含证书和安全功能
- **32:45** - Jenkins 使用 STS 承担集中式角色,无需团队本地管理
- **33:30** - 事件驱动自动化:新实例启动时自动引导
- **34:00** - 通过 Lambda 和 SSM 实现确定性和动态引导
- **34:30** - SSM 文档从集中式工具账户共享,保持单一事实来源

### Riot Games 性能提升 (35:00 - 38:00)
- **35:00** - 从本地 Intel 迁移到 EC2 Mac Intel:主要构建时间提升 3 倍
- **35:30** - 代码签名提升 2 倍,代码构建提升 2.5 倍
- **36:00** - 消除硬件故障噪音,看到真实性能信号
- **36:30** - 迁移到 Apple Silicon:同时进行硬件和软件升级
- **37:00** - 获得更快、更便宜、更好、可扩展的基础设施
- **37:30** - 机群多样性:根据工作负载形态映射不同 EC2 Mac 实例类型

### Riot Games 未来计划 (38:00 - 39:30)
- **38:00** - 探索共享容量,使容量对团队更具弹性
- **38:30** - 将更多 ARM 工作负载迁移到 M4/M4 Pro 以提升性能
- **39:00** - 资源缓存:Perforce 仓库约 2TB,需要优化
- **39:15** - 探索使用本地 NVMe 解决存储瓶颈

### Supercell 案例分享 (39:30 - 52:00)
- **39:30** - Tony Suvenan 介绍自己是 Supercell 高级云治理工程师
- **40:00** - 致谢同事 Juho Murimaki 领导解决方案创建
- **40:30** - Supercell 背景:芬兰游戏公司,知名游戏包括 Brawl Stars、Clash Royale、Clash of Clans
- **41:00** - 从自己的地下室数据中心迁移,而非 Nevada 沙漠
- **41:30** - 每个游戏团队("cell")高度独立,拥有自己的硬件
- **42:00** - 问题:地下室的"僵尸"Mac 在黑暗潮湿环境中增长
- **42:30** - 2023 年使用本地 Intel Mac,硬件问题严重
- **43:00** - IT 工程师需要花费大量时间重装和故障排查
- **43:30** - VMware 宣布不再支持 Mac 硬件上的 ESXi,尤其是 Apple Silicon
- **44:00** - 最糟糕时,三分之一的 Mac 机群无法运行
- **44:30** - 游戏团队受影响:构建时间变长,构建队列积压
- **45:00** - 矛盾:硬件损坏的同时,新游戏团队和现有团队都需要更多容量
- **45:30** - 选择:要么建立新数据中心,要么采用云方案
- **46:00** - 引用 2013 年名言:"朋友不让朋友建数据中心",2023 年仍然有效
- **46:30** - 选择 EC2 Mac,特别是 Apple Silicon 实例可用后
- **47:00** - 四大支柱:EC2 Mac、Tart 虚拟化、Terraform + Packer、Mise-en-place
- **47:45** - 使用 Tart(基于 Apple 官方虚拟化框架)在 EC2 Mac 上运行虚拟机
- **48:15** - 原因:避免 AMI 切换时的清理时间,快速切换 Tart VM 镜像
- **48:45** - Tart VM 镜像行为类似容器,可快速启动
- **49:15** - 使用 Mise-en-place 定义工具版本(Xcode、AWS SDK 等)
- **49:45** - 每次构建时 Mise-en-place 动态定制机器
- **50:15** - Supercell 2010 年成立时就"生于云端",在 AWS 上构建一切
- **50:45** - 拥有多年 AWS 和 EC2 经验

### Supercell 架构详解 (52:00 - 58:00)
- **52:00** - 架构:AWS 区域 → VPC → 多个可用区 → 自动扩展组
- **52:30** - EC2 Mac 特殊性:需要先配置专用主机,然后才能启动实例
- **53:00** - 使用 AWS License Manager 的主机资源组功能管理专用主机生命周期
- **53:45** - License Manager 自动根据自动扩展组需求配置按需主机
- **54:15** - 24 小时最低分配期后,License Manager 自动释放未使用的主机
- **54:45** - 通过 EC2 启动模板将自动扩展组连接到主机资源组
- **55:15** - License Manager 还用于管理 Tart 虚拟化引擎的许可证数量
- **55:45** - 使用 AWS 提供的默认 AMI,不做定制
- **56:15** - 用户数据脚本安装 Tart 并启动所需的虚拟机镜像
- **56:45** - Tart VM 镜像包含:GitHub Actions runner、Jenkins agent、Xcode、命令行工具、Mise-en-place
- **57:30** - 自定义 Cocoa Agent 根据元数据决定连接 Jenkins 还是 GitHub Actions
- **58:00** - 使用 GitHub Actions 和 Packer 构建 Tart VM 镜像

### Supercell 存储和工作流 (58:00 - 60:00)
- **58:00** - Tart VM 镜像存储在 EFS(弹性文件存储)上
- **58:30** - EFS 挂载到 EC2 Mac 实例的基础 Mac OS
- **59:00** - 允许快速切换不同 Xcode 版本、Mac OS 版本的组合
- **59:30** - 脚本存储在 S3 中
- **59:45** - 独特之处:使用虚拟化层实现灵活性

### 会议总结 (60:00 - 结束)
- **60:00** - 两家公司展示了不同的 EC2 Mac 实施方法
- **60:30** - 共同点:摆脱物理硬件维护,提升性能和可靠性
- **61:00** - 强调 EC2 Mac 的灵活性和可扩展性
- **61:30** - 会议结束,演讲者表示愿意会后交流