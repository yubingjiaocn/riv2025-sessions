# DAT410: PostgreSQL Performance: Real-World Workload Tuning

## 会议概述

本次会议是AWS re:Invent 2025的技术分享会，主题为PostgreSQL性能调优。主讲人Baji Shaik是AWS RDS和Aurora PostgreSQL数据库的高级数据库工程师，协助主讲人Vlad Vlasceanu是AWS数据库技术负责人。会议通过实际案例演示了如何解决常见的PostgreSQL性能问题，包括高CPU使用率、查询执行时间过长等问题。

演讲者以一个虚拟的数据库工程师John为例，展示了在数据增长过程中遇到的性能挑战，并通过五个具体的性能优化案例，演示了如何通过查询重写、索引优化、查询计划管理、HOT更新和分区优化等技术手段，将查询性能从15,000提升到24,000，实现了超过100%的性能改进。

## 详细时间线与关键要点

### 0:00-10:00 会议开场与性能调优基础
- 介绍演讲者和会议主题
- 启动负载生成器，模拟电商应用场景
- 介绍性能调优的关键关注领域：
  - CPU利用率：次优查询、全表扫描、并行查询
  - 内存：基于进程的架构、内存参数配置
  - 存储和IOPS：MVCC机制、索引维护、临时文件
  - 应用模式：查询阻塞、长事务、连接池

### 10:00-20:00 查询调优方法论与EXPLAIN ANALYZE
- 介绍查询调优的步骤化方法
- 详细解释EXPLAIN ANALYZE计划的结构
- 演示如何识别性能问题的关键指标：
  - 估算成本vs实际执行时间
  - 行数估算准确性
  - 缓冲区读取情况
- 介绍演示环境：电商应用，150+连接，读写平衡

### 20:00-35:00 案例1：查询重写优化
- 问题：函数调用导致全表扫描，执行时间60秒
- 分析：优化器无法识别函数返回值，导致对1100万行执行函数
- 解决方案：使用SELECT子查询替代直接函数调用
- 结果：执行时间从60秒降至800毫秒，缓冲区读取从87,000降至2,000块
- 性能改进：查询数量从9提升至489

### 35:00-45:00 案例2：战略性索引创建
- 问题：查询活跃产品时过滤大量非活跃产品
- 分析：30,000行被过滤器移除，只有33%产品为活跃状态
- 解决方案：创建部分索引，仅针对活跃产品
- 结果：过滤行数从30,000降至900，执行时间显著改善
- 性能改进：查询数量从1,200提升至2,000

### 45:00-55:00 案例3：查询计划管理
- 问题：使用pg_hint_plan扩展强制使用次优索引
- 分析：已有复合索引但被提示忽略，导致40万行被过滤
- 解决方案：使用apg_plan_management扩展切换查询计划
- 演示计划捕获、审批和切换过程
- 结果：消除行过滤，缓冲区读取大幅减少

### 55:00-62:00 案例4：HOT更新优化
- 问题：更新非索引列时仍需更新所有索引
- 解决方案：调整填充因子从100%到80%，为HOT更新预留空间
- 执行VACUUM FULL重组数据块
- 结果：70%以上更新转为HOT更新，查询数量提升至4,000

### 62:00-66:00 案例5：分区优化与索引清理
- 问题：日分区表导致过多锁获取，触发锁管理器事件
- 解决方案：改用月分区表减少分区数量
- 额外优化：清理未使用和重复索引
- 演示索引使用情况查询和批量删除
- 最终结果：总查询性能从15,000提升至24,000，实现100%+改进