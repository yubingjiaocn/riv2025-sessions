# AWS re:Invent 2025 - 使用 VPC Lattice 实现应用迁移的现代化方法

## 会议概述

本次技术会议由 Jamie、Yine 和 Ryan 三位 AWS 专家主讲,重点介绍了如何使用 VPC Lattice 服务来实现应用程序和基础设施的现代化升级。会议通过一个实际的架构案例,展示了如何逐步将传统的复杂网络架构迁移到基于 VPC Lattice 的现代化架构。

演讲者们强调了一个核心理念:不要一次性替换整个系统,而是采用"摘低垂果实"的策略,逐步引入 VPC Lattice,与现有配置并行运行,在验证无误后再完全切换。这种方法大大降低了迁移风险,避免了对业务的冲击。

会议最后,来自高盛(Goldman Sachs)的 Ryan 分享了他们在实际生产环境中使用 VPC Lattice 的经验,特别是在他们的 FastTrack 持续部署平台中的应用。整个会议为 300 级别,既包含了 VPC Lattice 的基础概念讲解,也深入探讨了实际应用场景和最佳实践。

## 详细时间线与关键要点

### 开场与议程介绍
时间戳: 会议开始
- Jamie 介绍了三位演讲者和会议议程
- 会议将通过实际架构案例展示如何使用 VPC Lattice 进行现代化改造
- 演讲者承认初始架构是故意设计得不够完美,以便展示改进空间

### 业务需求与挑战
时间戳: 议程介绍后
- 讨论了业务增长带来的需求增加
- 强调所有需求都是同时到来的,而不是按顺序出现
- 架构是不断叠加的,很少有机会从头开始重建

### 当前架构分析
时间戳: 业务需求讨论后
- 展示了初始架构:包含通过 VPN 连接的合作伙伴 VPC
- VPC2 中有需要从单体应用迁移到容器的后端服务
- 使用双向 Private Link 连接到收购公司
- 提供 IPv6 服务(医疗和政府客户的常见需求)
- 通过 Direct Connect 和防火墙连接到本地数据库

### 需要解决的问题清单
时间戳: 架构展示后
- 合作伙伴希望简化 VPN 连接,减少 IP 地址变更的复杂性
- 需要更好的收购公司连接策略(双向 Private Link 的监听器限制为 50 个)
- 扩展 IPv6 服务但避免连接瓶颈
- 确保本地主机只能访问 VPC2
- 将单体 EC2 实例升级为容器
- 为收购公司提供更好的本地数据库访问方式

### VPC Lattice 基础概念
时间戳: Yine 接手讲解
- VPC Lattice 是应用网络服务,连接、监控和保护服务间通信
- 支持多种计算类型:EC2、容器、无服务器、混合环境和数据库
- 支持多种协议并提供内置的安全性、监控和可观测性

### VPC Lattice 核心组件
时间戳: 基础概念后
- **服务(Services)**:将应用程序放入目标组,创建逻辑服务端点
- **资源(Resources)**:包括服务和应用资源(RDS、DNS 名称、IP 地址)
- **账户(Accounts)**:支持跨账户通信
- **服务网络(Service Network)**:连接提供者和消费者

### VPC Lattice 与 Transit Gateway 的对比
时间戳: 组件介绍后
- Transit Gateway 是核心网络服务,工作在第 3/4 层
- VPC Lattice 是应用网络服务,工作在第 7 层
- 两者可以很好地共存,各有不同的用途
- 成本对比:4 个应用使用 Transit Gateway + 负载均衡器约 $1,300/月,使用 VPC Lattice 约 $750/月

### 解决方案 1:合作伙伴 VPN 连接
时间戳: Jamie 继续讲解
- 创建 Lattice 服务网络并使用 RAM(资源访问管理器)跨账户共享
- 在账户 A 创建服务网络并关联 VPC
- 账户 B 和 C 共享服务并连接到服务网络
- 可以与现有 VPN 并行运行,无需立即替换

### 策略配置
时间戳: VPN 解决方案后
- 在前门服务上配置策略:要求特定令牌,只允许 GET 请求,限制访问路径
- 在服务网络上配置粗粒度策略:要求合作伙伴令牌
- 在合作伙伴服务上配置对应的反向策略
- 策略每 15 分钟自动轮换令牌,提供额外安全性

### 解决方案 2:收购公司连接
时间戳: Yine 讲解收购场景
- 解决重叠 IP 地址问题(现场调查显示很多人遇到过这个问题)
- VPC Lattice 通过链路本地 ENI(169.254.x.x 地址范围)完美处理重叠 IP
- DNS 解析指向链路本地地址,而不是实际 VPC 中的 IP
- 创建收购服务和后端服务,关联到服务网络
- 可以保留现有双向 Private Link 进行测试,验证后再移除

### 策略层次结构
时间戳: 收购解决方案后
- **服务网络策略**:粗粒度,影响范围大,例如要求属于特定组织或持有特定令牌
- **服务策略**:细粒度,限制具体的 HTTP 方法、路径和访问权限
- **资源配置**:资源默认对所有人开放,需要通过服务和服务网络策略来限制访问

### 解决方案 3:IPv6 工作负载
时间戳: 策略讨论后
- 医疗和政府客户通常要求 IPv6 支持
- 原架构使用 Private NAT Gateway 进行 IPv4 到 IPv6 转换
- VPC Lattice 原生处理 IPv4 到 IPv6 通信,无需额外组件
- 创建 IPv6 服务并添加到服务网络,可以移除 Private NAT Gateway

### 解决方案 4:混合云连接
时间戳: Jamie 讲解混合场景
- 强调 Transit Gateway 和 Direct Connect 不会消失,VPC Lattice 与它们协同工作
- 使用服务网络端点(Service Network Endpoints)连接本地主机
- 服务网络端点获取本地子网的 IP 地址
- 本地主机通过 Direct Connect → Transit Gateway → 服务网络端点访问服务
- 通过策略限制本地主机只能访问特定服务

### 解决方案 5:应用现代化
时间戳: 混合云解决方案后
- 将单体 EC2 应用迁移到 EKS 容器
- 在同一或不同 VPC 中创建新的容器服务
- 可以使用流量加权:例如 40% 到旧服务,60% 到新服务
- 逐步验证和切换,无需一次性替换
- 适用于 EKS 集群升级等场景

### 解决方案 6:数据库访问
时间戳: Yine 讲解资源网关
- 使用资源网关(Resource Gateway)提供对本地数据库的访问
- 资源网关配置定义后端目标(RDS、DNS 名称或 IP 地址)
- RDS 实例自动更新,IP 地址需要手动维护
- 通过资源端点或服务网络访问资源网关
- 可以移除收购公司的专用 Direct Connect,使用共享连接
- 资源网关确保收购公司只能访问特定数据库,无法访问其他本地资源

### 架构演进总结
时间戳: 所有解决方案展示后
- 展示了从初始复杂架构到最终简化架构的完整演进过程
- 强调逐步迁移的重要性,每一步都可以与现有系统并行
- Transit Gateway 仍然保留用于其他类型的通信
- 所有服务通过 Lattice 服务网络通信,使用策略强制执行安全要求

### 高盛案例分享:FastTrack 平台
时间戳: Ryan 开始演讲
- FastTrack 是高盛的托管持续部署平台,2021 年推出
- 采用"左移"方法,在部署前进行策略评估
- 应用使用 AWS CDK 编写,合成为 CloudFormation 模板
- 护栏在部署前评估策略(如 S3 加密、公共访问等)
- 结合 SCP、RCP 和权限边界填补策略空白

### FastTrack 网络架构
时间戳: 平台介绍后
- 使用共享 VPC 集合提供给用户账户
- 用户请求环境时自动配置两个账户:服务账户和工作负载账户
- 服务账户用于 CI/CD 管道和基础设施
- 工作负载账户运行实际应用
- 从中央网络账户共享 VPC 子网到工作负载账户

### FastTrack 面临的挑战
时间戳: 架构介绍后
- 子网 IP 地址耗尽问题
- 需要支持多区域部署
- 需要更细粒度的网络隔离
- 希望简化跨账户和跨 VPC 的服务通信

### FastTrack 中的 VPC Lattice 实施
时间戳: 挑战讨论后
- 在工作负载账户中创建 Lattice 服务
- 使用 RAM 将服务共享到中央网络账户
- 中央网络账户将服务关联到服务网络
- 服务网络共享回工作负载账户
- 工作负载账户中的 VPC 关联到服务网络

### VPC Lattice 带来的好处
时间戳: 实施方案后
- 解决了 IP 地址耗尽问题
- 简化了跨账户服务发现
- 提供了更细粒度的网络控制
- 内置的可观测性和监控
- 降低了运营复杂性

### 总结与要点
时间戳: 会议结尾
- VPC Lattice 是应用网络的现代化解决方案
- 支持逐步迁移,与现有架构并行
- 原生处理重叠 IP 和 IPv4/IPv6 转换
- 通过策略提供细粒度的安全控制
- 与 Transit Gateway 等现有服务协同工作
- 实际生产案例证明了其价值和可行性