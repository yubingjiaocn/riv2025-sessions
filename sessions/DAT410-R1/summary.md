# DAT410: PostgreSQL Performance: Real-World Workload Tuning

## 会议概述

本次会议是AWS re:Invent 2025的技术分享会，主题为PostgreSQL性能调优。主讲人Baji Shaik是AWS RDS和Aurora PostgreSQL数据库的高级数据库工程师，协助主讲人Vlad Vlasceanu是AWS数据库技术负责人。会议通过实际案例演示了如何解决常见的PostgreSQL性能问题，包括高CPU使用率、查询执行时间过长等问题。

演讲者以一个虚拟的数据库工程师John为例，展示了在数据增长过程中遇到的性能挑战，并通过五个具体的性能优化案例，演示了如何通过查询重写、索引优化、查询计划管理、HOT更新和分区优化等技术手段，将查询性能提升超过100%。整个演示基于Aurora PostgreSQL实例和电商应用的负载生成器进行。

## 详细时间线与关键要点

### 0:00-10:00 会议开场与性能调优基础
- 介绍演讲者和会议主题
- 启动负载生成器，模拟电商应用场景
- 介绍性能调优的关键领域：
  - CPU利用率：子优化查询、全表扫描、并行查询
  - 内存：基于进程的架构、内存参数配置
  - 存储和IOPS：MVCC机制、索引维护、临时文件
  - 应用模式：查询阻塞、长事务、连接池

### 10:00-20:00 查询调优方法论与Explain Analyze
- 介绍查询调优的步骤化方法
- 详细解释Explain Analyze计划的结构：
  - 估算成本 vs 实际执行时间
  - 计划节点和循环次数
  - 缓冲区读取信息
- 演示电商应用的表结构和负载特征
- 展示Performance Insights和Database Insights监控界面

### 20:00-35:00 案例1：查询重写优化
- 识别CPU消耗最高的函数调用查询
- 分析Explain Analyze结果：
  - 执行时间从60秒优化到800毫秒
  - 缓冲区读取从87,000块减少到2,000块
  - 消除了1000万行的过滤操作
- 解决方案：在函数调用中添加SELECT语句
- 性能提升：查询数量从9个增加到489个

### 35:00-45:00 案例2：战略性索引创建
- 分析平均价格查询的性能问题
- 创建部分索引优化活跃产品查询：
 sql
  CREATE INDEX CONCURRENTLY idx_category_active 
  ON products(category) WHERE is_active = true
  
- 性能改进：查询数量从1,200增加到2,000
- 总体查询吞吐量从15,000提升到20,000

### 45:00-55:00 案例3：查询计划管理
- 使用pg_hint_plan扩展的问题分析
- 演示Aurora查询计划管理扩展：
  - 捕获和管理查询计划
  - 使用set_plan_status函数切换计划
  - 从单列索引切换到复合索引
- 性能提升：查询数量从255增加到800
- 总查询数量达到24,000

### 55:00-65:00 案例4和5：HOT更新与分区优化
- HOT（Heap-Only Tuples）更新优化：
  - 调整fill_factor从100%到80%
  - 执行VACUUM FULL重组数据块
  - HOT更新比例提升到70%以上
- 分区表锁管理优化：
  - 从日分区（731个分区）改为月分区
  - 减少非快速路径锁的数量
  - 消除锁管理器等待事件

### 65:00-66:30 索引清理与总结
- 识别和删除未使用的重复索引
- 释放5-6GB的存储空间
- 最终性能结果：查询吞吐量提升超过100%
- 问答环节：讨论扩展兼容性、查询计划传播等问题