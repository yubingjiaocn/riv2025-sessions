# AWS re:Invent 2025 成本与使用报告高级分析会议总结

## 会议概述

本次会议深入探讨了AWS成本与使用报告(CUR)的高级应用场景。AWS成本与使用报告已发布11年,是理解云资源使用情况最强大的数据集之一。随着时间推移,AWS不断增强其功能,包括Athena集成、CUR 2.0、FOCUS标准以及CUR查询库等。

会议由两位AWS专家主讲:高级解决方案架构师Steph Gooch和FinOps专家经理Andy Brown。他们通过实时编码演示的方式,展示了如何利用CUR解决三大核心挑战:成本优化、成本分配和成本安全。演讲者强调,尽管CUR功能强大,但在某些场景下需要结合其他数据源(如VPC Flow Logs)才能获得完整的洞察。会议还特别介绍了如何使用Amazon Q辅助分析,以及如何通过推理配置文件(Inference Profiles)和标签来精确分配Amazon Bedrock的使用成本。

## 详细时间线与关键要点

### 开场与背景介绍 (00:00 - 03:30)

00:00 - 会议开始,介绍AWS成本与使用报告已发布11年,是理解云资源使用最强大的数据集

00:30 - 说明报告的演进历程:Athena集成、CUR 2.0、FOCUS标准、CUR查询库等新功能

01:00 - 提出会议将聚焦的三大主题:
- 优化(Optimization):寻找节省成本的机会
- 成本分配(Cost Allocation):理解和查看支出分布
- 成本安全(Securing Costs):控制访问权限

01:45 - 讲师自我介绍:Steph Gooch(高级解决方案架构师)和Andy Brown(FinOps专家经理)

### 互动游戏环节 (03:30 - 06:00)

03:30 - 开始CUR知识问答游戏,让观众站立参与

04:00 - 问题1:哪个版本的CUR具有最新功能?答案:CUR 2.0

04:30 - 问题2:CUR数据存储在哪里?答案:S3

05:00 - 问题3:标签是否默认添加到CUR?答案:否,需要启用成本分配标签

05:30 - 问题4:能否在CUR 2.0中添加账户名称?答案:是,这是新功能之一

### 第一部分:成本优化 - NAT网关案例 (06:00 - 25:00)

06:00 - Andy开始演示成本优化场景:收到成本异常检测邮件,NAT网关支出增加

06:30 - 在AWS Cost Explorer中发现EC2-Other服务下的NAT网关支出、NAT网关字节数和区域数据传输字节数都在增加

07:00 - 解释数据传输区域字节(Data Transfer Regional Bytes)是指跨可用区数据传输

07:30 - 使用Amazon Q查询NAT网关优化建议

08:00 - 进入Athena控制台,展示预先准备的CUR 2.0查询

08:30 - 开始修改查询,使用CASE语句创建类似数据透视表的结构,将9月和10月的成本分列显示

10:00 - 修改SELECT语句,删除billing_period和usage_type列,只保留resource_id

10:30 - 调整GROUP BY和ORDER BY子句,按10月成本降序排列

11:00 - 查询结果显示两个新的NAT网关资源在10月产生了新支出

12:00 - 指出NAT网关的局限性:它只是中间人,无法显示实际产生流量的源头

13:00 - Amazon Q建议使用VPC Flow Logs来获取更详细的网络流量信息

13:30 - 解释VPC Flow Logs的优势:
- 数据在几分钟内开始出现(不像CUR需要24小时)
- 可以输出到CloudWatch或S3
- 提供CloudFormation模板自动设置Athena集成

14:30 - 切换到VPC Flow Logs数据库,预览表结构

15:00 - 查看VPC Flow Logs数据:包含账户ID、源/目标地址、端口信息、字节数、开始/结束时间(Unix时间戳)

16:00 - 开始构建查询:选择源地址、目标地址和字节总和

16:30 - 添加WHERE子句过滤9月和10月数据,添加GROUP BY和ORDER BY子句

17:00 - 将字节转换为GB:除以1024三次(字节→KB→MB→GB)

17:30 - 首次运行查询返回零值,因为Athena将整数除法结果向下取整

18:00 - 修复方法:在1024后添加.0强制Athena保留小数位

18:30 - 查询返回前四大流量来源,但IP地址难以识别

19:00 - 再次使用Amazon Q识别IP地址对应的资源

19:30 - Amazon Q生成包含LIKE语句的查询,将IP地址分类为:
- 不同子网
- NAT网关(公有和私有IP)
- 外部服务(互联网或AWS服务如S3、RDS)

21:00 - 将Amazon Q生成的分类逻辑整合到查询中

21:30 - 运行更新后的查询,结果显示分类后的流量来源和目标

22:00 - 识别问题:第3行显示公有子网通过NAT网关访问外部服务,这是配置错误
- 公有资源不应使用NAT网关
- 跨可用区访问NAT网关产生额外的数据传输费用

23:00 - 使用WITH语句创建子查询,计算NAT网关和跨可用区数据传输的实际成本

23:30 - 添加CASE语句计算NAT网关数据处理费用(每GB $0.045)

24:00 - 添加跨可用区数据传输费用计算(每GB $0.02)

24:30 - 查询结果确认第3行产生了所有费用,可以将此信息提供给网络团队调查

### 第二部分:成本分配 - Amazon Bedrock案例 (25:00 - 40:00)

25:00 - Steph接手演示,介绍Amazon Bedrock成本分配的挑战

25:30 - 解释三种模型类型的计费实体差异:
- 第一方模型(First-party):AWS训练和销售(如Nova、Titan)
- 第二方模型(Second-party):第三方训练但AWS销售(如Llama)
- 第三方模型(Third-party):通过AWS Marketplace销售

26:30 - 指出Bedrock的第二个挑战:资源ID只显示模型名称,无法追踪具体使用者

27:00 - 介绍解决方案:推理配置文件(Inference Profiles)
- 可以预配置模型交互方式
- 可以添加标签
- 可以在CloudFormation或SDK中使用

28:00 - 展示CloudFormation和Python SDK中创建推理配置文件的示例代码

28:30 - 说明将使用"department"标签来分配成本

29:00 - 展示预先准备的查询,包含product_name、usage、spend、resource等基本信息

29:30 - 重点解释WHERE子句如何覆盖所有三种模型类型:
- product_code LIKE '%bedrock%'
- product_name LIKE '%bedrock%'
- line_item_usage_type LIKE '%token%' 和 LIKE '%Token%'(注意大小写和复数形式)

30:30 - 运行查询,展示结果:
- 未使用推理配置文件的行只显示模型名称
- 使用推理配置文件的行显示部门标签(dev、security、sales)

31:30 - 创建第一个查询:查找已创建推理配置文件但未添加标签的资源

32:00 - 使用WITH语句创建tokens子查询

32:30 - 选择resource_id、usage和spend,按resource_id分组

33:00 - 添加WHERE条件:
- 资源ID包含"application-inference-profile"
- department标签为NULL

33:30 - 遇到语法错误(使用了"="而非"LIKE"),观众指出错误

34:00 - 修正错误后运行查询,获得需要添加标签的推理配置文件列表

34:30 - 修改查询以显示已正确标记的资源:将IS NULL改为IS NOT NULL

35:00 - 删除"application"过滤条件,将resource_id改为department

35:30 - 查询结果显示各部门的使用量和支出:
- Sales团队:支出最高($2+)
- Dev团队:支出约为Sales的1/3,但使用量相近

36:30 - 解释支出差异原因:模型选择
- Dev和Security团队使用Amazon Nova(成本较低)
- Sales团队使用Claude(成本较高)

37:30 - 强调优化建议:如果团队支出激增,可以讨论是否需要使用昂贵模型,开发环境可以考虑使用更便宜的模型

### 第三部分:单位成本分析 (40:00 - 结束)

40:00 - 引入单位成本(Unit Cost)概念:销售一个单位或一次点击的支出

40:30 - 展示场景:成本持续上升,需要判断是因为用户增长还是资源浪费

41:00 - 介绍示例应用:使用EC2、Aurora、Lambda和Bedrock的Web应用

41:30 - 目标:计算每次点击的成本

42:00 - 说明Lambda是驱动力:每次点击触发Lambda函数

42:30 - 发现可以从CUR中提取Lambda调用次数

43:00 - 创建查询获取Lambda使用量:使用usage_amount列

43:30 - 添加过滤条件:Lambda服务、特定应用和账户ID、特定月份

44:00 - 运行查询,显示Lambda函数被调用的总次数

44:30 - 使用WITH语句将其命名为"invocations"子查询

45:00 - 创建第二个子查询获取应用总支出

45:30 - 选择SUM(cost)、product_name和billing_period

46:00 - 切换到错误的数据集导致查询失败(会议记录在此处中断)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


## 关键要点总结

1. CUR 2.0是最新版本,包含所有最新功能,应优先使用
2. 结合多数据源:VPC Flow Logs可以补充CUR在网络流量分析方面的不足
3. Amazon Q是强大助手:可用于识别资源、生成查询、提供优化建议
4. 推理配置文件和标签是Bedrock成本分配的关键
5. 模型选择影响成本:不同模型价格差异显著,应根据使用场景选择
6. 单位成本分析帮助区分成本增长是由业务增长还是资源浪费导致