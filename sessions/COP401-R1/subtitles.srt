1
00:00:00,240 --> 00:00:04,140
- [Steph Gooch] The AWS
cost and usage report,

2
00:00:04,140 --> 00:00:06,930
one of the most powerful data sets we have

3
00:00:06,930 --> 00:00:09,390
to understand our cloud footprint.

4
00:00:09,390 --> 00:00:12,510
It was actually released 11 years ago

5
00:00:12,510 --> 00:00:15,150
and can you believe what it
was like before that existed?

6
00:00:15,150 --> 00:00:16,380
And we've come so far.

7
00:00:16,380 --> 00:00:20,190
We have a Athena
integration, we have CUR 2.0,

8
00:00:20,190 --> 00:00:22,533
we have Focus, we have
the CUR Query Library.

9
00:00:23,379 --> 00:00:25,650
We have grown so much since then.

10
00:00:25,650 --> 00:00:29,340
However, some of the
challenges customers have

11
00:00:29,340 --> 00:00:32,310
still are the same from 11 years ago.

12
00:00:32,310 --> 00:00:35,793
That is why we've broken down
our session into three topics.

13
00:00:37,830 --> 00:00:39,570
Optimization.

14
00:00:39,570 --> 00:00:42,000
Who doesn't wanna save money in the cloud?

15
00:00:42,000 --> 00:00:43,920
This is a classic reason why we have

16
00:00:43,920 --> 00:00:45,810
the cost and use report to be able to find

17
00:00:45,810 --> 00:00:48,150
where we're spending money and to save it.

18
00:00:48,150 --> 00:00:51,570
But it can be quite nuanced
where those opportunities are

19
00:00:51,570 --> 00:00:52,800
and they can even be improved

20
00:00:52,800 --> 00:00:54,303
by having other data sets.

21
00:00:56,160 --> 00:00:57,690
Cost allocation.

22
00:00:57,690 --> 00:00:59,880
One of the biggest conversations

23
00:00:59,880 --> 00:01:02,520
I have with customers every single day

24
00:01:02,520 --> 00:01:04,680
is about being able to understand

25
00:01:04,680 --> 00:01:06,363
and see your spend.

26
00:01:08,160 --> 00:01:10,020
Securing our costs.

27
00:01:10,020 --> 00:01:14,970
Not something we typically
discuss in the world of FinOps

28
00:01:14,970 --> 00:01:16,410
and optimization,

29
00:01:16,410 --> 00:01:18,660
but we hopefully all in this room

30
00:01:18,660 --> 00:01:20,400
enjoy using the cost and use report

31
00:01:20,400 --> 00:01:22,530
and we wanna allow others to do that,

32
00:01:22,530 --> 00:01:25,020
but we wanna be able
to control the access,

33
00:01:25,020 --> 00:01:27,600
so that they can't see
data they shouldn't.

34
00:01:27,600 --> 00:01:29,550
In today's session, we
are gonna cover these

35
00:01:29,550 --> 00:01:32,610
and give you new ways to access
your cost and usage report

36
00:01:32,610 --> 00:01:34,440
and solve these problems.

37
00:01:34,440 --> 00:01:36,720
Just to introduce myself,
my name is Steph Gooch,

38
00:01:36,720 --> 00:01:40,710
I'm a senior SA advocate at
AWS and joining me as Andy.

39
00:01:40,710 --> 00:01:42,030
- [Andy Brown] Hi
everyone, I'm Andy Brown.

40
00:01:42,030 --> 00:01:44,403
I'm a senior manager
specializing in FinOps.

41
00:01:45,570 --> 00:01:47,370
- [Steph Gooch] Before
we get into the coding

42
00:01:47,370 --> 00:01:49,290
and querying of today's session,

43
00:01:49,290 --> 00:01:52,110
we wanted to warm up with a little game.

44
00:01:52,110 --> 00:01:53,040
It's early, I know,

45
00:01:53,040 --> 00:01:54,540
but we thought we'd
get the energy flowing.

46
00:01:54,540 --> 00:01:57,150
So if I can get everyone
to stand up if you can

47
00:01:57,150 --> 00:01:58,650
and would like to participate.

48
00:02:00,720 --> 00:02:01,920
The way this game is gonna work,

49
00:02:01,920 --> 00:02:03,660
is gonna be a question on the screen

50
00:02:03,660 --> 00:02:05,160
and you're gonna have two options.

51
00:02:05,160 --> 00:02:06,480
If you think it's the first answer,

52
00:02:06,480 --> 00:02:07,560
you'll put your left hand up.

53
00:02:07,560 --> 00:02:08,670
If you think it's the second answer,

54
00:02:08,670 --> 00:02:10,440
you'll put your right hand up.

55
00:02:10,440 --> 00:02:13,443
It's an honesty, Gabe, if you
get it wrong, you sit down.

56
00:02:14,370 --> 00:02:15,990
There's only four questions, okay?

57
00:02:15,990 --> 00:02:17,340
The last one standing will get

58
00:02:17,340 --> 00:02:19,770
a very special CUR related sticker.

59
00:02:19,770 --> 00:02:21,900
At the end of the session,
you can come and claim.

60
00:02:21,900 --> 00:02:24,540
The idea is to just
recap on some CUR basics

61
00:02:24,540 --> 00:02:26,820
and make sure everyone's
on the same level.

62
00:02:26,820 --> 00:02:28,920
First question, what version

63
00:02:28,920 --> 00:02:32,520
of the AWS cost and usage
report has the newest features?

64
00:02:32,520 --> 00:02:33,720
CUR Legacy

65
00:02:33,720 --> 00:02:35,520
or CUR 2.0?

66
00:02:35,520 --> 00:02:37,083
Three, two, one.

67
00:02:38,490 --> 00:02:39,323
CUR 2.0.

68
00:02:39,323 --> 00:02:40,770
Did anyone get that wrong?

69
00:02:40,770 --> 00:02:42,180
Well done folks. Well done. Well done.

70
00:02:42,180 --> 00:02:44,348
Okay, so this is the newest CUR.

71
00:02:44,348 --> 00:02:45,181
This is one that has all the features.

72
00:02:45,181 --> 00:02:48,180
If you have not used it, you
need to start deploying it

73
00:02:48,180 --> 00:02:50,693
and this is what we'll be
using in today's session.

74
00:02:51,540 --> 00:02:54,510
- [Andy Brown] Where is the
data for the CUR stored?

75
00:02:54,510 --> 00:02:57,183
Is it S3 or RDS?

76
00:02:58,020 --> 00:03:00,720
Three, two, one.

77
00:03:00,720 --> 00:03:03,390
Yes. S3 is the right answer.

78
00:03:03,390 --> 00:03:05,760
Basically any data you can get into S3

79
00:03:05,760 --> 00:03:08,040
is available for you to
be able to query in Athena

80
00:03:08,040 --> 00:03:09,420
and that's what we're gonna be showing you

81
00:03:09,420 --> 00:03:10,620
as well later today.

82
00:03:10,620 --> 00:03:12,510
- [Steph Gooch] Okay, you're
all doing really well.

83
00:03:12,510 --> 00:03:14,010
I need to have a lot of stickers.

84
00:03:14,010 --> 00:03:17,040
Are tags automatically
added to the CUR by default?

85
00:03:17,040 --> 00:03:18,843
Yes? No?

86
00:03:19,680 --> 00:03:21,000
Three, two, one.

87
00:03:21,000 --> 00:03:24,003
Get those hands up. No.

88
00:03:24,870 --> 00:03:26,250
Okay, that's got a few of you.

89
00:03:26,250 --> 00:03:28,980
The key phrase there is by default

90
00:03:28,980 --> 00:03:32,400
tags you have to have cost
allocation tags enabled

91
00:03:32,400 --> 00:03:35,280
so you don't have all your
organizations, hundreds of tags.

92
00:03:35,280 --> 00:03:36,510
We'll show some tagging there.

93
00:03:36,510 --> 00:03:38,070
You can be very smug if
you've got that one right.

94
00:03:38,070 --> 00:03:39,330
I can feel people's energy.

95
00:03:39,330 --> 00:03:40,770
All right, last query.

96
00:03:40,770 --> 00:03:44,940
- [Andy Brown] Can you add
account names into CUR 2.0?

97
00:03:44,940 --> 00:03:45,963
Yes or no?

98
00:03:46,860 --> 00:03:48,660
Three, two, one.

99
00:03:48,660 --> 00:03:49,892
Yes.

100
00:03:49,892 --> 00:03:50,970
- [Steph Gooch] Giving it
away at the front. Yes.

101
00:03:50,970 --> 00:03:51,870
- [Andy Brown] Yes.

102
00:03:51,870 --> 00:03:54,586
This is one of the new
features available in CUR 2.0

103
00:03:54,586 --> 00:03:55,419
for you doing it

104
00:03:55,419 --> 00:03:56,700
and we're gonna be using
that as one of our ways

105
00:03:56,700 --> 00:03:58,683
of securing the curve further.

106
00:03:59,520 --> 00:04:00,353
- [Steph Gooch] Brilliant.

107
00:04:00,353 --> 00:04:01,186
All right you guys, go get a sticker.

108
00:04:01,186 --> 00:04:03,450
Please sit down and come to us at the end

109
00:04:03,450 --> 00:04:05,610
and you can grab one of
our CUR special stickers.

110
00:04:05,610 --> 00:04:06,443
That was a little bit of fun.

111
00:04:06,443 --> 00:04:08,160
Get everyone standing and
moving before our session,

112
00:04:08,160 --> 00:04:09,930
'cause we know it is nice and early

113
00:04:09,930 --> 00:04:12,510
and thanks again for joining us.

114
00:04:12,510 --> 00:04:13,380
Let's get coding.

115
00:04:13,380 --> 00:04:15,750
So this is a live coding session.

116
00:04:15,750 --> 00:04:18,090
Like I said, we'll be querying,

117
00:04:18,090 --> 00:04:20,220
it is live so we'll be doing it

118
00:04:20,220 --> 00:04:21,630
and we'll wanna have some help.

119
00:04:21,630 --> 00:04:23,520
So we'll be asking questions to you guys,

120
00:04:23,520 --> 00:04:25,860
that's the interactive part
and you can shout them out.

121
00:04:25,860 --> 00:04:28,890
If you have questions about the session,

122
00:04:28,890 --> 00:04:31,740
we'll be taking those outside at the end,

123
00:04:31,740 --> 00:04:33,720
so we can get through everything today.

124
00:04:33,720 --> 00:04:37,110
But warning, I am dyslexic.

125
00:04:37,110 --> 00:04:39,900
There will be spelling
errors, there might be errors.

126
00:04:39,900 --> 00:04:42,480
What we have done is we have
a nice little tally over here.

127
00:04:42,480 --> 00:04:45,630
So in our sections, whoever
gets the most errors

128
00:04:45,630 --> 00:04:48,585
will have to do some kind
of forfeit at re:Invent.

129
00:04:48,585 --> 00:04:49,920
We do this every year.

130
00:04:49,920 --> 00:04:51,510
Make sure that you get
our LinkedIns at the end

131
00:04:51,510 --> 00:04:54,930
to see who have what we do
at the end of our session.

132
00:04:54,930 --> 00:04:57,030
We will make sure to share a GitHub repo

133
00:04:57,030 --> 00:04:58,140
in our resources at the end

134
00:04:58,140 --> 00:05:00,360
that have all of our queries
so you can take them home,

135
00:05:00,360 --> 00:05:01,530
so don't feel that you have to make

136
00:05:01,530 --> 00:05:03,420
any kind of specific notes.

137
00:05:03,420 --> 00:05:05,580
We've also re-prerecorded a session

138
00:05:05,580 --> 00:05:06,720
that's gonna be on a YouTube channel

139
00:05:06,720 --> 00:05:09,810
so you can watch this back
later and follow along.

140
00:05:09,810 --> 00:05:11,610
But with that I'm gonna hand over to Andy

141
00:05:11,610 --> 00:05:13,380
for our first query.

142
00:05:13,380 --> 00:05:15,600
- [Andy Brown] Great, thank you Steph.

143
00:05:15,600 --> 00:05:17,640
So who's been in this situation before?

144
00:05:17,640 --> 00:05:20,070
You're at your desk doing your day job

145
00:05:20,070 --> 00:05:22,023
and you get an email from AWS.

146
00:05:23,580 --> 00:05:25,470
Your custom normally detection detected,

147
00:05:25,470 --> 00:05:28,440
your NAT Gateway bend has increased.

148
00:05:28,440 --> 00:05:31,020
So you decide to go
into AWS cost explorer,

149
00:05:31,020 --> 00:05:33,360
you filter by the service EC2 other

150
00:05:33,360 --> 00:05:34,530
and you see yes,

151
00:05:34,530 --> 00:05:37,714
not only has your NAT Gateway
spend started to increase,

152
00:05:37,714 --> 00:05:39,240
we're also seeing some NAT Gateway bytes

153
00:05:39,240 --> 00:05:42,510
and we are also seeing some
data transfer reasonable bytes.

154
00:05:42,510 --> 00:05:45,240
So audience shout out if you know

155
00:05:45,240 --> 00:05:48,333
what data transfer regional bytes are.

156
00:05:50,850 --> 00:05:51,810
- [Steph Gooch] Into AZ.

157
00:05:51,810 --> 00:05:53,550
- [Andy Brown] I think
I heard an into AZ. Yes.

158
00:05:53,550 --> 00:05:55,710
So data transfer of regional bytes,

159
00:05:55,710 --> 00:05:58,020
it's inavailability zone data transfer.

160
00:05:58,020 --> 00:06:02,100
So for example, an EC2
instance in USD one A,

161
00:06:02,100 --> 00:06:05,970
talking to an US EC2
instance in US D one B.

162
00:06:05,970 --> 00:06:06,930
And to be honest,

163
00:06:06,930 --> 00:06:09,240
I don't really remember
all the different types

164
00:06:09,240 --> 00:06:11,280
of data transfer and how
they pair US usage types

165
00:06:11,280 --> 00:06:12,810
and costs flow and occur.

166
00:06:12,810 --> 00:06:13,800
And so when I saw this,

167
00:06:13,800 --> 00:06:15,090
I should typed into Amazon queue

168
00:06:15,090 --> 00:06:15,923
and it told me.

169
00:06:17,040 --> 00:06:20,400
But Steph, if you saw this
and you got this email,

170
00:06:20,400 --> 00:06:21,840
what would you do?

171
00:06:21,840 --> 00:06:23,580
- [Steph Gooch] I would just
push it to the developers

172
00:06:23,580 --> 00:06:24,813
and run away probably,

173
00:06:25,692 --> 00:06:27,927
which is what you're meant to do, right?

174
00:06:27,927 --> 00:06:28,760
- [Andy Brown] Yeah, one approach

175
00:06:28,760 --> 00:06:30,150
but probably not the AWS recommended way.

176
00:06:30,150 --> 00:06:31,950
So what I'm gonna be showing you today is,

177
00:06:31,950 --> 00:06:33,960
I'm gonna be going into
the cost and usage report.

178
00:06:33,960 --> 00:06:36,240
We're gonna filter and
have a look at the costs,

179
00:06:36,240 --> 00:06:38,280
but then we'll realize that
we need more information.

180
00:06:38,280 --> 00:06:40,530
So we're gonna be
integrating a new data source

181
00:06:40,530 --> 00:06:42,600
and then hopefully we'll
find that root cause

182
00:06:42,600 --> 00:06:44,400
and optimize this spend.

183
00:06:44,400 --> 00:06:46,533
So with that, let's go into the console.

184
00:06:48,120 --> 00:06:48,990
Cool, here we go.

185
00:06:48,990 --> 00:06:51,900
So everything we're doing
today, we're doing in CUR 2.0

186
00:06:51,900 --> 00:06:54,600
and we already have it
set up to go into Athena.

187
00:06:54,600 --> 00:06:56,280
I have this query to begin with

188
00:06:56,280 --> 00:06:57,870
which is their designed to mimic

189
00:06:57,870 --> 00:06:59,070
what we're seeing in cost explorers.

190
00:06:59,070 --> 00:07:00,063
So let me run this.

191
00:07:01,590 --> 00:07:03,450
It's gonna start coming back with

192
00:07:03,450 --> 00:07:05,550
the usage types coming through,

193
00:07:05,550 --> 00:07:06,720
you'll see we've got a variety

194
00:07:06,720 --> 00:07:09,220
of different NAT Gateways
and we've got the spend,

195
00:07:10,110 --> 00:07:12,990
but from this view it's
still not very clear on

196
00:07:12,990 --> 00:07:16,560
what is causing that increase
we saw in Cost Explorer.

197
00:07:16,560 --> 00:07:17,640
And so the first thing
we're gonna be doing,

198
00:07:17,640 --> 00:07:20,160
is we're gonna be creating
like a quasi pivot table.

199
00:07:20,160 --> 00:07:22,080
I'm gonna take the
September and October costs

200
00:07:22,080 --> 00:07:25,050
and split them out into
their own separate columns.

201
00:07:25,050 --> 00:07:25,883
So lemme scroll up,

202
00:07:25,883 --> 00:07:27,390
I'm gonna just navigate
this outta the way,

203
00:07:27,390 --> 00:07:28,290
so make it bigger.

204
00:07:29,190 --> 00:07:33,060
So within the sum statement
I'm gonna be putting a case,

205
00:07:33,060 --> 00:07:35,780
think about cases being an else statement.

206
00:07:35,780 --> 00:07:40,050
So case when billing period equals

207
00:07:40,050 --> 00:07:42,180
and we'll do September 1st,

208
00:07:42,180 --> 00:07:46,980
then return the cost, else return nothing.

209
00:07:46,980 --> 00:07:49,450
So when this runs

210
00:07:50,340 --> 00:07:52,110
only September cost will
start appearing this.

211
00:07:52,110 --> 00:07:55,560
And then so I can rename
the column September

212
00:07:55,560 --> 00:07:58,320
and then I just need to do
exactly the same for October,

213
00:07:58,320 --> 00:08:01,230
so let me copy, put in the comma,

214
00:08:01,230 --> 00:08:03,460
I'm gonna change this to 10 for October

215
00:08:04,950 --> 00:08:06,683
and change it to October. Cool.

216
00:08:08,040 --> 00:08:09,720
Now I can change my select statement.

217
00:08:09,720 --> 00:08:11,310
So no longer the billing period

218
00:08:11,310 --> 00:08:13,170
because I have my worst
statement to narrow it down

219
00:08:13,170 --> 00:08:14,730
to only September and October.

220
00:08:14,730 --> 00:08:16,173
I have it split out into
two separate columns,

221
00:08:16,173 --> 00:08:18,180
so I can delete that.

222
00:08:18,180 --> 00:08:20,490
I'm also gonna delete usage type.

223
00:08:20,490 --> 00:08:22,350
Right now I don't care
if it's data transfer

224
00:08:22,350 --> 00:08:23,640
or NAT Gateway related,

225
00:08:23,640 --> 00:08:26,250
I just want to know which
resources are causing this spike

226
00:08:26,250 --> 00:08:27,780
to work out, what's to do next.

227
00:08:27,780 --> 00:08:28,880
So let me delete that.

228
00:08:30,480 --> 00:08:31,500
I can change my group bys.

229
00:08:31,500 --> 00:08:33,296
'cause we're now in grouping one,

230
00:08:33,296 --> 00:08:35,490
one resource which is the resource ID.

231
00:08:35,490 --> 00:08:36,720
And I'm gonna change my order by,

232
00:08:36,720 --> 00:08:37,553
'cause I want to see

233
00:08:37,553 --> 00:08:39,510
what's the most expensive
resources in December,

234
00:08:39,510 --> 00:08:40,860
'cause that's where in October,

235
00:08:40,860 --> 00:08:42,743
'cause that's where we're
seeing the increase.

236
00:08:43,941 --> 00:08:44,790
So fingers crossed everything right,

237
00:08:44,790 --> 00:08:45,993
so let me run this now.

238
00:08:47,430 --> 00:08:48,300
- [Steph Gooch] While that's running.

239
00:08:48,300 --> 00:08:50,940
If you do see us about to make an error,

240
00:08:50,940 --> 00:08:52,440
you can shout out and stop us.

241
00:08:52,440 --> 00:08:54,090
'Cause often it's easier if people

242
00:08:54,090 --> 00:08:56,040
when you're looking at
someone else's query

243
00:08:56,040 --> 00:08:56,873
to find an error.

244
00:08:56,873 --> 00:08:57,810
So feel free to shout out

245
00:08:57,810 --> 00:08:59,160
if you see us about to make an error.

246
00:08:59,160 --> 00:09:01,140
- [Andy Brown] And my
common one is commas.

247
00:09:01,140 --> 00:09:02,340
I always forget about the commas

248
00:09:02,340 --> 00:09:03,660
or add too many commas.

249
00:09:03,660 --> 00:09:04,740
So as we see here,

250
00:09:04,740 --> 00:09:06,930
we've got some NAT Gateway
spends coming through

251
00:09:06,930 --> 00:09:09,030
and we've got some new
spends happening in October.

252
00:09:09,030 --> 00:09:10,950
So we've got this one here,
it's pretty much same,

253
00:09:10,950 --> 00:09:13,080
so this must have been
around the environment before

254
00:09:13,080 --> 00:09:14,680
but we've got two new resources.

255
00:09:15,630 --> 00:09:17,310
I could have tagging on this NAT Gateway

256
00:09:17,310 --> 00:09:18,900
which will probably tell me who owns this

257
00:09:18,900 --> 00:09:21,030
or what part of application with it.

258
00:09:21,030 --> 00:09:22,590
But the issue we have with NAT Gateway

259
00:09:22,590 --> 00:09:26,220
and also with the mail
of data transfer is,

260
00:09:26,220 --> 00:09:27,810
we don't know why.

261
00:09:27,810 --> 00:09:30,450
Like for those who don't
know what NAT Gateway is,

262
00:09:30,450 --> 00:09:34,500
there's something you deploy
within normally private VPCs

263
00:09:34,500 --> 00:09:35,760
which will allow your resources

264
00:09:35,760 --> 00:09:38,520
to have secure access out to the internet.

265
00:09:38,520 --> 00:09:40,110
It's just the middleman in the process.

266
00:09:40,110 --> 00:09:42,720
It doesn't actually
generate information itself.

267
00:09:42,720 --> 00:09:43,553
So in this situation,

268
00:09:43,553 --> 00:09:45,420
am I reaching out to the application team,

269
00:09:45,420 --> 00:09:47,880
'cause maybe they changed
the application deployment

270
00:09:47,880 --> 00:09:49,143
and something's changed.

271
00:09:50,040 --> 00:09:51,750
Or am I reaching out
to the networking team?

272
00:09:51,750 --> 00:09:53,640
'Cause maybe they changed
something in the configuration

273
00:09:53,640 --> 00:09:55,890
which is causing these
two NAT Gateways spin up

274
00:09:55,890 --> 00:09:58,200
and the data transfer going through.

275
00:09:58,200 --> 00:09:59,580
And this is where we hit the limitations

276
00:09:59,580 --> 00:10:00,840
of the cost continuity report

277
00:10:00,840 --> 00:10:03,570
and we have to try and
work out what's next.

278
00:10:03,570 --> 00:10:08,190
I am 100% not a networking
specialist. Really I'm not.

279
00:10:08,190 --> 00:10:11,610
And so as always I use
Q, Q is our best friend.

280
00:10:11,610 --> 00:10:13,560
As if I open up the panel here,

281
00:10:13,560 --> 00:10:16,020
hopefully it'll show you
the query we ran earlier.

282
00:10:16,020 --> 00:10:17,368
Here we go.

283
00:10:17,368 --> 00:10:20,410
And what I did was Q
helped me cost optimize

284
00:10:21,780 --> 00:10:24,090
my NAT Gateways and
the things it tells me,

285
00:10:24,090 --> 00:10:25,590
it tells me exactly some of the reasons

286
00:10:25,590 --> 00:10:28,200
and why that gateway spend
might be going across.

287
00:10:28,200 --> 00:10:30,240
And then it also tells me
like where do you want to go

288
00:10:30,240 --> 00:10:31,413
for extra information.

289
00:10:32,820 --> 00:10:36,693
Here Q is recommending
that we use VPC Flow Logs.

290
00:10:37,530 --> 00:10:39,554
So VPC Flow Logs is something you enable

291
00:10:39,554 --> 00:10:40,590
in each of your VPCs

292
00:10:40,590 --> 00:10:43,260
and what it does is it
tracks all the data flows

293
00:10:43,260 --> 00:10:44,580
within your resources,

294
00:10:44,580 --> 00:10:45,750
so you can work out what's going on

295
00:10:45,750 --> 00:10:47,000
and who's talking to who.

296
00:10:48,420 --> 00:10:49,350
When you deploy it,

297
00:10:49,350 --> 00:10:50,850
data starts appearing within minutes.

298
00:10:50,850 --> 00:10:51,990
So it's not something like the CUR,

299
00:10:51,990 --> 00:10:54,240
you have to wait for maybe up to 24 hours

300
00:10:54,240 --> 00:10:56,280
for the data to start flowing through.

301
00:10:56,280 --> 00:10:57,420
And also you get two choices

302
00:10:57,420 --> 00:10:59,370
of information of where it can go out to.

303
00:10:59,370 --> 00:11:00,660
It can either go to CloudWatch,

304
00:11:00,660 --> 00:11:02,880
so it's with the rest
of your application logs

305
00:11:02,880 --> 00:11:05,230
or you can actually have
the data flow into S3.

306
00:11:06,630 --> 00:11:08,243
If you choose S3,

307
00:11:08,243 --> 00:11:11,250
VPC Flow Logs also give you
a cloud formation template

308
00:11:11,250 --> 00:11:12,360
and the cloud formation template

309
00:11:12,360 --> 00:11:14,670
will do the full Athena setup for you.

310
00:11:14,670 --> 00:11:17,670
And so we enable VPC
Flow Logs in our area,

311
00:11:17,670 --> 00:11:19,500
we ran that cloud formation template

312
00:11:19,500 --> 00:11:22,140
and this is what we have set
up within our Athena today.

313
00:11:22,140 --> 00:11:25,620
So they expand out the database
on the left hand side again,

314
00:11:25,620 --> 00:11:26,453
I can change now

315
00:11:26,453 --> 00:11:29,430
as you see I've got my VPC
Flow Logs analysis table

316
00:11:29,430 --> 00:11:30,730
and I have the table here.

317
00:11:32,070 --> 00:11:34,020
Whenever I get a new data source,

318
00:11:34,020 --> 00:11:35,010
I normally span them out

319
00:11:35,010 --> 00:11:36,780
and I start having a little
bit of a nosy around,

320
00:11:36,780 --> 00:11:38,730
'cause I want to get my feel of the data

321
00:11:38,730 --> 00:11:40,200
before I start using it.

322
00:11:40,200 --> 00:11:43,650
So let me preview and let me hide Q,

323
00:11:43,650 --> 00:11:44,850
don't need them anymore.

324
00:11:46,320 --> 00:11:48,990
Okay, and so as the data
cuts are coming back,

325
00:11:48,990 --> 00:11:50,760
we'll start getting some of
the information available

326
00:11:50,760 --> 00:11:52,140
in VPC Flow Logs.

327
00:11:52,140 --> 00:11:54,240
We have the account ID all sitting in.

328
00:11:54,240 --> 00:11:56,523
We have the source and
destination address,

329
00:11:57,420 --> 00:11:59,370
we then have some port information

330
00:11:59,370 --> 00:12:00,660
and then we have some byte information.

331
00:12:00,660 --> 00:12:04,290
So for example, this row
here is representing 44 bytes

332
00:12:04,290 --> 00:12:06,640
of information going
between the two resources.

333
00:12:07,950 --> 00:12:09,660
We have the start and end time.

334
00:12:09,660 --> 00:12:12,420
This is all in unix epoch time.

335
00:12:12,420 --> 00:12:14,040
And so if you wanted to translate this out

336
00:12:14,040 --> 00:12:15,420
into something a little bit machinery,

337
00:12:15,420 --> 00:12:18,120
there is a function within
Athena to do that for you.

338
00:12:18,120 --> 00:12:19,440
But in our case we just,

339
00:12:19,440 --> 00:12:21,210
the daily granularity is enough

340
00:12:21,210 --> 00:12:24,420
and the VPC Flow Logs is
automatically partitioned by day

341
00:12:24,420 --> 00:12:26,970
and so I don't need to
worry about converting this.

342
00:12:27,840 --> 00:12:30,540
So let me change this into
something a little bit more

343
00:12:30,540 --> 00:12:31,980
just the columns of information I want.

344
00:12:31,980 --> 00:12:34,090
So I want the source address

345
00:12:36,570 --> 00:12:38,460
and the destination address

346
00:12:38,460 --> 00:12:40,533
and then I'm gonna do a sum of the bytes.

347
00:12:43,170 --> 00:12:44,703
Can I type today? There we go.

348
00:12:46,500 --> 00:12:48,180
Sum off bytes.

349
00:12:48,180 --> 00:12:52,680
Oh, I'm gonna add, I need to
add in some filters now here.

350
00:12:52,680 --> 00:12:54,289
So I need her do aware statement,

351
00:12:54,289 --> 00:12:58,200
'cause I'm gonna do where
the month is in September.

352
00:12:58,200 --> 00:12:59,460
October, so she just narrow it down

353
00:12:59,460 --> 00:13:02,100
to the months where we saw
that's increase in spike.

354
00:13:02,100 --> 00:13:04,830
I need to add in a group by one and two

355
00:13:04,830 --> 00:13:06,960
for my source and destination address.

356
00:13:06,960 --> 00:13:10,320
I am also gonna order by
the who's talking the most.

357
00:13:10,320 --> 00:13:12,180
So I'm gonna add in my order by

358
00:13:12,180 --> 00:13:13,770
and I'm gonna order by free descending,

359
00:13:13,770 --> 00:13:16,320
'cause I want to have
those biggest speakers.

360
00:13:16,320 --> 00:13:17,860
And then keep the limit 10,

361
00:13:17,860 --> 00:13:19,020
'cause there's a lot of
resources in my account.

362
00:13:19,020 --> 00:13:20,550
I actually want to know
who are the biggest ones

363
00:13:20,550 --> 00:13:21,950
to work out what's going on.

364
00:13:23,010 --> 00:13:24,690
I could just run this right now

365
00:13:24,690 --> 00:13:26,400
and this will return some information,

366
00:13:26,400 --> 00:13:27,960
but the byte numbers are
gonna be really large,

367
00:13:27,960 --> 00:13:29,610
'cause we've got a lot
of transfer going in.

368
00:13:29,610 --> 00:13:31,050
And so really, what I want to do is,

369
00:13:31,050 --> 00:13:33,810
I want to convert the bytes to gigabytes

370
00:13:33,810 --> 00:13:35,700
because that's how AWS
charges for us stuff.

371
00:13:35,700 --> 00:13:38,520
So we can align it to
what's happening in the CUR.

372
00:13:38,520 --> 00:13:41,220
And so audience shout
out if you know this,

373
00:13:41,220 --> 00:13:45,273
if I take bytes and I divide
it by 1,024, what do I get?

374
00:13:46,200 --> 00:13:48,060
Yeah, I hear some kilobytes.

375
00:13:48,060 --> 00:13:50,670
And another thousand 24? Megabytes.

376
00:13:50,670 --> 00:13:54,270
And then the final 1,024? Gigabytes. Yeah.

377
00:13:54,270 --> 00:13:55,436
So I'm doing that,

378
00:13:55,436 --> 00:13:57,390
so I can then compare it
to my costing user report.

379
00:13:57,390 --> 00:13:58,917
So let me run this

380
00:13:58,917 --> 00:14:01,517
and fingers crossed we'll
get some information back.

381
00:14:04,356 --> 00:14:05,520
Here we go.

382
00:14:05,520 --> 00:14:07,890
Okay, we'll get information back.

383
00:14:07,890 --> 00:14:10,330
But all the numbers are
returning zero bytes

384
00:14:11,220 --> 00:14:14,283
and this is due to the
way Athena handles data.

385
00:14:15,180 --> 00:14:16,830
So if we look at the definition

386
00:14:16,830 --> 00:14:18,900
of the table here on the left-hand side,

387
00:14:18,900 --> 00:14:22,410
you'll see that bytes are
stored as a big integer.

388
00:14:22,410 --> 00:14:25,410
And so this is the number
without any decimal places.

389
00:14:25,410 --> 00:14:29,190
And so at the above when divided by 1,024,

390
00:14:29,190 --> 00:14:32,070
Athena continues to ignore decimal places.

391
00:14:32,070 --> 00:14:32,940
So you remember that row

392
00:14:32,940 --> 00:14:35,250
where we had that 44 bytes of transfer.

393
00:14:35,250 --> 00:14:37,020
You drive that by 1,024,

394
00:14:37,020 --> 00:14:39,720
you're gonna get zero
if you round it down.

395
00:14:39,720 --> 00:14:41,460
And so there is a way to force Athena

396
00:14:41,460 --> 00:14:44,430
to think about those bytes
and include them within it.

397
00:14:44,430 --> 00:14:45,960
And the easiest way to do this

398
00:14:45,960 --> 00:14:49,093
is should put a 0.0 at each
of the end of these numbers.

399
00:14:49,093 --> 00:14:51,660
'Cause we're gonna say divide everything,

400
00:14:51,660 --> 00:14:53,460
but I care about the decimal places.

401
00:14:54,630 --> 00:14:57,510
So now when I run this, fingers crossed,

402
00:14:57,510 --> 00:15:00,573
I'm gonna get some real data
coming back and here we go.

403
00:15:01,440 --> 00:15:03,630
We've got the top four
rows coming through.

404
00:15:03,630 --> 00:15:04,463
They're the biggest ones.

405
00:15:04,463 --> 00:15:06,060
Everything else is under
like one gigabytes,

406
00:15:06,060 --> 00:15:08,213
so they're small in the
whole scheme of things.

407
00:15:09,570 --> 00:15:13,500
But like anyone know these
IP addresses, like no like,

408
00:15:13,500 --> 00:15:15,570
like if you do know IP addresses
at the top of your head,

409
00:15:15,570 --> 00:15:18,639
then well done.

410
00:15:18,639 --> 00:15:19,860
But I don't know these IP addresses,

411
00:15:19,860 --> 00:15:22,260
they don't really mean anything for me.

412
00:15:22,260 --> 00:15:23,430
And so once again

413
00:15:23,430 --> 00:15:25,710
we're back to our favorite friend Q.

414
00:15:25,710 --> 00:15:28,230
And so this tab here

415
00:15:28,230 --> 00:15:30,660
represents the account
where the issue's happening.

416
00:15:30,660 --> 00:15:32,700
This is where we deployed our VPC

417
00:15:32,700 --> 00:15:34,080
and I've gone ahead and asked Q

418
00:15:34,080 --> 00:15:36,120
to explain one of the IP addresses

419
00:15:36,120 --> 00:15:36,953
and you see it's come,

420
00:15:36,953 --> 00:15:39,210
it's able to pick up
exactly which instance ID,

421
00:15:39,210 --> 00:15:40,920
it's got the service, we stopped it,

422
00:15:40,920 --> 00:15:42,450
it tells me what instance type

423
00:15:42,450 --> 00:15:44,100
and all the relevant information.

424
00:15:45,480 --> 00:15:46,950
And so what we actually did was,

425
00:15:46,950 --> 00:15:49,830
I chucked all these IP addresses into Q

426
00:15:49,830 --> 00:15:52,380
and told me to tell me what they are

427
00:15:52,380 --> 00:15:54,120
and also group them together.

428
00:15:54,120 --> 00:15:55,650
We have a quite large environment,

429
00:15:55,650 --> 00:15:57,400
we've got auto scaling up and down,

430
00:15:58,920 --> 00:16:01,250
and this, which one is it?

431
00:16:01,250 --> 00:16:02,490
Here we go. Here we go.

432
00:16:02,490 --> 00:16:04,650
And this is what Q returned.

433
00:16:04,650 --> 00:16:05,820
It's using a light statement,

434
00:16:05,820 --> 00:16:07,440
'cause like I mentioned we've
got auto scaling groups.

435
00:16:07,440 --> 00:16:10,110
So the IP addresses of the
instances are changing over time

436
00:16:10,110 --> 00:16:10,980
and this categorized it

437
00:16:10,980 --> 00:16:13,050
into all the different subnets we have.

438
00:16:13,050 --> 00:16:14,520
We then have the two NAT Gateways.

439
00:16:14,520 --> 00:16:15,420
We've got running environment,

440
00:16:15,420 --> 00:16:18,003
both their public and
their private IP addresses.

441
00:16:19,020 --> 00:16:21,330
And then we have just general group by.

442
00:16:21,330 --> 00:16:23,430
When I ask Q about some
of the IP addresses,

443
00:16:23,430 --> 00:16:24,450
it just didn't recognize them.

444
00:16:24,450 --> 00:16:26,280
It couldn't find them
within our environment.

445
00:16:26,280 --> 00:16:27,510
And so it made a guess.

446
00:16:27,510 --> 00:16:28,920
The guess was either
it's like an internet,

447
00:16:28,920 --> 00:16:31,290
maybe there's a file we're
downloading or getting from,

448
00:16:31,290 --> 00:16:33,240
or maybe it's an AWS
service, maybe it's S3

449
00:16:33,240 --> 00:16:34,320
or RDS or something like that,

450
00:16:34,320 --> 00:16:35,550
it's reaching out too.

451
00:16:35,550 --> 00:16:36,383
And another situation,

452
00:16:36,383 --> 00:16:38,130
'cause we just can what we can control,

453
00:16:38,130 --> 00:16:39,720
which you're gonna group it under here

454
00:16:40,770 --> 00:16:43,440
and then this repeated again
for the destination location.

455
00:16:43,440 --> 00:16:44,730
So let me take this,

456
00:16:44,730 --> 00:16:48,570
I'm gonna copy you and let
me go back to my query.

457
00:16:48,570 --> 00:16:49,527
Here we go.

458
00:16:49,527 --> 00:16:51,450
And so I'm gonna just replace source

459
00:16:51,450 --> 00:16:54,273
and destination address
with those two queries.

460
00:16:55,410 --> 00:16:57,210
So now when I run it,

461
00:16:57,210 --> 00:16:58,500
fingers crossed we'll
get a little bit more

462
00:16:58,500 --> 00:17:00,060
useful information.

463
00:17:00,060 --> 00:17:02,110
Here we go. And it started to categorize.

464
00:17:03,960 --> 00:17:06,360
So I have a challenge for you.

465
00:17:06,360 --> 00:17:10,893
Can anyone recognize which
row number is the issue?

466
00:17:12,570 --> 00:17:15,303
Oh, did I hear?

467
00:17:17,832 --> 00:17:19,841
So three.
- Someone said four.

468
00:17:19,841 --> 00:17:20,674
- [Andy Brown] A four, no three,

469
00:17:20,674 --> 00:17:21,660
I'm pretty sure three.

470
00:17:21,660 --> 00:17:23,403
Yes, three is the issue.

471
00:17:24,330 --> 00:17:25,980
There's two reasons why I know this.

472
00:17:25,980 --> 00:17:27,900
One, I ask you,

473
00:17:27,900 --> 00:17:30,120
but two, and I'll show you in a moment.

474
00:17:30,120 --> 00:17:32,460
I went back to what our
fundamentals in the cost are.

475
00:17:32,460 --> 00:17:34,920
But I'll tell you why this is an issue

476
00:17:34,920 --> 00:17:36,300
because we're not networking.

477
00:17:36,300 --> 00:17:37,440
This is not a networking session.

478
00:17:37,440 --> 00:17:41,310
This is advanced analytics
would occur. Two reasons.

479
00:17:41,310 --> 00:17:43,140
First of all, I mentioned
that NAT Gateways

480
00:17:43,140 --> 00:17:45,570
are designed to provide private resources

481
00:17:45,570 --> 00:17:47,550
access to the internet.

482
00:17:47,550 --> 00:17:50,440
We have a public subnet
using this NAT Gateway

483
00:17:51,360 --> 00:17:54,270
and a public resource already
has a public IP address.

484
00:17:54,270 --> 00:17:55,530
It doesn't need to go NAT Gateway,

485
00:17:55,530 --> 00:17:57,210
it can just go to the internet itself.

486
00:17:57,210 --> 00:17:58,660
And so why it's rooting that.

487
00:17:59,550 --> 00:18:00,840
The second issue,

488
00:18:00,840 --> 00:18:04,590
we have this public subnet
in availability zone two

489
00:18:04,590 --> 00:18:08,040
talking to a NAT Gateway
in availability zone one

490
00:18:08,040 --> 00:18:11,313
and that's causing that
inter AZ data transfer.

491
00:18:12,360 --> 00:18:14,820
So like I said,

492
00:18:14,820 --> 00:18:16,530
that was purposely
designed to challenge you.

493
00:18:16,530 --> 00:18:18,870
I wasn't expecting people
to be able to identify this.

494
00:18:18,870 --> 00:18:21,570
And so how do we actually
identify what the issue is

495
00:18:21,570 --> 00:18:23,523
and go with and it's down to the cost,

496
00:18:23,523 --> 00:18:25,323
it's all about the money at the end.

497
00:18:26,280 --> 00:18:27,240
And so what I'm gonna do next,

498
00:18:27,240 --> 00:18:29,190
is I'm gonna work out what the NAT Gateway

499
00:18:29,190 --> 00:18:30,540
and data transfer charges are

500
00:18:30,540 --> 00:18:32,340
for these entries within this table.

501
00:18:34,050 --> 00:18:36,270
I'm gonna be starting with
using a with statement.

502
00:18:36,270 --> 00:18:39,600
So W statement is where you
create a subquery win Athena.

503
00:18:39,600 --> 00:18:41,610
So we're saying run everything here

504
00:18:41,610 --> 00:18:44,040
and we're gonna use it again later.

505
00:18:44,040 --> 00:18:46,830
So I'm gonna do with,
I'm gonna call it VPC

506
00:18:46,830 --> 00:18:49,140
as open the bracket

507
00:18:49,140 --> 00:18:50,790
and then go all the way
to the end of the crew

508
00:18:50,790 --> 00:18:51,940
we were working before,

509
00:18:52,920 --> 00:18:55,410
I want to take the semicolon
away and close the bracket.

510
00:18:55,410 --> 00:18:57,886
So that whole thing we've
been playing around with

511
00:18:57,886 --> 00:18:59,400
is now called VPC.

512
00:18:59,400 --> 00:19:03,160
So I can do select star from VPC

513
00:19:04,170 --> 00:19:05,400
and now I'm gonna add in my two columns

514
00:19:05,400 --> 00:19:07,650
for NAT Gateway and data transfer charge.

515
00:19:07,650 --> 00:19:09,870
I'm gonna use my old friend case,

516
00:19:09,870 --> 00:19:14,170
say case when source location is like NAT

517
00:19:16,560 --> 00:19:18,930
or destination locations like Nat.

518
00:19:18,930 --> 00:19:21,033
So anything which is using a NAT Gateway,

519
00:19:22,500 --> 00:19:25,590
then I'm gonna take the
sum with the gigabytes

520
00:19:25,590 --> 00:19:28,650
and I'm gonna to it by 0.045.

521
00:19:28,650 --> 00:19:29,850
The reason for 0.045

522
00:19:30,849 --> 00:19:32,850
is this is how much AWS charges

523
00:19:32,850 --> 00:19:36,570
for that gateway way data
processing within USD1 one A.

524
00:19:36,570 --> 00:19:38,520
Q told me this when in my earlier query.

525
00:19:38,520 --> 00:19:39,920
So that's how I get it from.

526
00:19:40,920 --> 00:19:43,710
I'm gonna then everything
else will be zero

527
00:19:43,710 --> 00:19:47,887
and call this as NAT data USD.

528
00:19:51,600 --> 00:19:52,433
Next statement is then

529
00:19:52,433 --> 00:19:55,049
for the enter a valid
C zone data transfer.

530
00:19:55,049 --> 00:19:56,251
So this is gonna be case where

531
00:19:56,251 --> 00:19:59,590
and the source location is like AZ1

532
00:20:00,510 --> 00:20:01,860
and we want an and statement

533
00:20:01,860 --> 00:20:03,210
because we want it where AZ1

534
00:20:03,210 --> 00:20:06,300
is talking to availability zone two.

535
00:20:06,300 --> 00:20:09,453
So destination location is like AZ2,

536
00:20:10,620 --> 00:20:13,260
then this is gonna be the sum of gigabytes

537
00:20:13,260 --> 00:20:15,270
and this time we're gonna
be times it by 0.02,

538
00:20:15,270 --> 00:20:16,590
'cause that's how much we charge for into

539
00:20:16,590 --> 00:20:18,190
availability zone data transfer.

540
00:20:19,590 --> 00:20:21,300
And then I need the
same again for this one.

541
00:20:21,300 --> 00:20:23,283
So let me copy this,

542
00:20:25,650 --> 00:20:27,600
put this and we're gonna do the other way.

543
00:20:27,600 --> 00:20:28,980
So we've got availability zone two,

544
00:20:28,980 --> 00:20:33,090
talking of two availability
zone one and then L zero.

545
00:20:33,090 --> 00:20:35,440
And then this can be then
my data transfer USD.

546
00:20:36,660 --> 00:20:38,040
Fingers crossed, this is all good.

547
00:20:38,040 --> 00:20:39,213
Let me run this.

548
00:20:40,920 --> 00:20:43,410
It's running or is a
good sign. Here we go.

549
00:20:43,410 --> 00:20:44,433
And as you can see,

550
00:20:45,916 --> 00:20:47,610
it is row free, all the charges.

551
00:20:47,610 --> 00:20:50,130
Remember if you go back to that
original cost explorer view,

552
00:20:50,130 --> 00:20:52,380
the NAT Gateway data
processing started up,

553
00:20:52,380 --> 00:20:53,850
the data transfer started up

554
00:20:53,850 --> 00:20:56,070
and we can see it's all row free.

555
00:20:56,070 --> 00:20:58,710
What this tells me now is I can reach out

556
00:20:58,710 --> 00:21:01,173
to my networking team to investigate.

557
00:21:02,190 --> 00:21:03,570
We got maybe a configuration change.

558
00:21:03,570 --> 00:21:05,160
Maybe they did something
for the root tables

559
00:21:05,160 --> 00:21:06,780
for that public subnet,
which is now forcing,

560
00:21:06,780 --> 00:21:07,920
it goes in that gateway

561
00:21:07,920 --> 00:21:09,450
and it's just that extra information

562
00:21:09,450 --> 00:21:10,850
to go to them to provide it.

563
00:21:14,160 --> 00:21:17,460
And so what I want you to
take away from this is,

564
00:21:17,460 --> 00:21:19,380
think about what other data sources.

565
00:21:19,380 --> 00:21:20,213
I do love the CUR.

566
00:21:20,213 --> 00:21:22,830
I wouldn't be on this stage
if I didn't love the CUR,

567
00:21:22,830 --> 00:21:24,930
but it's not the answer for everything.

568
00:21:24,930 --> 00:21:26,670
Maybe it is data transfer investigating

569
00:21:26,670 --> 00:21:28,980
and that's where the VPC
Flow Logs come through.

570
00:21:28,980 --> 00:21:31,530
Or maybe you're investigating
extended support charges

571
00:21:31,530 --> 00:21:32,940
and why they started introduced

572
00:21:32,940 --> 00:21:35,220
and you want to bring
in an inventory report.

573
00:21:35,220 --> 00:21:39,180
As long as you can get it into
S3, you can get to Athena.

574
00:21:39,180 --> 00:21:41,160
Finally, if you don't know what to do,

575
00:21:41,160 --> 00:21:42,540
use Amazon Q.

576
00:21:42,540 --> 00:21:43,530
The example I'm showing you today

577
00:21:43,530 --> 00:21:46,110
is a genuine customer
problem I helped with

578
00:21:46,110 --> 00:21:48,270
and I really had no clue what to do.

579
00:21:48,270 --> 00:21:49,530
I use Q for everything.

580
00:21:49,530 --> 00:21:53,070
I chucked all the information,
all the results into Q

581
00:21:53,070 --> 00:21:54,210
and it told me exactly what to do.

582
00:21:54,210 --> 00:21:56,550
It told me where to send
people who to go look into,

583
00:21:56,550 --> 00:21:59,250
'cause Q knows your AWS account.

584
00:21:59,250 --> 00:22:00,270
Everything I showed you today

585
00:22:00,270 --> 00:22:02,250
is from the free tier of Q as well.

586
00:22:02,250 --> 00:22:04,163
So it didn't cost me anything to run it.

587
00:22:05,040 --> 00:22:06,180
So this part of this session

588
00:22:06,180 --> 00:22:07,800
was very much focusing
on a particular service.

589
00:22:07,800 --> 00:22:09,660
We're looking at NAT Gateway.

590
00:22:09,660 --> 00:22:12,000
But what happens if you wanted to work out

591
00:22:12,000 --> 00:22:14,310
if your whole application
is running efficiently

592
00:22:14,310 --> 00:22:16,560
and if you have the
right KPIs to track that.

593
00:22:16,560 --> 00:22:18,000
With that I'm gonna hand it over to Steph

594
00:22:18,000 --> 00:22:20,703
to talk a little about our
favorite friend Mr. AI.

595
00:22:21,960 --> 00:22:23,220
- [Steph Gooch] Thanks Andy. Yes.

596
00:22:23,220 --> 00:22:25,980
Cost allocation, like I said earlier,

597
00:22:25,980 --> 00:22:27,960
one of the big challenges
we see with customers,

598
00:22:27,960 --> 00:22:29,550
which has been made trickier

599
00:22:29,550 --> 00:22:31,410
by things like Amazon Bedrock

600
00:22:31,410 --> 00:22:33,720
when it comes to allocating that spend.

601
00:22:33,720 --> 00:22:35,760
So we are gonna focus on just diving into

602
00:22:35,760 --> 00:22:37,740
some cost allocation for Bedrock usage

603
00:22:37,740 --> 00:22:39,660
and then looking at a bigger picture.

604
00:22:39,660 --> 00:22:42,780
But there are two big
reasons why we see customers

605
00:22:42,780 --> 00:22:45,720
not being able to cost
allocate Bedrock accurately.

606
00:22:45,720 --> 00:22:48,240
The first is billing entities.

607
00:22:48,240 --> 00:22:50,640
So when you choose your models,

608
00:22:50,640 --> 00:22:52,200
these have an effect on the entities

609
00:22:52,200 --> 00:22:55,830
and these show up differently
in the cost and usage report.

610
00:22:55,830 --> 00:22:57,420
So our first party models,

611
00:22:57,420 --> 00:23:02,420
these are ones that are trained,
sold, and developed by AWS.

612
00:23:04,380 --> 00:23:07,230
So think of things like Nova and Titan.

613
00:23:07,230 --> 00:23:09,690
Next we have second party models.

614
00:23:09,690 --> 00:23:12,000
These are ones that are developed

615
00:23:12,000 --> 00:23:14,190
and trained by someone else,

616
00:23:14,190 --> 00:23:16,290
but they're sold on AWS.

617
00:23:16,290 --> 00:23:18,000
Think of things like Llama.

618
00:23:18,000 --> 00:23:21,180
Finally we have third party models.

619
00:23:21,180 --> 00:23:25,950
These are ones developed,
trained and sold by someone else,

620
00:23:25,950 --> 00:23:30,510
but to get them onto AWS,
you need to use marketplace.

621
00:23:30,510 --> 00:23:33,300
This is why they show
up slightly differently

622
00:23:33,300 --> 00:23:36,183
and it can't be as simple
as select or wear Bedrock.

623
00:23:37,830 --> 00:23:41,580
The second challenge we have
is when you use a model,

624
00:23:41,580 --> 00:23:45,930
the resource ID just shows
up as the model name.

625
00:23:45,930 --> 00:23:47,400
That's all the information you get

626
00:23:47,400 --> 00:23:48,900
when you do it by default.

627
00:23:48,900 --> 00:23:50,160
So it's unlike an EC2

628
00:23:50,160 --> 00:23:51,250
or like we saw with the NAT Gateways

629
00:23:51,250 --> 00:23:53,010
where you get a specific ID

630
00:23:53,010 --> 00:23:55,050
that you can go and find in your accounts.

631
00:23:55,050 --> 00:23:57,450
You can't find it, it's just a model.

632
00:23:57,450 --> 00:23:58,770
But there is a way around that

633
00:23:58,770 --> 00:24:01,410
and that is inference profiles.

634
00:24:01,410 --> 00:24:04,620
Inference profiles are
a way to pre-configure

635
00:24:04,620 --> 00:24:06,390
how you interact with Bedrock

636
00:24:06,390 --> 00:24:08,490
and they allow you to
choose some customization.

637
00:24:08,490 --> 00:24:10,830
So what model do you want to use?

638
00:24:10,830 --> 00:24:12,480
What temperature do you wanna have?

639
00:24:12,480 --> 00:24:14,430
And you can tag it,

640
00:24:14,430 --> 00:24:15,990
of course tags are gonna come up.

641
00:24:15,990 --> 00:24:17,220
So you can tag this resource

642
00:24:17,220 --> 00:24:19,260
and then see who is using that model

643
00:24:19,260 --> 00:24:20,880
and where are they using it.

644
00:24:20,880 --> 00:24:22,620
You can do this in things
like CloudFormation.

645
00:24:22,620 --> 00:24:23,453
This is an example I have

646
00:24:23,453 --> 00:24:25,800
and this is also in the GitHub
repo we'll share at the end.

647
00:24:25,800 --> 00:24:28,740
And so you can reuse
this in your applications

648
00:24:28,740 --> 00:24:30,240
or you can use it in an SDK,

649
00:24:30,240 --> 00:24:32,283
this is Python and you can have that.

650
00:24:33,480 --> 00:24:35,280
What we'll be doing is,

651
00:24:35,280 --> 00:24:38,790
we will be cost allocating some usage

652
00:24:38,790 --> 00:24:40,140
based on the department tag,

653
00:24:40,140 --> 00:24:41,160
you can see on there,

654
00:24:41,160 --> 00:24:43,650
to see who is spending
money from what department

655
00:24:43,650 --> 00:24:45,270
in our accounts.

656
00:24:45,270 --> 00:24:46,263
Let's get into it.

657
00:24:48,900 --> 00:24:51,720
So I already have a bit
of a pre-done query.

658
00:24:51,720 --> 00:24:52,860
So it has some simple stuff in it,

659
00:24:52,860 --> 00:24:56,190
things like product name,
usage, spend, resource,

660
00:24:56,190 --> 00:24:57,840
classic information you use.

661
00:24:57,840 --> 00:24:59,310
But I wanna draw your attention down here

662
00:24:59,310 --> 00:25:00,570
to the where statement.

663
00:25:00,570 --> 00:25:03,750
This is where we cover
those first, second,

664
00:25:03,750 --> 00:25:05,610
third party model information.

665
00:25:05,610 --> 00:25:08,400
So where we have product code like Bedrock

666
00:25:08,400 --> 00:25:11,220
or product, product name like Bedrock,

667
00:25:11,220 --> 00:25:12,930
that is how we cover everything.

668
00:25:12,930 --> 00:25:14,880
For example, when you use Claude,

669
00:25:14,880 --> 00:25:18,030
it comes up with Claude
brackets, Amazon Bedrock.

670
00:25:18,030 --> 00:25:20,220
So we just wanna check that one line.

671
00:25:20,220 --> 00:25:22,140
The same with things like tokens,

672
00:25:22,140 --> 00:25:25,350
when it comes to one and two P parties,

673
00:25:25,350 --> 00:25:29,370
you have line item usage
type like token, lowercase,

674
00:25:29,370 --> 00:25:34,320
but you also have line item
usage type like token uppercase.

675
00:25:34,320 --> 00:25:36,720
Notice, no there's no S

676
00:25:36,720 --> 00:25:39,900
because sometimes it's
token, sometimes it's tokens.

677
00:25:39,900 --> 00:25:41,760
Don't know why I didn't make it.

678
00:25:41,760 --> 00:25:43,440
But we wanna cover everything,

679
00:25:43,440 --> 00:25:45,750
so we've just got these
where statements in there.

680
00:25:45,750 --> 00:25:46,887
I've already run this query

681
00:25:46,887 --> 00:25:48,930
and we can start to see some of the usage.

682
00:25:48,930 --> 00:25:50,280
So we see our spend, yeah, yeah,

683
00:25:50,280 --> 00:25:52,260
but this is where we
start to see information

684
00:25:52,260 --> 00:25:53,460
like that resource ID.

685
00:25:53,460 --> 00:25:55,813
So I wanna show you an example.

686
00:25:55,813 --> 00:25:58,620
These two rows are what it looks like

687
00:25:58,620 --> 00:26:00,930
when you have no inference profile,

688
00:26:00,930 --> 00:26:03,690
you just have usage of a model, right?

689
00:26:03,690 --> 00:26:06,750
If you wanted to cost allocate
this, it's a bit useless.

690
00:26:06,750 --> 00:26:07,680
So we can see some people

691
00:26:07,680 --> 00:26:09,990
are starting to use inference
profiles and see some tags.

692
00:26:09,990 --> 00:26:11,610
So we see things like the dev teams,

693
00:26:11,610 --> 00:26:13,560
they're using things like Nova Micro,

694
00:26:13,560 --> 00:26:16,410
we have security teams using Pro

695
00:26:16,410 --> 00:26:19,950
and we even have some sales
teams who are using Claude.

696
00:26:19,950 --> 00:26:22,050
So we can see this difference
from that first line,

697
00:26:22,050 --> 00:26:24,540
but we can see who the tags are.

698
00:26:24,540 --> 00:26:26,070
What we're gonna do first is,

699
00:26:26,070 --> 00:26:29,250
we can see like here

700
00:26:29,250 --> 00:26:33,060
some people haven't tagged
their spend, naughty people.

701
00:26:33,060 --> 00:26:35,250
We wanna make sure that we
can go and find those people

702
00:26:35,250 --> 00:26:37,590
and say, hey guys, you've already
got the inference profile,

703
00:26:37,590 --> 00:26:39,600
you've already done the work.

704
00:26:39,600 --> 00:26:41,820
Let's just tag it. Let's
add those couple of lines.

705
00:26:41,820 --> 00:26:43,550
So we're gonna do a query
just to find those people

706
00:26:43,550 --> 00:26:45,210
to have a bit of a hit list.

707
00:26:45,210 --> 00:26:47,260
So we're also gonna use a with statement,

708
00:26:49,050 --> 00:26:52,330
tokens as bracket everything up

709
00:26:54,840 --> 00:26:58,187
and select from tokens.

710
00:27:01,770 --> 00:27:03,720
All right, so what
information do we need to get?

711
00:27:03,720 --> 00:27:06,570
Well we're probably gonna
wanna grab those resource IDs

712
00:27:06,570 --> 00:27:07,770
so we can see what account

713
00:27:07,770 --> 00:27:10,110
and what the inference profile hash is.

714
00:27:10,110 --> 00:27:11,160
Then we're gonna get some usage

715
00:27:11,160 --> 00:27:13,890
because we wanna know who are
the heavy hitters for this.

716
00:27:13,890 --> 00:27:16,348
We don't just want people
who are doing hardly any work

717
00:27:16,348 --> 00:27:17,181
and like POCs,

718
00:27:17,181 --> 00:27:19,590
we want some bigger maybe
production workloads.

719
00:27:19,590 --> 00:27:21,900
So we'll give that a name

720
00:27:21,900 --> 00:27:24,330
and then we'll also get our spend.

721
00:27:24,330 --> 00:27:26,930
'Cause as Andy said, it all
comes back to the money.

722
00:27:29,520 --> 00:27:33,810
Because we have spend, we
have to have some group bys.

723
00:27:33,810 --> 00:27:37,110
So group by one in this case
and we'll do a where filter.

724
00:27:37,110 --> 00:27:38,760
So the where filter is gonna be,

725
00:27:38,760 --> 00:27:40,480
where the resource ID

726
00:27:42,120 --> 00:27:44,670
is like if we look down here,

727
00:27:44,670 --> 00:27:46,770
we can see this application
inference profile.

728
00:27:46,770 --> 00:27:49,530
That's the kind of calling
card that we're using one.

729
00:27:49,530 --> 00:27:50,930
So we can drop that in there

730
00:27:54,030 --> 00:27:56,460
and I don't want ones
that are already tagged

731
00:27:56,460 --> 00:27:57,600
so we can just filter those out.

732
00:27:57,600 --> 00:27:59,463
So where my user department tag

733
00:27:59,463 --> 00:28:03,330
that I've extracted is null.

734
00:28:09,011 --> 00:28:12,540
Oh god, no. Guys, Andy go put tally up.

735
00:28:12,540 --> 00:28:14,153
- [Andy Brown] We got the first one.

736
00:28:15,210 --> 00:28:16,643
- [Steph Gooch] What have I done wrong?

737
00:28:19,890 --> 00:28:20,883
Oh, what is it?

738
00:28:21,720 --> 00:28:23,170
No, it's just like, isn't it?

739
00:28:25,350 --> 00:28:28,050
Well there had to be some
drama in the session.

740
00:28:28,050 --> 00:28:29,500
You could say I planned that.

741
00:28:30,600 --> 00:28:32,700
Okay, so here we have
my inference profiles,

742
00:28:32,700 --> 00:28:34,110
a nice little list that we can go and say,

743
00:28:34,110 --> 00:28:36,300
hey, you teams, you're in this account,

744
00:28:36,300 --> 00:28:37,440
we can see some usage.

745
00:28:37,440 --> 00:28:39,150
Can you just go and tag this resource?

746
00:28:39,150 --> 00:28:39,990
Because we need to be able

747
00:28:39,990 --> 00:28:42,603
to cost allocate our
applications relevantly,

748
00:28:43,950 --> 00:28:46,590
but we wanna cost allocate
the ones that have tagged it.

749
00:28:46,590 --> 00:28:48,660
So a small change we need to do for this

750
00:28:48,660 --> 00:28:51,003
is we need changes to is not null,

751
00:28:52,620 --> 00:28:53,700
get rid of the application,

752
00:28:53,700 --> 00:28:55,350
'cause it's kind of mute because of that.

753
00:28:55,350 --> 00:28:57,540
And rather than resource ID,

754
00:28:57,540 --> 00:28:59,493
we can use user department.

755
00:29:05,130 --> 00:29:08,250
What will now see is our user departments,

756
00:29:08,250 --> 00:29:10,713
there's some usage and
some unblended spend.

757
00:29:11,730 --> 00:29:12,690
It's as simple as that,

758
00:29:12,690 --> 00:29:14,340
we've got some cost allocation.

759
00:29:14,340 --> 00:29:16,170
But one thing I wanna
draw your attention to,

760
00:29:16,170 --> 00:29:17,220
is the usage amount.

761
00:29:17,220 --> 00:29:19,200
So what we can see is the sales teams,

762
00:29:19,200 --> 00:29:21,720
they're the big spenders that
we have in our organization.

763
00:29:21,720 --> 00:29:23,910
They have oh, $2,

764
00:29:23,910 --> 00:29:25,800
but we look at things like the dev team

765
00:29:25,800 --> 00:29:27,840
and they have a third of the spend

766
00:29:27,840 --> 00:29:30,333
but almost the same usage.

767
00:29:31,290 --> 00:29:32,763
Does anyone know why that is?

768
00:29:36,270 --> 00:29:38,130
Almost someone said free to.

769
00:29:38,130 --> 00:29:39,870
It's because of the model selection.

770
00:29:39,870 --> 00:29:41,820
So earlier you saw the dev teams

771
00:29:41,820 --> 00:29:42,810
and the security teams,

772
00:29:42,810 --> 00:29:45,060
they're using Amazon Nova,

773
00:29:45,060 --> 00:29:48,483
which is a fraction of the
cost of things like Claude.

774
00:29:49,350 --> 00:29:51,600
Maybe the sales team need to use Claude

775
00:29:51,600 --> 00:29:52,740
for whatever they're doing.

776
00:29:52,740 --> 00:29:55,980
But if you are also looking to
optimize your Bedrock spend,

777
00:29:55,980 --> 00:29:58,590
having some decisions about
what models you're using

778
00:29:58,590 --> 00:30:00,150
will impact your cost.

779
00:30:00,150 --> 00:30:01,980
So if you start to see a team,

780
00:30:01,980 --> 00:30:05,070
a project department spend really spike

781
00:30:05,070 --> 00:30:06,720
because they're using Bedrock,

782
00:30:06,720 --> 00:30:08,550
you could go and have a
conversation with this data

783
00:30:08,550 --> 00:30:11,040
and say, hey, your model
selection is really impacting it.

784
00:30:11,040 --> 00:30:11,873
Is that the right model?

785
00:30:11,873 --> 00:30:15,360
If it is, fine, if not,
maybe POCs developing,

786
00:30:15,360 --> 00:30:18,423
try some cheaper models
like the Amazon native ones.

787
00:30:27,660 --> 00:30:29,370
With that,

788
00:30:29,370 --> 00:30:33,300
what happens when Bedrock
is part of a wider project?

789
00:30:33,300 --> 00:30:36,420
So not just specific to its
own little tokens in and out.

790
00:30:36,420 --> 00:30:37,620
What if we wanna think bigger?

791
00:30:37,620 --> 00:30:39,420
What if it's part of a full story?

792
00:30:39,420 --> 00:30:41,730
And what if we wanna
track optimization work?

793
00:30:41,730 --> 00:30:43,680
See if we have moved to a cheaper model

794
00:30:43,680 --> 00:30:46,230
or if we delete things
like idle NAT Gateways

795
00:30:46,230 --> 00:30:48,810
that we don't need are incorrectly set up.

796
00:30:48,810 --> 00:30:51,870
This is where something
like unit cost comes in.

797
00:30:51,870 --> 00:30:55,170
So the unit cost is the
expenditure to sell one unit

798
00:30:55,170 --> 00:30:56,880
of something or one click.

799
00:30:56,880 --> 00:30:58,380
And the story in this image is,

800
00:30:58,380 --> 00:30:59,550
someone's cost is going up.

801
00:30:59,550 --> 00:31:02,010
Like we just talked about, the
spend is growing and growing,

802
00:31:02,010 --> 00:31:03,930
the project we hope is doing well.

803
00:31:03,930 --> 00:31:05,430
And the question is,

804
00:31:05,430 --> 00:31:06,390
is the spend going up

805
00:31:06,390 --> 00:31:08,730
because more people are
using our application,

806
00:31:08,730 --> 00:31:10,320
more people are kind of logging in,

807
00:31:10,320 --> 00:31:14,910
more people are demanding
information from our applications.

808
00:31:14,910 --> 00:31:17,100
Or is it because someone
left something running,

809
00:31:17,100 --> 00:31:20,040
like a NAT Gateway or someone
chose an expensive model?

810
00:31:20,040 --> 00:31:21,210
How do we work that out?

811
00:31:21,210 --> 00:31:23,850
And that is where unit cost comes in.

812
00:31:23,850 --> 00:31:25,950
So we take the cost and divide it by

813
00:31:25,950 --> 00:31:29,520
things like invocations or
usage of an application.

814
00:31:29,520 --> 00:31:30,353
What I've done is,

815
00:31:30,353 --> 00:31:32,640
I've made us a little application

816
00:31:32,640 --> 00:31:36,000
that we're gonna show just
a simple little web app

817
00:31:36,000 --> 00:31:38,400
which covers which using
resources like EC2,

818
00:31:38,400 --> 00:31:40,383
Aurora, Lambda, Bedrock.

819
00:31:41,280 --> 00:31:45,600
And the question is how much
does that one click cost?

820
00:31:45,600 --> 00:31:47,610
That is the question we wanna answer.

821
00:31:47,610 --> 00:31:49,290
So what we need to do to do that is,

822
00:31:49,290 --> 00:31:52,860
we need to grab all of
the spend of our usage

823
00:31:52,860 --> 00:31:55,230
and then divide it by some kind of unit,

824
00:31:55,230 --> 00:31:56,910
some kind of invocation.

825
00:31:56,910 --> 00:31:58,890
And we can do that
because the driving force

826
00:31:58,890 --> 00:32:00,720
for this Bedrock usage is Lambda.

827
00:32:00,720 --> 00:32:02,100
So every time I click that button,

828
00:32:02,100 --> 00:32:04,050
a Lambda function gets triggered

829
00:32:04,050 --> 00:32:06,690
and we can actually grab
that data from the CUR.

830
00:32:06,690 --> 00:32:09,150
So that can be our usage amount

831
00:32:09,150 --> 00:32:10,740
and then divide it by the cost.

832
00:32:10,740 --> 00:32:11,970
This is something that I didn't know

833
00:32:11,970 --> 00:32:12,803
before we got into the session

834
00:32:12,803 --> 00:32:14,670
and we started playing around with ideas

835
00:32:14,670 --> 00:32:15,750
that you can actually extract this

836
00:32:15,750 --> 00:32:17,010
from the cost and use report,

837
00:32:17,010 --> 00:32:18,573
so we are gonna do that now.

838
00:32:23,040 --> 00:32:28,040
Does anyone know how I
grab the usage of Lambda

839
00:32:28,710 --> 00:32:30,540
in the cost and usage report?

840
00:32:30,540 --> 00:32:31,533
What column it is?

841
00:32:32,880 --> 00:32:35,463
No, that's okay. It's usage.

842
00:32:36,630 --> 00:32:38,700
Unsurprisingly it's actually usage amount.

843
00:32:38,700 --> 00:32:40,590
We can actually steal this
from my previous query.

844
00:32:40,590 --> 00:32:44,190
So usage amount, if we drop
that in here, and we summit,

845
00:32:44,190 --> 00:32:45,690
and I filtered based on Lambda,

846
00:32:45,690 --> 00:32:47,730
we filter based on the application

847
00:32:47,730 --> 00:32:50,520
and the account ID and the month.

848
00:32:50,520 --> 00:32:51,390
If we drop that in there,

849
00:32:51,390 --> 00:32:53,280
we'll start to see how many times

850
00:32:53,280 --> 00:32:55,050
that Lambda function was hit.

851
00:32:55,050 --> 00:32:57,090
How many times in a couple of months

852
00:32:57,090 --> 00:32:59,010
people have hit that button.

853
00:32:59,010 --> 00:33:00,240
Great. Now we have a base,

854
00:33:00,240 --> 00:33:02,100
now we need to go and get some spend,

855
00:33:02,100 --> 00:33:03,513
so we can group that up.

856
00:33:04,500 --> 00:33:08,043
This invocations as.

857
00:33:14,490 --> 00:33:16,350
So we're just gonna grab
our spend for this part,

858
00:33:16,350 --> 00:33:18,690
for this specific application.

859
00:33:18,690 --> 00:33:19,920
So we'll grab it from the CUR.

860
00:33:19,920 --> 00:33:24,210
So all we're gonna need
is are some of our spend.

861
00:33:24,210 --> 00:33:27,870
We can grab that from
there, from our other query.

862
00:33:27,870 --> 00:33:31,743
Always safer to copy and paste as cost.

863
00:33:33,990 --> 00:33:36,510
We're also gonna see what
products we have in here.

864
00:33:36,510 --> 00:33:38,730
We wanna make sure that we're capturing

865
00:33:38,730 --> 00:33:40,230
all the right information.

866
00:33:40,230 --> 00:33:41,706
And finally we need billing period,

867
00:33:41,706 --> 00:33:42,720
'cause we wanna check
when we're doing this,

868
00:33:42,720 --> 00:33:45,330
we're just looking over a
certain couple of months.

869
00:33:45,330 --> 00:33:47,550
'Cause we have a group
by, we gotta do that sum.

870
00:33:47,550 --> 00:33:51,610
So some we have group by,
group by one into three

871
00:33:52,800 --> 00:33:54,150
and we need a where statement.

872
00:33:54,150 --> 00:33:57,090
Luckily I've done a great job
of tagging in this application

873
00:33:57,090 --> 00:33:58,830
and so we've got a little tag we can use.

874
00:33:58,830 --> 00:34:00,630
So our tag,

875
00:34:00,630 --> 00:34:02,543
oh, it's 'cause we're
on the wrong data set.

876
00:34:04,980 --> 00:34:06,420
If you ever have across that situation

877
00:34:06,420 --> 00:34:09,450
where suddenly you can't
auto create information,

878
00:34:09,450 --> 00:34:12,030
it's because it's not on the right table.

879
00:34:12,030 --> 00:34:15,670
So, you know, my one is called

880
00:34:16,770 --> 00:34:17,733
oh, one brackets,

881
00:34:20,340 --> 00:34:22,390
it's a user and it's my FinOps tag

882
00:34:24,630 --> 00:34:26,523
equals nice AI app.

883
00:34:28,860 --> 00:34:32,490
Very simple. Just
selecting a spend for this.

884
00:34:32,490 --> 00:34:34,023
Oh, tell me.

885
00:34:35,907 --> 00:34:38,224
(audience member speaking softly)

886
00:34:38,224 --> 00:34:41,820
(gasp) You get an extra special
sticker because he saved me.

887
00:34:41,820 --> 00:34:42,900
That's what friends do.

888
00:34:42,900 --> 00:34:44,350
We're not friends apparently.

889
00:34:45,990 --> 00:34:46,877
All right group by

890
00:34:46,877 --> 00:34:50,641
and it is, oh we also need
another where statement.

891
00:34:50,641 --> 00:34:53,643
So we're just grabbing this month's thing.

892
00:34:55,495 --> 00:34:56,328
Am I safe?

893
00:34:59,400 --> 00:35:00,300
- [Andy Brown] No.

894
00:35:02,190 --> 00:35:04,651
- [Steph Gooch] Group
by one and three, right?

895
00:35:04,651 --> 00:35:06,300
You can put tally on.

896
00:35:06,300 --> 00:35:07,133
- [Andy Brown] I think I know

897
00:35:07,133 --> 00:35:11,718
who's gonna be doing
the challenge. (laughs)

898
00:35:11,718 --> 00:35:13,350
- [Audience member] The
catch is like a negative.

899
00:35:13,350 --> 00:35:15,000
- [Steph Gooch] Yeah, it's been more fun.

900
00:35:15,000 --> 00:35:16,770
You guys can see how we can fix errors.

901
00:35:16,770 --> 00:35:18,330
It's a more interesting show.

902
00:35:18,330 --> 00:35:20,800
So now we can see the resources we have

903
00:35:20,800 --> 00:35:21,720
and the cost as well.

904
00:35:21,720 --> 00:35:22,553
What is interesting is,

905
00:35:22,553 --> 00:35:23,910
some of these are gonna be quite static.

906
00:35:23,910 --> 00:35:27,390
So for the September, my resource
wasn't on the whole time,

907
00:35:27,390 --> 00:35:29,640
but if it was on 24/7, the same amount,

908
00:35:29,640 --> 00:35:31,410
it's gonna be very similar in cost.

909
00:35:31,410 --> 00:35:33,090
Things like Bedrock really differentiate

910
00:35:33,090 --> 00:35:35,010
because of how many
tokens come in and out.

911
00:35:35,010 --> 00:35:37,140
When I run that little web app,

912
00:35:37,140 --> 00:35:38,460
sometimes it gives me a massive amount,

913
00:35:38,460 --> 00:35:40,740
sometimes it gives me a small
amount of information back.

914
00:35:40,740 --> 00:35:41,573
Those things shift.

915
00:35:41,573 --> 00:35:43,500
So those costs are quite variable.

916
00:35:43,500 --> 00:35:45,330
So now we have all of this information,

917
00:35:45,330 --> 00:35:50,330
we can do another one with
spend, grab all of this.

918
00:35:53,280 --> 00:35:55,740
I don't need my product
kind of breakout anymore

919
00:35:55,740 --> 00:35:57,330
so I can get rid of that.

920
00:35:57,330 --> 00:35:58,500
Change that to two.

921
00:35:58,500 --> 00:36:01,110
And now we're gonna combine this data.

922
00:36:01,110 --> 00:36:03,110
So we're gonna collect select from spend

923
00:36:04,470 --> 00:36:05,520
and we're gonna do it in a join

924
00:36:05,520 --> 00:36:07,770
to connect these two things together,

925
00:36:07,770 --> 00:36:09,703
in a join invocations,

926
00:36:14,400 --> 00:36:15,480
we're gonna make a little shorthand

927
00:36:15,480 --> 00:36:17,460
to make the combination of
these a little bit easier

928
00:36:17,460 --> 00:36:18,510
and we're gonna select the information.

929
00:36:18,510 --> 00:36:19,740
So select,

930
00:36:19,740 --> 00:36:21,273
star S dot cost.

931
00:36:22,590 --> 00:36:27,420
We're gonna do I dot total invocations

932
00:36:27,420 --> 00:36:29,610
and then the very simple
arithmetic of the first one

933
00:36:29,610 --> 00:36:30,910
divided by the second one.

934
00:36:36,480 --> 00:36:38,850
We're also gonna grab that billing period

935
00:36:38,850 --> 00:36:41,640
because this is how
we're gonna join these.

936
00:36:41,640 --> 00:36:45,570
So we're gonna join on
I dot billing period

937
00:36:45,570 --> 00:36:47,343
equals S dot billing period.

938
00:36:50,340 --> 00:36:52,773
Any issues? Am I safe?

939
00:36:56,670 --> 00:36:58,863
- Oh, no.
- Oh, every time.

940
00:37:00,990 --> 00:37:03,640
Guys, I thought we were
friends, where's the support?

941
00:37:05,820 --> 00:37:07,080
Now we can see these things.

942
00:37:07,080 --> 00:37:08,370
Oh I've gotta do a forfeit.

943
00:37:08,370 --> 00:37:11,130
Now we can see our cost per click.

944
00:37:11,130 --> 00:37:12,660
So we have those 89 clicks.

945
00:37:12,660 --> 00:37:14,340
We have similar numbers

946
00:37:14,340 --> 00:37:16,470
because they were about the
similar amount of spend,

947
00:37:16,470 --> 00:37:17,303
similar things.

948
00:37:17,303 --> 00:37:19,140
Okay, so what?

949
00:37:19,140 --> 00:37:20,910
What if we optimize?

950
00:37:20,910 --> 00:37:23,820
What if we got rid of vital
resources we don't need?

951
00:37:23,820 --> 00:37:25,590
Or what if we change model?

952
00:37:25,590 --> 00:37:26,910
What if we move to graviton?

953
00:37:26,910 --> 00:37:28,140
What if we right-sized?

954
00:37:28,140 --> 00:37:30,360
What's gonna happen to
that per click cost?

955
00:37:30,360 --> 00:37:31,193
So what we can do is,

956
00:37:31,193 --> 00:37:34,830
we're gonna add in another
month's worth of spend

957
00:37:34,830 --> 00:37:36,630
where I actually went and did my row,

958
00:37:36,630 --> 00:37:37,780
I went and optimized

959
00:37:46,500 --> 00:37:48,210
and now we'll see hopefully

960
00:37:48,210 --> 00:37:51,900
that the spend per click has dropped down.

961
00:37:51,900 --> 00:37:53,700
So it's now, what's that?

962
00:37:53,700 --> 00:37:55,773
A quarter of the cost by optimizing.

963
00:37:56,760 --> 00:37:58,290
What I hopefully wanna
inspire you with this

964
00:37:58,290 --> 00:38:00,180
is to show you how to get this data, yes.

965
00:38:00,180 --> 00:38:02,220
But if you are doing optimization work

966
00:38:02,220 --> 00:38:03,840
in your organizations,

967
00:38:03,840 --> 00:38:05,730
try and find some KPI you can do.

968
00:38:05,730 --> 00:38:09,180
You can also do things
like compute gigabytes

969
00:38:09,180 --> 00:38:13,170
or you can do any kind
of usage you can gather.

970
00:38:13,170 --> 00:38:16,080
People often try and
focus on grabbing data

971
00:38:16,080 --> 00:38:17,670
that is part of their application.

972
00:38:17,670 --> 00:38:19,830
Usage may be in the application.

973
00:38:19,830 --> 00:38:20,910
That can be quite tricky,

974
00:38:20,910 --> 00:38:22,410
especially if you work centrally

975
00:38:22,410 --> 00:38:24,060
or you don't own that specific application

976
00:38:24,060 --> 00:38:26,100
to get that is typical.

977
00:38:26,100 --> 00:38:27,420
Whereas if you do it like this

978
00:38:27,420 --> 00:38:28,560
and you have it in the CUR,

979
00:38:28,560 --> 00:38:31,210
you've already got access
to all of that information.

980
00:38:34,860 --> 00:38:37,533
So with that, tag your usage.

981
00:38:38,850 --> 00:38:40,020
You don't always have to tag everything

982
00:38:40,020 --> 00:38:41,040
in your organization,

983
00:38:41,040 --> 00:38:42,960
but there are some situations like this

984
00:38:42,960 --> 00:38:44,790
where the nuance needs to be added

985
00:38:44,790 --> 00:38:46,830
so you can get more detailed information

986
00:38:46,830 --> 00:38:48,600
for your applications.

987
00:38:48,600 --> 00:38:50,610
Also, try getting different metadata

988
00:38:50,610 --> 00:38:52,800
or data for your unit cost.

989
00:38:52,800 --> 00:38:55,650
Even things like API
usage, Lambda like we said,

990
00:38:55,650 --> 00:38:57,390
or there's so many other parts

991
00:38:57,390 --> 00:38:59,550
that you can grab data from CloudWatch

992
00:38:59,550 --> 00:39:02,880
that you can drop in and use
as a data set to combine.

993
00:39:02,880 --> 00:39:05,793
With that, I'll hand over
to Andy for our last query.

994
00:39:07,200 --> 00:39:11,970
- [Andy Brown] Thanks
Steph. So who loves data?

995
00:39:11,970 --> 00:39:14,160
I am 100% one of them.

996
00:39:14,160 --> 00:39:16,710
There is a time and a
place for a dashboard.

997
00:39:16,710 --> 00:39:19,650
But I am most happiest when I
can dive into those numbers,

998
00:39:19,650 --> 00:39:22,350
dig and find and find
those optimization savings.

999
00:39:22,350 --> 00:39:23,970
And I think there's
plenty of people like us,

1000
00:39:23,970 --> 00:39:25,413
like our application teams.

1001
00:39:26,370 --> 00:39:27,870
On AWS, there's a few different ways

1002
00:39:27,870 --> 00:39:29,430
you can share cost data.

1003
00:39:29,430 --> 00:39:31,410
Within the console for
cost explore and budgets,

1004
00:39:31,410 --> 00:39:32,700
you can use billing views,

1005
00:39:32,700 --> 00:39:34,530
which is a way to group accounts together

1006
00:39:34,530 --> 00:39:36,150
and then share that group of information

1007
00:39:36,150 --> 00:39:38,490
so they can go to one place.

1008
00:39:38,490 --> 00:39:39,960
In the world of dashboards,

1009
00:39:39,960 --> 00:39:43,110
Amazon QuickSight has native
support for very level security

1010
00:39:43,110 --> 00:39:45,030
and our cloud intelligence dashboards

1011
00:39:45,030 --> 00:39:46,443
has it part of our solution.

1012
00:39:47,970 --> 00:39:49,593
However, what about the CUR?

1013
00:39:49,593 --> 00:39:51,540
What happen if you want to give the CUR

1014
00:39:51,540 --> 00:39:53,130
to your application team,

1015
00:39:53,130 --> 00:39:55,650
but you don't want to
show everything to them.

1016
00:39:55,650 --> 00:39:57,653
And that's what we're
gonna be covering today.

1017
00:39:58,950 --> 00:40:01,950
We're gonna be starting off
with AWS's recommended way

1018
00:40:01,950 --> 00:40:03,090
for deploying the CUR

1019
00:40:03,090 --> 00:40:05,730
and this is what we've been using today.

1020
00:40:05,730 --> 00:40:07,530
We're gonna be using Athena like normal.

1021
00:40:07,530 --> 00:40:09,570
We're not gonna be
introducing anything else.

1022
00:40:09,570 --> 00:40:12,060
The only thing we're gonna
be changing for the security,

1023
00:40:12,060 --> 00:40:15,120
is we're gonna introduce a
new service into the mix.

1024
00:40:15,120 --> 00:40:17,793
And this service is AWS Lake Formation.

1025
00:40:19,470 --> 00:40:22,020
Lake Formation is a way for
you to create a data lake

1026
00:40:22,020 --> 00:40:24,150
with fine grain security controls.

1027
00:40:24,150 --> 00:40:27,123
So you can say app team,
you can only see this.

1028
00:40:29,100 --> 00:40:30,150
There's gonna be four steps

1029
00:40:30,150 --> 00:40:32,010
we're gonna be following for this.

1030
00:40:32,010 --> 00:40:34,830
First, in Lake Formation,
we need to tell it,

1031
00:40:34,830 --> 00:40:37,020
we need help managing securities

1032
00:40:37,020 --> 00:40:39,270
and this is where the
data for this is stored.

1033
00:40:39,270 --> 00:40:41,870
And so in the CUR world
we'll give it the S3 bucket.

1034
00:40:43,140 --> 00:40:45,060
We then need to create a groups,

1035
00:40:45,060 --> 00:40:48,060
so a group of accounts or
groups of certain resources

1036
00:40:48,060 --> 00:40:50,060
and that's what they call a data filter.

1037
00:40:51,510 --> 00:40:53,820
We're gonna be then reviewing
our Athena configuration

1038
00:40:53,820 --> 00:40:55,920
to make sure that our
app team can go ahead

1039
00:40:55,920 --> 00:40:57,540
and actually run the queries.

1040
00:40:57,540 --> 00:40:59,550
And then finally everything in AWS

1041
00:40:59,550 --> 00:41:01,500
is all about permissions and security.

1042
00:41:01,500 --> 00:41:02,640
So we should be going through that

1043
00:41:02,640 --> 00:41:04,710
and making sure they can do everything.

1044
00:41:04,710 --> 00:41:07,060
So with that, let's switch
over to the console.

1045
00:41:09,570 --> 00:41:10,710
So what we have here,

1046
00:41:10,710 --> 00:41:11,700
lemme go up to my query here.

1047
00:41:11,700 --> 00:41:14,970
I have a very simple
query just to show you

1048
00:41:14,970 --> 00:41:16,860
what we have in our CUR table today.

1049
00:41:16,860 --> 00:41:19,260
So filtering by line item
from an account name.

1050
00:41:19,260 --> 00:41:20,760
And this should return eight accounts,

1051
00:41:20,760 --> 00:41:23,043
we have currently in our AWS organization.

1052
00:41:25,230 --> 00:41:26,430
What I want to do today is,

1053
00:41:26,430 --> 00:41:28,260
I want to give access to my app team,

1054
00:41:28,260 --> 00:41:29,853
to their dev and prod account,

1055
00:41:30,780 --> 00:41:33,080
but they don't want them
to see anything else.

1056
00:41:34,320 --> 00:41:35,153
In this whole world,

1057
00:41:35,153 --> 00:41:37,560
we're using the new multi-session feature.

1058
00:41:37,560 --> 00:41:40,470
And so this tab over here is my app team.

1059
00:41:40,470 --> 00:41:42,450
So I'm still in my FinOps account

1060
00:41:42,450 --> 00:41:44,190
but I'm now in my app team role,

1061
00:41:44,190 --> 00:41:45,607
wherever think before today

1062
00:41:45,607 --> 00:41:48,750
or before this session,
we've been using admin.

1063
00:41:48,750 --> 00:41:52,260
Here, you'll see they don't
have any access to Athena,

1064
00:41:52,260 --> 00:41:54,150
they're getting arrows,
they can't see any tables

1065
00:41:54,150 --> 00:41:55,750
and there's nothing you can run.

1066
00:41:57,300 --> 00:41:58,600
Let's go back to our admin

1067
00:41:59,700 --> 00:42:02,130
and we'll come back to them later.

1068
00:42:02,130 --> 00:42:05,130
So like I mentioned, step
one is telling Lake Formation

1069
00:42:05,130 --> 00:42:07,800
I need help managing access
to accessory buckets.

1070
00:42:07,800 --> 00:42:09,300
So let me go to Lake Formation

1071
00:42:13,980 --> 00:42:15,210
and this is what Lake Formation looks like

1072
00:42:15,210 --> 00:42:16,920
when you first start.

1073
00:42:16,920 --> 00:42:19,650
By default, Lake Formation will
take in all the information

1074
00:42:19,650 --> 00:42:22,350
already stored within the
AWS Glue Data Catalog.

1075
00:42:22,350 --> 00:42:25,260
So everything you already
created in Athena for example,

1076
00:42:25,260 --> 00:42:27,150
so your CUR tables, any views,

1077
00:42:27,150 --> 00:42:28,530
all that information will still be

1078
00:42:28,530 --> 00:42:30,730
already available for
you in Lake Formation.

1079
00:42:31,740 --> 00:42:32,790
Down on the left hand side,

1080
00:42:32,790 --> 00:42:34,980
I need to go to my data lake locations

1081
00:42:34,980 --> 00:42:37,203
and I'm gonna register a new location.

1082
00:42:38,820 --> 00:42:40,230
I need to give it the S3 bucket name.

1083
00:42:40,230 --> 00:42:42,363
So let me browse, I know it's in CID,

1084
00:42:44,089 --> 00:42:44,940
it's my data exports.

1085
00:42:44,940 --> 00:42:48,240
We use one bucket for everything,
so I'm gonna select that.

1086
00:42:48,240 --> 00:42:50,550
We then need to provide an IAM role.

1087
00:42:50,550 --> 00:42:53,130
This IAM role is gonna
be then working on behalf

1088
00:42:53,130 --> 00:42:54,990
of the app team to
actually go ahead the data.

1089
00:42:54,990 --> 00:42:57,190
So this IAM role needs
access to everything.

1090
00:42:58,440 --> 00:43:00,630
AWS does have a service
role for you to use this

1091
00:43:00,630 --> 00:43:02,670
and that's what we're
gonna be using today.

1092
00:43:02,670 --> 00:43:05,700
However, maybe you should speak

1093
00:43:05,700 --> 00:43:06,840
to your securities teams first

1094
00:43:06,840 --> 00:43:07,673
to see if something you want,

1095
00:43:07,673 --> 00:43:09,353
something a little bit more restrictive.

1096
00:43:10,560 --> 00:43:12,030
And then the last choice you have here

1097
00:43:12,030 --> 00:43:13,980
is for permission mode.

1098
00:43:13,980 --> 00:43:16,740
You have a choice between
hybrid access mode

1099
00:43:16,740 --> 00:43:17,793
or Lake Formation.

1100
00:43:18,630 --> 00:43:22,320
Lake Formation basically
will say that all access

1101
00:43:22,320 --> 00:43:23,670
to this S3 bucket

1102
00:43:23,670 --> 00:43:26,400
is now be only maintained
in Lake Formation.

1103
00:43:26,400 --> 00:43:28,320
So any permissions
already granted elsewhere

1104
00:43:28,320 --> 00:43:30,873
through IAM for example,
will then be ignored.

1105
00:43:31,830 --> 00:43:34,740
In our world we're gonna be
using hybrid access mode.

1106
00:43:34,740 --> 00:43:37,650
Hybrid access mode is gonna
be take the permissions

1107
00:43:37,650 --> 00:43:39,120
with defining Lake Formation

1108
00:43:39,120 --> 00:43:41,250
but also use the permissions in IAM

1109
00:43:41,250 --> 00:43:43,230
so they work together in a hybrid way.

1110
00:43:43,230 --> 00:43:44,780
We're good at naming sometimes.

1111
00:43:45,690 --> 00:43:46,523
We're doing this

1112
00:43:46,523 --> 00:43:47,880
because we already have
the cost intelligence,

1113
00:43:47,880 --> 00:43:49,590
cloud intelligence dashboard set up.

1114
00:43:49,590 --> 00:43:51,327
We have our finance
teams using the CUR today

1115
00:43:51,327 --> 00:43:53,010
and we don't wanna break anything

1116
00:43:53,010 --> 00:43:53,940
but maybe in the future

1117
00:43:53,940 --> 00:43:55,650
we want to move to Lake Formation mode,

1118
00:43:55,650 --> 00:43:58,560
so we only access
permissions in one place.

1119
00:43:58,560 --> 00:44:01,200
So step one's done, we
told Lake Formation,

1120
00:44:01,200 --> 00:44:03,243
help me manage access to this S3 bucket.

1121
00:44:05,070 --> 00:44:07,410
Now if I go to the data missions tab,

1122
00:44:07,410 --> 00:44:09,180
we'll see what's already been set up.

1123
00:44:09,180 --> 00:44:10,470
Like I said, this already taken

1124
00:44:10,470 --> 00:44:11,520
everything we've got in Athena.

1125
00:44:11,520 --> 00:44:14,703
So if they filter by table equals CUR two,

1126
00:44:15,900 --> 00:44:17,310
you'll see that our admin role,

1127
00:44:17,310 --> 00:44:18,390
the one we've been using all today,

1128
00:44:18,390 --> 00:44:19,680
has access to the table

1129
00:44:19,680 --> 00:44:21,840
and it has access to all the columns in.

1130
00:44:21,840 --> 00:44:24,693
And then this is RO represents
like the IAM permissions.

1131
00:44:26,280 --> 00:44:29,070
So I now need to create a new
permission from my app team

1132
00:44:29,070 --> 00:44:30,420
and define what that means.

1133
00:44:31,470 --> 00:44:34,290
I do this by going to data
filters up here on the left,

1134
00:44:34,290 --> 00:44:36,690
I'm gonna create a new data filter.

1135
00:44:36,690 --> 00:44:37,863
I give it a name.

1136
00:44:39,690 --> 00:44:41,490
I'm gonna choose okay what
access they're gonna have.

1137
00:44:41,490 --> 00:44:44,610
I'm gonna have access to my data export

1138
00:44:44,610 --> 00:44:46,440
and then my CUR two table.

1139
00:44:46,440 --> 00:44:48,790
And you can restrict both
column and row level.

1140
00:44:49,650 --> 00:44:51,120
In my case for my app team,

1141
00:44:51,120 --> 00:44:53,250
I want them to only access
the unblended costs.

1142
00:44:53,250 --> 00:44:54,843
They don't need to see any
of the other cost columns

1143
00:44:54,843 --> 00:44:55,970
that might confuse them

1144
00:44:55,970 --> 00:44:57,780
or they might make some wrong decisions.

1145
00:44:57,780 --> 00:44:59,700
So I'm gonna do exclude columns,

1146
00:44:59,700 --> 00:45:01,470
I'm gonna filter for the cost,

1147
00:45:01,470 --> 00:45:02,430
I'm gonna select them all.

1148
00:45:02,430 --> 00:45:03,990
They can have access to cost category

1149
00:45:03,990 --> 00:45:06,120
and like I said, they can
have access to unblended cost

1150
00:45:06,120 --> 00:45:08,170
but everything else they'll get excluded.

1151
00:45:09,450 --> 00:45:10,830
And then to restrict that,

1152
00:45:10,830 --> 00:45:12,510
they can only see their
account information,

1153
00:45:12,510 --> 00:45:14,640
we're gonna do the very level access

1154
00:45:14,640 --> 00:45:16,710
and we're gonna filter those.

1155
00:45:16,710 --> 00:45:17,790
And what you need to do here,

1156
00:45:17,790 --> 00:45:20,340
is you need to complete
this statement here.

1157
00:45:20,340 --> 00:45:24,240
So let's star from CUR two where.

1158
00:45:24,240 --> 00:45:25,440
And so in our situation,

1159
00:45:25,440 --> 00:45:30,440
we can do line item usage
account name is like app,

1160
00:45:31,020 --> 00:45:33,690
'cause we have that
consistent naming convention.

1161
00:45:33,690 --> 00:45:35,010
You can put anything in it,

1162
00:45:35,010 --> 00:45:36,450
if you want it filter
by particular products

1163
00:45:36,450 --> 00:45:39,060
or particular resource
IDs, you can put that.

1164
00:45:39,060 --> 00:45:40,230
It's just a normal where statement

1165
00:45:40,230 --> 00:45:41,580
you were writing in Athena.

1166
00:45:42,630 --> 00:45:47,400
One thing you can't easily
do is filter by tag.

1167
00:45:47,400 --> 00:45:50,580
And this is due to the way
that CUR two works with tags.

1168
00:45:50,580 --> 00:45:51,413
With CUR two,

1169
00:45:51,413 --> 00:45:55,320
tags are now stored in a map
function called resource tags.

1170
00:45:55,320 --> 00:45:59,460
And so Athena and Glue can't
see the values of the tag

1171
00:45:59,460 --> 00:46:02,700
and so this will fail when
you try and validate it,

1172
00:46:02,700 --> 00:46:04,170
there is a workaround.

1173
00:46:04,170 --> 00:46:07,080
What you can do in Athena is create a view

1174
00:46:07,080 --> 00:46:08,880
where you take the relevant tags

1175
00:46:08,880 --> 00:46:11,070
into its own separate column

1176
00:46:11,070 --> 00:46:13,500
and you do everything
we're showing you today

1177
00:46:13,500 --> 00:46:15,450
based on that view, not the table.

1178
00:46:15,450 --> 00:46:16,283
And so that's the workaround,

1179
00:46:16,283 --> 00:46:19,180
but for us we want to
do it by account name

1180
00:46:20,040 --> 00:46:22,500
and so this should be sufficient for us.

1181
00:46:22,500 --> 00:46:23,800
So create the data filter.

1182
00:46:24,810 --> 00:46:26,970
So what I've done is I created the filter,

1183
00:46:26,970 --> 00:46:30,180
but I haven't said who should
have access to the filter.

1184
00:46:30,180 --> 00:46:31,320
So lemme tick the box,

1185
00:46:31,320 --> 00:46:33,450
I'm gonna do grant permissions

1186
00:46:33,450 --> 00:46:36,273
and I'm gonna choose the
IAM role for my app team.

1187
00:46:37,680 --> 00:46:40,362
You choose what I already
picked up all the things,

1188
00:46:40,362 --> 00:46:42,959
'cause I did from the data permissions tab

1189
00:46:42,959 --> 00:46:44,310
and you choose what access you want.

1190
00:46:44,310 --> 00:46:47,280
So I'm gonna allow them
to select and describe.

1191
00:46:47,280 --> 00:46:48,780
I'm not allowing them to drop,

1192
00:46:48,780 --> 00:46:50,880
I'm not gonna allow them
grant any more permissions.

1193
00:46:50,880 --> 00:46:52,580
Just select and be able to run it.

1194
00:46:53,580 --> 00:46:55,770
And then you've got this last tick box

1195
00:46:55,770 --> 00:46:57,300
in our case we're gonna tick it.

1196
00:46:57,300 --> 00:46:59,250
Basically this tick box says,

1197
00:46:59,250 --> 00:47:01,593
do you want to enable this right now?

1198
00:47:03,060 --> 00:47:06,000
And so you might not,

1199
00:47:06,000 --> 00:47:07,530
maybe there's lots of
other configurations.

1200
00:47:07,530 --> 00:47:08,850
Maybe there's other data source

1201
00:47:08,850 --> 00:47:10,440
or other teams you want to do

1202
00:47:10,440 --> 00:47:12,900
and you're not ready for them to go live.

1203
00:47:12,900 --> 00:47:13,890
This is the only thing we're doing.

1204
00:47:13,890 --> 00:47:14,880
So we're ready to go live.

1205
00:47:14,880 --> 00:47:16,410
So we're gonna tick it.

1206
00:47:16,410 --> 00:47:17,610
If you don't tick this box,

1207
00:47:17,610 --> 00:47:19,770
you can just go to the hybrid
access here on the left

1208
00:47:19,770 --> 00:47:22,380
and then just go ahead and
you've set it up there.

1209
00:47:22,380 --> 00:47:23,980
But our case, we're ready to go.

1210
00:47:25,500 --> 00:47:28,170
So that's the Lake Formation done.

1211
00:47:28,170 --> 00:47:29,043
Step one and two.

1212
00:47:30,240 --> 00:47:34,230
Step three is all about Athena.

1213
00:47:34,230 --> 00:47:36,030
For those who set up Athena before,

1214
00:47:36,030 --> 00:47:38,730
you know you need to provide
Athena with an S3 bucket.

1215
00:47:39,840 --> 00:47:42,240
If you give your app team
access to this S3 bucket

1216
00:47:42,240 --> 00:47:43,560
for the Athena results,

1217
00:47:43,560 --> 00:47:46,440
they might actually see
other people's results.

1218
00:47:46,440 --> 00:47:48,210
And so get access to data don't want.

1219
00:47:48,210 --> 00:47:49,410
And if they're anyone like me,

1220
00:47:49,410 --> 00:47:51,120
I'm sneaky, I'm very
good at digging around

1221
00:47:51,120 --> 00:47:53,820
and trying to get access to
data in slightly different ways.

1222
00:47:53,820 --> 00:47:54,660
And so this is not great.

1223
00:47:54,660 --> 00:47:56,850
We want to try and avoid this situation.

1224
00:47:56,850 --> 00:47:58,350
And so what we're gonna do in Athena is,

1225
00:47:58,350 --> 00:48:03,350
we're gonna create a new
workgroup just for this app team

1226
00:48:03,450 --> 00:48:04,380
and workgroup thing about

1227
00:48:04,380 --> 00:48:06,360
is just a new configuration setting.

1228
00:48:06,360 --> 00:48:07,760
So let me go back to Athena.

1229
00:48:09,349 --> 00:48:12,600
I'm gonna open up the menu
here and go to workgroups.

1230
00:48:12,600 --> 00:48:15,543
I'm gonna create my
workgroup, give it a name.

1231
00:48:16,890 --> 00:48:18,510
I'm gonna leave everything the same here.

1232
00:48:18,510 --> 00:48:21,570
And then it's when we go to
crew result conversation.

1233
00:48:21,570 --> 00:48:23,610
In the past you'd have the customer manage

1234
00:48:23,610 --> 00:48:26,093
and you'll provide the S3
bucket, you might create it.

1235
00:48:27,060 --> 00:48:28,680
In our case, we're gonna
be using a new feature

1236
00:48:28,680 --> 00:48:30,990
called Athena Managed Storage.

1237
00:48:30,990 --> 00:48:34,590
Here Athena's gonna manage
the S3 bucket for you.

1238
00:48:34,590 --> 00:48:37,140
No one in your account is
gonna have access to this.

1239
00:48:37,140 --> 00:48:39,000
This is also available free of charge,

1240
00:48:39,000 --> 00:48:41,010
so when things are free and age of risk,

1241
00:48:41,010 --> 00:48:42,630
take advantage of it.

1242
00:48:42,630 --> 00:48:43,463
But it's free of charge

1243
00:48:43,463 --> 00:48:44,940
and it'll keep the data for 24 hours.

1244
00:48:44,940 --> 00:48:46,500
And so perfect for this situation,

1245
00:48:46,500 --> 00:48:47,460
'cause it means no one can go

1246
00:48:47,460 --> 00:48:49,010
and see other people's results.

1247
00:48:50,280 --> 00:48:51,923
So I'm gonna create my workgroup.

1248
00:48:53,940 --> 00:48:55,650
We're now on the final stage.

1249
00:48:55,650 --> 00:48:58,420
The final stage is setting
up the IAM permissions

1250
00:48:59,460 --> 00:49:02,793
and I'm gonna go to IAM
identity and access manager.

1251
00:49:04,170 --> 00:49:06,633
I need to go to my app team role.

1252
00:49:09,240 --> 00:49:11,670
And you'll see I already
have one policy for them.

1253
00:49:11,670 --> 00:49:12,503
This app team,

1254
00:49:12,503 --> 00:49:14,040
I've already actually given
access to the billing view.

1255
00:49:14,040 --> 00:49:15,253
So they're being used to seeing

1256
00:49:15,253 --> 00:49:17,303
a group of accounts within Cost Explorer.

1257
00:49:18,210 --> 00:49:20,220
And this is where they got
like that appetite to see more

1258
00:49:20,220 --> 00:49:22,566
and they wanted access to the CUR.

1259
00:49:22,566 --> 00:49:25,266
And so I need to grant new
additional access for them.

1260
00:49:26,730 --> 00:49:28,590
I've actually already
written a policy for this,

1261
00:49:28,590 --> 00:49:31,110
mainly because policies as you know,

1262
00:49:31,110 --> 00:49:32,130
always can be quite difficult

1263
00:49:32,130 --> 00:49:33,720
because you need to try and
work out what's going on

1264
00:49:33,720 --> 00:49:34,560
and make sure you get the right thing.

1265
00:49:34,560 --> 00:49:36,210
So I created one for you.

1266
00:49:36,210 --> 00:49:38,910
As a reminder, everything
we're showing you today

1267
00:49:38,910 --> 00:49:41,190
is available in our GitHub
including this policy.

1268
00:49:41,190 --> 00:49:44,190
So you'll be able to take
it from there and reuse it.

1269
00:49:44,190 --> 00:49:46,350
So lemme sort for my CUR. Here we go.

1270
00:49:46,350 --> 00:49:48,533
But let me take you through
what's in this policy.

1271
00:49:49,440 --> 00:49:53,730
First, this section is
the most important one.

1272
00:49:53,730 --> 00:49:56,550
This is the thing which
gives the access team

1273
00:49:56,550 --> 00:49:59,130
access to the information
in Lake Formation.

1274
00:49:59,130 --> 00:50:00,900
So this will allow them to go

1275
00:50:00,900 --> 00:50:03,250
and pick up that permission
we signed for them.

1276
00:50:04,230 --> 00:50:08,010
Everything else within the
policy is our standard setup.

1277
00:50:08,010 --> 00:50:09,480
So we have all the normal Athena things,

1278
00:50:09,480 --> 00:50:12,092
they can run queries, get results,

1279
00:50:12,092 --> 00:50:13,560
but you can see I defined the workgroup

1280
00:50:13,560 --> 00:50:14,730
to be that one we created up.

1281
00:50:14,730 --> 00:50:16,650
So they can only run
things in that workgroup

1282
00:50:16,650 --> 00:50:18,150
and access that configuration.

1283
00:50:19,140 --> 00:50:20,869
We then give them Glue data access,

1284
00:50:20,869 --> 00:50:21,810
so they can see the table.

1285
00:50:21,810 --> 00:50:23,520
But once again, I only give them access

1286
00:50:23,520 --> 00:50:26,220
to that CUR two table so
they can't see anything else.

1287
00:50:27,690 --> 00:50:29,760
So let me go ahead, let me tick the box,

1288
00:50:29,760 --> 00:50:31,150
let me add the permissions

1289
00:50:33,180 --> 00:50:35,520
and we are ready to go.

1290
00:50:35,520 --> 00:50:36,750
And this is where,

1291
00:50:36,750 --> 00:50:37,950
this is where I'm gonna get some marks.

1292
00:50:37,950 --> 00:50:40,367
Let's see what I have messed up.

1293
00:50:40,367 --> 00:50:41,880
So I'm gonna go back to Athena.

1294
00:50:41,880 --> 00:50:43,140
First we're gonna check is,

1295
00:50:43,140 --> 00:50:44,880
I haven't messed up my own access

1296
00:50:44,880 --> 00:50:46,860
and I haven't taken anything away.

1297
00:50:46,860 --> 00:50:48,573
So let me rerun this query here.

1298
00:50:52,811 --> 00:50:53,670
You can run it.

1299
00:50:53,670 --> 00:50:55,170
And you see we're still
getting eight accounts.

1300
00:50:55,170 --> 00:50:58,830
So good. My access is still
stable, things are working.

1301
00:50:58,830 --> 00:51:02,520
Now let me go to this tab here.

1302
00:51:02,520 --> 00:51:05,492
Oh no.
- Oh no, Andy gets an error.

1303
00:51:05,492 --> 00:51:06,928
(Steph laughs)

1304
00:51:06,928 --> 00:51:07,821
- [Andy Brown] Do you mind?

1305
00:51:07,821 --> 00:51:08,850
We should need Steph to lock me back in.

1306
00:51:08,850 --> 00:51:10,914
- Let me, I've swap over.
- Okay.

1307
00:51:10,914 --> 00:51:11,760
- You can keep talking.
- Yeah.

1308
00:51:11,760 --> 00:51:13,290
So we're gonna be going back here

1309
00:51:13,290 --> 00:51:15,780
and fingers crossed, once
Steph's logged us back in,

1310
00:51:15,780 --> 00:51:17,280
we will be able to see

1311
00:51:17,280 --> 00:51:19,713
that they now have
access to the CUR table.

1312
00:51:21,300 --> 00:51:22,823
- [Steph Gooch] All
right, let's have a look.

1313
00:51:24,420 --> 00:51:25,253
- [Andy Brown] This is what happens

1314
00:51:25,253 --> 00:51:27,010
when you prepare too early for a talk.

1315
00:51:28,041 --> 00:51:28,874
So here you go. I know.

1316
00:51:32,132 --> 00:51:35,613
- [Steph Gooch] Oh, interesting.

1317
00:51:36,900 --> 00:51:38,220
You need to go to the reinventing.

1318
00:51:38,220 --> 00:51:39,533
- [Andy Brown] Yeah, maybe go, yeah.

1319
00:51:41,850 --> 00:51:43,150
- [Steph Gooch] Let's see.

1320
00:51:46,050 --> 00:51:46,890
- [Andy Brown] But that's like, okay,

1321
00:51:46,890 --> 00:51:48,150
once Steph's got this back up and running,

1322
00:51:48,150 --> 00:51:49,080
we'll show you exactly

1323
00:51:49,080 --> 00:51:50,370
and fingers crossed it is working.

1324
00:51:50,370 --> 00:51:53,310
And what will happen is
within the FinOps account,

1325
00:51:53,310 --> 00:51:55,500
this app team will only
see their two accounts

1326
00:51:55,500 --> 00:51:57,153
and so they can now run queries.

1327
00:51:58,050 --> 00:52:00,420
And so what we really want
you to take away from this is,

1328
00:52:00,420 --> 00:52:02,970
everything we've shown
you with Lake Formation

1329
00:52:02,970 --> 00:52:04,473
is not actually CUR specific.

1330
00:52:05,370 --> 00:52:07,050
It could be anything
you've done in Athena.

1331
00:52:07,050 --> 00:52:09,870
We yes, ta-da.

1332
00:52:09,870 --> 00:52:12,390
Okay, so here we go. So
we're in a FinOps account.

1333
00:52:12,390 --> 00:52:14,070
I'm in my app team role.

1334
00:52:14,070 --> 00:52:16,389
I don't think that's, you can-

1335
00:52:16,389 --> 00:52:18,900
- Just come.
- Yeah, okay. Yeah.

1336
00:52:18,900 --> 00:52:20,520
So you can see here on my left hand side,

1337
00:52:20,520 --> 00:52:22,923
my app team can now see the CUR two role.

1338
00:52:24,101 --> 00:52:26,520
So if I expand it out and I
filter for those cost columns,

1339
00:52:26,520 --> 00:52:28,950
yes, they can only see those cost columns,

1340
00:52:28,950 --> 00:52:31,500
they give them access to,
they can't see anything else.

1341
00:52:31,500 --> 00:52:32,880
And now if I go back,

1342
00:52:32,880 --> 00:52:34,020
let me see what we've got here.

1343
00:52:34,020 --> 00:52:36,540
Oh no, which one? Here we go. Okay.

1344
00:52:36,540 --> 00:52:40,080
Okay, I'm gonna take
the query we had before.

1345
00:52:40,080 --> 00:52:41,730
I'm gonna paste it in here

1346
00:52:41,730 --> 00:52:44,340
and now this is the one with
the matter, fingers crossed.

1347
00:52:44,340 --> 00:52:45,450
Let's see if it works.

1348
00:52:45,450 --> 00:52:48,393
It should now return back
only the two accounts.

1349
00:52:49,860 --> 00:52:51,330
So again, so they have access.

1350
00:52:51,330 --> 00:52:53,970
So they, like I said, they
now have access to run queries

1351
00:52:53,970 --> 00:52:56,913
and do feel themselves,
but only see their data.

1352
00:53:01,410 --> 00:53:04,080
Everything I've shown you
today is not CUR specific.

1353
00:53:04,080 --> 00:53:06,660
So think about what other
teams are reaching out to you

1354
00:53:06,660 --> 00:53:08,070
and asking for data.

1355
00:53:08,070 --> 00:53:10,170
Maybe you could repeat the same process.

1356
00:53:10,170 --> 00:53:12,270
Long as you can get the data into S3,

1357
00:53:12,270 --> 00:53:15,210
you can get to Athena
you can get to Athena,

1358
00:53:15,210 --> 00:53:16,620
then you can register it in Lake Formation

1359
00:53:16,620 --> 00:53:17,940
and manage your order.

1360
00:53:17,940 --> 00:53:20,130
So think about maybe you're
downloading cost optimization,

1361
00:53:20,130 --> 00:53:21,240
hub data exports,

1362
00:53:21,240 --> 00:53:24,600
maybe some inventory or other
like reports you're producing

1363
00:53:24,600 --> 00:53:26,350
and you can this solution for that.

1364
00:53:27,750 --> 00:53:29,730
And so today we covered three main topics.

1365
00:53:29,730 --> 00:53:33,180
We started off with looking at
how to optimize data transfer

1366
00:53:33,180 --> 00:53:34,950
by introducing VPC Flow Logs

1367
00:53:34,950 --> 00:53:37,150
and using that as an
additional data source.

1368
00:53:38,130 --> 00:53:39,720
We then talked about AI

1369
00:53:39,720 --> 00:53:40,710
and work out how do you know

1370
00:53:40,710 --> 00:53:43,050
if your AI workload is efficient.

1371
00:53:43,050 --> 00:53:45,180
And then finally we talked
about how can we share this data

1372
00:53:45,180 --> 00:53:48,210
with more people about
sharing in a secure way.

1373
00:53:48,210 --> 00:53:50,660
I'm gonna hand it over to
Steph to finish us off.

1374
00:53:52,860 --> 00:53:54,600
- [Steph Gooch] We've made
it to our call to actions.

1375
00:53:54,600 --> 00:53:56,640
A couple of things for
you guys to take away.

1376
00:53:56,640 --> 00:53:58,350
Discover other data sources.

1377
00:53:58,350 --> 00:53:59,790
We showed you VPC Flow Logs,

1378
00:53:59,790 --> 00:54:02,010
but there are CloudWatch, S3,

1379
00:54:02,010 --> 00:54:03,120
there's loads of other services

1380
00:54:03,120 --> 00:54:04,830
that you can plug into Athena

1381
00:54:04,830 --> 00:54:06,633
and start to connect this data.

1382
00:54:07,530 --> 00:54:08,370
Tag your usage.

1383
00:54:08,370 --> 00:54:09,930
Like we said, we're relevant.

1384
00:54:09,930 --> 00:54:12,900
I always advise an account kind
of organizational structure,

1385
00:54:12,900 --> 00:54:14,880
but if there's specific
use cases for tagging,

1386
00:54:14,880 --> 00:54:16,890
do enforce those.

1387
00:54:16,890 --> 00:54:20,700
Enable RLS, give other
people the power of the CUR,

1388
00:54:20,700 --> 00:54:21,930
give them the chance to go in

1389
00:54:21,930 --> 00:54:24,840
and dive into this data as well.

1390
00:54:24,840 --> 00:54:27,900
Now I know that that is a lot of stuff

1391
00:54:27,900 --> 00:54:30,180
that we have covered today,

1392
00:54:30,180 --> 00:54:31,860
but I want you to have a go.

1393
00:54:31,860 --> 00:54:36,270
I want you to pick one
thing from today's session

1394
00:54:36,270 --> 00:54:39,210
and have a go in your
accounts, that is it.

1395
00:54:39,210 --> 00:54:41,340
Can get back after re:Invent.

1396
00:54:41,340 --> 00:54:43,290
See if it works for you.

1397
00:54:43,290 --> 00:54:45,330
Here's the QR code you've
all been waiting for

1398
00:54:45,330 --> 00:54:47,100
with the GitHub repo in it.

1399
00:54:47,100 --> 00:54:47,933
It's a link tree.

1400
00:54:47,933 --> 00:54:49,860
There's a bunch of
different resources in here,

1401
00:54:49,860 --> 00:54:53,610
including a home
recording of this session.

1402
00:54:53,610 --> 00:54:55,650
This one is recorded and
we'll come out later,

1403
00:54:55,650 --> 00:54:56,790
but we have a home recording in here

1404
00:54:56,790 --> 00:54:59,190
that you can just pop
in and see the queries.

1405
00:54:59,190 --> 00:55:00,140
There's also our LinkedIn,

1406
00:55:00,140 --> 00:55:02,610
so you can see whatever
fourth that I have to do.

1407
00:55:02,610 --> 00:55:03,480
- [Andy Brown] We've got another session.

1408
00:55:03,480 --> 00:55:04,313
We do have another session.

1409
00:55:04,313 --> 00:55:05,146
- [Steph Gooch] We're
gonna add them together.

1410
00:55:05,146 --> 00:55:06,600
- Yeah.
- And then we will also have

1411
00:55:06,600 --> 00:55:09,543
some resources like
inference profiles in there.

1412
00:55:10,620 --> 00:55:11,824
And with that,

1413
00:55:11,824 --> 00:55:12,657
thank you so much for joining us today.

1414
00:55:12,657 --> 00:55:14,430
I can't wait to see what you do

1415
00:55:14,430 --> 00:55:15,960
for the cost and usage report.

1416
00:55:15,960 --> 00:55:17,856
Thank you so much.
- Thank you.

1417
00:55:17,856 --> 00:55:19,876
(audience applauding)

