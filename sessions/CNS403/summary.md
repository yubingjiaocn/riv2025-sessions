# AWS re:Invent 2025 无服务器最佳实践会议总结

## 会议概述

本次会议由AWS无服务器开发者倡导者Julian主讲，主题为"无服务器开发者最佳实践"。会议通过一个虚构的烘焙店Emily's Pastries的五年成长故事，展示了从初创到国际化扩张过程中的无服务器架构演进。这个案例生动地反映了数千家公司在使用无服务器技术时的真实经历。

Emily的业务从疫情期间开始，最初每月仅处理40个订单，使用单一Lambda函数和基础DynamoDB表。随着业务增长到每月32万订单、60个国际门店，架构也经历了从单体应用到成熟无服务器架构的转变。会议深入探讨了在这个过程中遇到的性能瓶颈、扩展挑战以及解决方案，包括如何正确设计Lambda函数大小、实现异步架构、使用Step Functions进行编排、优化性能和成本等关键主题。

会议还介绍了AWS re:Invent 2025上发布的两项重要新功能：Lambda Durable Functions（支持长时间运行的工作流）和Lambda Managed Instances（结合Lambda简便性和EC2灵活性）。整个演讲内容丰富、信息量大，提供了大量可直接应用于实际项目的最佳实践和架构模式。

## 详细时间线

### 开场与背景介绍
[00:00 - 02:30] 
- 会议开场，Julian介绍自己是AWS无服务器开发者倡导者
- 强调无服务器是云端构建应用的默认方式
- 介绍Emily's Pastries的五年成长故事框架

[02:30 - 04:00]
- 展示五年业务增长数据：从每月40个订单增长到32万订单
- 说明架构如何支持这种戏剧性的扩展
- 提供资源页面二维码，包含演讲幻灯片和参考链接

### 第一阶段：起步阶段（2020年疫情期间）
[04:00 - 06:00]
- Emily在疫情期间开店，追随烘焙热情
- 初始架构：单一Lambda函数（200行代码）、基础DynamoDB表、电话手动支付处理
- 每月40个订单，来自本地社区客户
- 最小可行架构的优势：按使用付费模式、零基础设施管理

### 第二阶段：初步扩展（2021年）
[06:00 - 08:00]
- 简单架构仍然有效，开始拆分Lambda函数处理支付和库存跟踪
- 首次出现扩展挑战：早高峰时Lambda超时、性能下降、团队协调问题

### 第三阶段：架构危机（2022-2023年）
[08:00 - 11:00]
- 更多门店位置，订单量大幅增加
- 42个Lambda函数，复杂的依赖链，错误处理不足
- 早高峰级联故障，客户投诉激增
- 性能问题严重：订单处理时间超过6秒，高峰期3%的失败率
- 这成为迫使架构转型的突破点

### 第四阶段：架构重构（2024年）
[11:00 - 13:00]
- 实施适当的无服务器架构
- 引入Step Functions进行编排、EventBridge处理事件、SQS实现可靠处理
- 将42个Lambda函数减少到10个
- 处理时间从6秒降至400毫秒
- 为国际扩张奠定基础

### 第五阶段：全球扩张（2025年）
[13:00 - 15:00]
- 60个门店遍布欧洲和北美
- 每年380万订单，性能和可靠性优秀
- 无缝处理40倍的节假日流量高峰
- 尽管增长3倍，成本降低35%

## 核心最佳实践

### Lambda函数大小和组织
[15:00 - 22:00]
- **单一职责原则**：每个Lambda函数应有一个明确职责，避免"万能"函数
- **避免过度拆分**：不要过早创建微函数，从内聚函数开始，只在遇到实际问题时拆分
- **合理的函数数量**：42个函数的混乱是有机增长失控的结果
- **使用框架**：推荐使用SAM、CDK等框架简化开发
- **代码仓库组织**：不要为每个函数创建单独仓库，可以在单个仓库中管理多个服务
- **按业务域组织**：每个域拥有自己的数据和功能，团队可以自主选择技术栈
- **右适大小**：根据工作负载调整大小，按业务域组织，实现团队技术选择自主权

关键成果：
- 函数变小后冷启动减少
- 部署时间缩短
- 通过合理调整大小，计算成本降低40%

### 从同步到异步架构
[22:00 - 40:00]

同步架构的问题（2023年）：
- 早高峰期间级联系统故障
- 23%的订单被放弃
- 投诉增加，高峰期收入损失
- 顺序等待链：每一步必须完成才能得到响应
- 一个慢服务影响整个工作流

异步架构解决方案：
- 使用EventBridge事件总线实现服务间解耦
- 独立扩展，一个系统的故障不会破坏其他系统
- 使用异步回调更新原始调用者
- 引入Step Functions、EventBridge、SQS、AppSync Events

架构优势：
- 客户立即获得订单确认，无需等待所有处理完成
- EventBridge解耦所有服务
- AppSync Events提供实时更新（支付确认、厨房准备中、准备取货）
- 弹性：支付延迟不影响库存或通知
- 可扩展性：每个服务可根据需求独立扩展
- 清晰的事件追踪显示问题发生位置

### Lambda事件源映射（ESM）
[40:00 - 52:00]

ESM核心概念：
- Lambda服务自动从事件源拉取事件
- 支持基于内容的过滤，减少不必要的调用
- 可以批处理或分组记录以提高效率

队列vs流的区别：
- **队列（SQS）**：任务处理，每条消息独立，处理后删除
- **流（Kinesis/DynamoDB Streams）**：事件处理，需要多个消费者或消息重放，消息保留

SQS最佳实践：
- 可见性超时设置为Lambda函数超时的至少6倍
- 重试策略设置为3-5次
- 消息保留时间足够长以处理系统中断
- 必须设置死信队列（DLQ）捕获无法处理的消息
- 实现从DLQ恢复和重放消息的流程

ESM配置优化：
- 按需模式：最多1,500个并发调用
- 预配置模式：更快扩展，最多20,000个并发（16倍提升）
- 过滤功能：仅处理需要的消息，Emily通过过滤将某个ESM成本降低92%
- 批处理大小：建议从10开始，最大可达10,000
- 批处理窗口：改善低流量时的延迟
- 部分批处理失败报告：仅重试失败的记录

流量控制：
- 在ESM上设置最大并发，防止下游服务过载
- Lambda预留并发是函数级别的独立设置
- 如果同时使用，确保预留并发高于最大并发以防止限流

错误处理：
- SQS DLQ：捕获轮询或处理期间反复失败的消息
- Lambda失败目标：捕获调用失败（网络问题、限流、函数删除、IAM问题）
- 两者服务于不同目的，应一起使用

### 避免不必要的Lambda函数
[52:00 - 68:00]

问题背景（2024年）：
- 42个Lambda函数，许多只做简单数据转换和路由
- 不需要自定义业务逻辑的操作产生高计算成本
- 基本CRUD数据库更新的冷启动影响性能
- 多个函数调用的复杂故障场景

何时避免使用Lambda：
- 简单数据转换
- 直接服务到服务调用
- 仅路由数据
- 简单数据丰富

API Gateway直接集成：
- API Gateway可直接连接DynamoDB、SQS、Step Functions等多个AWS服务
- 无需Lambda作为代理
- 使用VTL（Velocity Template Language）配置，虽然测试有点麻烦，但配置后永久有效
- 简单、便宜、快速

EventBridge Pipes：
- 提供内置转换能力
- JSONPath提供强大的数据操作和过滤
- 可以丰富数据、进行格式转换
- 可选择性使用Step Functions或Lambda进行丰富
- 批处理以提高下游处理效率
- 适合不需要复杂业务逻辑的简单数据转换
- 减少基本事件处理的Lambda调用

Step Functions直接服务集成：
- 所有AWS SDK操作都可用（数千个集成）
- 简单配置调用，如更新DynamoDB库存
- 无冷启动，内置安全重试
- 支持内置JSON路径函数（生成UUID、计数、求和、长度等）
- 无需维护自定义代码即可构建大量功能

Step Functions与EventBridge结合使用：
- Step Functions适合域内微服务编排
- 完成服务需要做的事情后，向事件总线发出事件
- 实现不同域之间的事件驱动通信
- 强大的模型，允许添加多个域而不互相干扰

Step Functions两种工作流类型：
- **标准工作流**：可运行长达一年，异步，按状态转换计费
- **快速工作流**：高吞吐量，最长5分钟，可同步，按执行次数和内存消耗计费，在内存中运行超快

组合使用标准和快速工作流：
- 标准工作流编排完整订单处理生命周期，保留完整审计跟踪
- 嵌套快速工作流处理实时库存验证
- 快速工作流中使用并行状态同时检查库存和定价规则
- 使用DynamoDB直接服务集成，无Lambda冷启动

成果：
- 大幅减少Lambda函数和冷启动
- 改善延迟和超时
- 通过可靠的服务集成改善错误处理
- 每月节省$1,500，仅通过消除不必要的Lambda函数
- 证明了配置即代码优于自定义计算的力量
- 最好的Lambda函数往往是你不需要编写的那个

### Lambda Durable Functions（新功能）
[68:00 - 72:00]
- re:Invent 2025主题演讲中宣布的新功能
- 用喜欢的编程语言构建工作流
- 使用检查点暂停和恢复长时间运行的操作
- 内置幂等性
- 可以运行步骤、并行处理、等待回调
- 在异步Lambda函数内完成，不为等待时间付费
- 可运行长达一年
- Step Functions仍然适合直接服务集成
- 如果工作流需要大量自定义代码，或更喜欢用代码管理工作流，值得考虑
- Michael Gash和Eric Johnson将在明天的专题演讲中深入探讨（CNS 380）

### Lambda性能优化
[72:00 - 90:00]

Lambda Managed Instances（新功能）：
- 本周宣布的另一个新功能
- Lambda操作简便性 + EC2的完整范围和特定性
- AWS管理硬件，运行在您的VPC中
- 可根据内存、CPU或网络选择专用实例
- Lambda管理和处理实例
- 内置多并发（需要在代码中处理）
- 应用相同的超时限制
- 对于可以使用EC2定价计划（如预留实例）的大规模工作负载可节省成本
- 不适合所有人，适合高规模、稳态函数
- 启动速度不如按需快，但在高规模时提供成本管理选项
- Steven和Ashana将在周四的专题演讲中深入探讨

Lambda函数生命周期：
- 创建新执行环境（或在托管实例上部署容器）
- 下载代码或容器镜像
- 启动运行时
- 运行函数处理程序预初始化代码
- 首次调用
- 之后函数保持温暖状态

AWS控制vs开发者控制：
- AWS控制：环境创建、代码下载、运行时初始化
- 开发者控制：内存分配、初始化代码、函数处理程序代码、包大小

内存和CPU配置：
- Lambda按内存配置比例分配CPU能力
- 按需函数最高10GB，托管实例函数最高30GB
- 托管实例可配置内存与虚拟CPU的比例
- 按需函数超过约1.8GB内存后可使用多核，支持多线程
- 反直觉但真实：更高内存通常降低总成本
- 如果代码是CPU密集型，增加内存可提高性能并可能降低成本
- 关键是找到性能提升证明内存成本合理的最佳点

并行处理：
- 对于按需函数，如果想利用多个vCPU的能力，可在Lambda函数代码中使用并行处理
- 顺序处理3条记录需要300毫秒
- 使用Promise并行运行代码，所有3条记录仅需100毫秒
- 这是批处理充分利用CPU的超级解锁

Lambda Power Tuning工具：
- 开源工具，提供数据驱动的方法
- 可视化和微调Lambda函数的内存配置
- 在您选择的所有不同内存分配下运行函数的多次并发执行
- 测量性能表现
- 在您的账户中执行真实函数调用
- 显示真实成本和速度
- 以自动化方式帮助找到正确平衡

### 冷启动优化
[90:00 - 结束]
- Emily的数据显示冷启动影响性能
- 会议在此处字幕截断，但主题涵盖了冷启动的影响和优化策略

## 关键要点

1. 从简单开始，根据实际需求演进：不要过早优化或过度设计
2. 异步优先：异步架构应该是默认选择，提供更好的弹性和可扩展性
3. 配置优于代码：尽可能使用服务集成和配置，而不是编写自定义Lambda函数
4. 合理调整大小：Lambda函数、代码仓库、技术栈都要根据团队和工作负载合理调整
5. 利用新功能：关注Lambda Durable Functions和Managed Instances等新功能
6. 性能和成本平衡：通过合理配置内存、使用并行处理、消除不必要的函数来优化
7. 完善的错误处理：使用DLQ、失败目标、重试策略等多层错误处理机制