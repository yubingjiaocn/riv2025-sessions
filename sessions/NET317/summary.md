# AWS WAF 管理员的一天：从部署到优化的完整指南

## 会议概述

本次 AWS re:Invent 2025 技术分享会由 AWS 解决方案架构师专家 Tzoori Tamam 和 HSBC 银行的 Dan Avidan 共同主讲，主题为"WAF 管理员的典型一天"。这是一场 300 级别的技术深度分享，假设参会者已具备 AWS WAF 的基础知识。

会议采用故事化的方式，通过模拟 WAF 管理员一天的工作流程，从早晨接到新应用保护需求开始，到午餐时处理误报问题，再到下午的成本优化，最后展望未来的安全策略演进。Dan Avidan 分享了 HSBC 银行在采用 AWS WAF 过程中的实际经验，包括在全球多个市场、数百个 CloudFront 分发和每月数千亿请求量规模下的挑战与解决方案。

## 详细时间线与关键要点

### 00:00-05:00 开场介绍与场景设定
- Tzoori Tamam 介绍自己作为 AWS ED Services 解决方案架构师专家的身份
- 说明这是 300 级别技术分享，假设听众已具备 WAF 基础知识
- 介绍会议结构：通过 WAF 管理员一天的工作故事展开，后续由 HSBC 的 Dan 分享实际案例
- 设定场景：公司误解了 AI 机器人概念，建立了销售机器人的网站和移动应用

### 05:00-15:00 架构设计与部署策略
- 展示新应用架构：CloudFront 作为入口点，后端包含 ALB、API Gateway 和 S3 静态内容
- 讨论 WAF 部署的四个关键问题：
  - **在哪里部署**：推荐在 CloudFront 边缘部署，利用 750+ 个接入点的容量
  - **何时部署**：通常需要立即保护，需要在阻断模式和计数模式间做权衡
  - **谁来管理**：安全团队 vs 应用团队的管理复杂度平衡
  - **部署什么**：第一天的基础策略 vs 第100天的完整策略
- 介绍源站保护机制：
  - VPC Origins：将负载均衡器转为内部资源，只允许特定 CloudFront 分发访问
  - Origin Access Control (OAC)：通过 IAM 策略保护 S3 存储桶
  - 对于非 AWS 源站：使用托管前缀列表限制 IP 访问，配合密钥头部验证

### 15:00-25:00 WAF 策略配置与新功能
- 介绍两周前发布的 CloudFront 固定价格计划，包含预配置的 WAF 策略
- 展示从基础到商业级别的不同定价计划，包含 DDoS 保护、S3 存储、DNS 请求等
- 演示 WAF 控制台的简化配置流程：
  - 通过应用类型选择（内容分发、API、零售等）自动生成保护包
  - 三种预制保护包：基础版、核心版、增强版
  - 可调整速率限制阈值（10-20亿请求/5分钟）
- 强调日志记录的重要性：固定价格计划包含 CloudWatch 日志，按需付费模式下每百万请求提供 500MB 免费日志

### 25:00-35:00 监控仪表板与日志分析
- 展示 AWS WAF 内置仪表板功能（6月发布）：
  - 流量来源分析、规则命中统计、机器人流量检测
  - 顶级 IP 地址、URI、用户代理、JA3/JA4 指纹分析
  - 可直接从控制台导航日志，无需复杂的 CloudWatch 查询
- 演示交互式日志分析：点击 IP 地址可过滤相关请求，查看完整请求详情
- 支持传统 CloudWatch Logs Insights 查询用于高级分析

### 35:00-45:00 误报处理与策略调优
- 场景：午餐时间收到营销部门关于 403 错误的投诉
- 误报处理的最佳实践：
  - 保持冷静，不要关闭 WAF 或回滚更改
  - 分析触发误报的具体模式（URI、参数等）
  - 先将问题规则切换到计数模式，避免继续阻断用户
  - 创建精细化规则：继续阻断 XSS 攻击，但豁免特定 URI
- 标签（Labels）的重要作用：
  - 托管规则自动添加标签，自定义规则可添加标签作为操作
  - 可用作规则匹配条件或范围限定条件
  - 在日志和 CloudWatch 指标中可见，便于调查和过滤
- 调优建议：经常调优、逐步更改、使用标签管理流量

### 45:00-50:00 成本优化策略
- 确保 Layer 7 DDoS 规则位于策略顶部（被阻断的请求免费）
- 使用标签限定付费规则（如机器人控制）的检查范围
- 设置适当的日志保留期限，使用标签过滤噪音日志
- 推荐使用固定价格计划实现成本可预测性
- 不同日志目的地的成本考虑：
  - CloudWatch Logs：低流量时最便宜，配置最简单
  - Kinesis Data Firehose：高流量时最经济，可发送到 S3 或第三方
  - 直接 S3：配置简单但高流量时可能产生意外成本

### 50:00-56:00 HSBC 实际案例分享
- Dan Avidan 介绍 HSBC 作为全球大型银行的 WAF 应用场景
- 挑战包括：
  - 跨多个云提供商运营（AWS、GCP、本地部署）
  - 高度监管环境，每次宕机都需向监管机构报告
  - 每月数千亿请求，数百个 CloudFront 分发
  - 每日持续攻击，从 DDoS 到复杂的 Layer 7 攻击
- 解决方案：
  - 2018年开始的完全无服务器架构
  - 使用 Lambda@Edge 进行边缘计算处理
  - 通过自动化框架挖掘日志，自动阻断可疑 IP
  - 持续投资和团队建设，而非一次性部署
- 经验教训：
  - 保护明天的攻击而非昨天的
  - 自动化是关键，避免凌晨2点手动操作
  - 与 AWS TAM 和解决方案架构师保持密切合作