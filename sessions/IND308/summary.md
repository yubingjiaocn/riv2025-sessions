# AWS re:Invent 2025 - BMW 互联驾驶远程服务无服务器架构转型

## 会议概述

本次会议由AWS首席解决方案架构师Christian和BMW产品经理Ludvik共同主讲,深入探讨了BMW互联驾驶(Connected Drive)如何通过采用AWS无服务器架构和事件驱动设计,成功实现远程服务后端的现代化改造。BMW互联驾驶拥有超过2450万辆联网车辆,每天处理超过165亿次请求和184TB数据,是全球最大的联网车队之一。面对未来两年内请求量将增长三倍的预期,以及到2027年将发布超过40款采用Neue Klasse新技术的车型,BMW团队决定从根本上重新审视其远程服务架构。

2023年,BMW的远程服务虽然功能正常,但运行在从数据中心迁移到AWS的传统单体架构上,基于Amazon EKS和RDS,存在扩展性、维护复杂度和成本等方面的挑战。通过为期两周的概念验证试点项目,团队成功构建了基于Lambda、Step Functions、SNS/SQS、DynamoDB和API Gateway的全新事件驱动无服务器架构。新架构不仅在负载测试中处理了超过100万次请求且零错误,P99延迟低于1秒,P50延迟低于400毫秒,还将AWS基础设施成本降低了20%,同时几乎消除了所有基础设施维护工作。该解决方案已于2025年初成功投入生产,为BMW的"我的BMW"应用提供支持,该应用拥有5000万活跃用户,应用商店评分达4.8星。

## 详细时间线

### 开场与背景介绍 (0:00 - 3:30)

0:00 - 0:45 - 会议开场
- Christian(AWS首席解决方案架构师)和Ludvik(BMW产品经理)介绍会议主题
- 重点:探讨BMW如何使用AWS无服务器服务构建事件驱动架构,应对不可预测的工作负载

0:45 - 1:30 - 项目背景
- 2023年BMW已有可运行的远程服务解决方案
- 团队追求卓越,思考如何将良好的解决方案提升为卓越方案
- Christian与BMW合作已有5年

1:30 - 2:30 - 会议议程概览
- Ludvik介绍BMW互联驾驶和远程服务功能
- Christian讲解2023年的架构现状
- 深入探讨新架构设计决策和经验教训
- Ludvik分享架构迭代优化过程
- 总结生产环境实施后的收益

### BMW互联驾驶产品介绍 (2:30 - 8:00)

2:30 - 4:00 - BMW互联驾驶服务概述
- 覆盖BMW、Mini和劳斯莱斯全产品线
- 提供行业领先的互联服务
- 功能包括:通过"我的BMW"应用与车辆交互、车载游戏、车载流媒体、基于大语言模型的智能个人助手

4:00 - 5:30 - 规模数据
- 超过2450万辆联网车辆,是全球最大的联网车队
- 定期为超过1050万辆车辆提供OTA更新
- 每天处理超过165亿次请求
- 每天处理超过184TB数据
- 预计未来两年内请求量和流量将增长三倍
- 与AWS合作已有10年

5:30 - 7:00 - "我的BMW"应用
- 拥有5000万活跃用户
- iOS和Android应用商店评分4.8星
- 提供车辆实时数据、维修保养建议、经销商预约等功能
- 核心功能:远程服务

7:00 - 8:00 - 远程服务功能展示
- 远程预热/制冷车辆
- 远程关闭车窗(收到忘记关窗的推送通知)
- 防盗报警和车辆视频监控
- 每天处理250万次事件
- 每天处理超过1亿次API调用

### 远程服务技术演进历史 (8:00 - 11:30)

8:00 - 9:00 - 2006年第一代
- 首个用例:远程解锁车门
- 基于CDMA通信标准(美国)
- 使用语音呼叫执行远程服务
- 车辆定期启动调制解调器,呼叫中心不断拨打直到接通

9:00 - 9:30 - 2009年第二代
- 引入首批常开调制解调器
- 通过SMS远程唤醒车辆
- 增加SMS通信层
- 保留旧代车辆支持(车辆需要数十年连接支持)

9:30 - 10:30 - 2013-2021年演进
- 2013年:增加基于HTTP的通信协议
- 2018年:增加MQTT协议
- 2021年:支持UDP/IP触发器远程唤醒
- 仅淘汰最早两代车辆(通信标准不再支持)

10:30 - 11:30 - Neue Klasse新时代
- 展示全新BMW iX3电动车
- 2025-2027年将发布超过40款采用Neue Klasse技术的新车型
- 促使团队重新审视远程服务后端架构

### 2023年遗留架构分析 (11:30 - 16:30)

11:30 - 13:00 - 架构概览
- 2021年从BMW数据中心迁移到AWS(提升和迁移方式)
- 原先运行在OpenShift容器化环境
- 主要使用Amazon EKS和Amazon RDS
- 请求流程:客户端 → 远程服务后端 → 数据丰富/验证 → MQTT代理 → 车辆

13:00 - 14:30 - 单体架构细节
- 容器图标隐藏了大型单体应用
- 技术栈:Linux + Java运行时 + Java EE服务器
- 2006年的开发模式,不适合处理百万级请求规模
- 管理复杂度高,技术债务累积
- 无法淘汰遗留代码(需支持数十年功能)

14:30 - 16:30 - 面临的挑战
1. 可扩展性:未来两年请求量将增长三倍
2. 上市时间:2027年前发布40+新车型,需快速适配
3. 性能:高负载下保持低延迟和可靠性存在挑战
4. 成本:需优化AWS基础设施成本

### 利益相关者需求与试点规划 (16:30 - 19:30)

16:30 - 17:30 - 关键利益相关者访谈
- **客户**:可靠且响应快速的服务
- **DevOps工程师**:提高开发速度
- **高级管理层**:工程师专注新功能而非维护任务
- **产品经理(Ludvik)**:降低AWS账单
- **可靠性工程师**:强大且可快速扩展的系统

17:30 - 19:30 - 两周试点项目设计
- 目标:作为加速器而非一次性代码
- 选择两个代表性用例:远程鸣笛和远程闪灯
- 硬性要求:
  1. 支持"我的BMW"应用现有接口
  2. 支持与MQTT代理的双向接口
- 使用车辆模拟器进行自动化负载测试

### 新架构设计详解 (19:30 - 35:00)

19:30 - 21:00 - 四大核心组件
1. 事件创建组件:接收来自"我的BMW"应用的请求
2. 出站车辆通信服务:与MQTT代理通信
3. 入站车辆通信服务:处理车辆异步响应
4. 事件处理组件:事件分发、持久化和生命周期管理
- 额外实现订阅模拟器测量端到端延迟

21:00 - 23:00 - 远程鸣笛用例演示(第1部分)
- 客户在"我的BMW"应用中请求远程鸣笛
- API Gateway接收请求,集成Web应用防火墙验证
- 直接集成到AWS Step Functions Express(无中间Lambda,降低延迟和成本)
- 使用并行任务步骤同时处理多个组件

23:00 - 27:00 - 事件处理服务详解
- 事件通过直接服务集成转发到SNS主题
- 三个SQS队列订阅SNS主题
- 使用订阅过滤器避免不必要的下游处理
- **事件持久化组件**:
  - 将所有事件存储到DynamoDB
  - 使用AWS批处理(批量大小10)平衡速度和成本
  - 事件状态更新为"已创建"
- **事件分发层**:
  - 转换事件格式供外部订阅者使用
  - 仅订阅最终事件
  - 使用嵌入式指标格式(EMF)记录端到端延迟到CloudWatch

27:00 - 30:00 - 事件生命周期管理
- 挑战:每辆车同一时间只能有一个活动远程服务请求
- 必须确保请求最终达到终态(成功或失败)
- 场景:车辆停在无网络覆盖区域,无法接收/响应消息
- 解决方案:
  - Lambda函数根据服务类型和状态计算最大预期状态变更时间
  - 将消息放入SQS延迟队列(例如10秒延迟)
  - 延迟后Lambda检查DynamoDB中的状态变更
  - 如无变更,触发新事件标记请求失败

30:00 - 33:00 - 远程鸣笛用例演示(第2部分)
- **事件创建服务业务逻辑**:
  - 并行验证和丰富事件数据
  - BMW主要使用Java,Lambda函数用Java实现
  - 使用GraalVM编译为原生代码(无需Java运行时,降低冷启动延迟和成本)
  - 事件状态更新为"待处理"
- **出站通信**:
  - 消息放入SQS队列
  - AWS Fargate服务消费消息
  - 转换为MQTT消息并转发到MQTT代理
  - 车辆接收并处理请求

33:00 - 35:00 - 车辆响应处理
- 车辆异步发送确认消息到MQTT代理
- 入站Fargate服务消费消息
- 转发到第二个Step Functions
- 并行更新事件处理服务,状态变为"运行中"
- 根据服务类型执行相应工作流
- 车辆完成后发送最终消息,状态更新为"已执行"

### 试点项目结果 (35:00 - 42:00)

35:00 - 37:30 - 目标1:提高上市时间
- 将单体架构拆分为独立微服务
- 建立强大的关注点分离
- 试点期间多个双人团队并行工作
- 高度可扩展性:
  - 添加新远程服务用例主要是调整订阅,而非编写代码
  - Step Functions可轻松扩展(添加预检查、API调用等)
  - 事件处理模块可轻松添加(例如:监管披露模块)

37:30 - 39:30 - 目标2:减少维护工作
- **遗留架构维护负担**:
  - 代码:框架、Java JDK、依赖项
  - 基础设施:专有API网关、Kubernetes版本、容器操作系统、Java运行时、PostgreSQL RDS版本、Node.js清理脚本
- **新无服务器架构**:
  - 代码维护相同
  - 基础设施:AWS API Gateway(完全托管)、Lambda/Step Functions/SQS/SNS(完全托管)、无Java运行时(GraalVM原生编译)、DynamoDB(完全托管,内置TTL)
  - 仅剩Fargate车辆连接器需少量维护

39:30 - 41:00 - 目标3:可扩展性和性能
- 负载测试配置(使用Artillery):
  - 前2分钟:1 → 5 RPS
  - 接下来5分钟:5 → 100 RPS
  - 持续近3小时:100 RPS
  - 测试两种服务:远程鸣笛和远程闪灯
- **结果**:
  - 处理超过100万次事件/请求
  - 零错误
  - P99延迟远低于1秒
  - P50延迟低于400毫秒
  - 延迟峰值原因:HTTP请求超时设置不当(后续已修复,超过1秒则丢弃并重试)

41:00 - 42:00 - 目标4:成本优化
- 使用AWS定价计算器估算成本,显示可大幅降低成本
- 负载测试后使用AWS Cost Explorer验证:
  - 为每个AWS服务打标签以归因成本
  - 按小时查看成本明细
  - Lambda、SNS、SQS、Step Functions、API Gateway:按实际使用付费,直接推算月度成本
  - Fargate、DynamoDB存储、CloudWatch存储:按3小时成本推算月度成本
- **结果**:AWS基础设施成本降低20%

### 架构优化迭代 (42:00 - 48:00)

42:00 - 45:00 - 优化1:MQTT通信改进
- **遗留架构**:
  - 在Kubernetes单体中实现BMW库直接连接MQTT代理
- **试点架构**:
  - 迁移到Fargate容器,仍实现库并直接连接代理
- **最终优化**:
  - 与MQTT代理团队合作开发API
  - 通过API调用发送消息到车辆,代理团队负责放置消息
  - 代理订阅主题并将消息放入入站队列
  - 好处:抽象化不同车辆代次的框架和库版本
  - 移除Fargate连接器,实现完全无服务器
  - 几乎消除所有维护工作(仅剩证书和密钥管理)

45:00 - 48:00 - 优化2:车辆模拟器改进
- **遗留实现**:
  - 高级车辆模拟器运行在Fargate上
  - 作为车辆连接到MQTT代理
  - 需要复杂的安全配置和证书处理
  - 仅能模拟少数用例和正常场景
- **新实现**:
  - 在自己账户中模拟MQTT代理API
  - 完全无服务器的车辆模拟器
  - 可模拟所有用例和各种场景(成功、失败、超时等)
  - 简化开发和测试流程

### 生产环境部署与收益 (48:00 - 结束)

48:00 - 结束 - 项目成果总结
- 新架构于2025年初成功投入生产
- 支持"我的BMW"应用5000万活跃用户
- 实现所有关键目标:
  1. 显著提高上市时间和开发速度
  2. 几乎消除基础设施维护工作
  3. 出色的可扩展性和性能(零错误,低延迟)
  4. 降低20%的AWS基础设施成本
- 为BMW未来增长做好准备(应对未来两年3倍请求量增长)
- 成功支持Neue Klasse新车型技术