# AWS re:Invent 2025 Step Functions 可观测性会议总结

## 会议概述

本次技术会议由 AWS 无服务器首席专家 Pavan 和 AWS Step Functions 团队首席工程师 Diego 主讲,重点介绍了如何使用 AWS Step Functions 构建大规模数据处理工作流,以及如何通过可观测性工具监控和调试分布式工作流。

会议通过四个实际演示案例,展示了 Step Functions 的分布式映射(Distributed Map)功能如何处理大规模数据集。演示使用了一个包含全球风速数据的开源数据集,该数据集包含约 60 万个对象,总大小约 70GB。通过分布式映射功能,整个数据处理流程在约 2 分 15 秒内完成,展示了 Step Functions 在处理海量数据时的强大并发能力。

会议还深入讨论了 Step Functions 的关键可观测性指标,特别是最近推出的新指标功能,包括开放映射运行限制、映射运行积压大小以及状态转换配额等。这些指标帮助开发者更好地理解异步执行过程中的性能瓶颈,并及时采取优化措施。此外,会议还介绍了跨账户集成的最佳实践和注意事项。

## 详细时间线

### 开场介绍
[00:00 - 02:30]
- Pavan 和 Diego 自我介绍,Pavan 是 AWS 无服务器首席专家,Diego 是 Step Functions 团队首席工程师
- 现场调查:大部分观众已在生产环境使用 Step Functions,少数观众尚未使用
- 介绍会议议程:从基础构建开始,逐步深入可观测性和调试技巧

### 演示一:使用分布式映射处理风速数据
[02:30 - 08:45]
- 介绍用例:分析全球风速数据的开源数据集
- 数据集特点:按年份和站点 ID 分区,包含温度、露点、海平面气压和风速等参数
- 数据规模:约 60 万个对象,70GB 数据
- 最终目标:生成显示全球平均风速的可视化仪表板

[08:45 - 15:30]
- 在 Step Functions 控制台创建状态机,命名为"wind speed analysis"
- 选择标准工作流类型
- 配置分布式映射(Distributed Map):
  - 选择 S3 作为数据源
  - 设置批处理大小为 500 个对象
  - 设置并发限制为 1000(默认值,最高可达 10,000)
  - 设置容错阈值为 5%
  - 配置输出 S3 存储桶

[15:30 - 18:00]
- 配置子工作流:
  - 添加分析 Lambda 函数(计算平均风速)
  - 添加聚合 Lambda 函数(汇总结果)
  - 添加单位转换 Lambda 函数(将节转换为英里/小时)
- 注意:单位转换也可使用 JSONata 表达式优化,无需额外 Lambda 函数

[18:00 - 21:00]
- 创建状态机,系统自动识别所需权限并创建 IAM 策略
- 执行工作流,观察分布式映射的执行过程
- Diego 解释:每次迭代成为独立的工作流执行,避免单一执行的历史记录限制

[21:00 - 23:30]
- 观察执行进度:从待处理状态到运行状态
- 完整执行时间:约 2 分 15 秒处理 60 万个对象
- 每批处理 500 个项目
- 结果输出到 S3,可用于 QuickSight 可视化

### 问答环节一
[23:30 - 27:00]
- 问题:如果并发限制为 1000 且达到 Lambda 账户限制,其他 Lambda 是否还能运行?
- 回答:可以在状态配置中捕获限流异常并使用退避重试;Lambda 并发限制是软限制,可通过支持案例快速提升

### 演示二:开放映射运行指标
[27:00 - 32:00]
- Diego 介绍新推出的三个关键指标:
  1. 开放映射运行限制(Open Map Run Limit)
  2. 当前开放映射运行计数(Current Open Map Run Count)
  3. 映射运行积压大小(Map Run Backlog Size)
- 这些指标帮助识别异步执行中的延迟问题

[32:00 - 35:30]
- Pavan 演示负载测试场景
- 展示 CloudWatch 仪表板,显示三个关键指标
- 当开放映射运行超过限制时,积压大小开始增长
- 建议:为积压大小设置告警阈值,及时发现问题

[35:30 - 37:00]
- Diego 补充:积压指标仅在存在积压时发布,无积压时不显示数据
- 可通过 Service Quotas 请求提高限制

### 演示三:状态转换配额
[37:00 - 42:00]
- Diego 解释状态转换概念:执行开始、完成、节点间转换、分布式映射的每次迭代
- 默认限制:大区域每秒 5000 次,小区域每秒 800 次(软限制)
- 使用令牌桶算法:每秒重新填充,每次状态转换消耗一个令牌

[42:00 - 46:30]
- Pavan 演示状态转换限流场景
- 创建包含嵌套循环的状态机模拟高频状态转换
- 展示 CloudWatch 仪表板监控:
  - 桶大小(最大统计)
  - 重新填充率(最大统计)
  - 消耗容量(求和聚合)
  - 限流事件

[46:30 - 48:00]
- Diego 说明:CloudWatch 指标按分钟发布,但限制是按秒计算
- 添加"执行被限流"指标,按状态机筛选,识别导致限流的具体状态机

### 问答环节二
[48:00 - 50:00]
- 问题:状态转换的软限制是多少?
- 回答:大区域 5000/秒,无硬限制,可根据用例申请提升(如 30,000/秒)
- 问题:限制是按账户还是按状态机?
- 回答:按账户,所有状态机共享该限制

### 演示四:跨账户集成
[50:00 - 57:00]
- 用例:产品评论分析工作流
  - 中心账户:包含 Bedrock API 调用,判断评论真伪
  - 父账户:通过跨账户调用使用中心账户的工作流
- 关键配置:
  - 使用 .sync 方法进行同步调用
  - 父账户角色需要 AssumeRole 权限
  - 子账户角色需要信任父账户的主体
  - 使用条件属性防止混淆代理问题

[57:00 - 60:00]
- Diego 解释角色链机制:
  - 父账户的执行角色假定子账户的目标角色
  - 使用目标角色凭证进行 API 调用
  - 角色链由源账户发起,非 Step Functions 直接调用
  - 适用于所有跨账户集成,不仅限于 Step Functions

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


会议资源链接将在演示结束时提供,包含所有示例代码和配置