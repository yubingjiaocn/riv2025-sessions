# AWS re:Invent 2025 - Kinesis Data Streams 深度解析 (ENT 423)

## 会议概述

本次会议是一场400级别的技术深度分享,由AWS Kinesis Data Streams团队的软件开发总监John Markle和首席数据流架构师Ali Almi主讲。会议全面介绍了Amazon Kinesis Data Streams的核心架构、最新功能以及底层技术实现细节。

John首先介绍了Kinesis Data Streams作为AWS基础服务的四大支柱:弹性扩展、易用性、可靠性和高可用性。该服务在2025年Prime Day期间达到了每秒8.07亿条记录的峰值处理能力,每天处理超过70 PB的数据。会议重点展示了最近推出的两大新功能:On-Demand Advantage模式(提供预热吞吐量配置,成本降低40%)和大记录支持(单条记录从1MB提升至10MB)。通过一个社交媒体情感分析的实际演示,John展示了这些新功能如何帮助应用程序应对流量激增场景。

Ali随后深入讲解了Kinesis Data Streams的底层架构设计。他详细阐述了分片(shard)的分裂与合并机制,解释了为什么Kinesis采用分裂而非简单添加分片的方式来实现扩展——这种设计确保了消息顺序、支持缩容以及高效的负载均衡。Ali还揭示了系统的三层架构:前端API层(处理认证、授权、加密)、内部服务层(缓存、成员管理、定时器服务)以及跨三个可用区的存储节点层。整个架构设计确保了数据的三副本存储和高可用性,同时将复杂性完全屏蔽在用户之外。

## 详细时间线

### 开场与服务介绍 (0:00-8:30)

0:00 - 会议开始,John Markle介绍自己是AWS软件开发总监,负责Kinesis Data Streams团队

0:30 - Ali Almi介绍,首席数据流架构师

1:00 - 现场调查:大部分参会者使用过Kinesis Data Streams

1:30 - 会议议程概览:基础概念、新功能、实时演示、底层架构深度解析

2:00 - Kinesis Data Streams定义:完全托管的无服务器数据流服务

2:30 - 典型流式应用架构:生产者→Kinesis Data Streams→消费者(Flink/EMR/Lambda等)→数据湖

3:30 - 规模展示:Prime Day峰值达到每秒8.07亿条记录

4:00 - 对比:全球信用卡交易量在此速率下仅需3秒处理完毕

4:30 - 日常数据:340万个数据流,每天处理70 PB数据

5:00 - 单流能力:单个数据流可达每秒10 GB吞吐量

5:30 - 单流详细指标:每秒数百万条记录,支持多租户场景

6:00 - 四大支柱介绍:弹性、易用性、可靠性、高可用性

7:00 - 弹性:自动扩缩容,无需管理基础设施

7:30 - 高可用性:跨多个可用区部署,内置冗余机制

### 分片(Shard)概念详解 (8:30-12:00)

8:30 - 分片是扩展的原子单位

9:00 - 分片限制:写入1 MB/s,读取2 MB/s;写入1000条/s,读取2000条/s

9:30 - 分区键(Partition Key)机制:通过哈希算法分配到不同分片

10:00 - 分片的优势:可预测的扩展、离散容量管理、按需付费

10:30 - 分片的挑战:分区键映射复杂性、缩容时的数据重分配、消费者负载不均

11:00 - 客户需求:简化容量管理、支持更大记录

### On-Demand模式与新功能 (12:00-20:00)

12:00 - On-Demand模式推出(4年前):自动监控负载并调整分片数量

12:30 - On-Demand优势:免手动管理,自动应对流量激增

13:00 - CloudWatch图表演示:流量激增时自动扩展,节流率从60%降至0

14:00 - 扩展过程:5个分片自动扩展应对负载增加

15:00 - 客户挑战:可预测的性能、可预测的成本、一致的性能包络

15:30 - 新功能发布:On-Demand Advantage模式(上月推出)

16:00 - 预热吞吐量(Warm Throughput):提前配置预期峰值容量

16:30 - 成本优势:比常规On-Demand模式便宜40%

17:00 - 使用场景:适合有承诺工作负载的客户

17:30 - 新功能:大记录支持

18:00 - 记录大小从1 MB提升至10 MB(10倍增长)

18:30 - 传统方案:将大数据存储在S3,流中仅存储指针

19:00 - 传统方案问题:消费者复杂性增加、负载不均衡

19:30 - 新方案:直接支持10 MB记录,无额外成本

### 令牌桶机制详解 (20:00-23:00)

20:00 - 令牌桶(Token Bucket)限流机制解释

20:30 - 令牌以1 MB/s速率补充

21:00 - 大记录场景:10 MB记录消耗所有令牌,利用突发能力

21:30 - 后续请求:令牌耗尽后会被限流

22:00 - 恢复机制:降低吞吐量后令牌桶逐渐恢复

22:30 - 设计理念:在保持分片限制的同时支持大记录

### 实时演示:社交媒体情感分析 (23:00-32:00)

23:00 - 演示背景:John和Ali都是双胞胎父母,理解水平扩展的重要性

23:30 - 演示场景:产品发布的社交媒体情感分析

24:00 - 流量模式:11:00发布→11:05名人转发→11:45病毒式传播→逐渐回落

24:30 - 架构图:事件生产者→Kinesis Data Streams→Lambda处理→S3 Tables存储

25:00 - 第一阶段:每秒100条消息,4个分片,运行正常

25:30 - 第二阶段:名人转发后流量激增

26:00 - 问题出现:节流率上升,丢失数据

26:30 - On-Demand自动扩展:节流率降至零

27:00 - 分片变化:从4个分片扩展到更多分片

27:30 - 病毒式传播峰值:每秒50,000条记录

28:00 - 最终规模:128个活跃分片

28:30 - 结果统计:处理5510万条记录,但丢失200万条

29:00 - 使用On-Demand Advantage重新演示

29:30 - 配置预热吞吐量:控制台中设置预期峰值

30:00 - 容量规划工具:基于测试或生产数据推荐配置

30:30 - 新结果:从一开始就有128个分片

31:00 - 完美表现:处理5720万条记录,零丢失

31:30 - GitHub演示代码:提供QR码供下载

### 底层架构深度解析 (32:00-50:00)

32:00 - Ali接手讲解底层架构

32:30 - 背景:作为架构师帮助客户配置自管理流存储的经验

33:00 - 好奇心:自管理系统从1 GB/s扩展到10 GB/s需要数周规划,Kinesis如何做到自动化?

33:30 - 与工程团队的深入交流

34:00 - Kinesis设计原则回顾:易用、高可用、安全、持久、低延迟、超大规模

34:30 - 关键设计决策:如何扩展?

35:00 - 简单方案问题:直接添加分片会导致三个问题

35:30 - 问题1:消息乱序(相同分区键的消息可能到不同分片)

36:00 - 问题2:无法缩容(数据无法合并)

36:30 - 问题3:负载均衡困难(单个分片可达10 TB,难以在节点间移动)

37:00 - 创新方案:分片分裂(Split)而非添加

37:30 - 分裂机制:父分片关闭,创建两个子分片

38:00 - 消费顺序:先读取父分片,再读取子分片

38:30 - 合并机制:两个父分片关闭,创建一个子分片

39:00 - 架构优势:保证消息顺序、支持缩容、便于负载均衡

39:30 - 负载均衡:不同分片可在不同工作节点,无需复制大量数据

40:00 - 三副本存储架构

40:30 - 跨三个可用区存储数据

41:00 - 可用区作为故障隔离域

41:30 - 即使丢失整个可用区,仍有两个副本可用

42:00 - 主从复制架构

42:30 - 一个节点为主节点(Leader),接受写入

43:00 - 两个节点为副本(Replica)

43:30 - 发现问题:生产者和消费者需要找到正确的节点连接

44:00 - 复杂性:主节点故障切换时需要重新连接

44:30 - 前端API层的引入

45:00 - 单一API抽象所有复杂性

45:30 - 统一入口:收集各种来源的数据

46:00 - 无需管理网络基础设施

46:30 - 自动负载均衡到多个可用区

47:00 - 三个内部服务:缓存服务、成员服务、定时器服务

47:30 - 客户责任:生产者负载均衡、消费者租约管理

48:00 - Kinesis责任:持续监控后端节点

48:30 - Enhanced Fan-out功能:支持最多50个独立消费者组

49:00 - 优势:添加消费者无需重新规划容量

### API层与安全特性 (50:00-结束)

50:00 - API层的多租户特性:不同客户数据可能在同一节点

50:30 - 认证与授权:确保用户有权访问资源

51:00 - 配额管理:防止后端节点过载

51:30 - 加密:传输中加密(TLS)和静态加密(客户托管密钥或AWS密钥)

52:00 - IPv6支持:通过双栈API提供

52:30 - FIPS端点:在US GovCloud中可用

53:00 - 访问控制:基于资源的策略,流级别控制

53:30 - 会议总结与问答环节

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


关键要点总结:
- Kinesis Data Streams通过分片分裂/合并机制实现优雅扩展
- 新的On-Demand Advantage模式提供预热吞吐量和40%成本节省
- 大记录支持将单条记录限制从1 MB提升至10 MB
- 三副本跨可用区架构确保高可用性
- 前端API层完全屏蔽底层复杂性,实现真正的无服务器体验