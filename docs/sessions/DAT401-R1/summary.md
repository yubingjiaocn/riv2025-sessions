# AWS re:Invent 2025 DSQL 开发者实战会议总结

## 会议概述

本次会议是一场关于 Amazon DSQL（分布式 SQL 数据库）的开发者实战演示，由 AWS DSQL 团队的工程师 Marc 和数据库工程师 Raluca 主讲。会议采用"烘焙秀"的形式，通过构建一个简单的银行转账应用来展示 DSQL 的核心功能和开发实践。

DSQL 是 AWS 在去年 re:Invent 大会上预览发布、今年正式上线的分布式 Postgres 实现。它结合了关系数据库的强大功能（如 JOIN 操作、复杂查询）与 DynamoDB 的水平扩展能力和 Lambda 的无服务器特性。DSQL 基于四大核心支柱：几乎无限的扩展能力、高可用性、零基础设施管理和易用性。

## 详细时间线与关键要点

### 00:00-05:00 开场介绍与 DSQL 概述
- Marc 和 Raluca 介绍会议目标：构建银行转账应用演示 DSQL 功能
- DSQL 定位：分布式 Postgres 实现，融合关系数据库、水平扩展和无服务器特性
- 现场演示快速创建 DSQL 集群（约10秒完成）
- 强调 DSQL 简化了传统数据库的复杂配置选择

### 05:00-10:00 连接方式与开发环境设置
- 展示两种连接方式：Web 查询编辑器和 CloudShell 集成
- DSQL 支持 WebSocket 连接，浏览器可直接使用 Postgres 协议
- 介绍 GitHub 上的示例代码结构：CDK 文件夹（基础设施）和 Lambda 文件夹（应用代码）
- 演示基础 Lambda 函数和 CDK 部署配置

### 10:00-15:00 身份验证机制详解
- DSQL 使用类似 S3 预签名 URL 的身份验证机制
- 通过 AWS SDK 生成短期有效的认证令牌作为密码
- 演示命令行连接过程和环境变量配置
- 在 Lambda 函数中集成数据库连接池和认证逻辑

### 15:00-20:00 权限配置与数据库角色
- 创建数据库角色并映射到 IAM 角色
- 使用 CREATE ROLE 和 GRANT 语句配置权限
- 展示 aws_commons.create_iam_role 函数建立 IAM 到数据库角色的映射
- 验证连接成功并查看权限映射表

### 20:00-25:00 事务处理基础
- Raluca 详细解释 ACID 事务特性
- 创建账户表结构（ID 和余额字段）
- 演示错误的转账实现方式（不使用事务）
- 强调事务边界的重要性和一致性保证

### 25:00-30:00 并发控制机制
- 观众提问：并发事务如何处理同一账户的操作
- Raluca 解释乐观并发控制（OCC）vs 悲观并发控制
- DSQL 采用无锁设计，首个提交的事务获胜，其他事务需要重试
- 介绍序列化错误代码 40001 和重试逻辑的必要性

### 30:00-35:00 重试逻辑实现
- 实现 while true 循环处理并发冲突
- 添加错误处理逻辑，区分序列化错误和其他错误类型
- 强调在重试循环内获取新连接的重要性
- 添加遥测数据收集（重试次数、执行时间）

### 35:00-40:00 性能测试与扩展
- 运行 1000 个并发请求测试应用性能
- 观察到高冲突率和重试次数
- 增加账户数量到 100 万以减少热点写入
- 创建事务日志表记录所有操作

### 40:00-45:00 索引创建与查询优化
- 演示 CREATE INDEX ASYNC 语法的使用
- 异步索引创建避免表锁定，提供作业 ID 跟踪进度
- 使用 EXPLAIN ANALYZE 分析查询执行计划
- 展示索引对查询性能的影响

### 45:00-50:00 大规模负载测试
- 运行 4000-10000 TPS 的持续负载测试
- 展示 DSQL 的自动扩展能力，无需手动配置实例
- 监控错误率和 OCC 冲突率
- 通过增加账户数量减少写入热点

### 50:00-54:00 定价模型与总结
- 介绍 DPU（分布式处理单元）计费模式
- 展示实际使用成本：运行高负载测试仅花费 $2
- 强调按使用量付费的优势
- 会议总结和问答环节