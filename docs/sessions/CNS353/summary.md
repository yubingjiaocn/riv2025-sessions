# AWS re:Invent 2025 - Amazon ECS 部署策略会议总结

## 会议概述

本次会议由 AWS 高级解决方案架构师 Islam Hakub 主讲,重点介绍了如何在 Amazon ECS 上实现安全且具有弹性的容器应用部署。许多组织使用 Amazon ECS 托管基于容器的应用程序,他们的核心需求是能够以安全、有弹性的方式推出新版本,这意味着需要在零停机时间的情况下部署新版本,并且在发现问题时能够快速回滚到旧版本。

会议通过实际演示展示了两种主要的部署策略:滚动更新(Rolling Update)和蓝绿部署(Blue/Green Deployment)。演讲者使用了一个包含五个微服务的零售应用示例,所有服务都运行在 ECS 上,包括 UI 服务和四个后端服务(订单、结账、购物车和目录)。会议还深入探讨了如何使用生命周期钩子(Lifecycle Hooks)来自定义部署工作流,例如添加自动化测试或手动审批步骤。

## 详细时间线

### 开场介绍
[00:00 - 01:30]
- 演讲者 Islam Hakub 介绍自己是 AWS 高级容器解决方案架构师
- 说明会议主题:在 Amazon ECS 上实现安全且具有弹性的部署管道
- 介绍会议议程:ECS 部署概述、滚动更新策略、蓝绿部署策略和关键要点

### ECS 部署基础概念
[01:30 - 03:00]
- 解释 ECS 服务由任务定义和服务配置组合定义
- 任务定义包含容器镜像 URL、网络配置、环境变量等详细信息
- 介绍服务修订版本(Service Revision)的概念
- 说明服务部署对象如何跟踪从一个版本到另一个版本的部署过程

### 滚动更新部署策略
[03:00 - 06:30]
- 介绍滚动更新的工作原理:逐步用运行新版本的任务替换运行旧版本的任务
- 解释两个关键参数:
  - 最小健康百分比(Minimum Health Percent):部署期间可以运行的任务数量下限
  - 最大百分比(Maximum Percent):服务下可以运行的任务数量上限
- 这些参数帮助在可用性、部署速度和成本之间取得平衡

### 滚动更新实际演示
[06:30 - 09:00]
- 使用零售应用示例进行演示
- 展示如何通过 ECS 控制台查看服务配置
- 演示推送代码更改触发 CI/CD 管道
- 展示部署过程:源代码检出 → 构建容器镜像 → 推送到 ECR → 部署阶段
- 实时观察新任务逐步添加,旧任务逐步终止
- 通过浏览器验证新版本已成功部署,无停机时间

### 蓝绿部署策略介绍
[09:00 - 11:30]
- 说明滚动更新的局限性:回滚需要重新配置任务,耗时较长
- 介绍蓝绿部署策略:维护两个并行环境(蓝色为旧版本,绿色为新版本)
- 解释蓝绿部署的各个阶段:
  - 扩展阶段:配置绿色环境
  - 测试流量转移:将测试监听器指向新版本
  - 生产流量转移:将生产监听器指向新版本
  - 烘焙时间(Bake Time):保持两个环境以便快速回滚
  - 清理阶段:终止蓝色环境

### 蓝绿部署配置
[11:30 - 14:00]
- 演示如何在 ECS 控制台中配置蓝绿部署
- 配置烘焙时间参数
- 提供 IAM 角色以允许部署控制器修改监听器规则
- 选择生产监听器和测试监听器
- 配置两个目标组(蓝色和绿色环境各一个)

### 蓝绿部署实际演示
[14:00 - 17:30]
- 推送新的代码更改
- 使用两个浏览器窗口:一个连接生产监听器,一个连接测试监听器
- 观察部署过程:
  - 扩展阶段:创建新任务,任务数量翻倍
  - 测试流量转移:测试监听器显示新背景
  - 生产流量转移:生产监听器显示新背景
  - 烘焙时间:两个环境同时保持

### 快速回滚演示
[17:30 - 19:00]
- 演示如何在烘焙时间内快速回滚
- 点击回滚按钮
- 观察流量快速切换回蓝色环境(旧版本)
- 生产和测试监听器都恢复到旧背景
- 清理阶段删除绿色环境的新任务

### 生命周期钩子(Lifecycle Hooks)
[19:00 - 22:30]
- 介绍如何使用生命周期钩子自定义部署工作流
- 生命周期钩子是在部署工作流不同阶段调用的 Lambda 函数
- 钩子可以返回:进行中(In Progress)、成功(Success)或失败(Fail)
- 演示手动审批工作流的实现:
  - Lambda 函数在测试流量转移后阶段被调用
  - 将部署状态设置为待处理并保存到 S3
  - 通过 SNS 向审核人员发送通知
  - 审核人员验证测试监听器上的新版本
  - 批准后更新 S3 中的状态,部署继续进行

### 生命周期钩子配置和演示
[22:30 - 26:00]
- 在 ECS 控制台中配置生命周期钩子
- 选择 Lambda 函数并提供 IAM 角色
- 选择测试流量转移后阶段作为钩子触发点
- 推送代码更改并观察部署过程
- 部署在测试流量转移后阶段暂停
- 审核人员收到通知并验证新版本
- 批准后部署继续到生产流量转移阶段
- 完成烘焙时间和清理阶段

### 关键要点和总结
[26:00 - 28:30]
- ECS 提供多种部署策略:滚动更新、蓝绿部署、线性和金丝雀部署
- 蓝绿部署的主要优势:降低风险,维护两个环境以便快速回滚
- 权衡考虑:
  - 滚动更新:容量利用率较低,但回滚较慢
  - 蓝绿部署:使用更多容量,但回滚快速
- 提供额外资源链接供进一步学习

### 后续活动推荐
[28:30 - 29:30]
- 推荐两个相关会议:
  - 下午 1:30 在 Mandalay Bay 的蓝绿部署分组会议
  - 下午 4:00 在 MGM 的实践工作坊,可以亲手构建演示中展示的内容
- 会议结束,感谢听众参与