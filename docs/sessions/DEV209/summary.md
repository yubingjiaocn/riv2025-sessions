# AWS re:Invent 2025 - 使用 Argo CD 和 GitOps 部署 AWS 工作负载

## 会议概述

本次技术分享由来自澳大利亚的 AWS 社区构建者 Dale Orers 主讲，他在电信公司 59 工作。会议重点介绍了如何使用 GitOps 方法和 Argo CD 工具来管理和部署 AWS EKS（Elastic Kubernetes Service）工作负载。

随着企业应用规模的扩展，从单一部署发展到跨多个区域、多个环境的复杂部署架构，传统的部署方式面临着配置管理、基础设施管理和状态文件存储等诸多挑战。GitOps 作为一种现代化的部署方法，将 Git 仓库作为单一真实来源（Single Source of Truth），通过声明式的基础设施即代码（Infrastructure as Code）、版本控制、自动化部署和持续监控，确保了部署的一致性、可预测性和可审计性。

演讲者详细对比了传统 EKS 部署方式与使用 Argo CD 的 GitOps 方式的区别，展示了三种不同的多集群部署架构模式，并通过现场演示展示了如何使用 Argo CD 实现应用的自动同步、漂移检测和扩展操作。整个会议强调了 GitOps 在大规模 Kubernetes 集群管理中的重要性和实用价值。

## 详细时间线

00:00 - 00:45 - 开场与自我介绍
- 演讲者 Dale Orers 介绍自己是来自澳大利亚的 AWS 社区构建者
- 在电信公司 59 工作
- 提供 LinkedIn 二维码供参会者联系

00:45 - 01:30 - 会议议程介绍
- GitOps 概念及其重要性
- GitOps 的四大核心原则
- 使用 EKS 进行集群管理
- EKS 与 GitOps/Argo CD 的对比
- 现场演示环节

01:30 - 03:00 - 传统部署方式介绍
- 展示简单部署架构：Git 仓库 → 流水线 → 状态文件 → EKS
- 使用基础设施即代码工具（Terraform、Pulumi、CloudFormation、CDK）
- 状态文件存储在 S3 等远程仓库中

03:00 - 04:30 - 应用扩展带来的挑战
- 从单一工作负载扩展到多个工作负载
- 跨多个区域和多个环境的部署
- 配置管理、基础设施管理和状态文件管理的复杂性增加

04:30 - 06:00 - GitOps 概念介绍
- GitOps 是一种管理基础设施和应用部署的方法
- Git 仓库作为单一真实来源
- 确保部署的一致性，即使在规模扩展时也能保持

06:00 - 07:00 - GitOps 的三大组成部分
- 基础设施即代码（Infrastructure as Code）
- Git 仓库（版本控制和 Pull Request）
- CI/CD（构建、测试和部署）

07:00 - 10:30 - GitOps 的四大核心原则
1. 声明式定义：基础设施必须以声明式方式定义，确保可重现性
2. 不可变的期望状态：期望状态必须存储、不可变且正确版本化，便于审计
3. 自动拉取：GitOps 代理自动从源拉取期望状态，确保可预测性
4. 持续监控：GitOps 代理持续监控系统并根据期望状态应用变更，确保一致性

10:30 - 12:30 - 传统 EKS 部署面临的挑战
- 展示传统流程：团队 → Git 仓库 → 流水线 → EKS
- 提出关键问题：真实来源是什么？
  - 是 Git 仓库？
  - 是流水线产生的构件？
  - 是 S3 中的状态文件？
  - 还是 EKS 工作负载本身？
- 当出现故障或漂移时如何处理？

12:30 - 14:30 - Argo CD 介绍
- Argo CD 是 Kubernetes 的声明式持续交付工具
- 遵循 GitOps 原则，使用 Git 仓库作为单一真实来源
- 展示使用 Argo CD 的部署流程：
  - 团队推送变更到 Git
  - 持续集成（单元测试、构件、镜像、注册表）
  - PR 审批并合并到主分支（期望状态）
  - Argo CD 从 Git 拉取期望状态
  - 部署到 EKS 并持续监控同步状态

14:30 - 16:00 - 使用 GitOps 的优势
- 单一真实来源
- 所有内容都以基础设施即代码形式存在
- 支持应用回滚
- 漂移检测和自动修复
- 与 CI/CD 集成，增强部署流程

16:00 - 19:00 - 多集群部署架构模式

模式一：独立多集群部署
- 每个集群部署独立的 Argo CD 实例
- 管理开销大，需要为每个集群单独管理

模式二：Hub-Spoke 模型
- 中心账户部署 Argo CD 代理
- 工作负载部署在不同的 Spoke 账户
- Hub 直接与集群 API 通信
- 缺点：需要配置跨账户和网络访问

模式三：轻量级代理模型（推荐）
- 中心账户部署主 Argo CD 代理
- 每个 Spoke 集群部署轻量级 Argo CD 代理
- 使用出口访问，减少网络配置需求
- 最佳可扩展性方案
- 用户通过 Web UI 或 CLI 访问中心代理，统一管理所有工作负载

19:00 - 20:00 - Argo CD YAML 配置文件讲解
- 定义 Argo CD 项目
- 指定命名空间和服务器
- 配置源仓库 URL 和路径
- Argo CD 从指定仓库和路径拉取配置

20:00 - 21:00 - 应用生命周期
- 应用同步状态
- 检测配置漂移
- 显示不同步或过期状态
- Argo CD 自动修复同步问题

21:00 - 28:00 - 现场演示环节

21:00 - 22:30 - 环境准备
- 确认 Kubernetes 集群连接
- 创建 Argo CD 命名空间
- 安装 Argo CD
- 将 Argo CD 服务器端口转发到 80 端口

22:30 - 24:00 - YAML 文件检查
- 展示 Argo CD 应用配置文件
- 自动同步选项（演示中已注释）
- 指定仓库和路径（guestbook 应用）
- 应用包含 2 个副本的 Deployment 和一个 Service

24:00 - 25:30 - 访问 Argo CD UI
- 端口转发到本地主机
- 获取并解码初始管理员密码
- 打开 Chrome 浏览器访问 localhost
- 使用 admin 用户名和密码登录
- 初始状态没有应用

25:30 - 27:00 - 部署应用
- 应用 app.yaml 文件创建 Argo CD 项目
- 应用显示为"不同步"状态
- 左侧显示实时状态为空，右侧显示期望状态
- 执行同步操作，选择 Service 和 Deployment
- 两个副本开始启动
- 在控制台确认两个 guestbook 副本正在运行

27:00 - 28:00 - 扩展应用演示
- 修改部署配置，将副本数从 2 增加到 3
- 提交变更并推送到 Git 仓库
- Argo CD 检测到两个状态不同步
- 刷新 Argo CD UI，显示"不同步"状态
- Deployment 显示不同步：实时状态 2 个副本，期望状态 3 个副本
- 执行同步操作
- 确认现在有 3 个副本运行
- 使用 CLI 命令验证应用同步状态

28:00 - 29:30 - 会议总结要点
- 使用基础设施即代码部署所有资源
- 确保团队了解并正确使用 GitOps 流程
- 使用 Argo CD 等工具确保持续可观测性
- 选择合适的 GitOps 工具（Argo CD 只是众多选择之一）

29:30 - 30:00 - 结束语
- 感谢参会者出席
- 提供澳大利亚巧克力 Tim Tams
- 欢迎提问和交流