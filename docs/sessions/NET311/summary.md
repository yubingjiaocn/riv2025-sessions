# AWS re:Invent 2025 会议总结：使用 ELB 构建全球弹性应用

## 会议概述

本次会议由 John Zus（ELB 客户成功负责人）和 Filipe D Silva（首席解决方案架构师）主讲，主题为"全球弹性应用：使用 ELB 实现多可用区和多区域弹性的指南"。

会议深入探讨了如何在 AWS 上构建高可用性和弹性应用程序。演讲者强调了 Werner Vogels 的经典名言"一切都会失败"，并围绕这一理念展开讨论。会议内容涵盖了弹性的技术驱动因素（如减少停机时间、提高可用性、降低延迟）和业务驱动因素（如维持收入、保持客户信任）。演讲者特别指出，配置和部署错误（人为因素）是导致故障的最主要原因，远超过自然灾害等不可抗力因素。

会议重点讲解了多可用区（Multi-AZ）弹性架构，包括 ELB 如何通过 DNS 管理、健康检查机制和跨区域负载均衡来提高应用可用性。演讲者详细介绍了两层健康检查系统：Route 53 对负载均衡器节点的检查，以及负载均衡器节点对目标的检查。此外，还讨论了静态稳定性的重要性，建议预先部署冗余容量以应对可用区故障。最后，会议涉及了多区域（Multi-Region）弹性策略，强调了爆炸半径隔离、系统简化和高度自动化的重要性。

## 详细时间线

### 开场介绍
[00:00 - 02:30]
- John Zus 和 Filipe D Silva 介绍自己，感谢参会者在主题演讲期间前来参加
- 概述会议议程：指导原则、多可用区弹性、多区域弹性和问答环节
- 提到会后可在大厅继续交流具体架构问题

### 弹性基础概念
[02:30 - 06:45]
- 引用 Werner Vogels 名言："一切都会失败"（Everything fails all the time）
- 定义弹性：工作负载从基础设施或服务中断中恢复的能力
- 介绍弹性的双重驱动因素：技术驱动（减少停机、提高可用性、降低延迟）和业务驱动（维持收入、客户信任、公共形象）
- 列举需要缓解的故障类型：自然灾害（最不常见）、数据状态损坏、核心基础设施故障、配置和部署问题（最常见）
- 区分灾难恢复（恢复时间为小时到天）和高可用性（主备或主主架构，恢复时间更短）

### AWS 共享责任模型
[06:45 - 08:15]
- 介绍 AWS 提供的弹性基础设施：全球多个区域
- 解释可用区（AZ）概念：完全独立的基础设施，地理隔离但延迟保持在个位数毫秒
- 强调弹性是 AWS 和客户之间的共同责任

### 多可用区弹性架构
[08:15 - 12:30]
- Filipe 接手讲解多可用区弹性
- 展示简单应用示例：无 ELB 时，数据库故障需要手动故障转移，导致可用性下降
- 展示部分可用区连接问题的场景：需要在前端进行故障转移
- 介绍 ELB 如何改善可用性：透明扩展、流量分发、健康检查、DNS 流量管理

### ELB DNS 架构
[12:30 - 16:00]
- 展示典型 ELB 架构：DNS 层、负载均衡器、目标组和依赖项
- 解释 DNS 解析机制：返回随机顺序的 IP 以均匀分发流量，每个 IP 对应不同可用区
- DNS 记录 TTL 固定为 60 秒，确保客户端获取最新的健康主机
- 定义健康区域：至少包含一个健康目标，且该区域通过 Route 53 健康检查

### DNS 故障转移流程
[16:00 - 19:45]
- 演示 DNS 解析流程：用户查询 DNS 服务器，接收健康 IP 列表，建立连接
- 故障发生时：用户重新执行 DNS 查询，接收更新的健康主机列表，重新连接
- 回顾依赖项故障场景：当某个可用区无法连接数据库时，不应故障转移数据库，而应通过健康检查路由流量

### 两层健康检查系统
[19:45 - 24:00]
- 介绍 ELB 的两层健康检查设计：
  - 第一层：Route 53 持续对负载均衡器节点执行健康检查，确保 DNS 中仅发布健康 IP
  - 第二层：每个节点对目标执行健康检查，每个节点维护自己的健康目标视图
- 故障时的操作：重新路由流量，避开受影响的目标或可用区，并启动目标替换

### 健康检查选项
[24:00 - 28:30]
- 浅层健康检查：仅检查 Web 服务器连接性，返回响应代码
- 深层健康检查：执行额外的依赖项检查，但资源使用率高
- 混合健康检查（推荐）：异步检查依赖项，将结果填充到文件或缓存中，作为浅层健康检查提供给负载均衡器

### 静态稳定性
[28:30 - 32:15]
- 引用静态稳定性原则：当故障发生时资源可能不可用，如果失去三分之一容量可能导致过载
- 解决方案：预先部署冗余，实现静态稳定
- ELB 始终按至少一个可用区进行过度配置，以容忍故障
- 好处：实现无缝 DNS 故障转移，提供缓冲容量应对流量峰值
- 建议：目标也应预配置容量以容忍可用区故障，快速扩展、缓慢缩减

### 跨区域负载均衡
[32:15 - 36:00]
- 解释跨区域负载均衡：关闭时，负载均衡器 IP 仅与同一可用区的目标通信；开启时，可与所有可用区的目标通信
- 展示流量分配问题：当某个可用区目标数量较少时，关闭跨区域负载均衡会导致该区域目标承受不成比例的流量
- 建议：保持每个可用区健康目标数量成比例，确保后端容量能够处理可用区故障转移

### DNS 故障转移机制
[36:00 - 41:30]
- 场景：某个可用区所有目标故障
- 跨区域负载均衡关闭时：该可用区 IP 从 DNS 中移除，即使负载均衡器本身健康
- 跨区域负载均衡开启时：负载均衡器仍可向其他可用区目标发送流量，IP 不会从 DNS 中移除
- 强调：故障转移发生在数据平面层面，无需控制平面参与，适用于 ALB 和 NLB

### 故障开放模式
[41:30 - 46:00]
- 解释"故障开放"（Fail Open）原则：当所有目标都不健康时，不返回空记录
- DNS 层面：返回所有 IP（即使不健康），并在 Route 53 中标记"评估目标健康"失败，触发故障转移策略
- 目标层面：向所有目标发送流量，就像它们健康一样
- 警告：故障开放模式会掩盖其他故障，阻止额外的故障转移决策
- 可通过目标组健康阈值进行配置

### 监控故障开放模式
[46:00 - 49:15]
- 介绍如何监控负载均衡器是否处于故障开放模式
- 方法：创建 Route 53 故障转移策略记录（仅用于监控，不用于生产流量）
- 主记录指向 ELB 并启用"评估目标健康"，辅助记录返回静态资源或无记录
- 当检测到辅助记录被使用时，表明负载均衡器处于故障开放模式

### 目标健康阈值
[49:15 - 53:00]
- 默认行为：所有目标必须故障才触发 DNS 故障转移和目标故障开放
- 可配置阈值：建议配置早期干预点（如 30%），在所有目标故障前触发故障转移
- 统一阈值和详细阈值：可分别配置 DNS 故障转移和目标故障转移阈值
- 示例：当健康目标少于 30% 时触发故障转移，避免过载或客户体验下降

### 多目标组配置
[53:00 - 55:30]
- 场景：一个负载均衡器关联多个目标组（如测试和生产）
- 问题：某个目标组所有目标故障可能导致整个可用区 IP 从 DNS 中移除
- 解决方案：为非主要流量的目标组禁用健康阈值设置，避免影响主要流量

### Route 53 应用恢复控制器
[55:30 - 58:45]
- 介绍区域转移（Zonal Shift）功能：当检测到降级但目标尚未被标记为不健康时，可手动请求从 DNS 中移除某个可用区 IP
- 区域自动转移（Zonal Auto Shift）：AWS 检测到问题时自动执行区域转移
- 用途：可用于测试静态稳定性，执行故障演练
- 适用于跨区域负载均衡关闭和开启的场景

### 可观测性
[58:45 - 63:30]
- 强调可观测性的重要性（虽然时间有限无法深入讨论）
- 建议：在所有层面进行测量 - 负载均衡器指标、目标指标、依赖项指标
- 故障排查关键问题：故障是发生在单个可用区还是多个可用区？
  - 多个可用区同时出现问题：可能是依赖项问题，而非负载均衡器问题
  - 单个可用区问题：检查该区域特定目标
- 监控正向指标（如 2xx 响应率、健康主机数）和负向指标（如错误率）
- 推荐使用 CloudWatch 复合告警：组合多个告警，提高可见性

### 客户端最佳实践
[63:30 - 67:00]
- 强调客户端弹性的重要性：即使架构完善，客户端缓存 IP 或不正确处理故障也会导致问题
- 客户端应具备的能力：
  - 连接管理和连接池
  - 最大连接持续时间
  - 遵守 DNS TTL
  - 错误时重试响应的 IP，跳过失败的 IP
  - 实现带抖动的指数退避
- 好处：平衡连接分布、优雅故障处理、更快恢复时间、降低延迟

### 多区域弹性
[67:00 - 71:30]
- John 接手讲解多区域弹性
- 多区域的原因：
  - 额外的爆炸半径隔离
  - 应对配置问题或部署问题
  - 应对区域级灾难
  - 法律或合规要求（数据主权法）
- 多区域的挑战：这是一个非常困难的问题，涉及复杂的分布式系统
- 两个关键原则：
  1. 对齐所有人：确保团队和客户对故障模式、恢复时间和预期行为达成一致
  2. 保持简单：简单性可扩展，便于在故障时进行推理

### 多区域准备工作
[71:30 - 结束]
- 在实施多区域前应完成的工作：
  - 完善多可用区架构
  - 高度自动化基础设施（基础设施即代码）
  - 明确定义数据权威性和复制策略
- 强调一致性的重要性：避免手动配置导致的区域间差异
- 会议在讨论核心基础设施故障时结束（字幕截断）