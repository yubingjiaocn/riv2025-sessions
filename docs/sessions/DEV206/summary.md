# AWS re:Invent 2025 - DEV206 会议总结

## 会议概览

本次会议主题为"自动化 AWS Network Firewall 的 Suricata 规则"，演讲者分享了构建自动化管道来开发和部署网络防火墙规则的实践经验。会议重点介绍了 AWS Network Firewall 服务的核心功能，以及如何通过自动化解决手动管理 Suricata 规则所面临的挑战。

演讲者首先介绍了选择 AWS Network Firewall 的原因，包括其与 AWS 服务的深度集成、灵活的定价模型、强大的扩展性（每个可用区可达 100 Gbps）以及支持第 3 到第 7 层的规则定义。在实际部署中，Network Firewall 采用了南北向检查架构，用于检查从云环境到公共互联网的流量。

会议的核心内容聚焦于 Suricata 兼容规则的复杂性和管理难题。虽然 Suricata 规则功能强大且灵活，但其语法要求极其精确，即使是微小的错误也可能完全改变防火墙的行为。为解决这一问题，演讲者团队开发了一套完整的自动化解决方案，通过 Lambda 函数、S3 版本控制和事件驱动架构，将规则生成从依赖专家的手动过程转变为可重复、可测试、可扩展的自动化流程。该方案使团队成员能够通过简单的 CSV 文件提交规则需求，系统自动生成正确的 Suricata 语法、处理规则排序、执行验证并部署到 Network Firewall，大大提高了规则管理的效率和安全性。

## 详细时间线

00:00 - 会议开场与听众调查
- 欢迎参加 DEV206 会议：自动化 AWS Network Firewall 的 Suricata 规则
- 调查听众对防火墙设备的熟悉程度和配置经验
- 了解听众编写 Suricata 规则的实际经验

01:30 - 会议议程介绍
- 介绍会议结构：AWS Network Firewall 背景、防火墙规则和 Suricata、自动化解决方案设计、实施效益

02:15 - 选择 AWS Network Firewall 的原因
- 目标：为 AWS 云环境添加防火墙以提供更大的出站连接控制灵活性
- AWS Network Firewall 与 AWS 服务的原生集成优势
- 定价模型便利性：基于运行小时数和处理流量，适合临时工作负载

03:00 - AWS Network Firewall 核心特性
- 与 CloudWatch、S3 的日志集成
- 与 AWS Firewall Manager 和 Security Hub 的集中治理集成
- 支持第 3 到第 7 层的规则定义
- 深度包检测和域名过滤功能
- 可扩展至每个可用区 100 Gbps
- 支持南北向和东西向部署架构

04:30 - 示例架构说明
- 展示南北向检查架构
- Network Firewall 部署在集中检查 VPC 中
- 检查从工作负载 VPC 到公共互联网的流量
- 实现集中控制和流量分段

05:15 - Network Firewall 规则组件详解
- 防火墙策略包含有状态和无状态规则组
- 无状态规则组：不考虑流量方向和相关数据包
- 有状态规则组：考虑流量方向和相关数据包

06:00 - 有状态规则组类型
- AWS 托管规则组：预配置、即用型、由 AWS 提供安全覆盖
- 客户托管规则：满足特定环境和业务需求的定制规则

06:45 - 客户托管规则的三种类型
- 有状态标准规则：通过 UI/API/CloudFormation 定义，AWS 转换输入
- 域名列表规则：提供域名或子域名列表，AWS 处理逻辑
- Suricata 兼容规则字符串：直接提供 Suricata 规则，获得完整灵活性和控制权

08:00 - 规则类型建议
- 推荐从 AWS 托管规则组开始，提供基线安全控制
- 注意主动威胁检测的成本
- 使用 Suricata 兼容规则字符串以充分发挥 Network Firewall 的能力

08:45 - Suricata 规则语法的重要性
- 单行 Suricata 语法可定义完整的流量决策
- 语法精确性至关重要，小错误可能完全改变防火墙行为

09:15 - Suricata 规则语法错误示例
- 示例 1：缺少点前缀导致匹配意外域名（如 weevil.com）
- 示例 2：使用点前缀修饰符只匹配子域名，不匹配二级域名本身
- 示例 3：规则顺序错误导致丢失日志可见性（drop 规则在 alert 规则之前）

10:30 - 手动管理 Suricata 规则的挑战
- 依赖少数 Suricata 专家
- AWS Network Firewall 仅支持 Suricata 功能的子集
- 语法错误导致多次迭代修改
- 难以维护规则集，无法充分利用 Network Firewall 能力

11:30 - 自动化解决方案的必要性
- 将 Suricata 规则生成从专家专属流程转变为可重复、可测试、可扩展的流程
- 使整个团队能够自信地贡献规则

12:00 - 规则生命周期的前后对比
- 之前：工程师手动编写规则、无版本控制、直接上传到 Network Firewall 时出错
- 之后：自动化 Lambda 生成规则、S3 版本控制、自动验证和错误捕获

13:30 - 自动化管道架构概览
- 用户上传 CSV 文件到 Git 仓库
- 文件推送到版本化的 S3 存储桶
- 规则生成 Lambda 被触发，创建 Suricata 语法
- 输出返回 S3，触发第二个 Lambda
- 第二个 Lambda 将规则推送到 Network Firewall 设备
- EventBridge 和 CloudWatch Logs 监控整个解决方案

15:00 - CSV 输入格式说明
- 使用简单的结构化 CSV 文件捕获规则
- 每行代表一个逻辑语句：协议、端口、操作、域名等
- 团队成员无需担心专业语法即可提出更改

15:45 - Lambda 规则生成功能
- 强制执行正确的 Suricata 关键字（alert、drop、pass 等）
- 将 VPC ID 转换为 CIDR 块
- 确保日志规则在操作规则之前创建
- 强制执行清晰的日志消息

16:30 - 通配符功能示例
- 双星号通配符（**）：匹配二级域名及其所有子域名
- 单星号通配符（*）：仅匹配子域名，不匹配二级域名本身
- 复杂规则示例：为 TLS 和 HTTP 协议生成多条规则

18:00 - 验证 Lambda 功能
- 检查 Suricata 规则的格式错误和语法问题
- 评估编译后的规则长度与规则组容量
- 自动向工程师报告错误，缩短故障排除周期

19:00 - 示例代码分享
- 提供 QR 码访问第一个 Lambda 的示例代码
- Lambda 功能：将原始输入转换为 Suricata 规则字符串

19:30 - 关键要点总结
- Suricata 功能强大但精确性至关重要，自动化减少语法错误风险
- 规则意图成为真实来源，工程师描述需求，管道生成语法
- 事件驱动自动化提高安全性，内置验证、版本控制和错误处理
- 使用 AWS 原生服务（S3、Lambda、EventBridge、CloudWatch）保持解决方案轻量级
- 更快更安全的规则更新，团队无需 Suricata 专业知识即可快速响应威胁

20:45 - 规模化管理优势
- 轻松管理包含数百或数千条规则的大型规则组
- 自动化处理排序、验证和一致性
- 扩展防火墙保护不再增加运营负担
- 可在几分钟内更新和部署大型复杂规则

21:30 - 会议结束
- 邀请听众在会后交流讨论
- 请求填写会议调查反馈
- 感谢参与并祝愿 re:Invent 愉快