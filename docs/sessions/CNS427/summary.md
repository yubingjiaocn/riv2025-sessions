# AWS re:Invent 2025 - CNS427: 使用 Kiro 增强无服务器测试

## 会议概述

本次会议由来自新加坡的 Arti 和来自悉尼的 Thomas 主讲,重点介绍如何在无服务器开发生命周期中使用代理式 AI(Agentic AI)来简化测试流程。会议聚焦于自动化功能测试,包括单元测试、集成测试和端到端测试。

演讲者首先分析了无服务器应用测试面临的独特挑战:无服务器应用高度分布式和模块化,拥有大量集成点和云原生服务依赖。这导致测试过程中需要特别关注集成层的测试,同时还要处理依赖项的隔离测试问题(是否应该使用 mock、模拟器或直接使用 AWS 服务)。此外,Lambda 函数本身可能并不复杂,如何确定测试覆盖范围和重点也是一个挑战。

为了演示这些概念,演讲者使用了一个预先构建的任务管理 API 应用作为示例。该应用使用 Amazon API Gateway 作为 REST API 入口,Lambda 进行处理,DynamoDB 作为持久层,并通过 Amazon EventBridge 发布异步事件到通知服务。整个会议围绕如何改进这个应用的架构和测试策略展开,展示了如何使用 Kiro 和六边形架构(Hexagonal Architecture)来解耦代码,使其更易于测试和维护。

## 详细时间线

### **00:00 - 会议开场与背景介绍**
- Arti 和 Thomas 自我介绍,分别来自新加坡和悉尼
- 会议主题:使用代理式 AI 增强无服务器测试
- 明确会议为 400 级别,假设观众熟悉无服务器和基础编码知识

### **02:30 - 无服务器测试的挑战**
- 无服务器应用的特点:高度分布式、模块化、大量集成点
- 测试挑战:集成层测试、依赖项处理(mock vs 模拟 vs 真实服务)
- Lambda 函数复杂度与测试覆盖率的权衡

### **04:15 - 演示应用架构介绍**
- 任务管理 API:API Gateway + Lambda + DynamoDB
- 异步组件:EventBridge + 通知服务
- 使用 Python 和 AWS Powertools 实现

### **06:00 - 代码演练:原始架构**
- 展示任务 API 的目录结构
- Lambda handler 使用 Powertools 进行路由
- 创建任务流程:解析事件 → 构建任务对象 → 持久化到 DynamoDB → 发布事件 → 构建响应
- 业务规则示例:循环依赖检查

### **10:30 - 原始测试方法**
- 使用 Moto 库 mock Boto3 调用
- Pytest fixtures 用于设置和清理
- 测试用例演示:成功场景和循环依赖错误场景
- 测试运行时间:400-500 毫秒的初始化开销

### **14:00 - 原始架构的问题总结**
- 代码与基础设施选择紧密耦合
- 更换 AWS 服务需要重写测试
- 开发者体验有摩擦:需要了解服务的 mock 细节
- 测试速度有改进空间

### **16:30 - 使用 Kiro 进行架构审查**
- Thomas 演示 Kiro CLI 的自定义代理功能
- 配置专门的架构评估代理
- Kiro 生成完整的六边形架构审计报告
- 报告包含问题识别和改进建议

### **20:00 - Spec-driven 开发方法**
- 使用 Kiro 创建规范(spec)文件
- 生成需求(requirements)、设计(design)和任务(tasks)文件
- 展示如何使用 spec 来量化和实施架构变更

### **24:00 - 重构后的架构讲解**
- 六边形架构实现:Handler → Domain Logic → Adapters
- Handler 只处理 HTTP 请求验证
- Domain Logic 包含所有业务逻辑
- 通过接口(Protocols)与适配器通信
- 解耦了基础设施依赖

### **28:30 - 代码演练:重构后的架构**
- Task Service 使用依赖注入
- Python Protocols 创建契约而无需实现
- Repository 和 Event Publisher 可配置
- 默认使用 AWS 服务,测试时可注入 fake 实现

### **33:00 - 改进的测试策略**
- 依赖注入的优势:无需运行时 patching
- 创建可配置的 Fake Task Service
- 使用标志控制成功/失败场景
- 测试代码大幅简化

### **38:00 - 单元测试演示**
- 使用 Fake Task Service 替代 mock
- 通过 Pytest fixtures 注入依赖
- 测试代码更清晰,无需复杂的 mock 配置
- 循环依赖测试简化:只需设置标志

### **42:00 - Domain Logic 测试**
- 纯函数测试:给定输入,验证输出
- 循环依赖检查函数的测试示例
- 无需 mock,直接测试业务逻辑

### **45:00 - 性能对比**
- Moto mock:400-500 毫秒开销
- In-memory fake:约 120 毫秒
- 测试速度显著提升

### **47:00 - Mock vs Fake 的使用场景**
- 第三方依赖(如 SES 邮件服务)适合使用 mock
- 自有代码的复杂行为适合使用 fake
- 根据具体场景选择合适的测试策略

### **49:00 - 会议总结(截断处)**
- 介绍 Kiro 的属性基于测试(Property-based tests)
- 解决需求到代码转换的验证问题
- 会议在此处字幕截断

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


注意: 本总结基于提供的字幕文本,会议在介绍属性基于测试时截断,完整内容可能包含更多关于集成测试、端到端测试以及使用 MCP 服务器持续改进应用质量的内容。