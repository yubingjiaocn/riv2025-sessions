# AWS re:Invent 2025 - 使用 JSONata 和 AWS Step Functions 简化编排

## 会议概述

本次技术分享由 AWS 高级技术客户经理 Hishita Chakravarti 主讲,她在编排用例方面拥有超过 18 年的客户服务经验。会议重点介绍了如何使用 JSONata 和 AWS Step Functions 来简化工作流编排,解决传统架构中 Lambda 函数过度使用的问题。

传统的 Step Functions 架构通常依赖大量 Lambda 函数来处理数据转换和业务逻辑,这导致了函数激增、维护复杂、延迟增加和成本上升等痛点。通过引入 JSONata——一种轻量级的 JSON 查询和转换语言,开发者可以直接在 Step Functions 中完成复杂的数据操作、数值计算和负载转换,无需额外的 Lambda 函数。会议通过股票交易应用的实际案例,展示了如何将包含多个 Lambda 函数的传统架构简化为使用直接 API 调用、优化服务集成和 JSONata 转换的现代架构,最终实现更低的延迟、更少的维护负担和更优的成本效益。

## 详细时间线

00:00 - 开场与介绍
- 讲师自我介绍:Hishita Chakravarti,AWS 高级技术客户经理
- 观众调查:了解参会者对 Step Functions 的熟悉程度
- 会议主题:简化编排的重要性

02:30 - Step Functions 基础介绍
- Step Functions 是低代码可视化工作流服务
- 支持 AWS 服务、第三方 API 和应用程序 API 的编排
- 内置常见工作流模式:并行工作流、迭代工作流、人工审批、长时间运行工作流
- 提供错误处理、重试机制和端到端监控

04:45 - 传统架构的痛点
- 展示传统股票交易工作流示例:检查股价 → 人工审批 → 买入/卖出 → 报告结果
- 识别的问题:
  - Lambda 函数激增
  - 数据转换能力有限(仅有 JSONPath)
  - 维护挑战:CI/CD 管道、运行时弃用
  - 延迟和成本增加

07:20 - JSONata 介绍
- JSONata 是轻量级的 JSON 查询和转换语言
- 开源项目,灵感来自 XPath
- 功能特性:
  - 导航 JSON 对象和数组
  - 数组扁平化
  - 内置运算符和函数(数值、布尔、字符串)
  - 支持用户自定义函数
  - 与 AWS Step Functions 原生集成

10:15 - 简化策略一:移除 Lambda 函数
- 使用直接 HTTPS API 调用替代 Lambda
- 利用 JSONata 的转换能力处理负载
- 消除 Lambda 函数激增问题
- 使用 JSONata 调整负载格式以适配目标系统

12:40 - 简化策略二:数据聚合场景
- 增加复杂度:生成交易报告
- 输入数据:交易 ID、买卖类型、股票代码、价格、数量
- 输出需求:区分长期交易(持有超过 365 天)和短期交易
- 展示 YAML 格式的 ASL 代码片段:
  - 定义变量过滤长期和短期交易
  - 计算交易数量
  - 计算收益或损失
- 强调可扩展性:适用于各种自动化场景的数值计算和字符串操作

16:30 - 简化策略三:DynamoDB 集成
- 场景:将交易数据持久化到 DynamoDB
- 挑战:DynamoDB 需要特定的数据结构格式
- 解决方案:使用 JSONata 进行格式转换

18:00 - 实时演示
- 使用 Amazon Q 在 Visual Studio Code 中生成 JSONata 查询
- 输入:原始交易数据
- 输出:DynamoDB 所需的格式化结构
- 提示词:使用自然语言描述输入输出,要求使用单引号
- 测试流程:
  - 在 Step Functions 控制台编辑状态机
  - 使用"测试状态"功能验证转换
  - 确认生成的结构符合 DynamoDB 要求
- 关键点:无需编写代码,Amazon Q 自动生成 JSONata 查询

22:15 - JSONata 实现细节
- 使用 $states.input 作为默认输入
- 可以使用自定义变量替代默认输入
- UUID 函数生成唯一 ID
- 支持日期时间函数
- 映射字符串和数字类型
- 所有转换在单个 Step Functions 任务中完成

24:30 - 三大简化策略总结
1. 使用 JSONata 执行复杂数据操作
2. 使用 SDK 优化集成和 HTTPS API 调用
3. 减少 Lambda 依赖

25:45 - 简化编排的优势
- 简化维护:无需管理 Lambda 运行时、CI/CD 管道和弃用问题
- 降低延迟:Step Functions 内直接调用
- 降低成本:消除额外的 Lambda 费用
- 适用于 IT 自动化用例

27:30 - 生成式 AI 和代理工作流
- 观众调查:参加过生成式 AI 或代理工作流会议的人数
- 展示使用 Step Functions 构建的生成式 AI 代理工作流
- 案例:社交媒体代理,将长篇内容重新格式化到多个社交媒体平台
- 工具使用架构:LLM 做出决策
- 功能:内容摘要、发布、根据平台调整语气
- 关键点:使用 Bedrock Converse API 替代 Lambda 函数
- Lambda 仍可用于监督角色,但不应用于每个小型转换
- 展示 ASL 代码:定义模型 ID、消息、系统提示和工具结果

31:00 - 核心要点与类比
- 咖啡机类比:
  - 1920 年代制作咖啡:研磨、煮沸、过滤、倒入——多个独立步骤
  - 现代咖啡机:一体化简化流程
- JSONata 简化编排的方式类似:
  - 消除大量转换 Lambda 函数
  - 降低数据操作的延迟和成本
  - 提高工作流可读性和可维护性
  - 所有功能原生集成在 Step Functions 中

32:30 - 资源与后续会议推荐
- JSONata 官方文档
- 相关博客文章
- Serverless Land 资源
- 推荐会议:
  - AI 代理相关会议
  - 开发者生产力会议

33:15 - 结束语
- 感谢参会者
- 提醒完成移动应用中的会议调查