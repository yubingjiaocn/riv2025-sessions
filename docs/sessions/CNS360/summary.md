# AWS re:Invent 2025 无服务器应用安全最佳实践

## 会议概述

本次会议由AWS解决方案架构师Chris McPeek和Hegy Park主讲，重点探讨了无服务器应用的安全最佳实践。Chris在AWS工作了七年半，专注于无服务器应用开发；Hegy在AWS工作了九年多，专注于无服务器和代理应用（Agentic Applications）。

会议分为两个主要部分：首先，Chris介绍了无服务器安全的基础概念和最佳实践，涵盖账户边界、加密、IAM权限管理、最小权限原则、API保护等核心主题。其次，Hegy深入讲解了身份感知应用的安全实现，特别是OAuth 2.0在无服务器和代理应用中的应用。整个会议以一个健身追踪应用为例，展示了如何在实际架构中应用这些安全原则，包括API Gateway、Lambda函数和DynamoDB的安全配置。

演讲者强调了开发速度与安全性之间的平衡，介绍了如何通过权限边界、服务控制策略(SCP)等工具，让开发人员在保持敏捷开发的同时确保生产环境的安全。会议还涵盖了开发生命周期各阶段的安全考虑，包括代码分析、依赖检查、运行时异常检测等内容。

## 详细时间线

### 开场介绍 (0:00-2:30)
- **0:00** - Chris McPeek和Hegy Park自我介绍，说明会议主题为无服务器应用安全最佳实践
- **1:15** - 介绍静音会议的特殊性，要求观众通过点头和竖起大拇指提供反馈
- **1:45** - 组织观众集体欢呼，活跃气氛
- **2:00** - 说明会议结构：Chris先讲基础安全实践，Hegy后讲现代应用开发和身份感知

### 应用架构介绍 (2:30-4:00)
- **2:30** - 引入健身追踪器应用作为示例场景
- **3:00** - 介绍基础架构：运动员使用追踪器 → API Gateway → Lambda函数 → DynamoDB
- **3:30** - 说明Hegy正在训练马拉松，使用健身追踪器收集数据

### 账户边界 (4:00-6:00)
- **4:00** - 强调账户边界的重要性，虽然不是纯无服务器概念但很重要
- **4:30** - 询问观众背景：开发人员和安全工程师的比例
- **5:00** - 解释开发环境与生产环境的分离：开发人员在沙箱环境快速开发，通过结构化部署管道部署到生产环境
- **5:30** - 强调账户边界提供了良好的关注点分离

### 加密 (6:00-8:00)
- **6:00** - 介绍加密的重要性，AWS无服务器服务已内置大量安全功能
- **6:30** - Lambda环境变量加密：使用KMS密钥加密敏感环境变量
- **7:00** - API Gateway缓存加密：确保缓存数据被加密
- **7:30** - 传输中加密：所有无服务器服务默认支持，API Gateway仅接受HTTPS请求

### IAM身份和访问管理 (8:00-11:00)
- **8:00** - 介绍IAM的两个平面：控制平面（API调用）和数据平面（应用运行）
- **8:30** - 组织级别的服务控制策略(SCP)：跨多个账户应用
- **9:00** - 资源策略：应用于特定服务以控制访问
- **9:30** - 在健身API架构中应用IAM策略控制API调用和Lambda调用
- **10:30** - 强调根据不同层级设置权限边界

### Lambda函数的资源策略与执行角色 (11:00-13:00)
- **11:00** - 区分资源策略和执行角色，这与EC2实例的安全模型不同
- **11:30** - 资源策略：控制哪些服务可以触发或调用Lambda函数
- **12:00** - 执行角色：控制Lambda函数可以访问哪些资源
- **12:30** - 示例：API Gateway通过资源策略调用Lambda，Lambda通过执行角色写入DynamoDB

### 最小权限原则 (13:00-16:00)
- **13:00** - 介绍最小权限原则，承认作为开发人员理解这个概念有难度
- **13:30** - 开发人员倾向于快速开发，有时会设置过于宽泛的权限
- **14:00** - 强调在云开发中最小权限的重要性：仅授予服务所需的操作权限
- **14:30** - 采用迭代方式：设置权限 → 运行测试 → 验证操作
- **15:00** - 可以在CI/CD管道中验证权限设置是否符合组织合规要求

### 权限边界 (16:00-19:00)
- **16:00** - 开发人员也需要最小权限，不应访问不该访问的资源
- **16:30** - 权限边界：允许开发人员创建所需策略，但限制其可以开放的范围
- **17:00** - 权限边界只能拒绝操作，不能允许操作
- **17:30** - 示例：开发人员设置Lambda、DynamoDB、API Gateway的完全访问权限
- **18:00** - 安全团队通过权限边界限制为仅lambda:InvokeFunction、dynamodb:UpdateItem、apigateway:PutMethod
- **18:30** - 有效权限是两者的交集：仅lambda:InvokeFunction和dynamodb:UpdateTable

### 服务控制策略SCP (19:00-22:00)
- **19:00** - 企业级组织通常需要跨所有账户应用合规策略
- **19:30** - SCP可以在整个组织范围内应用策略
- **20:00** - 示例：限制API Gateway只能创建私有端点，不能创建公共端点
- **20:30** - 场景：要求所有追踪器流量通过特定VPC进行安全验证
- **21:00** - 锁定公共API访问，创建私有API端点并放入VPC
- **21:30** - 流量通过VPC进行安全分析，然后通过ENI流入API Gateway VPC

### API集成和数据库安全 (22:00-24:00)
- **22:00** - API集成将由Hegy详细讲解，这里重点讨论数据库
- **22:30** - DynamoDB支持IAM，可以通过IAM策略授予Lambda访问权限
- **23:00** - 对于不支持IAM的数据库（如EC2上的数据库）
- **23:30** - 使用Secrets Manager存储凭证，不要在代码中硬编码
- **23:45** - Lambda函数通过访问Secrets Manager来访问数据库

### 开发生命周期安全 (24:00-27:00)
- **24:00** - 开发生命周期各阶段都需要考虑安全
- **24:30** - 代码编写和存储：确保最小权限
- **25:00** - 代码推送到仓库触发管道：确保IAM范围正确，只有授权人员可以部署
- **25:30** - 源代码分析：检查依赖项的安全问题
- **26:00** - Amazon Inspector可以分析代码和依赖项问题
- **26:30** - 提到Matt Garman主题演讲中介绍的安全代理工具
- **26:45** - 麦克风出现问题，但继续讲解

### 运行时安全监控 (27:00-28:30)
- **27:00** - 如果代码检查遗漏了有问题的依赖项
- **27:30** - 运行时使用Amazon GuardDuty检测应用异常
- **28:00** - GuardDuty可以查看VPC流日志检测异常行为

### 事件负载验证 (28:30-31:00)
- **28:30** - 介绍Lambda事件负载验证的重要性
- **29:00** - PowerTools工具：轻松添加严格类型验证输入
- **29:30** - 展示PowerTools代码示例：导入依赖并在Lambda中验证
- **30:00** - 本周有多个PowerTools相关会议，AWS现在有专门团队开发
- **30:30** - API Gateway输入验证：在请求到达Lambda之前验证schema
- **31:00** - 三种验证配置：请求体、查询字符串参数、或全部验证

### API端点保护 (31:00-33:00)
- **31:00** - 之前讨论了将端点设为私有
- **31:30** - AWS WAF：基于IP地址、地理区域限制API Gateway访问
- **32:00** - AWS WAF支持第三方规则集订阅
- **32:30** - AWS Marketplace上有多个提供商提供WAF规则订阅
- **33:00** - Chris将话题交给Hegy讲解身份感知应用

### 身份感知应用介绍 (33:00-35:00)
- **33:00** - Hegy接手，询问观众是否能听到
- **33:30** - 说明将深入讲解一个特定的应用栈安全考虑
- **34:00** - 这在无服务器和代理应用中是常见用例
- **34:30** - 回到健身Web应用架构：用户 → Web应用 → API Gateway → Lambda → DynamoDB

### OAuth 2.0基础概念 (35:00-38:00)
- **35:00** - Hegy将重点讲解用户认证和授权
- **35:30** - 确保用户Hegy只能执行被允许的操作，访问被允许的资源
- **36:00** - 展示无服务器应用架构：不同API端点（活动、路线等）
- **36:30** - 使用领域驱动设计，不同团队管理不同API，可能有不同的认证方案
- **37:00** - 保护API端点的标准：OAuth 2.0
- **37:30** - 将深入讲解OAuth 2.0术语

### OAuth 2.0实体 (38:00-41:00)
- **38:00** - 资源所有者：拥有数据的用户（如Strava用户Hegy）
- **38:30** - 用户代理：Web浏览器或移动客户端
- **39:00** - 客户端/Web应用：部署在Fargate上的应用
- **39:30** - 资源服务器：需要保护的无服务器API
- **40:00** - 授权服务器：身份提供商，确定谁可以访问哪些资源
- **40:30** - 这五个实体是整个流程的关键组件

### OAuth 2.0授权流程类型 (41:00-43:30)
- **41:00** - 介绍获取资源访问权限的流程
- **41:30** - 授权码流程（Authorization Code Flow）：最常见，用户点击允许访问
- **42:00** - 客户端凭证流程（Client Credentials Flow）：用于机器对机器通信
- **42:30** - 授权码流程是面向最终用户的，有用户交互
- **43:00** - 客户端凭证流程没有用户点击批准按钮，完全自动化

### OAuth 2.0凭证 (43:30-46:00)
- **43:30** - 开发人员需要向身份提供商注册应用
- **44:00** - Client ID：类似用户名，应用的标识符
- **44:30** - Client Secret：类似密码，与Client ID配合使用
- **45:00** - 这两者一起用于验证应用身份
- **45:30** - 在向身份提供商注册时获得Client ID和Secret

### OAuth 2.0令牌 (46:00-49:00)
- **46:00** - 交换Client ID、Secret和用户身份后获得的令牌
- **46:30** - ID Token：短期令牌，标识谁在与服务交互（用户名、邮箱等）
- **47:00** - Access Token：最重要的令牌，定义允许执行的操作（作用域/scopes）
- **47:30** - 作用域示例：对某端点的读权限、对另一端点的写权限
- **48:00** - Refresh Token：用于自动刷新令牌，避免频繁要求用户重新批准
- **48:30** - Refresh Token可能有更长的生命周期（如24小时）

### 授权码流程 - 第一阶段 (49:00-52:00)
- **49:00** - 授权码流程分为两个阶段
- **49:30** - 第一阶段：用户登录并获取授权码
- **50:00** - 用户Hegy登录Web浏览器，重定向到登录页面
- **50:30** - 登录后出现弹窗："是否允许Hegy访问此资源？"
- **51:00** - 点击批准后，身份提供商生成授权码（一次性使用的长字符串）
- **51:30** - 授权码发送回前端应用
- **52:00** - 前端应用已有Client ID和Secret（部署时配置）

### 授权码流程 - 第二阶段 (52:00-55:00)
- **52:00** - 前端应用现在拥有：Client ID、Client Secret和授权码
- **52:30** - 应用使用这些凭证向授权服务器（Amazon Cognito）进行身份验证
- **53:00** - 发送Client ID、Client Secret和授权码
- **53:30** - Cognito验证后返回：ID Token、Access Token和Refresh Token
- **54:00** - 重要提示：这些令牌不应暴露给Web浏览器
- **54:30** - 令牌应保留在前端应用的后端，最终用户不应看到

### API调用验证流程 (55:00-57:30)
- **55:00** - 发送ID Token到API Gateway的授权器
- **55:30** - API Gateway将ID Token发送回授权服务器进行验证
- **56:00** - 验证通过后，确认这是Hegy的有效ID Token
- **56:30** - API Gateway允许请求，调用Lambda函数
- **57:00** - 假设已配置资源策略，允许API Gateway调用Lambda

### 完整流程回顾 (57:30-59:30)
- **57:30** - 用户连接到前端应用，登录获取授权码
- **58:00** - 授权码发送回前端应用
- **58:30** - 应用验证并调用API，API Gateway检查授权服务器
- **59:00** - Lambda函数被调用，作为资源服务器
- **59:30** - Lambda函数的handler有两个参数：event payload和context payload

### Lambda中的身份信息 (59:30-61:00)
- **59:30** - Context payload包含身份信息
- **60:00** - 开发人员可以在业务逻辑中使用这些身份信息
- **60:30** - 示例：根据用户组和权限执行自定义操作
- **61:00** - 即使完成OAuth流程后，仍可获得额外的身份信息

### 客户端凭证流程 (61:00-63:00)
- **61:00** - 回顾两个阶段：第一阶段是用户交互，第二阶段是机器对机器
- **61:30** - 客户端凭证流程：去掉第一阶段（登录和授权码交换）
- **62:00** - 只保留第二阶段：Web应用部署时带有Client ID和Secret
- **62:30** - 直接用Client ID和Secret交换令牌（ID、Access、Refresh Token）
- **63:00** - 不需要授权码，因为没有特定用户交互

### 客户端凭证流程验证 (63:00-64:30)
- **63:00** - 发送Bearer Token到API Gateway
- **63:30** - API Gateway向身份提供商验证
- **64:00** - 验证通过后调用Lambda函数
- **64:30** - Hegy总结：OAuth 2.0是无服务器API和代理应用的基础安全机制

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


会议总结：本次会议全面覆盖了无服务器应用安全的关键方面，从基础的账户隔离、加密、IAM权限管理，到高级的OAuth 2.0身份认证流程。演讲者通过健身追踪应用的实际案例，展示了如何在真实场景中应用这些安全最佳实践，为开发人员和安全工程师提供了实用的指导。