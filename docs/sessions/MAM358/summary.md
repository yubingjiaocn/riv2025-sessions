# AWS re:Invent 2025 技术分享会总结

## 会议概述

本次分享会由三位AWS解决方案架构师Adrian Beg、Durk和Robert主讲,重点探讨了应用现代化转型过程中的三个关键架构模式:Strangler Fig(绞杀者模式)、Saga(分布式事务模式)和Circuit Breaker(断路器模式)。

演讲者以一个名为"New Science"的科学新闻平台为案例,详细阐述了如何从单体应用逐步演进到微服务架构。该平台最初由三位朋友创建,提供用户注册、文章发布和评论功能。随着业务增长,应用变得越来越复杂,原有的单体架构开始成为瓶颈——成本激增、代码难以维护、团队陷入"救火"状态,无法专注于新功能开发。演讲强调了架构决策中的权衡取舍,指出任何架构选择都会带来复杂性,关键是选择最符合业务目标的方案,无论是改善客户体验、降低运营负担还是提升应用的敏捷性。

第二部分深入探讨了微服务架构下的系统集成挑战。当单体应用被拆分为多个独立服务后,如何协调这些服务之间的交互成为新的难题。演讲者介绍了Saga模式的两种实现方式(编排和编舞),并以"高级会员订阅"功能为例,展示了如何通过事件驱动架构和消息队列(Amazon SQS、SNS、EventBridge)实现松耦合的异步通信,从而提高系统的弹性和可扩展性。

## 详细时间线与关键要点

00:00 - 开场介绍
- 三位AWS解决方案架构师介绍自己及各自专长领域
- 明确会议主题:Strangler Fig、Saga和Circuit Breaker三种转型模式

02:30 - 架构决策的权衡
- 强调每个架构决策都涉及权衡:"无论你做什么,总会有不完美的地方"
- 通常需要在简单性和复杂性之间做出选择
- 架构师应关注对客户最重要的方面:用户体验、运营负担或应用敏捷性

04:00 - 案例背景:New Science平台诞生
- 三位朋友创建科学新闻平台,提供用户注册、文章发布和评论功能
- 初期应用简单,仅几百行代码,三名开发者可以理解全部应用
- 24小时内收到第一个用户反馈:需要搜索功能

06:15 - 单体应用的快速增长与问题累积
- CTO快速实现搜索功能,虽不完美但满足需求
- 团队优先考虑快速交付新功能,忽视技术债务
- 几年后问题开始显现:成本激增、代码难以维护、原始开发者离职且未留文档

08:45 - 单体应用的困境
- 团队从开发新功能转变为每天"救火"
- 任何变更都需要所有产品经理批准
- 应用承载的用户量远超最初设计
- 团队陷入恐惧和不满,单体应用成为发展障碍

10:30 - Strangler Fig模式介绍
- 展示澳大利亚昆士兰的绞杀榕树照片
- 解释绞杀榕的生长方式:从宿主树顶部开始生长,逐渐包裹并最终取代宿主树
- 在取代过程中,绞杀榕的根系为宿主树提供额外稳定性

13:00 - Strangler Fig模式在软件中的应用
- Martin Fowler于2004年提出该模式,至今仍然有效
- 核心概念:在现有系统边缘逐步构建新系统
- 关注最大问题,从单体应用中提取并构建新组件
- 优势:提高单体应用稳定性的同时,降低系统崩溃风险

15:20 - 实施步骤:引入代理层
- 在用户和应用之间插入Facade或Proxy(使用Amazon API Gateway)
- 初期仅作为路由层,将所有请求转发到单体应用
- 后续可选择性地将流量导向新服务或单体应用

17:45 - 第一步:重构搜索服务
- 搜索服务是最大问题点,使用关系数据库实现不当
- 批处理任务从1分钟延长到1小时,拖累整个数据库
- 决策:新服务拥有独立数据存储,使用专门的搜索数据结构
- 采用增量索引的持续工作模式

20:30 - 搜索服务迁移完成
- 在API Gateway中添加路由,将搜索请求导向新服务
- 其他请求继续发送到单体应用
- 移除问题代码,减轻单体数据库压力
- 该服务依赖较少,迁移相对简单

23:00 - 第二步:重构文章管理服务
- 文章管理服务需要频繁变更,但与其他组件交互较多
- 引入反腐败层(Anti-Corruption Layer)作为适配器
- 在单体应用中添加小型包装器,转换旧接口到新接口
- 目标:最小化对单体应用的修改

26:15 - 文章服务迁移策略
- 使用AWS Lambda实现API组件(适应可变负载)
- 使用Amazon S3存储文章内容,DynamoDB存储元数据
- 使用AWS DMS进行异构数据库迁移,将部分数据迁移到S3
- 持续同步直到准备切换

29:00 - 迁移成果与持续优化
- 通过API Gateway添加新路由,完成文章服务切换
- 随着服务迁出,可以缩减单体应用规模,降低成本
- 采用"冲洗并重复"策略,持续关注最重要问题
- 团队重获敏捷性,从"救火"转向创新

31:30 - 分布式系统的新挑战
- 从单体应用转向分布式系统后,集成和协调变得更复杂
- Durk接手讲解如何管理系统间交互

33:00 - Saga模式介绍
- Saga模式用于管理分布式系统中的工作流
- 两种实现方式:编排(Orchestration)和编舞(Choreography)
- 产品团队提出新需求:高级会员订阅功能

35:45 - 高级会员订阅流程
- 用户通过客户端提交订阅请求
- 订阅管理服务异步处理,立即返回响应
- 后台涉及多个下游系统:支付、内容启用、会员通讯、忠诚度服务
- 需要确保特定顺序:先收款再提供服务

38:20 - 系统集成决策
- 决定自建哪些服务,哪些使用第三方SaaS
- 支付服务使用第三方(避免PCI认证)
- 忠诚度和通讯服务使用第三方SaaS(非核心竞争力)
- 目标:松耦合、简单、高弹性的集成

40:30 - 同步vs异步集成
- 同步请求-响应模式引入运行时耦合
- 绑定所有阶段的资源,违背微服务独立扩展的承诺
- 下游系统问题可能影响上游系统稳定性

43:00 - 异步请求-响应模式
- 上游系统发送POST请求,下游立即返回202 Accepted
- 减少运行时耦合,但仍存在可用性依赖
- 如果下游系统不可用,无法发送请求

45:15 - 引入消息队列
- 消息队列具备缓冲能力,解决可用性依赖问题
- 即使下游系统暂时不可用,消息也会被缓冲
- 下游系统恢复后可按自己节奏消费消息
- 点对点特性支持横向扩展,每条消息只传递给一个消费者进程

47:30 - AWS消息服务推荐
- Amazon SQS:云原生无服务器消息系统
- Prime Day 2025峰值处理1.66亿条消息/秒
- Amazon MQ:支持JMS或AMQP等行业标准协议(Apache ActiveMQ或RabbitMQ)

49:45 - 发布-订阅模式
- 使用Topic替代部分Queue,简化架构
- 订阅管理服务只需发送一条消息,多个订阅者都能收到
- 新服务可直接订阅Topic,无需修改发布者
- 推荐使用Amazon SNS作为云原生无服务器服务

52:00 - Topic-Queue链式模式
- 结合Topic和Queue的优势
- 在订阅者前添加Queue,保留缓冲和负载均衡能力
- 既有发布-订阅的灵活性,又有队列的弹性

54:30 - 事件驱动架构
- 从发送命令转向发送事件
- 用单一消息总线替代多个消息通道
- 为第三方服务添加代理组件(Lambda函数)处理HTTP流量
- 推荐使用Amazon EventBridge作为无服务器消息总线

57:00 - Saga编舞模式实现
- 工作流分布在所有参与方
- 每个服务监听相关事件,处理后发布新事件
- 订阅管理服务发布"订阅升级请求"事件
- 支付管理服务、客户关系服务等监听并处理相关事件
- 欺诈检测服务、支付代理等监听"客户支付请求"事件
- 形成事件驱动的工作流链

59:30 - 会议结束
- 演讲在详细解释Saga编舞模式的事件流时结束
- 字幕显示内容在此处截断