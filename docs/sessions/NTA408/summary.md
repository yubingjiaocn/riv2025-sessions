# AWS 技术会议总结：云网格与多云连接解决方案

## 会议概述

本次会议由 HAProxy 团队的 Frank 和 Jacob 主讲，重点探讨了多云环境下的服务网格架构挑战及其解决方案。演讲者指出，传统服务网格虽然旨在解决连接性问题，但对大多数组织而言，只是将复杂性转移到了其他地方。现代基础设施是碎片化的——包括多个云平台、多个区域、本地数据中心和无法更改的遗留应用程序，而大多数服务网格在设计时并未考虑这些因素。

HAProxy 提出了"通用网格"(Universal Mesh)架构理念，通过在网络边界部署战略网关，而非管理分散的 sidecar 和代理部署，来简化运维复杂性。这种架构融合了 ingress、mesh 和 proxy 功能，提供开箱即用的联邦支持，实现跨集群、跨云、跨区域的无缝连接。演讲还展示了 HAProxy 在性能方面的突破——在单个 AWS Graviton 4 实例上实现了每秒 254 万次请求，同时保持极低的成本（每 10 亿次请求仅需 41 美分）。

此外，会议深入讨论了多层安全防护策略，包括零信任架构、动态速率限制、机器人检测、Web 应用防火墙等功能，所有这些都在不牺牲性能的前提下实现。通过统一的控制平面，用户可以集中管理所有策略并部署到任何平台——无论是 Kubernetes、EC2、ECS 还是本地环境。

## 详细时间线与关键要点

### 开场与问题陈述 (00:00 - 05:30)

00:00 - 00:45 - 会议开场，Frank 和 Jacob 介绍自己，并询问现场有多少人听说过和正在使用 HAProxy（许多与会者举手表示正在使用，团队为用户准备了 T 恤）

00:45 - 02:15 - 提出核心观点：服务网格本应解决连接性问题，但对大多数组织来说只是将复杂性转移到了其他地方

02:15 - 03:45 - 分析现代基础设施的碎片化现状：多云、多区域、本地数据中心、遗留应用，而大多数服务网格在设计时未考虑这些棕地企业环境

03:45 - 05:30 - 讨论服务网格架构的两种主流模式：
- Sidecar 架构：每个 Pod 或实例一个 sidecar，随着规模扩大变得过于昂贵和复杂
- Sidecarless 架构：虽然更好，但复杂性转移到其他组件（每节点的 Layer 4 代理和每命名空间的 Layer 7 代理）
- 两种架构都无法有效防止资源蔓延，难以管理南北向流量，联邦或多云/区域设置支持不足

### 通用网格架构介绍 (05:30 - 10:00)

05:30 - 07:00 - 提出核心理念：问题不在于服务本身，而在于网络边界。应该在网络边界部署战略网关，而非管理分散的 sidecar 和代理部署

07:00 - 08:30 - 介绍 HAProxy 的"通用网格"架构：
- 外部边缘：TLS 终止、安全、集中日志、速率限制
- 内部边缘：东西向流量、速率限制、流量分割等
- HAProxy 是全向的，可以处理南北向和东西向流量

08:30 - 10:00 - 通用网格的三大支柱：
- 融合：ingress、mesh 和 proxy 合而为一，由单个 HAProxy 管理
- 联邦：开箱即用的多集群、多云、多区域支持
- 统一的安全性、连接性和可观测性

### 多云连接的重要性 (10:00 - 11:30)

10:00 - 11:30 - Jacob 补充说明多云连接问题的现实性，提到 AWS 当天宣布的新解决方案（与 GCP 合作的 multiconnect），在 Layer 3 层面提供单一 API 调用连接多个云平台，显示市场对多云连接的巨大需求

### 通用网格的核心优势 (11:30 - 15:00)

11:30 - 13:00 - 通用网格解决的"不可能问题"：
- 连接一切：单一模式简化运维复杂性和资源利用
- 多集群和联邦就绪：理解跨集群的基础设施资源
- 统一模式：在任何地方使用相同的模式
- 灵活部署：可在 Kubernetes 外部、内部、EC2、EKS、ECS 等任何地方运行网关

13:00 - 15:00 - 架构图解说明：
- 控制平面（Fusion）管理所有配置
- 数据平面（HAProxy）提供所有功能
- 可路由到任何服务：ECS、EC2 自动扩展组、Kubernetes、虚拟机、本地环境等
- 通过单一控制平面统一管理

### 性能基准测试 (15:00 - 25:00)

15:00 - 17:00 - 强调 HAProxy 是世界上最快的应用交付和安全平台，2021 年在单个 AWS Graviton 2 实例上实现每秒 200 万次请求

17:00 - 19:30 - 讲述 2023 年遇到的挑战：新 LTS 版本的 TLS 库性能大幅下降，与作者沟通未能解决

19:30 - 21:00 - 2024-2025 年的解决方案：
- 重构整个 TLS 栈以支持现代 TLS 库
- 选择 AWS-LC 作为默认 TLS 库
- 同时支持操作系统提供的其他现代库以保证兼容性

21:00 - 23:30 - HAProxy 3.3 的最新基准测试结果：
- 在 Graviton 4 实例上实现每秒 254 万次请求
- 尽管从 2021 年到 2025 年发布了 10 个版本，软件膨胀通常会抵消硬件优势
- 但 HAProxy 3.3 仍然超越了 2021 年的性能
- 已达到硬件限制（CPU 缓存通信、网络队列限制——即使最现代的 CPU 也只有 16 个网络队列）

23:30 - 25:00 - 性能优化的其他方面：
- 优化负载均衡算法（从轮询切换到随机）
- 改进队列和计数器调优
- 队列系统可实现应用服务器 100% 性能利用率
- 成本效益：每 10 亿次请求仅需 41 美分（C8GN 实例类型），可降至 20 美分左右

25:00 - 27:00 - Jacob 补充说明实例选择的重要性：
- 团队对 AWS 上所有实例进行了 HAProxy 基准测试
- HAProxy 是网络密集型应用
- C8G 实例会很快达到网络限制
- 建议使用 C8GN（网络优化）实例以避免 PPS 和带宽限制
- Graviton 实例是 HAProxy 的最佳选择

### 联邦功能 (27:00 - 32:00)

27:00 - 29:00 - 联邦的核心理念：对 HAProxy 而言，IP 就是 IP，只要可路由即可。控制平面可以独立配置每个代理实例

29:00 - 30:30 - 架构说明：控制平面可以向 US East 和 US West 发送不同配置，但由于控制平面了解所有区域，也可以将信息发送到所有代理，实现跨区域冗余和故障转移

30:30 - 32:00 - 实际应用案例：
- 支付提供商：需要跨三到四个区域/可用区的冗余，希望保持区域亲和性但在服务故障时允许跨区域切换，并可配置优先级
- 广告技术：与 AWS 合作的推荐解决方案
- 5G/移动提供商：在 AWS Wavelength 区域扩展覆盖，为远程区域的 5G Kubernetes 集群提供原生负载均衡

### 零信任与 TLS (32:00 - 35:00)

32:00 - 33:30 - 零信任是服务网格的关键点，HAProxy 和控制平面之间处理所有 TLS 和证书管理：证书更新、验证、后端服务器健康检查、客户端证书、CA 证书等

33:30 - 35:00 - 性能优化和现代化：
- 在 TLS 层面优化性能并持续监控
- 迁移到 AWS-LC 提供更多加密选项，包括量子加密（尽管尚未看到太多用例）
- 始终处于新技术前沿
- 刚发布了 Kernel TLS 和加密客户端 Hello (ECH) 的实验版本

### 身份验证与授权 (35:00 - 40:00)

35:00 - 37:00 - 身份验证和 SSO 模块工作流程：
- 企业版提供模块支持 OpenID、SAML、ADFS 代理协议
- 客户端向 HAProxy 提交请求，HAProxy 重定向或在后台与 IDP 通信，然后将信息传递给后端服务器

37:00 - 38:30 - JWT 原生支持：
- 原生支持 JSON 和 JWT
- 可查找算法、发行者、过期时间、作用域等信息
- 基于发现的信息构建访问控制列表
- HAProxy 3.3 新增 JWE（加密 JWT）令牌支持，可先解密再验证

38:30 - 40:00 - OPA（开放策略代理）支持：
- 对于更复杂的策略需求
- 可用 Rego 语言定义策略
- HAProxy 解析输入并根据策略决定是否允许
- 身份验证和授权非常灵活

### 多层安全防护 (40:00 - 55:00)

40:00 - 42:00 - Jacob 介绍多层安全的含义：
- 结合身份验证、授权
- 检测应用层 DDoS 攻击、网络爬虫、暴力破解、垃圾邮件、漏洞扫描、针对性攻击
- 网络爬虫是当前最重要的问题之一（AI 机器人爬取网站内容）

42:00 - 44:00 - 多层检测和决策的概念：
- 四个独立层次，但实际上同时工作
- 可选择哪一层先响应，或先完成所有检测再做决策
- 某些情况下可提前决策（如 IP 在拒绝列表中则立即拒绝，无需进行机器人检测和 WAF 过滤）

44:00 - 46:00 - 第一层：访问控制
- 拒绝或允许特定 IP 地址
- 允许内部 IP 地址、特定监控系统
- 拒绝特定指纹或来自机器人的 IP 地址
- HAProxy 支持数百万 IP 地址的大文件，查找时间恒定（得益于 Willy Tarreau 创建的弹性二叉树数据结构）

46:00 - 49:00 - 第二层：速率计算
- 不是拒绝，而是计算特定速率
- 基于 IP 地址、带宽、机器人标签、URL 等计算请求速率
- 静态限制很难设置，HAProxy 提供更好的方法
- 实践中每次设置速率限制都会出错（流量模式变化大）

49:00 - 51:30 - 全局分析引擎（动态速率限制）：
- 跨多个 HAProxy 实例聚合统计数据和速率
- 计算统计聚合
- 例如：对机器人进行速率限制，设为昨天同一小时 95 百分位的 1.5 倍
- 动态速率限制每小时、每秒或每 5 秒自动调整
- 无需设置静态速率限制

51:30 - 54:00 - 第三层：机器人检测
- 市场上有很多机器人和爬虫公司
- 需要识别请求是否来自机器人（不一定是坏事）
- 识别爬虫，特别是基于 AI 的爬虫
- 好公司会声明身份（如 OpenAI），坏公司会隐藏 AI 爬虫身份，伪装成标准浏览器

54:00 - 57:00 - 第四层：Web 应用防火墙 (WAF)
- WAF 的常见问题是延迟和吞吐量
- 启用开源 WAF 会导致延迟增加、吞吐量下降
- HAProxy 构建的 WAF 延迟几乎无法检测
- 客户反馈：启用 WAF 后首字节时间没有统计学差异

57:00 - 1:00:00 - 决策层：
- 完成所有检测后做出决策
- 可以拒绝、允许、tarpit（延迟响应）
- Tarpit 很受欢迎：不拒绝请求，而是延迟响应，让攻击者以为成功了但实际上被限制
- 大多数客户不会直接阻止，而是标记、观察，稍后做决策
- 或将流量发送到受限后端（正常用户使用高性能后端，可疑用户使用低性能后端）

1:00:00 - 1:02:30 - 其他响应选项：
- 显示验证码或挑战
- JavaScript 挑战：要求客户端计算两个质数，耗时 500 毫秒
- 不阻止请求，但增加攻击成本以减少流量
- 这是业务决策，不应由技术单方面决定

1:02:30 - 1:04:00 - 路由层：
- 作为反向代理和负载均衡器路由请求
- 用数据增强请求：GeoIP 数据、重写头部、设备信息等
- 标准路由：基于 SNI、Cookie、路径等
- 独特优势：可访问整个 HTTP 请求
- 可基于 AI 模型路由（如特定 AI 模型请求路由到不同后端）

1:04:00 - 1:06:00 - 边缘案例：LLM 和 AI 安全
- 基于令牌而非请求的速率限制（令牌昂贵）
- PII 检测：大型企业不希望向 AI 发送或输出 PII
- API 密钥保护（标准 API 网关功能）

### 实施示例 (1:06:00 - 1:12:00)

1:06:00 - 1:08:00 - Jacob 展示自己的实施示例（用户可自定义）：
- 决策顺序：拒绝、速率限制、挑战、沙箱、允许
- 拒绝列表中的机器人和 IP 地址
- 触发 WAF 超过 3 次的拒绝（人类可能触发一两次，但三次就是恶意行为）

1:08:00 - 1:10:00 - 动态速率限制策略：
- 允许人类达到 95 百分位的 3 倍
- 允许可疑客户端达到 2 倍
- 允许机器人达到 1.5 倍
- 人类有最大余地，机器人余地最小

1:10:00 - 1:12:00 - 需要结合声誉信号和行为分析：
- 随着 AI 和代理的发展，无头浏览器几乎无法检测
- 需要多种组合方式
- HAProxy 的工具允许执行这些复杂策略

### 配置管理与控制平面 (1:12:00 - 1:18:00)

1:12:00 - 1:14:00 - 统一控制平面方法：
- 集中所有策略到控制平面
- 部署到所有公有云、虚拟机、本地环境、Kubernetes 等
- 一次部署配置，应用到所有 HAProxy 实例

1:14:00 - 1:16:00 - 安全配置文件：
- 最初的安全配置有 200 行
- 抽象为安全配置文件
- 左侧添加所有信号（检测）
- 右侧做出所有决策（响应）
- 例如：左侧检测网络爬虫，右侧决定如何响应

1:16:00 - 1:18:00 - 大规模部署：
- 客户通常运行数百个负载均衡器实例
- 跨所有云、本地基础设施、所有区域、所有可用区
- 有时为避免跨流量而在每个可用区部署
- 安全配置文件可部署到所有实例
- 可检查流量将发生什么

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


会议总结：本次会议全面展示了 HAProxy 通用网格架构如何解决现代多云环境中的复杂性挑战，通过卓越的性能、灵活的联邦支持和多层安全防护，为企业提供了一个统一、高效、安全的应用交付平台。