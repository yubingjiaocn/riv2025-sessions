# AWS re:Invent 2025 - Fidelity Investments 企业级文本转SQL解决方案

## 会议概述

本次闪电演讲由AWS和Fidelity Investments团队联合呈现,重点介绍了如何在企业规模上实现文本转SQL(Text-to-SQL)解决方案。演讲者包括AWS的Vikram、Fidelity Investments AI卓越中心负责人Manish Wiker以及技术实施负责人Ray Xan。

Fidelity团队通过观察用户行为发现,数据访问的困难程度远超数据本身的复杂性。用户需要在多个应用程序(CRM、仪表板、Excel等)之间切换,并频繁寻求技术团队的帮助。传统的数据访问模式中,数据需要经过多层处理(数据准备、转换、UI展示)才能到达用户,导致数据变得固化和模板化,无法满足用户灵活多变的查询需求。为解决这一痛点,团队开发了自然语言转SQL的能力,让用户问题直接触达数据层,实现了数据访问的民主化,减少了对SQL专家的依赖,并使多种角色能够快速获得数据驱动的洞察。

技术实施基于三大智能支柱:AI就绪数据、语义层和动态工作流。团队采用了一致的命名规范、明确的关系定义、单一数据源和产品层次结构等原则来准备数据。通过语义文件自动生成工具、查询重写机制、上下文工程优化、示例学习和持续监控改进,系统在执行准确率上达到93-95%,结果相似度达到89-92%,平均响应时间为28秒。

## 详细时间线

00:00:00 - 开场介绍
- AWS Vikram欢迎参会者,介绍re:Invent 2025第四天的闪电演讲主题
- 介绍Fidelity Investments团队成员

00:00:30 - 团队介绍
- Manish Wiker介绍自己担任Fidelity Institutional业务单元AI卓越中心负责人
- Ray Xan介绍自己负责Text-to-SQL技术实施

00:01:00 - 问题发现阶段
- 采用以用户为中心的方法观察用户如何与数据交互
- 发现用户使用多个应用程序(CRM、仪表板、Excel)拼凑数据
- 用户经常需要致电同事或其他团队成员寻求帮助

00:02:00 - 核心问题识别
- 问题不在于数据本身,而在于数据访问
- 这是企业中普遍存在的痛点,不是孤立问题
- SQL虽然强大但需要技术依赖,而业务需要直观快速的数据访问

00:03:00 - 传统数据访问模式的挑战
- 展示数据从底层到用户的传递过程
- 数据经过多层(数据准备、转换、UI渠道)变得固化和模板化
- 用户问题却是灵活和智能的,形成矛盾

00:04:00 - 解决方案构想
- 提出将用户问题直接连接到数据的想法
- 引出自然语言转SQL查询能力的需求

00:04:30 - 方案价值
- 实现数据访问民主化
- 减少对SQL专家的依赖
- 赋能组织内多种角色
- 提升组织整体数据洞察能力
- 帮助业务快速获得数据驱动的决策支持

00:05:30 - 技术实施架构介绍
- Ray Xan开始介绍技术实施细节
- 基于三大智能支柱:AI就绪数据、语义层、动态工作流

00:06:00 - AI就绪数据原则
- 第一支柱:AI就绪数据是基础
- 结构化数据使其同时被人类和大语言模型理解
- 语义层将业务语言转换为数据库术语
- 动态工作流管理从自然语言输入到可执行查询的整个过程

00:07:00 - 数据准备四大原则
- 使用一致的命名规范
- 建立强关系基础(明确定义主键和外键)
- 单一数据源
- 使用产品层次结构

00:08:00 - 数据层次结构示例
- 以投资者-账户-持仓为例说明层次设计
- 当用户询问投资者总投资组合价值时,LLM可直接查询预聚合数据
- 避免生成复杂的聚合SQL

00:09:00 - 语义文件结构
- 展示投资管理示例:基金信息、投资者档案、投资者持仓三个表
- 每列包含多个属性:业务描述、示例值、同义词、关系定义
- 业务描述弥合语言差距
- 示例值让模型了解真实数据形态

00:10:30 - 语义文件自动生成
- 手动创建语义文件繁琐且易出错
- 构建工具自动生成语义文件
- 强调需要人工审核业务描述和同义词
- 这是一个迭代过程,可能需要回溯调整模式

00:11:30 - 查询重写机制
- 用户问题并非总是完美的
- 查询重写弥合模糊意图与精确查询之间的差距
- 判断问题是否清晰、是否有数据支持、需要哪部分数据

00:12:00 - 三种决策路径
- 接受、拒绝或澄清
- 示例:预测性问题(下季度基金表现)会被拒绝,因为只有历史数据
- 模糊问题(最佳基金)会要求澄清标准(按AUM还是资产类别)

00:13:00 - 上下文工程
- 上下文工程是AI准确性与猜测之间的关键差异
- 用户问题结合六个语义组件:系统提示、问题特定模式、教学示例、实体值、输出格式、使用的工具

00:14:00 - 上下文窗口管理挑战
- 企业数据库可能有数百张表、数千列
- 语义文件可能超过100K,无法全部注入上下文窗口
- 解决方案:发送精简格式给LLM,让其识别所需的表和列
- 过滤无关信息,使负载减少90%但保持100%相关性

00:15:30 - 示例学习机制
- LLM通过上下文学习中的教学示例学习
- 建立内存存储,保存已验证的SQL和问题-SQL配对
- 当新问题到来时,检索最相似的三个问题作为示例
- LLM根据示例生成符合最佳实践的SQL

00:16:30 - 持续学习循环
- 部署监控系统捕获用户与系统的所有交互
- 使用LLM判断评估查询,识别可疑内容
- 人工专家定期审查问题查询
- 发现错误后修正示例并插入存储
- 构建机构记忆,确保未来查询比过去更智能

00:17:30 - 实体搜索技术
- 用户倾向使用快捷方式和缩写
- 将维度列的所有值存储在向量存储中
- 执行语义匹配,仅将最匹配的结果插入上下文窗口

00:18:30 - SQL生成与验证
- 上下文准备完成后发送给LLM生成SQL
- 设置安全防护:仅允许SELECT语法,禁止DELETE、INSERT、UPDATE
- 提供16点指令指导LLM如何执行JOIN、创建WHERE子句等

00:19:00 - 语法检查与重试机制
- SQL返回后执行语法检查
- 如有语法错误,将错误消息和原始问题发回LLM重试
- 最多重试三次
- 仅验证通过且语法正确的SQL才会到达数据库

00:20:00 - 反直觉发现:示例数量与性能
- 最初使用超过100个示例,准确率不佳
- 发现许多示例并非必需,LLM无需它们也能生成正确SQL
- 将示例精简至30个,但每个都有存在理由(处理边缘情况或教授业务规则)
- 高信号指导、低噪音

00:21:00 - 测试套件建设
- 投入大量精力构建测试套件
- 提供质量门控
- 每次升级模型版本或添加新数据源时重复测试
- 确保无回归

00:22:00 - 性能指标
- 当前使用Anthropic Claude Sonnet 4模型
- 三个维度衡量性能:
  - 执行准确率:93-95%(比较目标SQL与生成SQL的行数)
  - 结果相似度:89-92%(使用LLM判断比较前500行)
  - 平均响应时间:28秒

00:23:00 - 性能演进
- 这些数字不是第一天就达到的
- 通过持续改进和确保模型持续学习实现
- 不断扩展知识库

00:24:00 - 经验教训总结
- 使用确定性工作流:可预测、可靠、第一天即可投产
- 清晰的模式:结构化且文档完善,防止解释错误
- 精准的教学示例:每个示例都有存在理由,质量重于数量
- 优化的上下文:发送足够但不多余的信息给LLM
- 核心理念:简单且工程化良好的系统优于复杂花哨的系统

00:25:00 - 结束与问答
- 感谢参会者的时间和关注
- 团队将在现场接受提问