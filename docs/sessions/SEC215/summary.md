# AWS re:Invent 2025 技术会议总结

## 会议概述

本次会议由 AWS 首席产品经理 Mark Klene 和 PayPal POS 的 Philip Buddy 共同主讲，主题是 PayPal POS 如何摆脱传统硬件安全模块（HSM）并完全迁移到云端进行支付处理的实践经验。会议重点介绍了 AWS Payment Cryptography 服务，这是一个基于云的解决方案，用于安全处理卡交易，可替代客户传统上在数据中心部署的物理 HSM。

PayPal POS（原 Zettle）是一家成立于 2010 年的瑞典初创公司，主要为小型商户提供移动支付终端服务。在迁移之前，他们在欧洲、北美和墨西哥的三个数据中心运营着复杂的 HSM 基础设施。作为一个精简的团队，他们面临着沉重的基础设施维护负担、高昂的合规审计成本以及扩展到新区域的巨大开支。通过采用 AWS Payment Cryptography，PayPal POS 成功实现了 99.9% 的交易流量迁移到云端，大幅降低了运营复杂度，消除了区域扩展的硬件成本，并将团队重心从基础设施管理转向产品开发。

整个迁移过程采用了谨慎的影子测试（shadowing）策略，在不影响客户交易的前提下验证了新服务的正确性和性能。在一次意外的数据中心故障中，团队能够迅速切换到 AWS Payment Cryptography，实现了零客户影响，充分证明了云服务的可靠性和灵活性。

## 详细时间线

### 00:00 - 会议开场与服务介绍
- Mark Klene 自我介绍，担任 AWS Payment Cryptography 首席产品经理
- 介绍 Philip Buddy 来自 PayPal POS
- 会议主题：PayPal POS 摆脱 HSM 并迁移到云端的经验

### 01:30 - AWS Payment Cryptography 服务概述
- 云基础的安全支付处理解决方案，替代物理 HSM
- 支持卡发行、交易收单、发卡方交易处理等用例
- 提供 PIN 数据转换、P2PE 数据解密、密钥管理、CVV2 生成、ARQC 验证等功能
- 基于 RESTful API 的弹性服务，无需预配置硬件
- 集成 AWS IAM、CloudWatch 和 CloudTrail

### 03:45 - 服务核心优势
- 消除对专用支付 HSM 的依赖，迁移关键支付工作负载
- 通过完全托管服务减少运营负担，符合 PCI PIN、P2PE、3DS、DSS 标准
- 高吞吐量和低延迟，自动弹性扩展
- 简化设置，无需购买硬件，几分钟内即可开始使用

### 05:00 - PayPal POS 公司背景
- 2010 年在瑞典成立，原名 Zettle
- 主要产品：可连接手机的移动支付终端
- 典型客户：冰淇淋店、海滩商店等季节性小型商户
- 业务覆盖欧洲、北美和墨西哥

### 06:15 - 原有基础设施架构
- 在三个地理位置运营数据中心
- 每个数据中心采用完全冗余设置：双交换机、双光纤线路、双 HSM
- 理论上可承受单个 HSM 和单个交换机故障而不影响服务
- 支持跨区域故障转移

### 07:30 - 团队结构与职责范围
- 精简团队但拥有高度垂直所有权
- 负责支付网关、收单服务、加密服务（HSM 接口）
- 同时负责数据中心和基础设施管理

### 08:15 - 寻求新解决方案的原因
- 团队人员流失严重，面临人力短缺
- 作为产品团队却花费大量时间在基础设施和合规上
- 扩展到新区域成本高昂（需要建立新数据中心）

### 09:30 - 方案选型
- 考虑过外部公司托管 HSM
- AWS Payment Cryptography 完美契合需求
- 公司已全面采用托管基础设施（ECS Fargate、弹性负载均衡器等）
- 零工作量即可启动，直接发送请求

### 10:45 - 迁移计划第一步：审计批准
- 必须获得审计批准才能开始实际工作
- 因为使用 PCI P2PE 标准（用于卡终端）
- 需要对当前环境进行增量审计
- 作为新服务，需要在 PayPal 内部和审计机构中进行学习和批准

### 12:00 - 迁移计划第二步：影子测试（Shadowing）
- 将流量镜像到两套系统进行对比测试
- 在切换前验证 Payment Cryptography 的性能表现

### 12:45 - 迁移计划第三步：渐进式推出
- 由于存在大量外部依赖关系，采用逐步推出策略
- 需要与终端和收单方交换新密钥
- 需要确认收单方支持加密方法的变更
- 分阶段逐步迁移

### 13:30 - 迁移计划第四步：最终推广
- 目标是从交易流程中完全移除 HSM
- 不再需要考虑审计和季度配置检查

### 14:15 - 影子测试技术实现
- 请求进入支付网关后分别发送到 HSM 和 Payment Cryptography
- 最初计划保留加密服务作为抽象层
- 发现可以完全移除中间服务，因为 AWS API 调用与 S3 或 DynamoDB 无异
- 将加密工作直接集成到支付网关服务中

### 15:45 - 影子测试策略细节
- 始终使用 HSM 的响应作为实际响应
- 异步发送请求到 Payment Cryptography 并记录响应
- 由于加密操作是幂等的，可以比较二进制响应
- 使用生产流量测量正确性和响应时间

### 16:30 - 监控指标与仪表板
- 每次请求都发送指标数据
- 每天早上查看仪表板
- 监控结果差异率（result discrepancy）
- 发现小 bug 后与 AWS 密切合作快速修复
- 在不影响实际交易的情况下获得完全信心

### 18:00 - 延迟性能观察
- 初期 Payment Cryptography 延迟呈现峰值波动
- 夜间低流量时延迟增加，可能是冷启动原因
- 六个月后（从 3 月开始），随着请求量增加，延迟显著降低
- 性能和稳定性持续改善

### 19:15 - 跳过操作（Skipped Operations）
- 无法一次性全部推出，采用渐进策略
- 某些操作被 HSM 支持但 Payment Cryptography 设置尚不支持
- 由于密钥交换或其他原因需要跳过部分操作
- 在不等待所有功能就绪的情况下尽可能多地获取数据

### 20:30 - 意外的生产切换事件
- 原计划影子测试 3-6 个月（受数据中心合同限制）
- 在伦敦数据中心进行例行补丁更新时发生故障
- 一个交换机故障导致另一个交换机也宕机
- 流量转移到另一个数据中心

### 21:45 - 紧急切换到云端
- 斯德哥尔摩办公室团队和现场团队同时响应
- 决定直接将所有流量切换到 AWS Payment Cryptography
- 一夜之间完成从 HSM 到云端的完全切换
- 实现零客户影响，避免了一次事故

### 23:00 - 可靠性的重要性
- 对小型企业客户而言，可靠性至关重要
- 一天的停机可能导致商户无法生存（如圣诞市场销售）
- 不丢失交易是最高优先级
- 即使有冗余，减少冗余仍会带来风险

### 24:30 - 迁移过程中的挑战
- 虽然是加密技术，但本质上是标准的本地到云迁移
- 需要触及所有旧流程和代码库的各个部分
- 作为新 AWS 服务存在磨合问题
- 但获得了与 AWS 的密切合作关系
- 需要在 PayPal 内部推广新服务的可信度

### 26:00 - 当前状态与长尾流程
- 99.9% 的流量不再通过 HSM
- 仍保留一个 HSM 用于安全和处理传入密钥组件
- 正在通过改进流程和 AWS 新功能来消除剩余依赖
- 不再需要亲自管理 HSM 是巨大的解脱

### 27:15 - 收益一：PCI 合规性
- 大量时间用于 PCI 合规性思考
- 每年 DSS 审计、每两年 P2PE 审计、每三年 PIN 审计
- 保持合规是不可协商的要求
- PayPal 内部最初不相信云端加密服务能够符合 PCI 标准

### 28:30 - 收益二：现代化接口
- 从 HSM 的老式二进制协议接口转向 JSON API
- 不再围绕 HSM 能力设计功能
- 可以直接使用 translate_pin 等通用 API
- 功能设计不再受限于硬件约束

### 29:45 - 收益三：增强的韧性
- 不再需要管理数据中心的交换机
- 服务标准与其他 AWS 服务一致
- 减轻了心理负担

### 30:30 - 收益四：新区域扩展
- 原本扩展到新区域需要数万美元（机架租赁、光纤线路、硬件购买、许可证）
- 现在 Payment Cryptography 是唯一不增加成本的部分
- 按请求付费模式，只是将流量从一个区域转移到另一个区域
- 新区域扩展实际上是免费的
- 团队从阻碍者变成推动者

### 32:00 - 收益五：开发者所有权
- 最大且最意外的收益
- 以前加密工作由专人负责，其他开发者不敢触碰
- 现在就像调用 S3 或 DynamoDB API 一样简单
- 开发者直接接触和修改加密代码
- 考虑性能和连接池等熟悉的问题
- 不再是神秘的未知领域

### 33:30 - 收益六：产品聚焦
- 团队从基础设施聚焦转向产品聚焦
- 不再需要飞往全球各地进行数据中心补丁维护
- 工作性质在两年内发生根本转变

### 34:30 - 收益七：减少审计范围
- 每次现场审计都需要检查所有 HSM 配置
- 需要签署启用的命令清单
- 现在审计责任几乎完全转移到 AWS
- 团队只是服务的使用者

### 35:30 - 会议总结
- Mark Klene 感谢 Philip 分享 PayPal 的经验
- 成功摆脱对物理数据中心的最后依赖之一
- 全程保持 PCI PIN 和 P2PE 合规性
- 新区域扩展零成本
- 服务已覆盖 12 个区域，未来还会更多

### 36:45 - 基础设施简化成果
- 删除了数百行代码
- 移除了中间件层
- 开发者可以直接使用 RESTful API

### 37:30 - 合作伙伴关系与性能改进
- PayPal 已上线使用服务超过一年
- 性能和稳定性持续提升
- 感谢 Philip 分享 PayPal 的故事
- 会后可进行进一步交流和提问

### 38:00 - 会议结束