# AWS re:Invent 2025 - AWS Lambda Durable Functions 会话总结

## 会话概述

本次会话由 AWS 首席开发者倡导者 Eric Johnson 和无服务器组织产品经理 Michael 共同主持,重点介绍了 AWS Lambda 的重大新功能 - Durable Functions(持久函数)。这是一项革命性的功能,允许开发者像编写单体应用一样编写业务逻辑,同时享受微服务架构的所有优势。

Durable Functions 通过检查点(checkpoint)和重放(replay)机制实现了持久执行能力,使 Lambda 函数能够暂停执行、等待长时间运行的操作(如人工审批)、自动重试失败的步骤,并在故障后从上次成功的检查点恢复。最重要的是,这些都是常规的 Lambda 函数,开发者可以使用熟悉的编程语言(JavaScript、Python、TypeScript 等)和工具进行本地测试和调试。

演示环节展示了一个基于 Serverless Espresso 的实际应用案例,演示了如何使用 Durable Functions 处理订单流程,包括订单验证、库存预留、等待支付确认等步骤,以及如何在本地进行测试和调试。这项功能极大地简化了复杂业务逻辑的编排,减少了开发者需要编写的样板代码。

## 详细时间线

00:00:00 - 开场与规则说明
- Eric Johnson 自我介绍,说明自己是 AWS 首席开发者倡导者,专注于无服务器技术
- 介绍演讲规则:手势含义、引号使用、以及关于自己使用助听器的说明
- 强调这是他最喜欢的公告之一

00:02:30 - 无服务器架构演进历史
- 回顾从单体架构到微服务的演进过程
- 单体架构的优点:所有代码在一处,开发简单
- 单体架构的缺点:紧耦合,扩展困难
- 微服务架构的优点:解耦,独立扩展
- 微服务架构的挑战:协调复杂性、级联故障、认知负担

00:04:00 - AWS 无服务器服务发展历程
- 2014年:AWS Lambda 推出,首次引入无服务器计算概念
- Lambda 特点:无状态、短生命周期
- 2016年:AWS Step Functions 推出,提供无基础设施的编排能力
- 2019年:Amazon EventBridge 推出,实现事件驱动架构
- 开发者的核心需求:应用逻辑编排

00:06:00 - 开发者的理想状态
- 开发者希望像构建单体应用一样编写代码
- 但希望部署为微服务架构
- 需要在单一界面上工作,但使用解耦架构
- 避免认知过载

00:07:00 - AWS Lambda Durable Functions 正式发布
- Michael 介绍 Durable Functions 的核心能力
- 可以构建最复杂的应用,如订单处理、支付系统、用户入职流程
- 使用熟悉的编程语言和工具(包括 LLM 代理)
- 支持本地构建、测试、调试
- 可以暂停函数执行,等待长时间运行的操作(如人工审批)
- 完全托管,无需管理服务器

00:08:30 - 感谢贡献者
- Michael 感谢 AWS 客户、合作伙伴、英雄和同事对此次发布的贡献

00:09:00 - Durable Functions 的核心概念
- Durable Functions 是常规的 Lambda 函数,不是新资源
- 现有的流程、事件集成、工具都可以继续使用
- 具有"超能力":检查点和重放机制

00:10:00 - 检查点(Checkpoint)功能
- 允许在事件处理器中保存进度
- 类似于在执行过程中按"保存"按钮
- 用途1:故障恢复 - 知道从哪里恢复
- 用途2:暂停执行 - 等待外部事件

00:11:00 - 重放(Replay)功能
- 从头到尾重新运行事件处理器
- 跳过已完成的检查点
- 不会重做已完成的工作或副作用

00:12:00 - 开源 SDK 介绍
- 提供新的开源 SDK
- 将底层原语(检查点、重放)抽象为高级操作
- 包括 steps(步骤)和 waits(等待)等操作
- 这个概念称为"持久执行"(Durable Execution)

00:13:00 - 如何开始使用
- 在控制台中创建 Lambda 函数时,只需启用一个开关
- 通过 API 配置(支持 CloudFormation、CDK 等 IaC 工具)
- 两个新属性:执行超时(最长1年)和保留期(可选)

00:15:00 - 代码实现示例
- 导入 Durable Execution SDK
- 使用 withDurableExecution 包装器包装事件处理器
- 获取 durableContext 访问超能力
- 使用 context.step 创建检查点
- 使用 context.wait 暂停执行

00:17:00 - 订单处理示例演示
- 四步订单处理流程:验证、预留库存、支付、完成
- 每个步骤都用 context.step 包装
- 演示检查点如何工作

00:18:00 - 进度检查功能
- 第一步:验证阶段执行并创建检查点
- 自动跟踪进度

00:19:00 - 自动重试机制
- 第二步:库存预留失败
- 自动重试、退避和抖动
- 减少样板代码

00:20:00 - 幂等性和去重
- 内置幂等性和去重逻辑
- 如果函数崩溃,上游重试不会创建新的执行
- 确保只有一个执行在运行

00:21:00 - 重放机制详解
- 系统尝试从中断中恢复
- 使用相同的函数版本进行重放
- 生命周期固定到特定版本
- 跳过已完成的检查点
- 对于昂贵、延迟敏感或有副作用的步骤特别有用

00:23:00 - 等待(Wait)功能
- 支付步骤使用 wait 能力
- 等待外部事件(如用户点击按钮或刷卡)
- Wait 也是检查点
- 到达 wait 点时函数优雅终止

00:24:00 - 唤醒机制
- 基于计时器的唤醒:context.wait(5秒)
- 回调机制:发送回调 ID 给下游服务
- 条件轮询:定期调用外部 API,间隔期间休眠

00:25:00 - 取消功能
- 支持取消等待
- 可以配置超时自动取消
- 取消后触发重放,执行补偿逻辑

00:26:00 - Saga 模式支持
- 补偿工作或撤销操作
- 在分布式架构中实现 Saga 模式变得简单
- 使用 try-catch 和步骤实现
- 撤销操作也获得相同的可靠性保证

00:27:00 - 本地测试和可观测性
- Michael 提到本地测试和可观测性功能
- 过渡到 Eric 的演示环节

00:28:00 - 演示准备
- Eric 提醒观众他的编码能力有限
- 将进行实时编码演示
- 介绍 Serverless Espresso 应用

00:29:00 - Serverless Espresso 应用介绍
- 基于 Step Functions 的知名应用
- Eric 将其改造为使用 Durable Functions
- Durable Function 是应用的核心

00:30:00 - 架构概览
- 事件驱动架构
- Durable Function 处理暂停、重启、并行执行、子上下文等

00:31:00 - 订单处理步骤
- 订单下单
- 初始化订单
- 验证订单(并行执行)
- 等待咖啡师接受

00:32:00 - 初始化订单代码
- 使用 context.step 包装
- 步骤名称用于控制台显示
- 访问 step context
- 与 DynamoDB 交互的代码
- 日志记录

00:33:00 - 重试策略配置
- 设置重试策略
- 可以为不同步骤设置不同策略
- 配置重试次数和抖动
- 比手写重试逻辑更简单

00:34:00 - 验证订单并行执行
- 使用子上下文(child context)
- 并行执行多个任务
- 获取事件配置(商店是否开放、容量、菜单)
- 检查参会者订单数量(限制每天1-2杯)

00:35:00 - 并发控制
- 设置最大并发数
- 保护下游服务
- 控制同时运行的任务数量

00:36:00 - 等待咖啡师接受
- 使用 waitForCallback
- 获取回调 ID
- 暂停 Lambda 函数
- 等待 API 调用完成回调

00:37:00 - 超时和取消处理
- 设置2分钟超时
- 捕获超时异常
- 处理咖啡师未及时接受或用户取消的情况
- 实现补偿逻辑(Saga 模式)

00:38:00 - 回调 API
- Lambda 新增回调 API
- 可以完成或失败回调

00:39:00 - SAM 模板配置
- 展示 SAM 模板
- 第676行:durable config 配置
- 添加权限声明

00:40:00 - IAM 权限
- 两个新权限:checkpoint:DurableExecution 和 get:DurableExecutionState
- SAM 会自动添加这些权限
- 权限范围限定到特定函数

00:41:00 - 本地调用演示
- 使用 sam local invoke 命令
- 本地运行 Durable Function
- 可以同步或异步运行

00:42:00 - 回调交互
- 函数到达回调点
- 返回回调 ID
- 演示发送回调成功响应
- 实时显示订单被接受

00:43:00 - 获取执行状态
- 使用 sam local 获取执行结果
- 查看完整历史记录
- 表格格式显示所有步骤

00:44:00 - JSON 格式输出
- 添加 --format json 参数
- 获取详细的 JSON 格式历史
- 所有数据存储在本地容器中
- 用于调试

00:45:00 - 本地单元测试
- 进入 Lambda 函数目录
- 运行 npm test
- 使用 SDK 提供的测试运行器
- 支持各种断言
- 通过模拟进行测试,无需连接 AWS 云

00:46:00 - SDK vs CDK 澄清
- Michael 纠正:测试功能在 SDK 中,不是 CDK
- SDK 提供测试工具包
- 支持单元测试和模拟

00:47:00 - 测试策略
- 使用 SDK 进行单元测试(模拟)
- 使用 SAM 进行本地集成测试(连接云服务)
- 最后部署到生产环境

00:48:00 - 实时订单演示
- 展示 QR 码让观众扫描
- 观众开始下订单
- 订单实时显示在屏幕上

00:49:00 - 大量订单涌入
- 订单数量激增
- Eric 开玩笑要警告咖啡师
- 关闭 QR 码以保护咖啡师

00:50:00 - Lambda 控制台查看
- 进入 Lambda 函数控制台
- 展示新的"Durable Executions"标签
- 标签上有"new"标识

00:51:00 - 查看运行中的执行
- 显示大量正在运行的 Durable Executions
- 每个执行都有独立的状态
- 可以查看输入和输出

00:52:00 - 查看已取消的订单
- 找到一个被用户取消的订单
- 查看输入和输出详情
- 显示取消原因

00:53:00 - 版本管理
- 显示当前在版本99
- 表明已经进行了大量测试
- 进入一个正在等待的执行

00:54:00 - 等待回调状态
- 展示函数正在等待咖啡师接受的状态
- 演示结束

会话展示了 AWS Lambda Durable Functions 如何简化复杂业务逻辑的开发,提供了强大的本地测试能力和可观测性,同时保持了 Lambda 的简单性和无服务器的优势。