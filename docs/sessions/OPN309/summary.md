# AWS re:Invent 2025 会议总结：Disagree and Commit - Elasticache 的开源之旅

## 会议概述

本次会议由 Amazon Elasticache 团队的首席工程师 Malin Olsen 和 AWS 评论家 Corey Quinn 共同主讲,主题为"Disagree and Commit"。会议讲述了 Amazon Elasticache 服务如何通过积极贡献开源社区,最终实现了服务优化并降低了客户成本的故事。

会议的核心内容围绕 Elasticache 团队从最初维护私有 Redis 分支的困境,到积极拥抱开源贡献,再到 Redis 许可证变更后果断支持 Valkey 开源项目的完整历程。这个故事展示了 AWS 如何通过开源协作不仅改善了自身服务,也为整个社区带来了价值。演讲者强调,Elasticache 实际上直接运行开源引擎(如 Redis、Memcached),只在其周围添加了约 100 行管理代码,这使得开源社区的健康发展对 AWS 服务至关重要。

最重要的是,通过向开源社区贡献代码而非维护私有分支,Elasticache 团队减少了工程负担,提高了服务性能,并最终能够为客户降低价格——这正是会议标题所暗示的"因为开源贡献如此有价值,我们决定降低定价"的核心主题。

## 详细时间线与关键要点

### 开场介绍 (0:00-2:30)
- **演讲者介绍**: Malin Olsen(Amazon Elasticache 首席工程师)和 Corey Quinn(AWS 评论家)
- **会议主题**: 讲述 AWS 服务如何通过开源贡献获益,最终降低客户成本
- **Corey 自我定位**: 幽默地称自己为"暴力破解+热情"的程序员,自 2011 年起使用 Valkey 和 Redis

### Elasticache 架构基础 (2:30-5:00)
- **服务架构**: Elasticache 为客户 VPC 提供托管缓存服务
- **核心组件**: 创建专用 VPC、EC2 实例(缓存节点)、管理进程、缓存引擎
- **开源引擎**: 直接使用开源 Memcached 和 Redis,仅有约 100 行代码差异
- **重要发现**: Elasticache 实际运行的是开源二进制文件,而非完全重写的专有实现

### TLS 加密支持的挑战 (5:00-10:00)
- **2018 年客户需求**: 客户要求 TLS 加密支持以满足合规要求
- **初始方案**: 使用 TLS 代理,但性能损失严重
- **性能对比**: 原生 Redis 可达 130,000 请求/秒,使用 TLS 代理后降至 80,000 请求/秒
- **解决方案**: 将 TLS 直接嵌入 Redis,显著提升性能和资源利用率
- **维护困境**: 从 Redis 3 到 Redis 6,每次版本升级都需要解决合并冲突

### 私有分支的恶性循环 (10:00-13:00)
- **功能开发**: 2018-2020 年间开发了多个功能(集群、槽位迁移、密码轮换、跨区域复制等)
- **恶性循环**: 工程师时间都花在处理合并冲突上,没有时间向上游贡献代码
- **审批流程**: 早期贡献开源需要与 IP 律师、总经理和业务律师沟通
- **核心问题**: 内部功能越多,合并冲突越多,越没时间上游贡献,形成恶性循环

### 开源贡献的转变 (13:00-17:00)
- **密码空格 Bug**: 发现 Redis 密码中包含空格会导致复制失败
- **贡献过程**: 提交 PR 后,维护者 Salvatore Sanfilippo 建议使用更健壮的 RESP2 协议
- **成功案例**: 通过社区协作获得了比原始方案更好的解决方案
- **TLS 上游贡献**: 投入 50% 时间贡献 TLS 功能到 Redis 开源项目
- **代码质量**: 初期代码充满 if-else 判断,经过社区反馈改进为连接抽象层

### TLS 贡献的最终结果 (17:00-19:00)
- **协作成果**: 虽然最终被接受的代码由 Redis Labs 贡献,但 AWS 的努力推动了社区协作
- **开源理念**: 强调开源是协作而非单方面代码倾倒
- **AWS 贡献策略**: 只维护与托管服务相关的内部代码,其他功能(Bug 修复、性能优化)全部贡献上游

### Serverless 功能与槽位统计 (19:00-24:00)
- **2023 年 Serverless 发布**: Elasticache 推出 Serverless 功能
- **技术挑战**: 需要动态扩展以处理峰值负载(如外卖高峰期)
- **解决方案**: 开发集群槽位统计功能,跟踪每个槽位的吞吐量和网络流量
- **提前贡献**: 在 2023 年 re:Invent 发布前一年(2022 年)就提交了 PR
- **社区参与**: 获得 GCP 等其他云提供商的积极参与,PR 有 111 条评论

### Redis 许可证变更危机 (24:00-28:00)
- **PR 被拒**: 槽位统计 PR 在数月后被 Redis Limited 拒绝,未给出明确承诺
- **2024 年 3 月**: Redis 将许可证从 BSD 改为 SSPL 和 RSAv2(限制性许可证)
- **许可证影响**: 新许可证要求托管服务提供商开源全部基础设施或支付许可费
- **OSI 立场**: 开源促进会(OSI)不承认 SSPL 为开源许可证
- **社区反应**: 此举激怒了整个社区,但未能成功"勒索"AWS

### Valkey 开源项目诞生 (28:00-32:00)
- **快速响应**: 数周内社区 fork 了 Redis 7.2.4(最后的 BSD 版本)
- **项目命名**: 新项目命名为 Valkey,保持 BSD 许可证
- **核心支持者**: 原 Redis 维护者加入,AWS、Google、Oracle 等大公司支持
- **Linux 基金会**: 提供中立治理,确保不会再次发生许可证变更
- **2025 年 5 月**: Redis 试图改回 AGPL 许可证,但为时已晚,社区已转向 Valkey

### Valkey 项目治理 (32:00-35:00)
- **非 AWS 控制**: Valkey 不是 AWS 的 fork,而是 Linux 基金会项目
- **技术指导委员会**: 6 名成员来自不同公司(AWS、Ericsson、Huawei、Tencent、GCP)
- **社区规模**: 超过 50 个组织支持,包括 Percona、Snap、Verizon、Oracle
- **项目成果**: 150+ 独特代码贡献者,数千次提交,数千万容器拉取
- **Elasticache 支持**: Amazon Elasticache for Valkey 基于开源 Valkey 构建

### 性能创新与优化 (35:00-结束)
- **多线程改进**: 从 2018 年开始研究水平和垂直吞吐量提升
- **热键问题**: 解决缓存中不均匀负载和热键处理问题
- **性能数据承诺**: 演讲者强调所有性能数据都是真实可验证的,可在 valkey.io 博客查看详细测试方法
- **持续创新**: 强调数据库和缓存服务需要持续创新,不能停滞不前

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


核心要点总结:
- Elasticache 直接运行开源引擎,开源健康对 AWS 至关重要
- 维护私有分支成本高昂,贡献开源是双赢策略
- Redis 许可证变更促使社区创建 Valkey 开源项目
- 通过开源协作,AWS 改善了服务并最终降低了客户成本