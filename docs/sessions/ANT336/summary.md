# AWS re:Invent 2025 - 企业级 Apache Spark ETL 优化会议总结

## 一、会议概述

本次会议由 AWS 的 Vivek(首席交付架构师)和 Gioani(AWS Spark 团队负责人)主讲,重点介绍了在 AWS Glue、Amazon EMR 和 Amazon Athena 上运行的 Apache Spark 的企业级 ETL 优化方案。会议从一个实际案例引入:一个团队的 Spark 作业运行缓慢,虽然添加了许多优化参数,但由于配置了 S3A 参数却使用了 EMRFS 连接器,导致性能问题。这个常见的混淆场景正是本次会议要解决的核心问题之一。

会议围绕三大支柱展开:安全性(Security)、统一性(Unification)和性能(Performance)。演讲者指出,当前企业客户在 ETL 管道中面临的主要挑战包括:数据处理速度慢、Spark 配置复杂、跨服务行为不一致、以及安全治理分散等问题。例如,一家大型金融科技公司的数据平台团队将近四分之一的工程时间用于调整 500 个生产作业的 Spark 配置,而一家大型旅游公司约 40% 的作业失败是由于 Spark 配置错误导致的。

AWS 通过最新发布的技术改进彻底重新设计了 Spark 体验:实现了跨 EMR、Glue 和 Athena 的统一 Spark 运行时(Spark 3.5.6、Iceberg 1.10、Hoodie 1.02),将 S3A 设为默认存储连接器,原生集成 Lake Formation 实现细粒度访问控制,并通过多项性能优化(包括 Iceberg 读写提速 4.5 倍、JSON 处理提速 20%、字符串操作提速高达 96 倍等)显著提升了 ETL 管道的执行效率。所有这些改进无需代码更改即可使用。

## 二、详细时间线与关键要点

### 开场与问题陈述 (0:00-5:30)
- **0:00** - 演讲者分享真实案例:团队的慢速 Spark 作业问题,根本原因是配置了 S3A 参数但实际使用 EMRFS 连接器
- **1:15** - 介绍演讲者:Vivek(首席交付架构师)和 Gioani(AWS Spark 团队负责人)
- **1:45** - 会议议程:痛点分析、AWS 和 Spark 的解决方案(安全性、统一性、性能)、实际用例、可操作资源
- **2:30** - 强调业务速度要求:数据需要在秒级而非天级处理,但 ETL 系统仍然缓慢
- **3:15** - 真实客户反馈:金融科技公司将 25% 工程时间用于调整 500 个生产作业的 Spark 配置
- **3:45** - 旅游公司案例:40% 的作业失败源于 Spark 配置错误

### AWS ETL 生态系统概览 (5:30-8:00)
- **5:30** - AWS ETL 架构介绍:S3(数据湖)→ Glue Data Catalog(元数据管理)→ Lake Formation(安全治理)→ 分析引擎(Athena、Glue、EMR)
- **6:45** - 当前挑战:安全性(手动执行行列级规则)、性能(元数据瓶颈、冗余扫描)、一致性(跨服务行为不同)
- **7:30** - 提出愿景:如果 Spark 作业更智能、治理内置、跨服务使用同一引擎会怎样?

### 第一支柱:安全性 (8:00-18:30)
- **8:00** - 三大支柱介绍:安全性、统一性、性能
- **8:45** - 安全性特性:细粒度访问控制、Lake Formation 原生集成、支持调用者权限的多选视图
- **10:00** - 常见安全挑战:权限用户访问受限、分析师反复申请权限、数据管理员跨服务管理策略
- **10:45** - Lake Formation 与 Spark 集成历史回顾:
  - 2022 年:通过 Record Server 中间层,使用 FTAC(全表访问控制)
  - 2023 年:引入 FGAC(细粒度访问控制),支持行/列/单元格级过滤
  - 2024 年:执行层移入 Spark 内部,无需代理
  - 2025 年:完全原生,Spark 直接读写和管理 Lake Formation 治理下的表
- **12:30** - FTAC vs FGAC 对比:FTAC 提供完整可见性和直接 IO,适合 ETL 管道;FGAC 提供行列级隔离,适合多用户分析
- **14:00** - 跨引擎 SQL 逻辑挑战:团队需要为 Athena 和 Spark 分别重写相同的业务逻辑
- **15:15** - Glue Data Catalog 视图解决方案:统一治理、跨引擎一致性、加速协作
- **16:30** - 创建视图语法演示:使用 CREATE PROTECTED MULTI-DIALECT VIEW 和 SECURITY DEFINER
- **17:45** - 视图的业务价值:定向数据共享、多服务分析、集中合规性

### 第二支柱:统一性 (18:30-28:00)
- **18:30** - Gioani 接手演讲,介绍统一性支柱
- **19:00** - 统一性挑战:跨 EMR、Glue、Athena 的多个版本和库版本导致配置不一致、功能差异、需要重写作业
- **20:15** - 重大发布:EMR 7.12、Glue 5.1、Athena 统一使用 Spark 3.5.6、Iceberg 1.10、Hoodie 1.02
- **21:00** - 统一体验:无需重写查询、性能一致、功能一致,唯一决策是选择运行平台
- **22:00** - 从 EMRFS 到 S3A 的转变:
  - 历史背景:EMR 早期发布 EMRFS,后来开源社区创建 S3A
  - 客户挑战:从本地迁移时配置不匹配
  - **EMR 7.10 起 S3A 成为默认存储层**
- **23:30** - S3A 优势:开源对齐、标准化配置(fs.s3a 命名空间)、统一认证、优化的提交器
- **24:45** - S3A 新功能:支持所有 S3 存储类(标准、Express One Zone、Outposts、**Glacier**)
- **25:30** - Glacier 访问用例:合规审计、无需数据移动,只需恢复对象并配置 read.restore.object 参数
- **27:00** - 性能对比:S3A 比 EMRFS 和开源 S3A 更快且更具成本效益

### 第三支柱:性能 (28:00-42:00)
- **28:00** - 性能重要性:客户需要在 SLA 内完成作业(每小时刷新仪表板、上午 9 点前生成报告等)
- **28:45** - S3A 写入性能:动态写入快 15.8 倍,比 EMRFS 快 3 倍;静态插入比 EMRFS 快 10%
- **30:00** - 物化视图介绍:作为缓存机制,减少提取、转换、加载各阶段的开销
- **31:15** - 重大发布:AWS Spark 物化视图(昨晚发布)
  - 集成所有 AWS 服务(EMR、Glue、Athena)
  - AWS 完全托管,自动刷新
  - Spark 自动查询重写,性能提升高达 8 倍
  - 基于 Apache Iceberg 格式
  - SQL 语法:CREATE MATERIALIZED VIEW AS SELECT
- **33:00** - 手动刷新语法:REFRESH MATERIALIZED VIEW
- **34:00** - ETL 管道中的四种常见模式:Iceberg、JSON、加密、字符串操作
- **34:30** - Iceberg 性能:
  - 读取比开源快 4.5 倍(EMR 7.12)
  - 写入操作(merge、update、delete、insert)比开源快 2 倍以上
- **36:00** - JSON 性能:JSON 读取器比上一版本快 20%,无需应用更改
- **37:15** - 加密性能:
  - 加密开销从 32% 降至 6%,减少 85%
  - 整体基准测试快 20%
  - 改进了加密本身和 shuffle 性能
- **38:45** - 字符串操作性能(1-100 字符):
  - Upper/Lower case:提速 10-12 倍
  - Trim:提速 3-4.5 倍
  - Concat/Substring 等:提速 10-80%
  - Length:提速 96 倍(每字符 1 倍,线性增长)
  - Reverse:提速 56 倍
- **40:30** - 字符串操作用例:文本清理、电话号码解析、ID 标准化、数据脱敏、名称标准化

### 总结与资源 (42:00-43:30)
- **42:00** - 总结:从脆弱的管道到面向未来的管道
  - 安全性:内置而非附加,Lake Formation 原生集成
  - 统一性:跨所有 AWS Spark 服务的一致运行时
  - 性能:可扩展的性能优化
- **42:45** - 提供相关博客和资源链接
- **43:15** - 会议结束,感谢观众

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


关键技术发布总结:
- Spark 3.5.6 统一运行时(EMR 7.12、Glue 5.1、Athena)
- S3A 成为默认存储连接器,支持 Glacier
- AWS Spark 物化视图(查询性能提升 8 倍)
- Iceberg 读取快 4.5 倍,写入快 2 倍以上
- 字符串操作性能提升最高达 96 倍