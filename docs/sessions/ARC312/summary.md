# AWS 区域构建技术会议总结

## 会议概述

本次会议（ARC 312）由 AWS EC2 团队的首席工程师 Don McGary 和首席技术项目经理 Michelle Tissson 主讲，深入探讨了 AWS 如何构建新区域（Region）、可用区（Availability Zone）和本地区域（Local Zone）。

会议首先回顾了 AWS 全球基础设施的核心概念，包括分区（Partition）、区域、可用区等架构层次。目前 AWS 拥有 38 个区域和 38 个本地区域，并持续扩展中。演讲者特别强调了为弹性而构建的重要性，解释了区域服务与可用区服务的区别，以及如何通过跨多个可用区部署来实现高可用性。

会议的核心内容是对比了 AWS 区域构建方式的演变。2010 年构建圣保罗区域时，采用的是手动方式——工程师需要飞到现场，使用 U 盘手动安装和配置系统。这种方式虽然在早期有效，但随着 AWS 服务数量的增加和全球扩张需求的提升，已经无法满足规模化需求。如今，AWS 采用"用 AWS 构建 AWS"的方法，通过现有区域作为引导区域（Bootstrap Region），在物理基础设施就绪之前就开始软件构建，实现了物理和软件工作流的并行化。这种方法大大提高了构建效率，使 AWS 能够同时进行多个区域的构建。

## 详细时间线与关键要点

### 开场介绍 (0:00-2:30)
- **演讲者介绍**：Don McGary（EC2 首席工程师）和 Michelle Tissson（EC2 首席技术项目经理）
- **会议议程预览**：涵盖全球基础设施概念、弹性构建、历史演变、可用区/本地区域、依赖关系管理等主题

### AWS 全球基础设施概览 (2:30-8:00)
- **区域分布**：38 个已启动区域，正在建设的包括欧盟主权云、智利和沙特阿拉伯
- **本地区域**：38 个都市区域，持续扩展中
- **分区概念**：商业分区（AWS）、美国政府云分区（AWS-US-GOV）、中国分区（AWS-CN）、即将推出的欧盟主权云分区
- **分区特点**：每个分区拥有独立的全球服务实例（如 IAM 和 Route 53），账户身份在不同分区间不互通

### 基础设施层次结构 (8:00-12:00)
- **区域定义**：提供 AWS 服务的地理区域，由三个或多个可用区组成
- **可用区特性**：
  - 每个可用区可包含数十到数百个数据中心
  - 可用区内数据中心共享命运
  - 可用区间保持个位数毫秒级延迟
  - 可用区间距离足够远以避免共同故障（自然灾害、电力事件等）
- **本地区域**：可用区的延伸，控制平面在父可用区，容量更接近客户或提供额外的机器学习能力

### 弹性架构设计 (12:00-16:00)
- **服务范围理解**：区分区域级服务（S3、CloudWatch、DynamoDB）和可用区级服务（EC2 实例）
- **多可用区部署**：对大多数客户而言，跨多个可用区部署足以满足弹性需求
- **多区域策略**：适用于特定用例，但会增加 DNS 管理复杂性和成本

### 区域构建的两大工作流 (16:00-19:00)
- **物理工作流**：选址、考虑扩展选项、建设数据中心、交付和布线机架、连接到 AWS 网络
- **软件工作流**：从基础认证服务到所有 AWS 服务的构建

### 2010 年的构建方式：圣保罗区域案例 (19:00-26:00)
- **手动方式**：工程师 John 携带 U 盘飞往现场，手动安装引导脚本
- **局限性**：
  - 需要学习大量技能（网络配置、虚拟化、操作系统等）
  - 容易出错（30 步操作中通常会出错 1-2 步）
  - 难以扩展（无法同时进行多个区域构建）
  - 无法支持新的架构（如所有服务运行在 EC2 上、IAM 区域选择加入等）

### 创新驱动的变革 (26:00-30:00)
- **技术演进**：所有 AWS 服务现在都运行在 EC2 上（EC2 运行在 EC2 上）
- **客户需求**：数字主权、数据保护、更多区域以降低延迟
- **全球化价值主张**：客户能够在几分钟内实现全球部署

### 2025 年的现代构建方式 (30:00-38:00)
- **并行化策略**：物理和软件工作流同时进行
- **用 AWS 构建 AWS**：使用现有区域作为引导区域
- **引导区域选择标准**：
  - 容量考虑（不影响生产客户）
  - 网络延迟
  - 光纤连接考虑
- **引导 VPC**：跨三个可用区，所有服务认为自己存在于新建区域中

### 引导环境的技术细节 (38:00-46:00)
- **Franken 实例**：打破循环依赖的关键
  - 提供 DNS 服务
  - 提供 PKI（公钥基础设施）
  - 提供 RPM 仓库
  - 处理主机认证
- **智能代理**：前端表现为构建区域，后端使用引导区域的存储
  - 解决 EC2 需要 S3/DynamoDB，而 S3/DynamoDB 需要 EC2 的循环依赖
  - 通过 DNS 技巧和代理服务器实现

### 构建流程详解 (46:00-52:00)
- **第一阶段**：在引导 VPC 中构建 EC2 控制平面和核心网络服务
- **第二阶段**：机架就绪后，使用引导 VPC 的控制平面在构建区域启动实例
- **第三阶段**：在构建区域构建 S3 和 DynamoDB
- **迁移过程**：
  - 将数据从引导区域复制到构建区域
  - 服务团队在构建区域扩容，在引导 VPC 缩容
  - 终止引导区域资源
  - 应用访问控制列表阻止流量
  - 观察期后断开连接
- **最终阶段**：构建所有服务，运行演练，启动区域

### 可用区构建 (52:00-57:00)
- **流程相似但更简单**：使用引导可用区而非引导区域
- **时间更长的原因**：
  - 在生产区域中操作，有实际客户运行
  - 必须遵守部署安全规则（每天不能在多个可用区部署）
  - 需要极其谨慎以避免影响现有客户
- **优势**：无需在新区域重建整个堆栈即可增加弹性和容量

### 本地区域构建 (57:00-62:00)
- **类型**：标准本地区域和专用本地区域（为特定客户定制）
- **架构**：EC2 控制平面在父可用区，容量在本地区域
- **服务范围**：比完整区域小得多
- **主要复杂性**：建立父可用区与本地区域之间的网络连接
- **用例**：
  - 将应用程序部署到更接近最终用户的位置
  - 满足数据驻留要求（例如控制平面在 A 国，数据存储在 B 国）
  - 使用 S3 Express 等本地区域版本的区域服务

### 依赖关系管理 (62:00-70:00)
- **四大类别**：
  1. **服务启动**：分批启动数百个外部服务和数千个内部服务
  2. **依赖管理**：维护高层依赖图用于调度，但细粒度依赖几乎不可能维护
  3. **静态稳定性**：确保故障时优雅恢复
  4. **持续测试**：验证所有计划的功能

### Run Instances API 依赖示例 (70:00-76:00)
- **复杂性展示**：一个简单的 run instances 调用涉及数百个内部服务
- **API 编排框架**：每个框中的代理代表一个服务团队（8-10 名工程师）
- **依赖图的挑战**：
  - 即使能够构建完美的依赖图，也会在第二天过时
  - 每个团队每天都在编写代码和改变系统行为
  - 追踪分布式系统中的依赖关系是徒劳的

### 静态稳定性解决方案 (76:00-结束)
- **核心概念**：系统在依赖项不可用时仍能继续运行
- **应用场景**：
  - 数据中心断电后自动恢复
  - 无需数百名工程师手动干预
  - 区域构建过程中打破循环依赖
- **实现方式**：设计服务时考虑依赖项可能不可用的情况，实现优雅降级和自动恢复