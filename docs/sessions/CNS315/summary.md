# AWS re:Invent 2025 ECS 高级部署策略会议总结

## 会议概述

本次会议由 Kevin Gibbs 和 Mike Rizzo 主讲，深入探讨了 Amazon ECS（Elastic Container Service）的高级部署策略。演讲者首先强调了软件部署对于向客户交付价值的重要性，随后系统地介绍了 ECS 服务部署的基础概念和最新推出的高级部署功能。

会议的核心内容围绕 ECS 在 2025 年推出的三种高级部署策略展开：蓝绿部署（Blue/Green）、金丝雀部署（Canary）和线性部署（Linear）。这些新策略相比传统的滚动部署（Rolling），提供了更灵活的流量控制、更快速的回滚能力，以及通过生命周期钩子（Lifecycle Hooks）实现的自定义测试和验证功能。演讲者通过一个虚构但详细的客户案例"Unicorn Watch"（独角兽观察平台），展示了如何在实际场景中应用这些高级部署策略，包括与应用负载均衡器（ALB）、服务连接（Service Connect）以及无头服务（Headless Service）的集成方式。

## 详细时间线与关键要点

### 开场介绍 (00:00 - 02:30)
- **00:00** - Kevin Gibbs 开场，表达对软件部署的热情，强调部署是向客户交付价值的关键方式
- **00:30** - 介绍演讲者团队：Kevin Gibbs 和 Mike Rizzo
- **01:00** - 概述会议议程：ECS 服务和部署基础、高级部署技术深入讲解、部署策略选择与迁移指南

### ECS 服务与部署基础 (02:30 - 06:00)
- **02:30** - 解释 ECS 服务的两个核心配置：任务定义（Task Definition）和服务配置（Service Configuration）
- **03:00** - 介绍服务修订版本（Service Revision）的概念，以及 ECS 部署的定义
- **03:30** - 讲解部署控制器（Deployment Controller）的三种类型：ECS 原生控制器、CodeDeploy、外部控制器
- **04:00** - 介绍四种部署策略：滚动部署（默认）、蓝绿部署、金丝雀部署、线性部署

### 部署策略的关键差异 (06:00 - 09:30)
- **06:00** - 对比滚动部署与高级部署的任务容量差异：滚动部署保持恒定容量，高级部署在部署期间会有双倍任务数
- **06:45** - 解释流量转移机制：蓝绿部署一次性转移 100%，金丝雀部署分两步，线性部署多步渐进
- **07:30** - 介绍通用配置选项：生命周期钩子（Lifecycle Hooks）和烘焙时间（Bake Time）
- **08:15** - 详细说明各策略的特定配置：滚动部署的容量控制、金丝雀的初始转移百分比（0.1%-99.9%）、线性的阶段增量（3%-99.9%）

### 高级部署深入讲解 - Mike Rizzo (09:30 - 12:00)
- **09:30** - Mike Rizzo 接手演讲，介绍 AWS 对独角兽的热爱（幽默开场）
- **10:00** - 引入客户案例：Ada，Unicorn Watch 平台的 CTO
- **10:30** - 描述 Unicorn Watch 的初始架构：UI 前端、目录服务、订单服务、流媒体服务，使用 ALB、NLB 和 Service Connect

### Unicorn Watch 的挑战与需求 (12:00 - 14:30)
- **12:00** - 说明客户面临的挑战：需要保持高可用性和可靠性，同时加快交付速度
- **12:45** - 客户需求：将目录服务暴露给第三方网站，实现 API 访问
- **13:30** - 原有限制：使用 CodeDeploy 进行 UI 的蓝绿部署，但无法支持 Service Connect 和基于路径的路由

### 高级部署生命周期详解 (14:30 - 20:00)
- **14:30** - 详细讲解高级部署的生命周期阶段
- **15:00** - 预扩容阶段（Pre-Scale Up）：可附加生命周期钩子，例如进行容器镜像来源验证
- **15:30** - 扩容阶段（Scale Up）：创建绿色环境，扩展到完整规模
- **16:00** - 后扩容阶段（Post-Scale Up）：绿色环境就绪，但尚未接收流量
- **16:30** - 测试流量转移阶段（Test Traffic Shift）：配置路由，使测试流量流向绿色环境
- **17:00** - 后测试流量转移阶段（Post-Test Traffic Shift）：适合进行自动化测试或人工审批的钩子点
- **17:45** - 生产流量转移阶段（Production Traffic Shift）：根据策略（蓝绿/金丝雀/线性）转移生产流量
- **18:30** - 后生产流量转移阶段（Post-Production Traffic Shift）：保持蓝色环境运行以便快速回滚
- **19:00** - 烘焙时间（Bake Time）：可配置的等待期，最长 24 小时
- **19:30** - 清理阶段（Cleanup）：缩减蓝色环境，绿色环境成为新的生产环境

### 金丝雀和线性部署的特殊性 (20:00 - 22:30)
- **20:00** - 金丝雀部署：生产流量转移分两步，第一步转移配置的百分比（如 10%），第二步完成剩余转移
- **20:45** - 金丝雀烘焙时间：在初始百分比转移后的等待期
- **21:15** - 线性部署：多阶段渐进式流量转移，适合性能监控场景
- **21:45** - 使用场景对比：金丝雀用于限制爆炸半径的生产测试，线性用于渐进式性能验证

### 故障检测与回滚机制 (22:30 - 25:00)
- **22:30** - 介绍三种故障检测机制
- **23:00** - 断路器（Circuit Breaker）：检查新任务是否在指定时间内达到健康稳定状态
- **23:30** - CloudWatch 告警（Catch Alarms）：基于指标（如 4xx/5xx 错误、CPU/内存利用率）触发回滚
- **24:15** - 自定义测试和流量监控：通过生命周期钩子在 Lambda 中实现自定义逻辑
- **24:45** - 强调在金丝雀/线性部署中需要考虑蓝绿混合运行时的告警阈值设置

### ALB 集成实现 (25:00 - 30:00)
- **25:00** - 回到 Unicorn Watch 架构，开始讲解 UI 和目录服务的改进
- **25:30** - 目标：UI 使用蓝绿部署，目录服务使用金丝雀部署，并在同一 ALB 端口上暴露
- **26:00** - ALB 高级部署配置要求：需要生产监听器规则（Production Listener Rule）和可选的测试监听器规则
- **26:45** - ECS 通过操作监听器规则的权重来实现流量转移
- **27:15** - 支持 ALB 的高级请求路由功能：基于路径、请求头、查询字符串的路由
- **28:00** - 配置示例：需要第二个目标组、生产监听器规则 ARN、测试监听器规则 ARN 和 IAM 角色
- **28:45** - IAM 角色用于授予 ECS 操作监听器规则权重的权限
- **29:30** - 强调 ECS 不关心监听器规则所在的端口，提供灵活性

### UI 蓝绿部署实战演示 (30:00 - 34:00)
- **30:00** - 演示 Unicorn Watch UI 的蓝绿部署流程
- **30:30** - 初始状态：蓝色环境接收所有流量
- **31:00** - 扩容绿色环境，经过预扩容、扩容、后扩容阶段
- **31:30** - 测试流量转移：在测试监听器上调整权重，100% 测试流量流向绿色环境
- **32:00** - 后测试流量转移钩子：监控审批参数（存储在 Parameter Store），等待人工审批
- **32:45** - 钩子返回"进行中"状态时，ECS 会重复调用直到成功或失败
- **33:15** - 审批通过后，生产流量转移：调整生产监听器规则权重，开始烘焙时间
- **33:45** - 清理阶段：缩减蓝色环境，绿色成为新的蓝色

### 基于路径的路由配置 (34:00 - 36:30)
- **34:00** - 讲解如何在同一 ALB 端口上暴露多个服务
- **34:30** - 使用基于路径的路由：/catalog/* 路由到目录服务，/frontend/* 路由到 UI 服务
- **35:00** - 使用基于请求头的路由标识测试流量：X-NEXTB-TEST 请求头
- **35:30** - 配置四个监听器规则：目录生产、目录测试、UI 生产、UI 测试
- **36:00** - 强调监听器规则的顺序很重要，需要正确排序以获得预期效果

### Service Connect 集成 (36:30 - 40:30)
- **36:30** - 讲解目录服务通过 Service Connect 内部暴露时的金丝雀部署
- **37:00** - Service Connect 没有监听器规则，通过 Service Connect 代理进行路由
- **37:30** - 蓝色和绿色修订版本都注册到 Cloud Map，绿色标记为测试实例
- **38:00** - Service Connect 代理配置：默认使用 X-Amazon-ECS-Blue-Green-Test 请求头路由到绿色环境
- **38:30** - 可自定义请求头路由规则：支持请求头存在性检查、值匹配、模式匹配
- **39:00** - 可使用 User-Agent 字符串或 API 版本号等进行路由

### 性能测试实现案例 (40:30 - 43:30)
- **40:30** - Unicorn Watch 目录团队的性能测试需求
- **41:00** - 解决方案：在 Service Connect 命名空间中部署流量生成器
- **41:30** - 流量生成器自动标记所有请求为测试流量
- **42:00** - 在后测试流量转移阶段实现钩子：触发负载生成器，测量性能，判断通过或失败
- **42:30** - 关键要点：Service Connect 测试必须从命名空间内部进行，不能从外部测试
- **43:00** - 金丝雀生产流量测试：利用生产流量转移钩子被调用两次的特性

### 金丝雀生产流量监控 (43:30 - 45:30)
- **43:30** - 第一次调用生产流量转移钩子：启动测试，监控金丝雀百分比的生产流量性能
- **44:00** - 金丝雀烘焙时间期间持续监控
- **44:30** - 第二次调用钩子：收集和分析监控结果，决定是否继续或回滚
- **45:00** - 展示了如何结合绿色环境测试和金丝雀生产流量测试

### 无头服务部署 (45:30 - 48:00)
- **45:30** - 介绍订单状态轮询的架构限制：扩展性差，通知机制受限
- **46:00** - 新架构需求：异步事件驱动，订单服务发布事件到队列，通知服务从队列拉取消息
- **46:30** - 挑战：通知服务是无头服务（没有负载均衡器），CodeDeploy 无法支持
- **47:00** - ECS 蓝绿部署支持无头服务模式
- **47:30** - 无头服务定义：没有 Service Connect，没有负载均衡器，任务主动从队列拉取消息

### 无头服务部署机制 (48:00 - 结束)
- **48:00** - 无头服务的疑问：没有流量转移，如何实现高级部署？
- **48:30** - （会议字幕在此处截断，但暗示将继续讲解无头服务的部署机制）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


注： 本总结基于提供的字幕文本，会议在讲解无头服务部署机制时字幕截断。完整内容可能包含更多关于无头服务部署、最佳实践和总结要点。