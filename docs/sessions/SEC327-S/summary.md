# AWS re:Invent 2025 会议总结：大规模检测工程 - 构建高保真安全运营

## 会议概述

本次会议由 Datadog 安全倡导与研究团队负责人 Andrew Krug 和 Riot Games 高级安全工程师 Nathan 共同主讲，主题聚焦于如何通过"检测即代码"(Detection as Code)方法论实现大规模、高保真度的安全运营。

会议深入探讨了现代安全运营面临的核心挑战：如何在海量日志数据中有效检测威胁，同时保持检测规则的高质量和可维护性。传统的手动检测工程方法存在版本控制缺失、开发孤岛化、质量不一致等问题。为解决这些挑战，演讲者介绍了将软件开发生命周期(SDLC)原则应用于检测规则编写的最佳实践。

Riot Games 作为实际案例，分享了他们如何利用 Datadog Cloud SIEM 构建完整的检测即代码平台。他们的解决方案包括：使用 Vector 进行日志预处理和过滤、通过 Kafka 实现背压管理、利用 ECS 容器服务进行灵活的日志转换、以及通过 GitHub 实现基础设施即代码的管理方式。整个系统强调在日志进入 SIEM 之前进行早期过滤以节省成本，同时保持系统的弹性扩展能力和数据质量。会议还演示了从 GUI 创建检测规则、导出为 JSON、通过 CI/CD 流程部署的完整工作流程。

## 详细时间线与关键要点

开场介绍 (0:00-2:30)
- Andrew Krug 介绍自己是 Datadog 安全倡导与研究团队负责人
- Nathan 介绍自己是 Riot Games 高级安全工程师，拥有 6 年安全经验，曾是软件开发人员
- 现场调查：多数参会者从事安全工作，部分已是 Datadog 客户

检测工程基础概念 (2:30-5:00)
- 检测工程定义：编写检测规则以发现威胁和错误配置
- 检测即代码：将 SDLC 原则应用于检测规则编写
- 核心挑战：如何在高准确率下持续实现检测目标

日志管理挑战 (5:00-7:30)
- 现代环境中日志源如繁星般无限：AWS CloudTrail、工作负载安全日志、VPC 流日志、AI 平台日志等
- 核心目标：以可操作和有上下文的方式检测恶意活动
- 介绍检测开发生命周期：需求收集、设计、开发、测试、部署、退役

手动检测工程的问题 (7:30-9:00)
- 缺乏版本控制和审计历史
- 开发孤岛化，缺乏组织范围的可见性
- 输出质量不一致
- 大规模管理困难

检测即代码的优势 (9:00-11:00)
- 引入版本控制和同行评审
- 需要成熟的 API 支持
- 实现测试和验证，包括历史数据回测
- CI/CD 集成确保语法有效性
- 强调可重用性和模块化

检测准确性权衡 (11:00-14:00)
- 完美召回率(Perfect Recall)：识别 100% 的恶意事件，零假阴性
- 完美精确度(Perfect Precision)：仅在真实恶意事件发生时触发，零假阳性
- 实际情况：需要在两者之间找到平衡
- 类比：烟雾探测器(容忍假阳性)vs 垃圾邮件过滤器(避免假阳性)

平衡检测质量的策略 (14:00-16:30)
- 理解对假阳性的容忍度
- 使用历史数据评估规则性能
- 持续监控规则的假阳性率
- 评估规则调优对检测覆盖范围的影响

Riot Games 案例：日志优化挑战 (16:30-19:00)
- Nathan 介绍三大挑战的第一个：日志量管理
- 日志过多导致成本高昂，日志过少失去检测信号
- SIEM 优化的六大原则：早期过滤节省成本、动态适应、规范化清晰度、保持弹性、自信扩展、强制数据卫生

日志处理架构 (19:00-23:00)
- 架构图解析：公共/私有收集器 → Vector 自动扩展组 → Kafka(背压) → ECS 容器服务(Vector 过滤) → Datadog → SOAR → Jira → Slack
- 使用 Vector(Rust 编写的开源日志传输工具)进行日志转换
- 通过 GitHub 存储 Vector 配置文件，实现基础设施即代码
- 设置监控确保配置成功推送

Vector 配置示例 (23:00-27:00)
- Vector 三大组件：Source(数据源)、Transform(转换)、Sink(目标)
- 示例 1：从 Windows 事件日志收集安全日志，添加 log_source_owner 标签，发送到 Datadog
- 示例 2：从 S3 读取 CloudTrail 日志，删除不必要字段(如 event_version)，发送到 Datadog
- 强调在摄取前删除无用字段以节省成本

SIEM 优化总结 (27:00-28:30)
- 为速度而构建：收集所有数据，灵活发送到任何目标
- 边缘过滤：在数据进入 SIEM 前过滤
- 动态丰富：实时添加标签和字段
- 保持控制：通过基础设施即代码和 PR 流程管理

存储与重新激活策略 (28:30-32:00)
- 挑战：并非所有日志都需要索引(如 PAN 流量日志)
- 解决方案：将日志存档到 S3，需要时重新激活
- Datadog GUI 演示：设置存档名称、过滤查询、配置 S3 存储桶
- 可以精细控制存档内容，例如仅存档 VPN 日志

重新激活用例演示 (32:00-35:00)
- 场景：调查可疑用户活动，需要回溯 VPN 会话 IP 地址
- 重新激活 GUI：选择时间范围、存档名称、查询条件
- 关键优势：通过时间范围和用户过滤大幅减少重新激活时间(从 5-10 小时降至 5-10 分钟)
- 对事件响应场景至关重要

Archive Search 新功能 (35:00-36:30)
- Andrew 介绍 Archive Search：直接在 S3 等冷存储上运行搜索查询
- 无需完全重新激活即可进行威胁狩猎和取证调查
- 先在冷存储中搜索，确认有价值后再决定是否重新激活
- 成本优化的重要功能

检测即代码核心挑战 (36:30-39:00)
- Nathan 强调：检测质量不来自更多规则，而来自更好的流程
- Riot 最初在 GUI 中手动构建规则，后来演进为检测即代码
- 核心原则：版本控制、自动化测试、协作与评审、CI/CD 自动化
- 协作评审的重要性：防止拼写错误、配置错误(如通知发送到错误环境)

自动化测试的价值 (39:00-40:30)
- 运行 Python 脚本进行基本验证
- 检查规则是否包含 MITRE 技术和战术标签
- 验证环境标签存在
- 确保规则名称符合标准
- 验证规则语法有效性

实际演示：创建检测规则 (40:30-45:00)
- 在 Datadog GUI 中创建阈值规则
- 示例：检测 AWS CloudTrail 的 StopLogging 事件
- 按账户 ID 分组
- 使用"预览匹配日志"功能测试查询
- 设置规则条件：大于零时告警
- 添加规则名称和描述

标签管理 (45:00-47:00)
- 添加 MITRE 战术和技术标签(用于覆盖范围跟踪)
- 添加环境标签
- 提及抑制规则(Suppression)也通过 CI/CD 管理
- 关键步骤：导出规则为 JSON，但不保存(取消)

部署流程演示 (47:00-51:00)
- 在 IDE 中将导出的 JSON 文件放入 cloud_trail 文件夹
- 运行 python manage.py validate 进行验证
- 首次验证失败：缺少 CI/CD 标签
- 添加 CI/CD 标签(用于关联 GitHub 仓库与 Datadog 中的规则)
- 运行 python manage.py deploy 部署规则
- 在 Datadog GUI 中刷新确认规则已创建

CI/CD 标签机制 (51:00-52:30)
- CI/CD 标签包含哈希值
- managed_secops 标签标识由 CI/CD 管理的规则
- CI/CD 哈希用于检测规则变更：比较本地与 Datadog 中的哈希值
- 哈希不同则触发更新

更新规则演示 (52:30-54:30)
- 简单示例：在规则名称中添加"updated"
- 运行验证：通过
- 运行部署：系统识别为更新操作
- 在 GUI 中刷新确认规则名称已更新

删除规则演示 (54:30-56:00)
- 删除规则的方法：直接删除本地 JSON 文件
- 说明：演示中使用 CLI 命令，实际生产环境通过 GitHub Actions/Jenkins 等 CI/CD 工具自动执行
- 删除文件后部署，规则从 Datadog 中移除
- 在 GUI 中刷新确认规则已删除

工作流程总结 (56:00-结束)
- 完整演示了创建、更新、删除检测规则的 CI/CD 流程
- 强调 GUI 与代码化管理的结合：在 GUI 中设计和测试，导出为代码进行版本控制和部署
- 所有操作通过 Git 仓库管理，实现审计追踪和团队协作
- 自动化验证确保规则质量和一致性