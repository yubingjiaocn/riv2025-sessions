# AWS re:Invent 2025 - AWS WAF 实战：典型的一天

## 会议概述

本次会议是一场300级别的技术分享，由AWS解决方案架构师Tuam和HSBC银行的Dan Vidan共同呈现。会议以"WAF管理员的一天"为故事线，详细介绍了如何在AWS上部署和管理Web应用防火墙(WAF)。

第一部分由Tuam讲解AWS WAF的最佳实践，从早晨接到新应用上线通知开始，逐步展示如何快速部署WAF策略、处理误报、优化成本等实际场景。他强调了从简单配置开始、逐步优化的渐进式方法，避免一开始就配置过于复杂导致运维困难。特别介绍了CloudFront固定价格计划、新的控制台UI、内置仪表板等简化WAF部署和管理的新功能。

第二部分由HSBC的Dan分享真实的企业级WAF应用案例。HSBC作为全球大型银行，在多个市场运营，面临复杂的监管要求和持续的网络攻击。他们构建了一个完全无服务器的边缘保护平台，使用CloudFront、WAF和Lambda@Edge保护跨云环境（包括AWS、GCP和本地数据中心）的应用。Dan强调了在高度监管的金融行业中，WAF已成为监管机构的强制要求，尤其是在欧洲和亚太地区。

## 详细时间线

### 00:00 - 开场介绍
- 演讲者自我介绍：Tuam（AWS教育服务解决方案架构师专家）和Dan Vidan（HSBC）
- 会议定位为300级别技术分享，假设观众已具备AWS WAF基础知识
- 提醒演讲节奏较快，内容较多，可以稍后在YouTube上回看

### 02:30 - 场景设定：早晨的新应用
- 故事开始：早晨收到通知，公司推出了一个机器人销售网站和移动应用
- 应用架构介绍：CloudFront作为入口，后端包括ALB（应用负载均衡器）、API Gateway和S3静态内容
- WAF管理员需要立即保护这个新上线的应用

### 05:00 - WAF部署的关键问题
- **在哪里部署**（Where）：CloudFront边缘 vs 各个后端组件
- **何时部署**（When）：理想情况是提前规划，但现实往往需要立即行动
- **谁来管理**（Who）：安全团队 vs 应用团队
- **部署什么**（What）：第一天启用哪些规则，如何逐步增强

### 07:30 - 部署位置选择
- 推荐在CloudFront上部署WAF：在边缘阻止攻击，利用750+个接入点和高带宽容量
- 可选方案：在CloudFront部署粗粒度控制，在后端组件（ALB、API Gateway）部署细粒度控制
- 强调在边缘阻止流量的重要性，避免攻击流量进入VPC

### 10:00 - 源站保护（Origin Cloaking）
- **VPC Origins**：最佳实践，将负载均衡器变为内部资源，只有特定CloudFront分发可访问
- **S3的OAC**（Origin Access Control）：使用IAM策略保护S3存储桶
- **其他场景**：使用IP前缀列表和自定义密钥头保护本地或其他云的源站

### 13:00 - WAF策略配置
- **CloudFront固定价格计划**：2周前推出的新功能，包含预配置的WAF策略
- 提供从免费到高级的多个定价层级，每个层级包含不同的保护功能
- 业务层级包含：DDoS保护、S3存储、DNS请求等综合服务

### 16:00 - 从CloudFront控制台快速启用WAF
- 简单的勾选框配置：SQL注入保护、速率限制、监控模式等
- 无需深入了解WAF技术细节，应用所有者也能轻松配置
- 强调"足够好"的起点，可以在此基础上逐步优化

### 18:30 - 从WAF控制台创建保护策略
- 回答关于应用类型的简单问题：内容分发、API、零售等
- 三种预制保护包：基础版、核心版、高级版
- 基础版包含：速率限制、IP信誉服务、计数模式的机器人控制

### 21:00 - 渐进式部署策略
- 警告：不要一开始就启用所有功能，避免配置过于复杂导致误报
- 建议从简单配置开始，建立信任后逐步增强
- 可配置速率限制阈值（10到20亿请求）和日志记录

### 23:30 - 日志记录的重要性
- 启用CloudWatch日志非常简单，只需勾选一个框
- 固定价格计划中包含日志费用
- 按需付费模式下，每百万WAF请求提供500MB免费日志

### 25:00 - 策略总结与咖啡时间
- 选择了核心保护包，包含：IP封锁、地理位置封锁、HTTP合规性保护、已知漏洞防护（如Log4j）
- Layer 7 DDoS规则已启用（计数模式），位于策略顶部
- 现在可以监控日志并在准备好时启用阻止模式

### 27:00 - 日志分析与仪表板
- 展示新的内置仪表板（2024年6月推出）
- 可视化流量来源、触发的规则、机器人流量、DDoS流量等
- 显示热门IP地址、URI、用户代理、JA3/JA4指纹等

### 29:30 - 交互式日志导航
- 直接从控制台浏览日志，无需编写CloudWatch Logs Insights查询
- 点击IP地址可过滤该IP的所有请求
- 查看完整请求详情：IP地址、信誉、查询参数、标签等
- 所有内容可操作：可以基于任何字段进行过滤

### 32:00 - 午餐时间的紧急情况
- 营销部门报告客户收到403错误
- 仪表板显示多个IP地址因"请求体中的跨站脚本"规则被阻止
- 怀疑是误报，需要调查

### 34:00 - 误报处理
- 检查被阻止的IP地址，发现它们是正常用户（登录、购买、发帖）
- 所有阻止都发生在特定页面：/missing-robots-form
- 确认是误报，需要修复

### 35:30 - 误报缓解策略
- **第一步**：保持冷静，不要关闭WAF或回滚更改
- **第二步**：识别触发误报的具体模式（URI、参数等）
- **第三步**：将触发误报的规则切换到计数模式
- **第四步**：创建新规则，使用标签继续保护其他路径，但排除误报的URI

### 38:00 - 标签（Labels）的重要性
- 标签是WAF的"多功能工具"
- 托管规则自动添加标签（如核心规则集的标签）
- 自定义规则可以添加标签
- 可以使用标签作为匹配条件或范围缩小条件
- 标签在日志和CloudWatch指标中可见

### 40:30 - 调优最佳实践
- 经常调优策略，尽早调优
- 逐步进行更改，不要一天添加五个规则
- 使用标签管理流量
- 避免混乱，建立信任后再增加复杂性

### 42:00 - 下午咖啡时间：成本优化
- 确保Layer 7 DDoS规则位于策略顶部（被阻止的请求免费）
- 缩小付费规则（如机器人控制）的范围，只检查必要的流量
- 设置适当的日志保留期（14天到7年）
- 使用标签过滤噪音日志
- 考虑切换到固定价格计划以获得可预测的成本

### 44:30 - 日志目的地选择
- **CloudWatch Logs**：最简单配置，低流量时最便宜，包含在定价计划中
- **Kinesis Data Firehose**：高流量时最便宜，可发送到S3或第三方供应商
- **S3直接**：最简单配置，但高流量时可能产生意外的传输成本

### 46:00 - 定价计划监控
- 控制台中的清晰仪表板显示配额使用情况
- 可以看到500M请求配额中已使用多少
- 偶尔超出配额不会产生超额费用
- 持续超出配额可能导致限流

### 47:30 - HSBC案例分享开始
- Dan Vidan介绍HSBC零售银行的WAF之旅
- HSBC IWPB（国际财富和优越理财）团队是数字化推动者
- 提供通用框架和平台：移动认证、业务流程编排、边缘路由和保护

### 49:00 - HSBC的规模和挑战
- 全球最大银行之一，在多个市场运营
- 某些市场（如中国）因数据驻留要求无法使用AWS
- 某些市场（如埃及）尚不能使用任何云提供商
- 需要跨整个环境移植WAF保护

### 51:00 - 监管环境
- 高度监管的环境，每次停机都需向监管机构报告
- 品牌保护至关重要
- 拥有白标品牌（如英国的Marks & Spencer Money）
- 亚太地区拥有竞争品牌，需要满足反竞争法

### 53:00 - HSBC团队规模
- 支持多个市场、多个AWS账户（生产和非生产）
- 支持多个价值流，每个价值流有多个应用
- 攻击面巨大，需要顶级保护
- 每月处理数百TB流量，数十亿请求
- 数百个CloudFront分发，多个WAF
- 每天都在遭受攻击

### 55:00 - 监管趋势
- 欧洲央行和亚太地区监管机构越来越关注WAF
- 亚太地区WAF现在是强制性监管要求
- 监管机构开始强制要求使用WAF

### 56:30 - HSBC的WAF之旅起点
- 2018年re:Invent启发，决定构建新的云平台
- 个人使命：完全采用无服务器架构
- 云迁移时间比预期长，仍在混合云环境中运营
- 目标：将安全左移，从第三方服务提供商和源站抽象敏感安全令牌

### 58:00 - HSBC架构
- Shield提供Layer 4缓解
- CloudFront和WAF检查请求
- Lambda@Edge处理（无EC2反向代理，完全无服务器）
- 这是在CloudFront Functions之前的架构，现在会考虑迁移部分功能
- 不仅保护AWS源站，还保护本地和其他云提供商（如GCP）的源站

### 59:30 - 持续演进的威胁
- 威胁格局不断演变
- 早期DDoS不是大问题，AWS Shield会处理Layer 4攻击
- Layer 7攻击变得更加复杂，需要持续应对

注：会议在此处字幕截断，完整会议可能还有更多内容