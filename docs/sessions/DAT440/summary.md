# AWS re:Invent 2025 - DynamoDB 全局表复制模式详解

## 会话概述

本次技术分享由 AWS 工程师 Sumo Pir 和 Amazon DynamoDB 高级首席工程师 Amrit Kumar 共同主讲，深入探讨了 DynamoDB 全局表的两种复制模式：异步复制和多区域强一致性复制。

随着客户构建的系统越来越需要将数据靠近全球各地的终端用户，多区域架构已成为默认选择。这不仅是为了降低延迟，也是出于合规性和业务连续性的考虑。DynamoDB 全局表正是为支持这种多区域架构而设计的。然而，多区域复制面临着根本性挑战：区域间距离遥远（跨越大洋），延迟差异巨大且不可预测。例如，从弗吉尼亚到东京的写入可能需要数百毫秒，而到俄亥俄州只需 20 毫秒。

由于没有单一的复制模型能够适配所有工作负载，DynamoDB 提供了两种复制模式供客户选择。核心权衡在于：是要快速且可预测的性能（类似单区域写入），还是要写入立即在所有区域可见？异步复制模式提供高性能和低延迟，适合可预测的性能工作负载；而多区域强一致性（MRSC）全局表则适合需要强一致性的工作负载，确保任何区域的写入在其他区域强一致性读取时都能立即可见。

另一个关键权衡涉及恢复点目标（RPO）和恢复时间目标（RTO）。DynamoDB 全局表从设计之初就采用主-主架构，实现了零 RTO。而 RPO 决定了在区域服务中断时可以承受丢失多少数据，这直接影响复制的速度和一致性强度。

## 详细时间轴与关键要点

### 00:00 - 开场介绍
- 演讲者介绍：Sumo Pir（AWS 工程师）和 Amrit Kumar（DynamoDB 高级首席工程师）
- 主题：DynamoDB 全局表的两种复制模式及其保证

### 01:30 - 多区域需求背景
- 客户需要数据靠近终端用户（低延迟、合规性要求）
- 需要高可用性：任何区域的写入在其他区域也可用
- 需要业务连续性：区域服务中断时的容错能力
- 多区域架构正成为默认选择

### 03:45 - 多区域挑战
- 区域间距离遥远，延迟差异大
- 弗吉尼亚到东京：数百毫秒；弗吉尼亚到俄亥俄：20 毫秒
- 需要处理多个副本的并发写入和顺序问题
- 没有单一模型适合所有工作负载

### 05:20 - 核心权衡
- **性能 vs 一致性**：快速可预测的性能 vs 跨区域写入可见性
- **RPO vs RTO**：数据丢失容忍度 vs 故障恢复时间
- DynamoDB 全局表提供主-主架构，实现零 RTO

### 07:00 - 一致性模型基础（Amrit Kumar）
- **强一致性**：写入后所有人立即看到相同数据
- **最终一致性**：写入后数据最终会收敛
- **写后读一致性**：写入后能读取自己的写入
- **单调读**：时间始终向前推进，不会读到旧版本

### 09:30 - DynamoDB 架构概览
- 请求路由器：确定数据存储位置
- 三个可用区存储三份数据副本
- 存储节点领导者处理写入
- 最终一致性读可以读任何副本，强一致性读必须读领导者

### 12:15 - 异步全局表复制机制
- 写入首先在本地区域持久化（两个可用区）
- 通过 DynamoDB Streams 复制到其他区域
- 每个区域对有独立的单向复制器
- 每条路径是独立的故障域

### 15:40 - 复制顺序保证
- **按项目（per-item）保证顺序**：单个项目的修改按顺序复制
- **跨项目不保证顺序**：不同项目的复制可能乱序到达
- 单调读保证：不会时光倒流

### 18:20 - 冲突解决机制
- 使用时间戳进行冲突解决
- 所有区域共享原子钟
- **最后写入者获胜（Last Writer Wins）**
- 时间戳较晚的写入会覆盖较早的写入

### 21:30 - 强一致性读的限制
- 异步全局表中，强一致性读只反映本区域的写入
- 不保证能看到其他区域的最新写入
- 复制有传播延迟

### 24:00 - 故障场景分析
- **单区域完全离线**：其他区域间复制继续正常工作，故障区域恢复后追赶数据
- **网络分区（单链路断开）**：不进行中继复制，断开的两个区域间数据不同步，链路恢复后数据收敛
- **网络分区（多链路）**：通过第三区域可以间接同步

### 27:45 - Streams 和事务注意事项
- Streams 只反映实际发生的写入，过时的复制写入不会产生通知
- 区域内保证 ACID 事务
- 远程区域可能看到部分事务（torn transaction）

### 30:00 - 多区域强一致性（MRSC）全局表介绍（Sumo Pir）
- 解决"读取自己的写入"问题
- 即使在区域故障时也保持写入高可用
- 项目级别的可序列化强一致性读

### 32:30 - MRSC 核心机制：多区域日志
- 构建跨多个区域的仅追加日志（append-only journal）
- 日志成功追加需要在三个区域中的两个持久化
- 所有客户端按日志追加顺序接收日志条目

### 35:15 - MRSC 写入流程
- 写入请求转发到 GT 复制引擎（在 DynamoDB 内部）
- 生成复制日志条目并追加到多区域日志
- 日志成功追加后回调所有区域的复制引擎
- 写入发起区域立即应用并返回成功/失败

### 38:40 - 并发写入处理
- 不同项目的并发写入由日志序列化
- 日志追加顺序决定应用顺序
- 所有区域按相同顺序应用

### 41:20 - MRSC 强一致性读实现
- 使用"读栅栏"（read fence）/心跳机制
- 追加心跳日志条目到多区域日志
- 应用心跳之前的所有日志条目
- 确保看到所有区域的所有写入
- **强一致性读延迟接近写入延迟**

### 44:30 - 见证区域（Witness Region）
- 客户反馈：两个区域足够，第三个区域增加成本
- 见证区域：仅参与日志，不存储 DynamoDB 表
- 无资源成本和运营成本
- 支持两个完整副本 + 一个见证区域

### 47:00 - MRSC 冲突解决
- 写入序列化到同一日志，自动解决冲突
- 使用幂等日志条目（基于乐观并发控制）
- 将所有操作转换为条件写入（基于时间戳）
- 冲突时返回可重试异常

### 50:15 - 幂等性实现示例
- 读取当前项目状态
- 生成条件插入/更新/删除日志条目
- 基于系统元数据时间戳的条件检查
- 重复应用时条件失败，自动跳过

### 53:00 - 故障特性
- 区域完全隔离时的行为
- （会话在此处被截断）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


总结：本次会话全面对比了 DynamoDB 两种全局表复制模式的技术实现、一致性保证、故障处理和适用场景，为构建多区域应用提供了深入的技术指导。