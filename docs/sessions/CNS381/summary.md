# AWS re:Invent 2025 - Lambda 多租户隔离新特性详解

## 会议概述

本次会议由 AWS 无服务器架构首席解决方案架构师 Anton 和 Bill 主讲,重点介绍了 AWS Lambda 最新推出的**租户隔离模式(Tenant Isolation Mode)**。会议通过一个名叫 Joe 的云架构师的成长故事,生动地阐述了在构建多租户 SaaS 应用时面临的挑战,以及如何利用 Lambda 的新特性来解决这些问题。

演讲者首先解释了单租户与多租户架构的区别。单租户模式提供最高级别的隔离,但成本高昂且难以扩展;多租户模式成本效益高,但需要处理租户间的隔离问题,包括"嘈杂邻居"效应和数据残留问题。Lambda 的无服务器特性与 SaaS 应用天然契合,能够实现成本与使用量的线性对应,并通过 Firecracker microVM 提供强大的底层隔离。

新推出的租户隔离模式是一个突破性功能,它允许单个 Lambda 函数为不同租户创建独立的执行环境,无需预注册租户,支持无限数量的租户。开发者只需在创建函数时启用该模式,并在调用时传入租户 ID,Lambda 就会自动确保不同租户的请求永远不会共享同一个执行环境,从而从根本上解决了数据残留和跨租户污染的问题。这一特性大大简化了多租户应用的开发,让开发者无需编写复杂的清理逻辑或自定义租户框架。

## 详细时间线

### 开场与背景介绍 (0:00 - 5:30)
- **0:00** - 会议开始,演讲者 Anton 和 Bill 自我介绍,说明今天将讨论使用 Lambda 构建安全多租户 SaaS 应用的话题
- **1:15** - 引入主角 Joe,一个梦想成为云架构师的普通人,通过他从单人居住到合租的经历类比单租户与多租户环境
- **2:45** - Joe 在合租中遇到"嘈杂邻居"和共享环境被弄脏的问题,意识到需要租户隔离
- **3:30** - 解释单租户环境:每个租户拥有专用资源,隔离度最高但成本昂贵且难以扩展
- **4:20** - 解释多租户环境:资源在多个租户间共享,成本更低、运维更简单,但需要维护租户间的隔离

### Joe 的工作挑战与技术需求 (5:30 - 12:00)
- **5:30** - Joe 毕业后找到工作,开始构建多租户云应用,面临实际业务和技术挑战
- **6:15** - 业务需求:快速创新、不能有嘈杂邻居问题、需要完美的隔离
- **7:00** - Bill 解释为什么无服务器和 SaaS 是天然契合:运营效率高、成本效益好、无需管理基础设施
- **8:00** - 展示成本对比图:传统服务器架构需要为峰值预留资源并持续付费,而无服务器的成本与使用量几乎完全同步
- **9:00** - 详细讲解 Lambda 并发机制:通过图表展示请求如何被分配到不同的执行环境

### Lambda 底层架构与隔离机制 (12:00 - 18:30)
- **12:00** - 揭秘:无服务器背后实际上是大量 EC2 实例组成的集群
- **12:45** - 深入 EC2 内部结构:裸机 → Host OS → Kernel → Firecracker microVM → Guest Kernel → Runtime → 函数代码
- **13:30** - 强调 Firecracker microVM 提供的强隔离,多层隔离如同俄罗斯套娃
- **14:15** - 跨函数边界:不同函数永远不共享执行环境,CPU、磁盘、内存完全隔离
- **15:00** - 同一函数内:环境变量、IAM 执行角色和代码可能在同一函数的不同调用间共享
- **16:00** - 展示多租户场景下的执行环境图:不同颜色代表不同租户,同一执行环境可能先后处理来自不同租户的请求
- **17:30** - 问题核心:无法控制哪个租户的请求会落在哪个执行环境中

### 数据残留问题演示 (18:30 - 23:00)
- **18:30** - Bill 进行现场演示:创建一个简单的内存和磁盘计数器函数
- **19:15** - 代码逻辑:读取计数器 → 打印 → 递增 → 存储回内存/磁盘
- **20:00** - Joe 在 Lambda 控制台测试,发现每次调用计数器都会递增
- **20:45** - 租户 ID 显示为 undefined,Joe 没有意识到潜在问题
- **21:30** - 解释问题场景:蓝色租户调用后留下数据残留,黄色租户可能看到蓝色租户的数据,绿色租户可能看到前两者的数据
- **22:30** - 强调这不是 Lambda 特有问题,而是所有共享计算环境(容器、EC2)的通用挑战

### 现有解决方案 (23:00 - 30:00)
- **23:00** - Anton 强调即使数据是公开的也不应忽视隔离问题,文档化最佳实践不够,需要实际的技术解决方案
- **24:00** - 方案一:每租户一个函数(Function per Tenant)
- **24:30** - 优点:最高级别隔离、成本归因简单、可按租户配置
- **25:15** - 缺点:运维复杂度高(50,000 个租户 = 50,000 个函数)、CI/CD 复杂、可能触及 API 限制、租户上线慢、版本漂移
- **26:30** - 方案二:自定义租户框架/SDK
- **27:00** - 介绍 CyberArk 案例:构建了自定义租户框架来处理隔离
- **27:45** - 优点:资源复用率高、单位成本低、租户上线快、运维简单、功能发布快
- **28:30** - 缺点:仍可能有嘈杂邻居、需要额外的计算级隔离、需要手动清理残留数据、按租户观测性困难

### Lambda 租户隔离模式发布 (30:00 - 38:00)
- **30:00** - Joe 在午餐时思考:如果有供应商提供的租户计算隔离解决方案就好了
- **30:30** - 重大发布:Lambda 推出新的**租户隔离模式(Tenant Isolation Mode)**
- **31:00** - 核心概念一图解释:传入租户 ID,Lambda 自动为每个租户创建独立的执行环境,不同租户永不共享执行环境
- **32:00** - 现场演示:在 Lambda 控制台中看到新的 Tenant ID 属性
- **32:30** - 以蓝色租户身份调用,计数器从 1 递增到 5
- **33:15** - 切换到绿色租户,计数器从 0 开始,证明使用了不同的执行环境
- **34:00** - 绿色租户计数器达到 9-10
- **34:30** - 切换回蓝色租户,计数器从 6 继续(之前停在 5),证明蓝色租户的执行环境仍然存在
- **35:15** - 切换到橙色租户(新租户),计数器从 0 开始
- **36:00** - 强调这不仅适用于计数器,还适用于租户特定配置、数据、数据库连接字符串等缓存信息

### 使用方法与技术细节 (38:00 - 45:00)
- **38:00** - 创建函数:添加新属性 tenancyConfig 并设置 tenantIsolationMode: PerTenant
- **38:45** - 已支持 CDK、Terraform 等基础设施即代码工具
- **39:15** - 重要:只能在创建新函数时启用,不能修改现有函数(出于安全考虑)
- **39:45** - 调用函数:必须提供 tenantId 参数,否则会返回错误
- **40:30** - 在函数代码中访问:通过 context.tenantId 获取租户 ID
- **41:15** - 无需预注册租户
- **41:30** - 支持无限数量的租户
- **41:45** - 租户 ID 可以是任意字母数字字符串,最长 128 字符
- **42:15** - 同时支持 ZIP 和容器镜像部署方式

### 注意事项与限制 (45:00 - 50:00)
- **45:00** - 冷启动现在是按租户的:每个租户都有自己的执行环境,因此会有独立的冷启动
- **45:45** - 高频调用的租户几乎不会注意到,但每天只调用几次的租户每次调用可能都是冷启动
- **46:30** - 并发配额仍然适用:10 个租户意味着至少 10 个执行环境,会消耗更多并发配额
- **47:15** - 不支持预置并发(Provisioned Concurrency):因为无法预先知道所有租户
- **48:00** - 当前仅支持直接调用或 API Gateway 集成,其他事件源暂不支持

### 可观测性 (50:00 - 结束)
- **50:00** - 强烈建议使用 JSON 格式日志
- **50:30** - 启用 JSON 日志后,Lambda 会自动将租户 ID 注入到日志中
- **51:00** - 无需在代码中手动打印租户 ID
- **51:30** - 演示如何在 CloudWatch Logs Insights 中按租户 ID 查询日志
- **52:00** - 总结:租户隔离模式大大简化了多租户 SaaS 应用的开发,提供了供应商级别的隔离保障
- **52:30** - 最后一张幻灯片提供 QR 码,包含所有资源链接和演示文稿