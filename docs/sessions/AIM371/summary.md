# AWS re:Invent 2025 - 使用 SageMaker HyperPod CLI 和 SDK 构建、微调和部署 AI 模型

## 会议概述

本次技术会议由 AWS SageMaker AI 团队的解决方案架构师 Joseph Angelo Portell 和首席软件工程师 Arun Nagarajan 主讲，重点介绍了 Amazon SageMaker HyperPod 的 CLI 和 SDK 工具。SageMaker HyperPod 是一个专为大规模训练和部署基础模型而设计的托管集群服务，能够扩展到数千个加速器。该服务的核心优势在于其内置的弹性恢复能力、高效的资源利用优化以及简化的用户体验。

会议通过一系列实时编码演示，展示了从集群创建、模型训练、模型部署到资源治理的完整工作流程。特别值得注意的是，HyperPod CLI 和 SDK 为数据科学家提供了比直接使用 Kubernetes 命令更加抽象和友好的接口，使得复杂的分布式训练和推理部署可以通过简单的命令完成。演讲者还展示了最近推出的在 HyperPod 上运行 IDE 和 Notebook 的新功能，进一步提升了开发体验。

## 详细时间线与关键要点

### 开场介绍 (0:00 - 2:30)
- **0:00** - 会议开始，Joseph Angelo Portell 介绍自己作为 SageMaker AI 解决方案架构师的背景，专注于帮助客户在 HyperPod 上进行大规模 LLM 训练和推理
- **0:45** - 介绍联合演讲者 Arun Nagarajan，他是 HyperPod 设计和功能开发的核心工程师
- **1:15** - 概述会议议程：HyperPod 介绍、CLI/SDK 功能、实时演示（集群创建、训练、部署、任务治理、IDE 集成）

### SageMaker HyperPod 产品介绍 (2:30 - 6:45)
- **2:30** - HyperPod 定义：用于管理和操作持久化集群以训练和部署基础模型的服务
- **3:00** - 核心优势：可扩展至数千个加速器、提高效率、减少训练时间、降低成本
- **3:30** - 弹性能力详解：服务持续对集群实例进行健康检查，自动检测 GPU 故障、网络故障并采取修复措施（替换或重启实例）
- **4:15** - 高可扩展性：支持单脊柱节点拓扑以实现低延迟，预配置 EFA 高速网络连接，支持托管自动扩缩容
- **5:00** - 高度可定制性：用户可以完全控制从硬件到库和框架的整个技术栈，支持 SSH 访问集群节点
- **5:30** - 高效性：集成任务治理功能实现资源分配和优先级管理，集成 Prometheus 和 Grafana 可观测性解决方案
- **6:00** - 架构灵活性：支持从硬件选择、存储配置（S3、FSx for Lustre）、框架选择（PyTorch、TensorFlow、Jax）到实验跟踪解决方案的全方位定制

### 编排选项与架构 (6:45 - 9:30)
- **6:45** - 两种编排选项：Slurm（传统 HPC 体验）和 Amazon EKS（Kubernetes 编排，本次会议重点）
- **7:30** - EKS 编排架构：HyperPod 托管计算节点，EKS 集群作为编排器，用户通过 Kubernetes API 交互
- **8:15** - 用户交互方式：可从 SageMaker Studio 或本地终端使用 CLI/SDK
- **8:45** - 管理员功能：使用 Kubernetes API 配置集群，通过 AWS Systems Manager Session Manager 建立安全连接访问节点
- **9:00** - 存储配置：支持 S3、FSx for Lustre 或自定义文件系统，通过 VPC 中的弹性网络接口连接

### HyperPod CLI 和 SDK 介绍 (9:30 - 12:00)
- **9:30** - 构建 CLI/SDK 的原因：客户反馈直接使用 kubectl 和 YAML 配置文件过于复杂
- **10:00** - 目标用户需求：数据科学家和研究人员需要更抽象、更贴近 GenAI 工作负载的接口
- **10:30** - 开源项目：在 GitHub 的 SageMaker HyperPod CLI 仓库中提供
- **11:00** - 架构设计：分层架构，顶层为用户体验层（CLI 命令和 SDK），核心模块实现命令逻辑，底层使用 Kubernetes 客户端
- **11:30** - 模板版本化：CLI 使用版本化模板表示集群中安装的自定义资源定义，确保向后兼容性

### 集群创建体验 (12:00 - 14:30)
- **12:00** - 简化的集群创建：从 AWS 控制台推出的新体验
- **12:30** - 快速设置选项：提供预配置的基础设施默认值（VPC、CIDR 范围等）
- **13:00** - 自定义设置选项：允许用户调整配置，选择启用或禁用特定操作符
- **13:30** - CLI 安装：通过 pip install sagemaker-hyperpod 安装
- **14:00** - 演示准备：展示控制台中的现有集群（EKS 编排和 Slurm 编排）

### 实时演示：集群设置与配置 (14:30 - 20:00)
- **14:30** - 展示 AWS 控制台中的 HyperPod 集群：ML-cluster-aim-371（EKS 编排）
- **15:00** - 集群配置详情：两个实例组（G5.12xlarge 带 4 个 A10 GPU，T3.2xlarge CPU 节点）
- **15:45** - 切换到 VS Code 演示环境，展示模块化示例代码结构
- **16:15** - 验证 CLI 安装：运行 hyp --version 检查版本
- **16:45** - 列出集群：使用 hyp cluster list 命令查看账户中的 EKS 编排集群
- **17:15** - 设置集群上下文：运行命令更新本地 kubeconfig 以连接到特定集群
- **17:45** - 获取当前集群上下文：使用 hyp cluster get-context 确认工作集群
- **18:15** - 存储配置说明：集群附加了 FSx for Lustre 文件系统，配置了数据仓库关联实现与 S3 的双向同步
- **19:00** - 集群创建演示：使用 hyp init cluster-stack 初始化工作目录
- **19:30** - 生成的文件：config.yaml（抽象配置）和 Jinja 模板（CloudFormation 参数）

### 集群创建配置详解 (20:00 - 23:30)
- **20:00** - Jinja 模板内容：包含可用区、NAT 网关、实例组、FSx 配置等复杂参数
- **20:45** - config.yaml 简化配置：提供与控制台相同的配置选项（Kubernetes 版本、操作符、实例组等）
- **21:30** - 配置编辑方式：直接编辑 config.yaml 或使用 hyp configure 命令
- **22:00** - 配置验证：使用 hyp validate 验证配置无误
- **22:30** - 创建集群：运行 hyp create 触发集群创建
- **23:00** - 运行目录：包含已评估的 CloudFormation 参数，用于实验跟踪
- **23:15** - 监控创建进度：在 AWS 控制台 CloudFormation 中查看嵌套堆栈部署状态

### 训练操作符介绍 (23:30 - 26:30)
- **23:30** - Arun 接手演示，介绍 HyperPod 训练操作符
- **24:00** - 超快速故障恢复：故障发生时不会销毁容器，保留初始化工作，恢复时间从分钟级降至秒级
- **24:45** - 自定义监控：除基础设施故障外，还可监控训练日志中的问题（如训练停滞、损失曲线异常）
- **25:30** - 任务治理集成：最大化 GPU 资源利用率
- **26:00** - 训练数据集展示：用于训练具有工具调用和思维链能力的代理模型（Qwen 3）

### 实时演示：模型训练 (26:30 - 33:00)
- **26:30** - 简化的训练提交：单个命令完成分布式训练配置
- **27:00** - 验证数据集：检查 S3 中的训练和验证数据集
- **27:30** - 验证 ECR 镜像：确认训练镜像已准备就绪
- **28:00** - 提交训练作业：使用 hyp job create 命令，指定 2 个 G5 节点，每节点 4 个训练进程
- **28:30** - CLI 工作原理：构建正确的 Kubernetes spec 文件并提交到集群
- **29:00** - 列出作业：使用 hyp job list 查看作业状态（已运行）
- **29:30** - 获取作业详情：显示 2 个副本、每节点 4 个进程的配置
- **30:00** - 列出 Pod：查看训练作业的两个 Pod
- **30:30** - 查看 Pod 日志：显示初始化完成、检查点加载、训练开始
- **31:00** - 操作符功能总结：单命令指定镜像和配置，自动启动训练 Pod，持续健康检查

### 故障恢复演示 (33:00 - 36:00)
- **33:00** - 模拟节点故障：手动标记节点为失败状态（生产环境中由健康代理自动完成）
- **33:45** - 应用 Kubernetes 标签：标记节点为 failed 和 pending-reboot
- **34:15** - 观察 Pod 重新调度：失败节点上的 Pod 被调度到不同节点
- **34:45** - 快速恢复：Pod 已处于运行状态
- **35:15** - 查看作业描述：操作符记录在 6.5 秒内完成故障修复
- **35:45** - 关键价值：无需凌晨 3 点起床修复因单个 GPU 故障导致的训练作业失败

### 训练作业的其他提交方式 (36:00 - 38:00)
- **36:00** - 初始化训练目录：使用 hyp init 创建模板化文件
- **36:30** - 生成的配置文件：包含空白字段的 config.yaml
- **37:00** - 配置方式：使用 configure 命令或直接编辑器编辑
- **37:30** - 验证和创建：运行 validate 和 create 命令提交作业

### SDK 接口演示 (38:00 - 39:30)
- **38:00** - Python SDK 抽象：除 CLI 外还提供 Pythonic SDK 实现
- **38:30** - 使用场景：适用于 Notebook 或自动化脚本
- **39:00** - HyperPodPyTorchJob 类：实例化并提供配置，调用 create() 提交作业
- **39:15** - SDK 功能：支持 list、status、pod logs 等所有 CLI 功能

### 训练演示总结 (39:30 - 40:30)
- **39:30** - 快速简单：使用 CLI/SDK 提交训练作业无需担心故障恢复
- **40:00** - 故障恢复速度：恢复非常快速
- **40:15** - 分层架构：在 Kubernetes/kubectl 之上的抽象层，高级用户仍可使用 kubectl

### 推理操作符介绍 (40:30 - 43:00)
- **40:30** - 启动推理端点创建（需要几分钟）
- **41:00** - 删除训练作业为推理部署腾出资源
- **41:30** - 使用配置文件方式：运行 validate 和 create 启动推理部署
- **42:00** - 推理操作符功能概述：简化部署、灵活模型来源、自动扩缩容支持
- **42:30** - 简化部署：创建生产级推理端点所需的所有基础设施（ALB、SSL 证书、自动扩缩容策略）

### 推理操作符功能详解 (43:00 - 45:00)
- **43:00** - 模型来源灵活性：支持 FSx、S3 中的自定义模型或 SageMaker JumpStart 内置模型
- **43:30** - 自动扩缩容：与 CloudWatch 或 Prometheus 指标集成，自动监控和扩缩容
- **44:00** - Karpenter 集成：与 HyperPod 的 Karpenter 自动扩缩容无缝协作，按需配置实例
- **44:30** - 不同用户流程：数据科学家使用 CLI/SDK 创建端点，应用开发者通过 ALB 或 SageMaker 端点调用模型

### 实时演示：推理部署 (45:00 - 50:30)
- **45:00** - 验证模型位置：检查 S3 存储桶中的部署模型
- **45:30** - 配置文件方式：展示已配置的 config.yaml
- **46:00** - CLI 等效命令：展示指定端点名称、模型位置、实例类型、镜像 URI 的命令行方式
- **46:30** - 使用 SageMaker DJL 容器：直接使用 SageMaker 提供的容器镜像
- **47:00** - 列出端点：使用 hyp endpoint list 查看集群中的所有端点
- **47:30** - 部署状态：显示 "deployment complete"，Pod 应处于运行状态
- **48:00** - 查看操作符日志：显示指标启用、推理端点配置设置
- **48:30** - 查看自定义端点日志：确认部署成功
- **49:00** - Pod 状态检查：Pod 已就绪可进行推理
- **49:30** - 查看 Pod 日志：显示初始化完成、模型加载、工作线程启动
- **50:00** - SageMaker 端点创建完成：可以进行推理调用
- **50:15** - 执行推理：聊天补全成功返回结果

### 推理演示总结与其他功能 (50:30 - 52:00)
- **50:30** - 推理演示结束
- **51:00** - JumpStart 部署方式：只需指定模型 ID，系统自动下载模型并部署
- **51:30** - 单命令完成复杂设置：负载均衡器、自动扩缩容控制器、指标、日志、Kubernetes 部署全部自动配置
- **51:45** - 跳过自动扩缩容演示：由于时间限制，示例代码中包含但不演示

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


注： 所有演示代码和配置文件将在会议结束后提供下载。