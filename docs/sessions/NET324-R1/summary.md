# AWS re:Invent 2025 技术会议总结：使用 Amazon CloudFront 和 AWS WAF 管理机器人与人类流量

## 会议概述

本次会议由 AWS 边缘专家 Itav Arditi 和初创企业解决方案架构师 Nick McCord 主讲，重点介绍了如何使用 Amazon CloudFront 和 AWS WAF 来区分和管理机器人与人类用户的流量。会议属于 300 级别的深度技术讨论，通过构建一个宠物收养平台的实际案例，演示了从基础 WAF 保护到高级边缘计算解决方案的完整实施过程。

演讲者们强调了现代互联网环境中机器人流量管理的复杂性，包括好机器人（如搜索引擎爬虫）、坏机器人（如 DDoS 攻击者和内容窃取者）以及新兴的 AI 机器人。通过实时演示和代码展示，他们详细说明了如何构建智能的流量路由系统，既能保护合法用户体验，又能收集有价值的攻击者信息用于安全分析。

## 详细时间线与关键要点

### 开场介绍 (00:00-05:00)
- **演讲者介绍**：Itav Arditi（AWS 边缘专家，10年边缘客户经验）和 Nick McCord（初创企业解决方案架构师）
- **会议定位**：300级别技术深度讨论，包含复杂概念和实时代码演示
- **会议结构**：架构图展示、实时演示、代码分析，会后15分钟答疑时间

### 机器人流量分类与挑战 (05:00-10:00)
- **四类流量识别**：人类用户、好机器人（搜索引擎爬虫）、坏机器人（DDoS攻击、内容窃取）、AI机器人
- **业务影响**：坏机器人可能导致基础设施攻击、知识产权窃取、服务可用性下降
- **AI机器人趋势**：过去两年显著增长，结合了人类和机器人行为特征

### AWS 边缘服务架构 (10:00-15:00)
- **CloudFront 全球网络**：超过700个接入点(PoPs)，支持缓存内容和API服务
- **请求处理流程**：查看器请求 → WAF规则评估 → 源请求(缓存未命中) → 源响应 → 查看器响应
- **日志系统**：CloudWatch、Kinesis Data Firehose、S3标准日志；Kinesis Data Stream实时日志(秒级)

### WAF 保护机制详解 (15:00-20:00)
- **保护包结构**：规则 → 规则组 → 保护包的层次化管理
- **规则优先级**：按优先级顺序执行，终止性规则会阻止后续规则评估
- **AWS托管规则**：IP信誉列表、OWASP Top 10核心规则集等预配置保护

### 实际案例：宠物收养平台 (20:00-25:00)
- **业务背景**：基于2024年ASPCA报告，580万只猫狗需要收养
- **平台功能**：宠物搜索、收养申请、管理面板
- **关键指标**：网站流量、申请审核时间、收养时间

### 第一阶段：基础 WAF 实施 (25:00-35:00)
- **速率限制**：基于时间窗口、URI、IP、请求头的流量控制
- **JA3/JA4指纹识别**：SSL/TLS连接特征哈希，检测请求操作技巧
- **机器人控制**：AWS托管规则组(通用和目标版本)，标记和处理爬虫、扫描器
- **实施效果**：简单机器人被阻止，但复杂机器人增加攻击频率

### 第二阶段：智能缓存策略 (35:00-45:00)
- **非终止性操作**：从阻止(block)改为计数(count)，添加自定义请求头
- **差异化内容**：机器人获得受限的宠物列表，人类用户获得完整内容
- **缓存策略配置**：基于X-Amazon-WAF头部的条件缓存
- **业务影响**：降低了总体流量和Lambda调用次数，改善了合法用户体验

### CloudFront Functions 技术深入 (45:00-55:00)
- **轻量级边缘计算**：JavaScript运行环境，支持变量、函数、原生方法
- **高级功能**：Buffer、Crypto、Promise、async/await支持
- **日志集成**：console.log自动发送到CloudWatch Logs(US-East-1)
- **控制流程**：返回请求对象继续处理，返回响应对象终止请求

### 第三阶段：源修改与流量路由 (55:00-65:00)
- **源修改功能**：动态重定向机器人流量到专用Lambda函数
- **缓存破坏机制**：1%的机器人流量绕过缓存，获取实时数据用于分析
- **辅助函数**：updateRequestOrigin、selectRequestOriginById、requestOriginGroups
- **故障转移机制**：原生的多源故障转移支持

### 实时代码演示 (65:00-75:00)
- **函数关联**：在CloudFront行为中配置viewer request触发器
- **机器人检测逻辑**：检查WAF添加的头部，实现条件路由
- **随机缓存破坏**：Math.random()实现1%流量的缓存绕过
- **源选择**：使用预配置的Lambda函数URL作为机器人专用源

### 高级监控与分析 (75:00-80:00)
- **静态资源监控**：为图片请求添加CloudFront Functions
- **异步日志记录**：不影响响应性能的元数据收集
- **关联分析**：将API请求与图片渲染请求进行关联
- **成本优化**：最小化额外Lambda调用，可调整采样率

### 性能指标与成本影响 (80:00-结束)
- **缓存命中率**：轻微下降(仅1%流量缓存未命中)
- **Lambda调用**：新增少量机器人处理调用
- **成本控制**：高度可定制的采样率，最小化额外成本
- **业务价值**：保护合法用户体验，获得攻击者情报，维护平台完整性