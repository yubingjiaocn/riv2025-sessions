# AWS re:Invent 2025 - DSQL 开发者实战会议总结

## 会议概述

本次会议是一场关于 Amazon DSQL 的开发者实战演示（Code Talk），由两位 DSQL 团队的工程师 Mark 和 Ruka 主讲。DSQL 是 AWS 在去年 re:Invent 大会上发布预览版、今年早些时候正式 GA 的分布式 PostgreSQL 实现。会议通过构建一个简单的银行转账应用来展示 DSQL 的核心特性和开发实践。

DSQL 的设计目标是将关系型数据库的强大功能（如 JOIN、复杂查询、模式管理）与 DynamoDB 的水平扩展能力和 Lambda 的无服务器特性结合在一起。它提供四大核心支柱：几乎无限的扩展能力、高可用性、零基础设施管理和易用性。会议重点演示了如何使用 AWS CDK 声明式管理基础设施，如何通过 Lambda 函数连接 DSQL，以及如何处理并发事务冲突。

整个演示采用"烹饪节目"风格，讲师现场编写代码，展示了从创建集群（仅需 10 秒）、配置 IAM 权限、编写事务逻辑到处理乐观并发控制（OCC）的完整开发流程。会议特别强调了 DSQL 的强快照隔离（Strong Snapshot Isolation）特性和无锁设计，这使得系统能够支持更高的事务吞吐量，但需要开发者在应用层实现重试逻辑。

## 详细时间线与关键要点

### 开场介绍 (00:00 - 02:30)
- **00:00** - Mark 和 Ruka 介绍自己是 DSQL 团队的工程师
- **00:30** - 说明这是一场代码实战演示，将构建一个简单的银行应用
- **01:00** - 演示场景：Mark 欠 Ruka 钱，需要通过应用进行转账
- **01:30** - 会议将涵盖：连接 DSQL、使用 CDK、处理并发冲突
- **02:00** - 提醒观众这是"烹饪节目"风格，会有等待时间，欢迎提问

### DSQL 产品介绍 (02:30 - 05:00)
- **02:30** - 现场调查：很少人使用过 DSQL（符合预期）
- **03:00** - DSQL 于去年 re:Invent 发布预览版，今年早些时候 GA，目前约 6 个月
- **03:30** - 核心定位：分布式 PostgreSQL 实现，结合关系型数据库、DynamoDB 式扩展和 Lambda 式无服务器
- **04:00** - 四大支柱：几乎无限扩展、高可用性、零基础设施管理、易用性
- **04:30** - 客户需求：既要关系型数据库功能，又要无单点故障和自动扩展

### 快速创建集群演示 (05:00 - 08:00)
- **05:00** - Ruka 在控制台演示创建集群，挑战观众数到 10
- **05:30** - 集群创建完成：仅需约 10 秒（最近推出的快速创建功能）
- **06:00** - 慢动作回放：展示创建界面只有单区域/多区域选项
- **06:30** - 关键特性：界面无滚动条，无需选择实例类型、副本数、子网等
- **07:00** - 强调传统数据库创建的痛点：需要提前做大量决策
- **07:30** - DSQL 简化配置：可选标签、加密密钥、删除保护、高级安全选项

### 连接方式介绍 (08:00 - 10:30)
- **08:00** - 展示两种连接方式：查询编辑器和 Cloud Shell
- **08:30** - 查询编辑器：2 周前发布，浏览器通过 WebSocket 直接连接 DSQL
- **09:00** - Cloud Shell 集成：控制台底部可一键连接，自动填充连接命令
- **09:30** - 演示 PostgreSQL 协议兼容性
- **10:00** - 开始切换到代码演示环节

### 项目结构与 Lambda 设置 (10:30 - 15:00)
- **10:30** - 介绍 GitHub 上的 starter kit：包含 CDK 和 Lambda 两个文件夹
- **11:00** - Lambda 函数基础：简单的请求处理器，返回问候语
- **11:30** - CDK 配置：自动打包 Lambda 代码并部署
- **12:00** - DSQL 集群配置：通过 CDK 定义，包含删除保护、标签等
- **12:30** - 展示 CDK 输出：集群端点和 Lambda IAM 角色
- **13:00** - 集群端点说明：每个集群有唯一端点（UUID），便于 PostgreSQL 客户端连接
- **13:30** - 演示 Lambda 函数调用：aws lambda invoke 命令
- **14:30** - 准备演示数据库连接

### 身份验证机制详解 (15:00 - 20:00)
- **15:00** - 设置环境变量：PGUSER=admin, PGDATABASE=postgres, PGHOST=<endpoint>
- **15:30** - 密码生成：通过 AWS CLI 生成临时令牌
- **16:00** - 关键概念：类似 S3 预签名 URL 的机制
- **16:30** - 详细解释：SDK 构建 HTTP 请求并签名，提供防篡改和过期特性
- **17:00** - 令牌包含：主机、操作（DBConnectAdmin）、签名
- **17:30** - 令牌作为密码使用，有效期很短（已过期的令牌展示）
- **18:00** - 设置 PGPASSWORD 环境变量
- **18:30** - 成功连接到 DSQL（修正区域配置后）
- **19:00** - 运行标准 PostgreSQL 命令验证连接

### Lambda 函数数据库集成 (20:00 - 25:00)
- **20:00** - 展示 db.ts 文件：Node.js PostgreSQL 驱动配置
- **20:30** - 唯一修改：密码字段调用 SDK 生成令牌函数
- **21:00** - 集群端点通过环境变量传入
- **21:30** - CDK 配置：将集群端点注入 Lambda 环境变量
- **22:00** - IAM 权限配置：允许 Lambda 角色连接数据库
- **22:30** - 首次调用失败（预期）：数据库端尚未授权
- **23:00** - 数据库端授权：CREATE ROLE myapp WITH LOGIN
- **23:30** - 执行 GRANT 语句，将 IAM 角色映射到数据库角色
- **24:00** - 查看 aws_commons.iam_role_mapping 表
- **24:30** - 设计理念：暴露完整的 PostgreSQL 权限系统，只需绑定 IAM 实体到数据库角色

### 银行应用模式设计 (25:00 - 28:00)
- **25:00** - 创建 accounts 表：ID（主键）和 balance（余额）
- **25:30** - 演示错误的转账方式：不使用事务
- **26:00** - 问题场景：执行第一条语句后系统崩溃会怎样？
- **26:30** - 业务逻辑错误：余额不足时的并发问题
- **27:00** - 示例：$10 余额同时支付两笔债务的竞态条件
- **27:30** - 强调必须使用事务保证原子性

### 事务与隔离级别深入讲解 (28:00 - 33:00)
- **28:00** - Ruka 讲解事务的重要性
- **28:30** - 原子性（Atomicity）：BEGIN 和 COMMIT 之间的操作要么全部成功要么全部失败
- **29:00** - DSQL 隔离级别：强快照隔离（Strong Snapshot Isolation），比 PostgreSQL 的可重复读更强
- **29:30** - 异常（Anomalies）概念：事务中看到不合理的数据
- **30:00** - 示例：幻读（Phantom Row）- 多次查询看到不同结果
- **30:30** - 数据库的职责：隔离事务，提供单用户系统的假象
- **31:00** - DSQL 唯一异常：写偏斜（Write Skew）
- **31:30** - 强一致性：写入立即对所有读取可见，无需路由到特定端点
- **32:00** - 对比最终一致性系统
- **32:30** - ACID 特性：原子性、一致性、隔离性、持久性

### 事务代码实现 (33:00 - 38:00)
- **33:00** - Mark 开始编写事务代码
- **33:30** - 标准模式：try-catch 包裹 BEGIN/COMMIT
- **34:00** - 错误处理：抛出异常并确保连接返回池
- **34:30** - 连接池管理：避免连接泄漏导致的故障
- **35:00** - 实现转账逻辑：扣款和收款两条 SQL
- **35:30** - 使用绑定变量：防止 SQL 注入（"Bobby Drop Tables"）
- **36:00** - 添加业务逻辑检查：账户存在性、余额充足性
- **36:30** - 问题讨论：并发场景下的问题
- **37:30** - 观众提问：两个事务同时提取 $100 如何处理？

### 乐观并发控制（OCC）机制 (38:00 - 43:00)
- **38:00** - Ruka 解释 DSQL 的乐观并发控制
- **38:30** - 核心机制：两个事务更新同一行时都被允许尝试
- **39:00** - 冲突解决：第一个提交的事务成功，第二个收到序列化错误
- **39:30** - 错误码：PostgreSQL 40001（序列化错误）
- **40:00** - 应用层职责：实现重试逻辑
- **40:30** - 理想模式：幂等事务设计
- **41:00** - 对比悲观并发控制：行锁和等待队列
- **41:30** - Ruka 的 Oracle DBA 噩梦：事务排队等待行锁
- **42:00** - DSQL 优势：无锁设计，更高吞吐量
- **42:30** - 观众确认：DSQL 中没有锁，提交时才决定胜者

### 重试逻辑实现 (43:00 - 48:00)
- **43:00** - 开始实现重试循环：while(true) 包裹事务代码
- **43:30** - 错误处理：检查错误码是否为 40001
- **44:00** - 序列化错误时执行 continue 重试
- **44:30** - 重要细节：在循环内获取新连接
- **45:00** - 添加遥测数据：跟踪重试次数和持续时间
- **45:30** - 返回重试统计信息
- **46:00** - Ruka 补充：可以量化热点和死锁频率
- **46:30** - 可选优化：指数退避策略
- **47:00** - 观众评论：OCC 是权衡，不一定优于传统锁
- **47:30** - 讨论：读已提交模式下无需重试循环

### 并发测试与性能观察 (48:00 - 52:00)
- **48:00** - 准备运行并发测试：1000 个账户，1000 个并发请求
- **48:30** - 随机选择付款人和收款人进行转账
- **49:00** - 预期：高冲突率（因为账户数等于并发数）
- **49:30** - 遇到连接泄漏问题：超时错误
- **50:00** - 调试：修复连接未返回池的问题
- **50:30** - 观众提问：为什么必须在重试循环内获取连接？
- **51:00** - Mark 解释：分布式系统中连接可能失败，需要获取新连接恢复
- **51:30** - 观众提问：连接是否收费？答案：连接免费

### 问答环节要点 (贯穿全程)
- **VPC 端点支持**：支持 VPC 端点和资源策略，最近新增
- **安全策略**：有详细博客介绍 5 种锁定方式
- **MySQL 支持**：目前没有 MySQL 版本，但 SQL 方言通用性强
- **端点策略**：支持资源策略，可限制 IP、VPC 等
- **连接池配置**：演示中配置 20 个连接（对单请求 Lambda 来说过度配置）
- **令牌生成性能**：仅需约 20 纳秒
- **re:Invent 彩蛋**：在 AWS 展位说出"序列化错误 40001"可获得卫衣和贴纸

### 技术架构要点总结
- **无基础设施管理**：无需选择实例类型、副本数、子网等
- **快速创建**：集群创建仅需 10 秒
- **WebSocket 支持**：浏览器可直接连接
- **IAM 集成**：通过临时令牌认证，无需管理密码
- **PostgreSQL 兼容**：完全兼容 PostgreSQL 协议和权限系统
- **分布式架构**：连接分布在不同机器，部分故障不影响整体
- **强一致性**：写入立即全局可见
- **无锁设计**：支持更高并发，但需应用层重试